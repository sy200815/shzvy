<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yok Chat</title>
 <!-- åœ¨ <head> é‡Œé¢ï¼Œæˆ–è€… <body> çš„æœ€ä¸Šé¢åŠ è¿™ä¸€è¡Œ -->
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        :root {
    --bg-color: #DCE9F5;       /* é›¾éœ¾è“èƒŒæ™¯ */
     /* â–¼â–¼â–¼ æ–°å¢ï¼šå¡ç‰‡èƒŒæ™¯è‰² (é»˜è®¤çº¯ç™½) â–¼â–¼â–¼ */
    --card-bg: rgba(255, 255, 255, 1); 
    /* â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² */      
    --text-main: #5A6A7E;      /* æ·±ç°è“å­—ä½“ */
    --text-light: #8B9BB4;     /* æµ…ç°è“å­—ä½“ */
    --accent: #7FA6C8;         /* å¼ºè°ƒè‰² (æ ¸å¿ƒé¢œè‰²) */
    --btn-text: #FFFFFF;       /* æŒ‰é’®æ–‡å­—è‰² */
    --shadow: 0 8px 20px rgba(127, 166, 200, 0.15);
    --bubble-mine: #7FA6C8;    /* èŠå¤©æ°”æ³¡(æˆ‘)çš„èƒŒæ™¯è‰² */
}
      
        body {
            font-family: 'Helvetica Neue', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh; /* å æ»¡å…¨å± */
            width: 100vw;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-main);
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡å­—ï¼ŒåƒAppä¸€æ · */
        }

        /* --- èƒŒæ™¯ä¸å¤´åƒåŒºåŸŸ --- */
        #wallpaper-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-color);
        }
        
        /* å¤´åƒæ¡† */
        #avatar-box {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: white;
            margin-top: 120px; /* è·ç¦»é¡¶éƒ¨è·ç¦» */
            box-shadow: var(--shadow);
            border: 3px solid white;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: var(--text-light);
            overflow: hidden;
        }

        /* --- çŠ¶æ€æ  --- */
        #status-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-main);
            z-index: 100;
        }
        .battery-icon {
            width: 24px; height: 12px;
            border: 1.5px solid var(--text-main);
            border-radius: 3px;
            position: relative;
            display: flex;
            align-items: center;
            padding: 1px;
        }
        .battery-icon::after { /* ç”µæ± å¤´ */
            content: '';
            position: absolute; right: -4px; top: 2px;
            width: 2px; height: 4px;
            background: var(--text-main);
            border-radius: 0 1px 1px 0;
        }
        .battery-level {
            height: 100%;
            background-color: var(--text-main);
            border-radius: 1px;
            width: 50%; /* é»˜è®¤ç”µé‡ */
        }

        /* --- ä¸»å±å¹•æ—¶é—´ --- */
        #main-clock {
            margin-top: 20px;
            font-size: 48px;
            font-weight: 300;
            color: var(--text-main);
            text-shadow: 0 2px 10px rgba(255,255,255,0.5);
            z-index: 1;
        }

        /* --- åº”ç”¨ç½‘æ ¼ --- */
        #app-grid {
            margin-top: 40px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 90%;
            z-index: 1;
        }

        .app-icon {
            width: 60px; height: 60px;
            background: white;
            border-radius: 18px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.95); }
        .app-img { width: 30px; height: 30px; margin-bottom: 4px; }
        .app-name { font-size: 10px; color: var(--text-main); margin-top: 5px;}

        /* --- API è®¾ç½®çª—å£ (æ¨¡æ€æ¡†) --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 200;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
        }
        .close-btn { font-size: 24px; cursor: pointer; padding: 10px; }
        
        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: bold; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            background: #F9F9F9;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            color: var(--text-main);
        }
        input:focus { border-color: var(--accent); background: white; }
        
        .btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:active { opacity: 0.8; }
        .btn-secondary { background-color: #E0E0E0; color: #666; margin-top: 0; width: auto; padding: 8px 15px;}

        /* éšè—çš„æ–‡ä»¶ä¸Šä¼ Input */
        .hidden-input { display: none; }
        
        /* --- Chat åº”ç”¨ç‰¹æœ‰æ ·å¼ --- */
        
        /* èŠå¤©åº”ç”¨çš„å®¹å™¨ä¿®æ­£ï¼Œè®©å®ƒé“ºæ»¡ä½†ç•™å‡ºçŠ¶æ€æ ä½ç½® */
        #chat-app {
    background-color: var(--bg-color);
    /* â–¼â–¼â–¼ æ–°å¢ï¼šèƒŒæ™¯å›¾å±æ€§ â–¼â–¼â–¼ */
    background-image: var(--chat-bg-img, none); /* é»˜è®¤æ—  */
    background-size: cover;
    background-position: center;
    background-attachment: fixed; /* è®©èƒŒæ™¯å›ºå®šä¸åŠ¨ï¼Œçœ‹èµ·æ¥æ›´é«˜çº§ */
    /* â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² */
    
    padding: 0;
    display: none;
    flex-direction: column;
    transition: background-color 0.3s;
}

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .chat-header-bar {
            height: 60px;
            padding-top: 30px; /* é¿å¼€çŠ¶æ€æ  */
            padding-left: 20px;
            padding-right: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: transparent;
            flex-shrink: 0;
        }
        .chat-title { font-size: 24px; font-weight: 800; color: #4A5A6E; }
        .chat-search-icon { color: #4A5A6E; }

        /* ä¸­é—´å†…å®¹æ»šåŠ¨åŒº */
        .chat-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
            padding-bottom: 80px; /* ç»™åº•éƒ¨å¯¼èˆªç•™ä½ç½® */
        }

        /* èŠå¤©åˆ—è¡¨å¡ç‰‡ (ä»¿å‚è€ƒå›¾) */
        .chat-item-card {
            background: white;
            border-radius: 24px; /* è¶…å¤§åœ†è§’ */
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(127, 166, 200, 0.08);
            transition: transform 0.1s;
            position: relative;
        }
        .chat-item-card:active { transform: scale(0.98); }
        
        .chat-avatar {
            width: 56px; height: 56px;
            border-radius: 18px; /* æ–¹å½¢åœ†è§’å¤´åƒ */
            background-color: #eee;
            background-size: cover;
            background-position: center;
            margin-right: 15px;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .chat-preview { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { font-size: 12px; color: #bbb; position: absolute; top: 18px; right: 20px; }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: absolute;
            bottom: 20px; left: 20px; right: 20px;
            height: 70px;
            background: white;
            border-radius: 35px;
            display: flex;
            justify-content: space-around; /* ç­‰è·åˆ†å¸ƒ */
            align-items: center;
            box-shadow: 0 10px 30px rgba(127, 166, 200, 0.15);
            z-index: 10;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #C0C8D3;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-label { font-size: 10px; margin-top: 4px; font-weight: bold;}

        /* --- æ–°ç‰ˆ API è®¾ç½®é¡µé¢ç¾åŒ– (ä»¿å‚è€ƒå›¾é£æ ¼) --- */
        
        /* è¦†ç›–åŸæœ¬çš„æ¨¡æ€æ¡†èƒŒæ™¯ï¼Œè®©å®ƒæ›´åƒä¸€ä¸ªAPPé¡µé¢ */
        #api-settings {
            background-color: #F7F9FC; /* ææµ…çš„ç°è“è‰²èƒŒæ™¯ */
            padding: 0;
        }

        /* é¡¶éƒ¨çš„å¯¼èˆªæ¡ */
        .api-header {
            background: white;
            padding: 20px;
            padding-top: 50px; /* é¿å¼€çŠ¶æ€æ  */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            z-index: 10;
        }
        .api-header h2 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        .api-back-btn {
            position: absolute;
            left: 20px;
            top: 50px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
        }

        /* è®¾ç½®å†…å®¹çš„æ»šåŠ¨å®¹å™¨ */
        .api-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ç™½è‰²å¤§å¡ç‰‡å®¹å™¨ */
        .settings-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(127, 166, 200, 0.08);
            margin-bottom: 20px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .setting-label {
            font-size: 15px;
            font-weight: 700;
            color: #444;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* è¾“å…¥æ¡†ç¾åŒ–ï¼šæµ…ç°è‰²åœ†è§’çŸ©å½¢ */
        .cute-input {
            width: 100%;
            background-color: #F5F7FA;
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 14px;
            color: #555;
            outline: none;
            transition: all 0.3s;
            box-sizing: border-box;
            font-family: inherit; /* ç»§æ‰¿å­—ä½“ */
        }
        .cute-input:focus {
            background-color: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(127, 166, 200, 0.2);
        }

        /* è¾…åŠ©è¯´æ˜æ–‡å­— */
        .helper-text {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.5;
        }

        /* æ¨¡å‹é€‰æ‹©åŒºåŸŸå¸ƒå±€ */
        .model-row {
            display: flex;
            gap: 10px;
        }
        .model-select-wrapper {
            flex: 1;
            position: relative;
        }
        /* è‡ªå®šä¹‰ä¸‹æ‹‰ç®­å¤´ */
        .model-select-wrapper::after {
            content: 'â–¼';
            font-size: 10px;
            color: #999;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* æŒ‰é’®ç¾åŒ– */
        .btn-refresh {
            background-color: white;
            border: 1px solid #E0E0E0;
            color: #666;
            border-radius: 12px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        .btn-refresh:active { background-color: #f0f0f0; }

        .btn-save {
            background: var(--accent);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            box-shadow: 0 8px 20px rgba(127, 166, 200, 0.3);
            cursor: pointer;
        }
        .btn-save:active { transform: scale(0.98); }

        /* æ¸©åº¦è¾“å…¥æ¡†ç‰¹æ®Šå¤„ç† */
        .temp-wrapper {
            display: flex;
            align-items: center;
            background: #F5F7FA;
            border-radius: 12px;
            padding: 5px 15px;
        }
        .temp-input-clean {
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
            width: 60px;
            text-align: center;
            outline: none;
        }
        
        /* --- è”ç³»äººåˆ—è¡¨æ ·å¼ --- */
        .contact-item {
            background: white;
            border-radius: 20px;
            padding: 12px 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            transition: transform 0.1s;
        }
        .contact-item:active { transform: scale(0.98); background-color: #fafafa; }
        
        .contact-avatar {
            width: 48px; height: 48px;
            border-radius: 16px;
            background-size: cover;
            background-position: center;
            margin-right: 15px;
            border: 1px solid #eee;
        }
        .contact-name { font-size: 15px; font-weight: bold; color: #333; }
        .contact-tag { 
            font-size: 10px; color: #7FA6C8; background: #E3F2FD; 
            padding: 2px 8px; border-radius: 10px; margin-left: 8px; 
        }

        /* --- é¡¶éƒ¨æŒ‡çº¹æŒ‰é’® --- */
        #add-contact-btn {
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰åˆ‡åˆ°è”ç³»äººtabæ‰æ˜¾ç¤º */
            cursor: pointer;
            color: #7FA6C8;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        #add-contact-btn:active { background: rgba(127, 166, 200, 0.1); }

        /* --- æ–°ç‰ˆåˆ›å»ºè§’è‰²é¡µé¢ (è¦†ç›–å±‚) --- */
        #create-role-page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F2F6FC;
            z-index: 85; /* åœ¨åº•éƒ¨å¯¼èˆªä¹‹ä¸Š */
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .create-header {
            padding: 20px; padding-top: 50px;
            display: flex; align-items: center;
            color: #333; font-size: 18px; font-weight: bold;
        }
        .back-icon { margin-right: 15px; cursor: pointer; }

        /* ç¾åŒ–åçš„è¡¨å•å¡ç‰‡ */
        .create-card {
            background: white;
            margin: 20px;
            border-radius: 30px;
            padding: 30px 20px;
            box-shadow: 0 10px 30px rgba(127, 166, 200, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* æ›´æœ‰å±‚æ¬¡æ„Ÿçš„å¤´åƒä¸Šä¼  */
        .avatar-uploader {
            width: 90px; height: 90px;
            border-radius: 30px;
            background: #F7F9FC;
            border: 2px dashed #DCE9F5;
            display: flex; justify-content: center; align-items: center;
            color: #A0B0C0; font-size: 12px;
            cursor: pointer;
            margin-bottom: 25px;
            background-size: cover; background-position: center;
            transition: all 0.3s;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
        }
        .avatar-uploader:active { transform: scale(0.95); border-color: var(--accent); }

        /* æ¸…çˆ½çš„è¾“å…¥è¡Œ */
        .input-row {
            width: 100%; margin-bottom: 20px;
        }
        .input-label {
            font-size: 12px; color: #8B9BB4; margin-bottom: 8px; margin-left: 5px; font-weight: bold;
        }
        .clean-input {
            width: 100%;
            background: #F7F9FC;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 14px;
            color: #333;
            outline: none;
            box-sizing: border-box;
            transition: background 0.2s;
        }
        .clean-input:focus { background: #fff; box-shadow: 0 0 0 2px #DCE9F5; }

        /* æ€§åˆ«é€‰æ‹©èƒ¶å›Š */
        .gender-capsule {
            display: flex; background: #F7F9FC; border-radius: 15px; padding: 4px;
        }
        .gender-opt {
            flex: 1; text-align: center; padding: 10px 0;
            font-size: 13px; color: #8B9BB4; border-radius: 12px; cursor: pointer; transition: 0.2s;
        }
        .gender-opt.active {
            background: white; color: var(--accent); font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .create-btn-float {
            margin-top: 10px;
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 18px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(127, 166, 200, 0.3);
            cursor: pointer;
        }
        
        /* --- 5. èŠå¤©å®¤é¡µé¢ (æ²‰æµ¸å¼) --- */
        #chat-room-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F9F9F9; /* é»˜è®¤æ›´ç™½çš„èƒŒæ™¯ */
            z-index: 60; /* æ¯”åˆ›å»ºé¡µæ›´é«˜ */
            display: none;
            flex-direction: column;
            background-size: cover;
            background-position: center;
        }

        /* èŠå¤©å®¤é¡¶éƒ¨ */
        .room-header {
            height: 50px;
            padding-top: 30px; /* é¿å¼€çŠ¶æ€æ  */
            padding-left: 15px; padding-right: 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.9); /* æ¯›ç»ç’ƒè¡¨å¤´ */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            z-index: 10;
        }
        .room-info { text-align: center; flex: 1; }
        .room-name { font-size: 16px; font-weight: bold; color: #333; }
        .room-status { font-size: 10px; color: var(--accent); height: 14px; opacity: 0; transition: opacity 0.3s; }
        .room-status.typing { opacity: 1; }

        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
        #message-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æ¶ˆæ¯è¡Œ */
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.left { justify-content: flex-start; }
        .msg-row.right { justify-content: flex-end; }

        /* æ°”æ³¡åŸºç¡€æ ·å¼ */
        .msg-bubble {
            max-width: 70%;
            padding: 10px 14px;
            font-size: var(--chat-font-size, 14px); /* åŠ¨æ€å­—ä½“å¤§å° */
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* æ°”æ³¡å½¢çŠ¶å˜ä½“ */
        .bubble-round { border-radius: 20px; } /* åœ†æ»šæ»š */
        .bubble-sharp { border-radius: 4px; }  /* ä»¿å¾®ä¿¡å°å°–è§’ (ç®€åŒ–ç‰ˆ) */
        .bubble-default { border-radius: 12px; } /* é»˜è®¤ */

        /* åº•éƒ¨è¾“å…¥æ  (ç²¾è‡´å°å·§) */
        /* --- â–¼â–¼â–¼ è¯·æ›¿æ¢æˆè¿™ä¸ª â–¼â–¼â–¼ --- */
.room-footer {
    background: white;
    padding: 8px 12px; /* ä¸Šä¸‹å·¦å³çš„è¾¹è·éƒ½æ”¹å°äº† */
    padding-bottom: 30px; /* é€‚é…å…¨é¢å±åº•éƒ¨ */
    display: flex; align-items: flex-end; gap: 8px; /* å…ƒç´ é—´è·ä¹Ÿæ”¹å° */
    box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
}
        
        /* --- â–¼â–¼â–¼ è¯·æ›¿æ¢æˆè¿™ä¸ª â–¼â–¼â–¼ --- */
.chat-input-box {
    flex: 1;
    background: #F2F2F2;
    border-radius: 18px; /* åœ†è§’æ”¹å°ä¸€ç‚¹ */
    padding: 8px 15px; /* ä¸Šä¸‹å†…è¾¹è·æ”¹å° */
    max-height: 100px;
    overflow-y: auto;
    font-size: 14px;
    border: none; outline: none;
    resize: none; /* ç¦æ­¢æ‹–æ‹½ */
}

        /* --- â–¼â–¼â–¼ è¯·æ›¿æ¢æˆè¿™ä¸ª â–¼â–¼â–¼ --- */
.action-btn {
    width: 36px; height: 36px; /* æŒ‰é’®æ•´ä½“å˜å° */
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer;
    transition: transform 0.1s;
    flex-shrink: 0;
}
        .action-btn:active { transform: scale(0.9); }
        
        /* æ¥æ”¶æŒ‰é’® (å·¦ä¾§) */
        .btn-receive { background: #F0F2F5; color: #5A6A7E; }
        /* å‘é€æŒ‰é’® (å³ä¾§) */
        .btn-send { background: var(--accent); color: var(--btn-text); }
      


        /* --- 6. èŠå¤©è®¾ç½®é¡µé¢ (ç‹¬ç«‹é¡µé¢) --- */
        #chat-settings-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F2F6FC;
            z-index: 70;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        .setting-section {
            background: white;
            margin: 15px 20px;
            border-radius: 16px;
            padding: 5px 0; /* å†…éƒ¨åˆ—è¡¨ */
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        
        .setting-item {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f5f5f5;
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-title { font-size: 14px; color: #333; font-weight: 500; }
        
        /* é¢œè‰²é€‰æ‹©å™¨åœ†ç‚¹ */
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #eee; cursor: pointer;
            display: inline-block;
        }
        
        /* å½¢çŠ¶é€‰æ‹©å™¨ */
        .shape-selector { display: flex; gap: 10px; }
        .shape-opt {
            width: 30px; height: 30px; background: #eee; cursor: pointer;
            border: 2px solid transparent;
        }
        .shape-opt.active { border-color: var(--accent); background: #DCE9F5; }
        
        /* --- â€œæˆ‘â€é¡µé¢çš„æ ·å¼ --- */
.me-section {
    background: white;
    border-radius: 20px;
    margin: 15px 0;
    padding: 5px 20px;
    box-shadow: 0 4px 15px rgba(127, 166, 200, 0.08);
}
.me-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
}
.me-item:last-child {
    border-bottom: none;
}
.me-item-title {
    font-size: 15px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 12px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
}
.me-item .arrow {
    color: #ccc;
}

    /* --- â€œæˆ‘â€çš„å­é¡µé¢é€šç”¨æ ·å¼ --- */
    .me-page {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: #F2F6FC;
        z-index: 80; /* æ¯”èŠå¤©å®¤é«˜ï¼Œä½†å¯ä»¥è¢«å…¶ä»–æ¨¡æ€æ¡†è¦†ç›– */
        display: none;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }
    .me-page-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    /* --- çºªå¿µæ—¥åˆ—è¡¨é¡¹æ ·å¼ --- */
    .anniversary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 5px;
        border-bottom: 1px solid #f5f5f5;
    }
     .anniversary-item:last-child { border-bottom: none; }
    .anniversary-info span { display: block; }
    .anniversary-info .name { font-size: 14px; font-weight: bold; color: #333; }
    .anniversary-info .date { font-size: 12px; color: #888; }
    
    .delete-btn {
        background: #FFEEEE; color: #F56C6C;
        border: none; border-radius: 50%;
        width: 30px; height: 30px;
        cursor: pointer;
        font-weight: bold;
    }
    
    /* --- é’±åŒ…è®°å½•æ ·å¼ --- */
    .bill-item {
        display: flex; justify-content: space-between; align-items: center;
        background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .bill-info { font-size: 14px; color: #333; }
    .bill-time { font-size: 12px; color: #999; margin-top: 4px; }
    .bill-amount { font-weight: bold; font-size: 16px; }
    .bill-amount.plus { color: #67C23A; } /* ç»¿è‰²åŠ é’± */
    .bill-amount.minus { color: #F56C6C; } /* çº¢è‰²æ‰£é’± */

    /* --- è¡¨æƒ…åŒ…æ ¼å­æ ·å¼ --- */
    .sticker-item {
        width: 100%; aspect-ratio: 1; /* æ­£æ–¹å½¢ */
        background-color: #fff;
        border-radius: 12px;
        background-size: cover; background-position: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        position: relative;
    }
    .sticker-delete {
        position: absolute; top: -5px; right: -5px;
        width: 20px; height: 20px; background: #ff4d4f; color: white;
        border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px;
    }
    
    /* --- èŠå¤©æ¶ˆæ¯é‡Œçš„å›¾ç‰‡æ ·å¼ (é‡è¦) --- */
    .msg-bubble img {
        max-width: 100%;
        border-radius: 8px;
        display: block;
    }
    
    /* --- æµ·é¾Ÿæ±¤æ ·å¼ --- */
    .soup-player-tag {
        padding: 8px 15px;
        background: rgba(0,0,0,0.3);
        border: 1px solid #555;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: 0.2s;
    }
    .soup-player-tag.selected {
        background: #E67E22;
        border-color: #E67E22;
        color: white;
        font-weight: bold;
    }
    
    /* æ¸¸æˆæ°”æ³¡ç¨å¾®ä¸åŒï¼ŒåŒºåˆ†äºæ™®é€šèŠå¤© */
    .soup-bubble {
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        max-width: 80%;
        line-height: 1.5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .soup-dm { background: #2C3E50; color: #E67E22; border: 1px solid #E67E22; align-self: flex-start; }
    .soup-user { background: #E67E22; color: white; align-self: flex-end; }
    .soup-teammate { background: #34495E; color: #AED6F1; align-self: flex-start; }
    
    /* --- èŠå¤©å®¤å¤´åƒä¸æ—¶é—´æˆ³æ ·å¼ --- */
    .msg-row {
        align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
    }
    
    /* å¤´åƒå®¹å™¨ (åŒ…å«å›¾ç‰‡å’Œæ—¶é—´) */
    .msg-avatar-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 8px;
        flex-shrink: 0;
    }
    
  /* --- ç¼©å°çš„èŠå¤©å¸ƒå±€ (80% size) - ä¿®å¤ç‰ˆ --- */
    
    /* 1. ä¿®å¤å¤´åƒæ˜¾ç¤º */
    .msg-avatar-img {
        width: 32px; height: 32px; /* ä¿æŒç¼©å° */
        border-radius: 10px;
        margin-bottom: 2px;
        
        /* æ ¸å¿ƒä¿®å¤ä»£ç ï¼šå¼ºåˆ¶å›¾ç‰‡å¡«æ»¡ */
        background-size: cover !important;
        background-position: center !important;
        background-color: #e0e0e0; /* ç°è‰²åº•è‰²ï¼Œé˜²å›¾ç‰‡åŠ è½½å¤±è´¥ */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .msg-timestamp {
        font-size: 9px;
        margin-top: 2px;
        transform: scale(0.85);
        opacity: 0.6;
    }

    /* 2. ä¿®å¤æ°”æ³¡åŸºç¡€æ ·å¼ */
    .msg-bubble {
        max-width: 75%;
        padding: 8px 12px;
        font-size: 13px !important;
        line-height: 1.4;
        /* æ³¨æ„ï¼šè¿™é‡Œåˆ æ‰äº† border-radiusï¼Œé˜²æ­¢è¦†ç›–ç”¨æˆ·çš„é€‰æ‹© */
    }

    /* 3. å¼ºåˆ¶ç”Ÿæ•ˆçš„æ°”æ³¡å½¢çŠ¶ (åŠ äº† !important) */
    .bubble-round { border-radius: 20px !important; }  /* åœ†æ»šæ»š */
    .bubble-sharp { border-radius: 2px !important; }   /* å°å°–è§’ */
    .bubble-default { border-radius: 10px !important; } /* é»˜è®¤ */

    /* è°ƒæ•´å·¦å³é—´è· */
    .msg-row.left .msg-bubble { margin-left: 6px; margin-top: 2px; }
    .msg-row.right .msg-bubble { margin-right: 6px; margin-top: 2px; }

    /* --- é€æ˜æ°”æ³¡æ¨¡å¼ (ç”¨äºå›¾ç‰‡/è½¬è´¦) --- */
    .bubble-transparent {
        background-color: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
        border: none !important;
    }
    .bubble-transparent img {
        display: block;
        border-radius: 8px;
        max-width: 140px !important; 
    }
    
    /* --- å¤šåŠŸèƒ½é¢æ¿æ ·å¼ --- */
    .panel-btn {
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer; font-size: 12px; color: #666;
    }
    
    /* --- åŠŸèƒ½é¢æ¿å›¾æ ‡ç¾åŒ– --- */
    .panel-btn .p-icon {
        width: 44px; height: 44px; 
        background: white;
        border-radius: 14px; 
        display: flex; justify-content: center; align-items: center;
        margin-bottom: 6px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        transition: transform 0.1s;
        color: #5A6A7E;
    }
    .panel-btn:nth-child(1) .p-icon { color: #FFC107; background: #FFFDF5; }
    .panel-btn:nth-child(2) .p-icon { color: #FA9D3B; background: #FFF8F0; }
    .panel-btn:nth-child(3) .p-icon { color: #F56C6C; background: #FFF5F5; }
    .panel-btn:nth-child(4) .p-icon { color: #409EFF; background: #F0F7FF; }
    
    /* --- æ–°ç‰ˆè½¬è´¦å¡ç‰‡æ ·å¼ --- */
    .transfer-card {
        background-color: #FA9D3B;
        width: 200px;
        border-radius: 12px;
        overflow: hidden;
        color: white;
        position: relative;
        box-shadow: 0 2px 8px rgba(250, 157, 59, 0.3);
    }
    .transfer-top {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .transfer-icon-circle {
        width: 36px; height: 36px;
        border-radius: 50%;
        border: 2px solid white;
        display: flex; justify-content: center; align-items: center;
    }
    .transfer-info { display: flex; flex-direction: column; }
    .transfer-amount { font-size: 15px; font-weight: bold; }
    .transfer-desc { font-size: 11px; opacity: 0.9; }
    .transfer-bottom {
        background-color: rgba(255,255,255,0.15);
        padding: 6px 12px;
        font-size: 10px;
        color: rgba(255,255,255,0.9);
    }
    
    /* --- ğŸµ éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ --- */
    
    /* æ’­æ”¾å™¨æ¨¡æ€æ¡† (å±…ä¸­æ‚¬æµ®) */
    #music-player-modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); /* æ·±è‰²æ²‰æµ¸èƒŒæ™¯ */
        backdrop-filter: blur(10px);
        z-index: 150;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        animation: fadeIn 0.3s ease;
    }

    /* é¡¶éƒ¨æ­ŒååŒº */
    .music-info-top {
        text-align: center;
        margin-bottom: 40px;
    }
    .music-title { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
    .music-artist { font-size: 14px; color: #aaa; }

    /* é»‘èƒ¶å”±ç‰‡åŒº */
    .vinyl-wrapper {
        width: 280px; height: 280px;
        border-radius: 50%;
        background: #1a1a1a;
        background-image: radial-gradient(circle, #111 30%, #333 31%, #111 32%, #333 60%, #111 61%);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex; justify-content: center; align-items: center;
        position: relative;
        border: 4px solid #333;
    }
    /* å”±ç‰‡å°é¢ */
    .vinyl-cover {
        width: 180px; height: 180px;
        border-radius: 50%;
        background-size: cover; background-position: center;
        border: 5px solid #111;
    }
    /* æ—‹è½¬åŠ¨ç”» */
    .rotating { animation: rotate 20s linear infinite; }
    .paused { animation-play-state: paused; }
    
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* æ’­æ”¾æ§åˆ¶æ  */
    .player-controls {
        margin-top: 50px;
        display: flex; align-items: center; gap: 30px;
    }
    .ctrl-btn {
        cursor: pointer; color: white; transition: transform 0.1s;
        display: flex; justify-content: center; align-items: center;
    }
    .ctrl-btn:active { transform: scale(0.9); color: var(--accent); }
    .ctrl-btn-big {
        width: 60px; height: 60px; border-radius: 50%;
        background: white; color: #333;
    }

    /* æ­Œå•åˆ—è¡¨æ¨¡æ€æ¡† */
    #music-list-modal {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60%;
        background: white;
        border-radius: 20px 20px 0 0;
        z-index: 160;
        display: none;
        flex-direction: column;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease;
    }
    .music-list-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f5f5f5;
        display: flex; justify-content: space-between; align-items: center;
    }
    .music-list-item.playing { color: var(--accent); font-weight: bold; }
    
    /* --- é•¿æŒ‰èœå•æ ·å¼ --- */
    #msg-context-menu {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 200;
        display: none;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s;
    }
    .menu-content {
        background: white;
        border-radius: 12px;
        width: 70%;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .menu-item {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #eee;
        font-size: 16px;
        color: #333;
        cursor: pointer;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:active { background: #f5f5f5; }
    .menu-item.danger { color: #ff4d4f; }

    /* --- æŸ¥çœ‹æ›´å¤šå†å²è®°å½•æŒ‰é’® --- */
    .load-more-btn {
        text-align: center;
        font-size: 12px;
        color: #7FA6C8;
        padding: 10px 0;
        cursor: pointer;
    }
    
    /* --- INS é£åŠ å·é¢æ¿æ ·å¼ --- */
    
    /* é¢æ¿å®¹å™¨ï¼šå¹³æ—¶è—åœ¨å±å¹•æœ€åº•ä¸‹ */
    #chat-action-panel {
        position: absolute; 
        bottom: 0; left: 0; right: 0;
        background: white;
        border-radius: 30px 30px 0 0; /* åªæœ‰ä¸Šé¢æ˜¯åœ†è§’ */
        box-shadow: 0 -10px 40px rgba(0,0,0,0.08); /* å”¯ç¾çš„å¤§é˜´å½± */
        padding: 25px 20px 40px 20px; /* å¢åŠ åº•éƒ¨ç•™ç™½ */
        z-index: 100;
        transform: translateY(110%); /* é»˜è®¤å‘ä¸‹è—èµ·æ¥ */
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* é¡ºæ»‘çš„åŠ¨ç”»æ›²çº¿ */
        display: block !important; /* å¼ºåˆ¶æ˜¾ç¤ºï¼Œé€šè¿‡ transform æ§åˆ¶å¼€å…³ */
    }

    /* æ¿€æ´»çŠ¶æ€ï¼šæ»‘ä¸Šæ¥ */
    #chat-action-panel.active {
        transform: translateY(0);
    }

    /* é¡¶éƒ¨çš„å°æ¨ªæ¡ (è£…é¥°ç”¨ï¼ŒåƒiPhoneåº•éƒ¨æŠ½å±‰) */
    .panel-handle {
        width: 40px; height: 5px;
        background: #E0E0E0;
        border-radius: 10px;
        margin: 0 auto 25px auto; /* å±…ä¸­ */
    }

    /* åŠŸèƒ½å›¾æ ‡ç½‘æ ¼ */
    .ins-grid {
        display: flex;
        justify-content: space-between;
        padding: 0 10px;
        margin-bottom: 20px;
    }

    /* å•ä¸ªå›¾æ ‡æŒ‰é’® */
    .ins-btn {
        display: flex; flex-direction: column; align-items: center;
        gap: 8px; cursor: pointer; transition: transform 0.1s;
    }
    .ins-btn:active { transform: scale(0.95); }

    /* å›¾æ ‡åœ†åœˆèƒŒæ™¯ */
    .ins-icon-circle {
        width: 56px; height: 56px;
        border-radius: 20px; /* æ–¹åœ†å½¢ */
        display: flex; justify-content: center; align-items: center;
        font-size: 24px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        color: white;
    }

    /* ä¸åŒåŠŸèƒ½çš„é¢œè‰² */
    .bg-yellow { background: linear-gradient(135deg, #FFD54F, #FFC107); box-shadow: 0 8px 20px rgba(255, 193, 7, 0.25); }
    .bg-green  { background: linear-gradient(135deg, #81C784, #66BB6A); box-shadow: 0 8px 20px rgba(102, 187, 106, 0.25); }
    .bg-pink   { background: linear-gradient(135deg, #FF8A65, #FF7043); box-shadow: 0 8px 20px rgba(255, 112, 67, 0.25); }
    .bg-blue   { background: linear-gradient(135deg, #64B5F6, #42A5F5); box-shadow: 0 8px 20px rgba(66, 165, 245, 0.25); }
    .bg-purple { background: linear-gradient(135deg, #BA68C8, #AB47BC); box-shadow: 0 8px 20px rgba(171, 71, 188, 0.25); }

    .ins-label { font-size: 12px; color: #666; font-weight: 500; }

    /* å†…å®¹å±•ç¤ºåŒº (è¡¨æƒ…åŒ…ç½‘æ ¼ç­‰) */
    #panel-content-area {
        background: #F7F9FC; /* æµ…ç°è‰²åº•ï¼ŒåŒºåˆ†å±‚æ¬¡ */
        border-radius: 20px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 10px;
        display: none; /* é»˜è®¤éšè—ï¼Œç‚¹å‡»å›¾æ ‡æ‰æ˜¾ç¤º */
    }
    
    /* --- ä¿¡æ¯å±•ç¤ºå¼¹çª— (å·çœ‹éšç§ä¸“ç”¨) --- */
    #info-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 300;
        display: none; justify-content: center; align-items: center;
        animation: fadeIn 0.3s;
    }
    .info-card {
        background: white; width: 80%; max-height: 70%;
        border-radius: 24px; padding: 25px;
        overflow-y: auto; position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: flex; flex-direction: column;
    }
    .info-header {
        font-size: 18px; font-weight: bold; margin-bottom: 15px;
        display: flex; align-items: center; gap: 10px; color: #333;
    }
    .info-content {
        font-size: 14px; line-height: 1.6; color: #555; white-space: pre-wrap;
    }
    /* åŠ è½½åŠ¨ç”» */
    .loading-dots::after {
        content: ' .'; animation: dots 1.5s infinite;
    }
    @keyframes dots { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }
    
    /* --- â–¼â–¼â–¼ ä¿®å¤ï¼š
      â–¼â–¼â–¼ --- */
        .msg-bubble {
            /* åŸæ¥æ˜¯ 70%-75%ï¼Œæ”¹æˆ 60% æˆ– 260px ä¼šæ›´ç²¾è‡´ */
            max-width: 60% !important; 
            
            /* é¡ºä¾¿åŠ ä¸ªæœ€å°å®½åº¦ï¼Œé˜²æ­¢åªæœ‰ä¸€ä¸ªâ€œå—¯â€å­—çš„æ—¶å€™æ°”æ³¡ç¼©æˆä¸€å›¢å¤ªéš¾çœ‹ */
            min-width: 20px; 
        }

        /* å¦‚æœè§‰å¾—ç”µè„‘ä¸Šè¿˜æ˜¯å¤ªå®½ï¼Œå¯ä»¥é™åˆ¶ä¸€ä¸ªæœ€å¤§åƒç´ å€¼ */
        @media (min-width: 768px) {
            .msg-bubble {
                max-width: 400px !important; /* ç”µè„‘ä¸Šæœ€å®½ä¸è¶…è¿‡ 400px */
            }
        }
        /* --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² --- */
        
        /* --- â–¼â–¼â–¼ æ–°å¢ï¼šç³»ç»Ÿæç¤ºæ°”æ³¡ (å±…ä¸­æ˜¾ç¤º) â–¼â–¼â–¼ --- */
        .msg-system-row {
            display: flex;
            justify-content: center;
            width: 100%;
            margin: 10px 0;
        }
        .msg-system-bubble {
            background-color: rgba(0, 0, 0, 0.05);
            color: #999;
            font-size: 11px;
            padding: 4px 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        /* æ”¶æ¬¾æˆåŠŸçš„é¢œè‰² (æ©™è‰²) */
        .msg-system-bubble.received { color: #FA9D3B; background-color: #FFF7E6; }
        /* é€€è¿˜çš„é¢œè‰² (çº¢è‰²) */
        .msg-system-bubble.returned { color: #F56C6C; background-color: #FEF0F0; }
        /* --- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² --- */

      /* --- å¤‡å¿˜å½•é¡µé¢ä¸“ç”¨æ ·å¼ --- */
#memo-page {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: #F5F7FA; /* æµ…ç°åº•è‰² */
    z-index: 100; /* ç¡®ä¿ç›–ä½èŠå¤©å®¤ */
    display: none;
    flex-direction: column;
    animation: slideUp 0.3s ease;
}

/* å¤‡å¿˜å½•åˆ—è¡¨å®¹å™¨ */
.memo-list-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    padding-bottom: 40px;
}

/* å•ä¸ªå¤‡å¿˜å½•å¡ç‰‡ï¼ˆç™½è‰² + é›¾éœ¾è“é˜´å½±ï¼‰ */
.memo-card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 25px;
    position: relative;
    /* æ ¸å¿ƒï¼šé›¾éœ¾è“é˜´å½± */
    box-shadow: 0 10px 25px rgba(127, 166, 200, 0.25); 
    border-left: 6px solid #7FA6C8; /* å·¦ä¾§è£…é¥°æ¡ */
    transition: transform 0.2s;
}

.memo-card:active {
    transform: scale(0.99);
}

/* å¡ç‰‡å¤´éƒ¨ï¼šæ—¥æœŸ */
.memo-header-date {
    font-size: 18px;
    font-weight: bold;
    color: #5A6A7E;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #E0E6ED;
    padding-bottom: 10px;
}

/* å…·ä½“çš„æ¯ä¸€æ¡å¾…åŠ */
.memo-item-row {
    font-size: 14px;
    color: #555;
    line-height: 1.8;
    margin-bottom: 8px;
    display: flex;
    align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
}

/* é€‰ä¸­æ¡†æ ·å¼ï¼ˆè£…é¥°ç”¨ï¼‰ */
.memo-checkbox {
    width: 16px; height: 16px;
    border: 2px solid #B0C4DE;
    border-radius: 5px;
    margin-right: 10px;
    margin-top: 4px; /* å¾®è°ƒä½ç½® */
    flex-shrink: 0;
}

/* ç”ŸæˆæŒ‰é’®æ‚¬æµ®åœ¨å³ä¸‹è§’ */
.fab-btn {
    position: absolute;
    bottom: 30px; right: 20px;
    width: 56px; height: 56px;
    background: linear-gradient(135deg, #7FA6C8, #6C8DAF);
    border-radius: 50%;
    box-shadow: 0 8px 20px rgba(127, 166, 200, 0.4);
    display: flex; justify-content: center; align-items: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: transform 0.2s;
}
.fab-btn:active { transform: scale(0.9); }

/* åŠ è½½åŠ¨ç”» */
.memo-loading {
    text-align: center; color: #7FA6C8; padding: 20px; font-size: 13px; display: none;
}

      /* --- è¶³è¿¹é¡µé¢ä¸“ç”¨æ ·å¼ (çº¯ç™½æç®€é£) --- */
#footprint-page {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: #FFFFFF; /* çº¯ç™½èƒŒæ™¯ */
    z-index: 100;
    display: none;
    flex-direction: column;
    animation: slideUp 0.3s ease;
}

/* æ»šåŠ¨åŒºåŸŸ */
.footprint-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px 30px; /* å·¦å³ç•™å®½ä¸€ç‚¹ç»™æ—¶é—´è½´ */
    position: relative;
}

/* å·¦ä¾§è´¯ç©¿çš„ç°è‰²çº¿æ¡ */
.footprint-line-bg {
    position: absolute;
    top: 20px; bottom: 0; left: 40px; /* çº¿æ¡ä½ç½® */
    width: 2px;
    background-color: #F0F0F0;
    z-index: 0;
}

/* å•ä¸ªè¶³è¿¹èŠ‚ç‚¹ */
.fp-item {
    position: relative;
    margin-bottom: 30px;
    padding-left: 30px; /* ç»™å·¦è¾¹çš„åœ†ç‚¹ç•™ä½ç½® */
    z-index: 1; /* åœ¨çº¿æ¡ä¹‹ä¸Š */
}

/* æ—¶é—´è½´ä¸Šçš„åœ†ç‚¹ */
.fp-dot {
    position: absolute;
    left: 5px; top: 5px; /* è°ƒæ•´åœ†ç‚¹ä½ç½®å¯¹é½æ—¶é—´ */
    width: 12px; height: 12px;
    border-radius: 50%;
    background: white;
    border: 3px solid #DCE9F5; /* æµ…è“åœˆ */
    box-shadow: 0 0 0 2px white; /*ä»¥æ­¤é®æŒ¡çº¿æ¡*/
}
.fp-dot.latest {
    border-color: #7FA6C8; /* æœ€æ–°çš„ç‚¹é¢œè‰²æ·±ä¸€ç‚¹ */
    background: #7FA6C8;
}

/* æ—¶é—´æ–‡æœ¬ */
.fp-time {
    font-size: 12px;
    font-weight: bold;
    color: #999;
    margin-bottom: 4px;
    font-family: monospace; /* ç­‰å®½å­—ä½“æ˜¾ç¤ºæ—¶é—´æ›´æœ‰æ„Ÿè§‰ */
}

/* è¡Œä¸ºä¸åœ°ç‚¹ */
.fp-main-content {
    font-size: 15px;
    color: #333;
    font-weight: bold;
    margin-bottom: 8px;
}

/* æµ…è“è‰²éšç¬”æ°”æ³¡ */
.fp-note {
    background-color: #E3F2FD; /* æµ…è“èƒŒæ™¯ */
    color: #5A6A7E;
    font-size: 13px;
    padding: 10px 14px;
    border-radius: 0 12px 12px 12px; /*å“ªæ€•æ˜¯æ°”æ³¡ä¹Ÿåšä¸€ä¸ªå°é€ å‹*/
    line-height: 1.5;
    position: relative;
    display: inline-block;
    max-width: 100%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
}
.fp-note::before {
    content: 'ğŸ“';
    font-size: 10px;
    margin-right: 4px;
}

/* åº•éƒ¨åŠ å·æŒ‰é’® (å¤ç”¨ä¹‹å‰çš„æ ·å¼ï¼Œå¾®è°ƒé¢œè‰²) */
.fp-fab {
    position: absolute;
    bottom: 30px; right: 20px;
    width: 50px; height: 50px;
    background: white;
    border: 1px solid #E0E0E0;
    border-radius: 50%;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    display: flex; justify-content: center; align-items: center;
    color: #5A6A7E;
    font-size: 24px;
    cursor: pointer;
    z-index: 10;
}
.fp-fab:active { background: #f9f9f9; transform: scale(0.95); }

      /* --- ç¢ç¢å¿µ (ç¬”è®°) é¡µé¢æ ·å¼ --- */
#note-page {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background-color: #F7F9FC; /* ææµ…çš„è“ç°åº•è‰² */
    z-index: 110; /* æ¯”å…¶ä»–é¡µé¢ç¨å¾®é«˜ä¸€ç‚¹ */
    display: none;
    flex-direction: column;
    animation: fadeIn 0.3s ease;
}

/* ç¬”è®°æ»šåŠ¨åŒº */
.note-container {
    flex: 1;
    overflow-y: auto;
    padding: 25px;
    display: flex;
    flex-direction: column;
    gap: 20px; /* å¡ç‰‡ä¹‹é—´çš„é—´è· */
}

/* å¯çˆ±çš„ç™½è‰²å¡ç‰‡ */
.note-card {
    background: white;
    border-radius: 24px; /* å¤§åœ†è§’ï¼Œçœ‹èµ·æ¥æ›´è½¯èŒ */
    padding: 25px;
    position: relative;
    /* æ ¸å¿ƒï¼šæœ‰å±‚æ¬¡æ„Ÿçš„é›¾éœ¾è“é˜´å½± */
    box-shadow: 0 8px 25px rgba(127, 166, 200, 0.15); 
    border: 1px solid rgba(255, 255, 255, 0.8); /* å¾®å¦™çš„è¾¹æ¡† */
    transition: transform 0.2s;
}

/* è£…é¥°ï¼šå·¨å¤§çš„å¼•å·èƒŒæ™¯ */
.note-card::before {
    content: 'â€œ';
    position: absolute;
    top: -10px; left: 15px;
    font-size: 80px;
    color: #F0F5FA; /* éå¸¸æ·¡çš„è“è‰²è£…é¥° */
    font-family: serif;
    z-index: 0;
    pointer-events: none;
}

/* æ–‡å­—å†…å®¹ */
.note-content {
    position: relative;
    z-index: 1;
    font-size: 15px;
    color: #5A6A7E;
    line-height: 1.6;
    font-weight: 500;
}

/* åº•éƒ¨çš„å°æ ‡ç­¾ (æ—¶é—´æˆ–å¿ƒæƒ…) */
.note-footer {
    margin-top: 15px;
    font-size: 12px;
    color: #B0C4DE;
    text-align: right;
    position: relative;
    z-index: 1;
}

/* åˆ·æ–°æŒ‰é’® (æ‚¬æµ®) */
.note-refresh-btn {
    position: absolute;
    bottom: 40px; right: 30px;
    width: 50px; height: 50px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 5px 15px rgba(127, 166, 200, 0.3);
    display: flex; justify-content: center; align-items: center;
    font-size: 24px;
    cursor: pointer;
    color: #7FA6C8;
    transition: transform 0.5s ease;
    z-index: 10;
}
.note-refresh-btn:active { transform: rotate(180deg); }

      /* --- æœ‹å‹åœˆ (Moments) é¡µé¢æ ·å¼ --- */
#tab-moments {
    display: none; 
    background-color: #ffffff;
    flex: 1; /* æ”¹æˆè¿™ä¸ªï¼Œé…åˆJSçš„éšè—å¤´éƒ¨ï¼Œèƒ½å®Œç¾é“ºæ»¡ */
    height: 100%;
    overflow-y: auto; 
    position: relative;
    padding-top: 0 !important; /* å¼ºåˆ¶å»æ‰é¡¶éƒ¨å†…è¾¹è· */
}

/* 1. é¡¶éƒ¨å°é¢åŒºåŸŸ */
.moments-header {
    position: relative;
    height: 260px;
    background-color: #eee;
    margin-bottom: 40px; /* ç»™å¤´åƒç•™å‡ºä½ç½® */
}
.moments-cover {
    width: 100%; height: 100%;
    background-size: cover; background-position: center;
    cursor: pointer;
}

/* 2. ä¸ªäººå¤´åƒä¸åå­— (æ‚¬æµ®åœ¨å°é¢å³ä¸‹è§’) */
.moments-user-info {
    position: absolute;
    bottom: -30px; right: 20px;
    display: flex; align-items: flex-end;
    gap: 15px;
}
.moments-my-name {
    color: white; font-weight: bold; font-size: 18px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    margin-bottom: 15px;
}
.moments-my-avatar {
    width: 70px; height: 70px;
    border-radius: 12px;
    background-size: cover; background-position: center;
    border: 3px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    cursor: pointer;
}

/* 3. å¸–å­åˆ—è¡¨å®¹å™¨ */
.moments-list {
    padding: 20px;
    padding-bottom: 80px; /* é¿å¼€åº•éƒ¨å¯¼èˆª */
}

/* 4. å•ä¸ªå¸–å­å¡ç‰‡ */
.moment-item {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    border-bottom: 1px solid #f5f5f5;
    padding-bottom: 20px;
}
.moment-avatar {
    width: 42px; height: 42px;
    border-radius: 8px;
    background-size: cover; background-position: center;
    flex-shrink: 0;
}

.moment-content-box {
    flex: 1;
}
.moment-name {
    color: #576B95; /* å¾®ä¿¡è“ */
    font-weight: bold; font-size: 15px;
    margin-bottom: 6px;
}
.moment-text {
    font-size: 15px; color: #333; line-height: 1.5;
    margin-bottom: 10px;
}

/* é…å›¾ç½‘æ ¼ */
.moment-imgs {
    display: flex; gap: 5px; flex-wrap: wrap;
    margin-bottom: 10px;
}
.moment-img {
    width: 90px; height: 90px;
    background-size: cover; background-position: center;
    border-radius: 4px;
    cursor: zoom-in;
}
.moment-img.single { /* å•å›¾æ˜¾ç¤ºå¤§ä¸€ç‚¹ */
    width: 160px; height: auto; aspect-ratio: 4/3;
}

/* æ—¶é—´ä¸æ“ä½œæ  */
.moment-meta {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 12px; color: #999; margin-bottom: 10px;
}
.moment-action-btn {
    background: #F7F7F7; padding: 4px 8px; border-radius: 4px;
    color: #576B95; cursor: pointer;
}

/* 5. ç‚¹èµä¸è¯„è®ºåŒº (ç°è‰²æ°”æ³¡) */
.moment-comments-area {
    background-color: #F7F7F7;
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 13px;
    position: relative;
    margin-top: 8px;
}
/* å°ä¸‰è§’ç®­å¤´ */
.moment-comments-area::before {
    content: ''; position: absolute; top: -6px; left: 15px;
    width: 0; height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-bottom: 6px solid #F7F7F7;
}

.moment-likes {
    color: #576B95;
    border-bottom: 1px solid #eee;
    padding-bottom: 5px; margin-bottom: 5px;
    display: flex; align-items: center; gap: 5px;
}
.moment-likes::before { content: 'â™¡'; font-size: 14px; }

.comment-row {
    margin-bottom: 3px; line-height: 1.4; color: #333;
}
.comment-user { color: #576B95; font-weight: 500; cursor: pointer; }

/* 6. å‘å¸ƒæŒ‰é’® (å³ä¸Šè§’ç›¸æœº) */
.moments-camera-btn {
    position: absolute;
    top: 20px;  /* âœ… è¿™é‡Œæ”¹æˆäº†æ­£æ•°ï¼Œè®©å®ƒä¹–ä¹–å‘†åœ¨å°é¢å›¾å³ä¸Šè§’ */
    right: 20px;
    color: white;
    z-index: 20; /* ç¨å¾®è°ƒé«˜å±‚çº§ï¼Œé˜²æ­¢è¢«é®æŒ¡ */
    cursor: pointer;
    font-size: 24px; /* ç¨å¾®æ”¾å¤§ä¸€ç‚¹ï¼Œæ›´å®¹æ˜“ç‚¹åˆ° */
    background: rgba(0,0,0,0.2); /* åŠ ä¸ªåŠé€æ˜å°åœ†åº•ï¼Œé˜²èƒŒæ™¯å¤ªç™½çœ‹ä¸æ¸… */
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: transform 0.1s;
}

.moments-camera-btn:active {
    transform: scale(0.9); /* ç‚¹å‡»æ—¶æœ‰ä¸ªç¼©å°çš„åŠ¨æ•ˆ */
}

/* å‘å¸ƒå¼¹çª— */
#post-moment-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: white; z-index: 200; display: none; flex-direction: column;
    animation: slideUp 0.2s ease;
}

      /* --- å¼ºåˆ¶è¦†ç›–æ‰€æœ‰å¡ç‰‡èƒŒæ™¯ä¸ºå˜é‡ --- */
.chat-item-card, 
.contact-item, 
.me-section, 
.settings-card, 
.create-card,
.bill-item,
.memo-card,
.note-card {
    background: var(--card-bg) !important; /* ä½¿ç”¨å˜é‡ï¼Œæ”¯æŒé€æ˜ */
}

/* === ä¸–ç•Œä¹¦ä¸“ç”¨æ ·å¼ === */

/* åˆ—è¡¨æ¡ç›®å¡ç‰‡ */
.wb-item-card {
    background: white;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 4px 12px rgba(127, 166, 200, 0.1);
    position: relative;
    border-left: 4px solid var(--accent); /* å·¦ä¾§åŠ ä¸ªè‰²æ¡è£…é¥° */
    transition: transform 0.1s;
}
.wb-item-card:active { transform: scale(0.99); }

.wb-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 8px;
}
.wb-tag {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    background: #F0F8FF;
    color: var(--accent);
    font-weight: bold;
}
.wb-role-tag {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 10px;
    background: #FFF3E0;
    color: #FF9800;
    margin-left: 5px;
}

.wb-preview {
    font-size: 13px;
    color: #555;
    line-height: 1.5;
    /* é™åˆ¶æ˜¾ç¤º3è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* ç¼–è¾‘å¼¹çª—çš„å¤§æ–‡æœ¬æ¡† */
.wb-textarea {
    width: 100%;
    background: #F9F9F9;
    border: 1px solid #EEE;
    border-radius: 12px;
    padding: 15px;
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    box-sizing: border-box;
    resize: none; /* ç¦æ­¢æ‹–æ‹½å¤§å° */
    outline: none;
    height: 200px; /* å›ºå®šé«˜åº¦ */
    transition: border 0.2s;
}
.wb-textarea:focus { border-color: var(--accent); background: white; }

/* ä¼˜åŒ–æ–‡å­—æ’ç‰ˆï¼Œé˜²æ­¢è´´è¾¹ */
.message-bubble .content {
    padding: 12px 16px; /* å¢åŠ å†…è¾¹è· */
    line-height: 1.6;   /* å¢åŠ è¡Œé«˜ */
    font-size: 14px;    /* è°ƒæ•´å­—å· */
    border-radius: 12px; /* ç¨å¾®åœ†æ¶¦ä¸€ç‚¹ */
    min-height: 20px;   /* é˜²æ­¢åªæœ‰ä¸€ä¸ªå­—æ—¶å¤ªæ‰ */
    word-wrap: break-word; /* é˜²æ­¢é•¿è‹±æ–‡æ’‘ç ´ */
}

/* é˜²æ­¢é£é“ƒæŒ¡ä½ç‚¹å‡»æ“ä½œ */
.message-bubble::before,
.message-bubble::after,
.message-bubble .content::before,
.message-bubble .content::after {
    pointer-events: none; /* è®©é¼ æ ‡å¯ä»¥ç©¿é€è£…é¥°å“ç‚¹å‡»æ–‡å­— */
}

/* ==============================================
   â˜… é»˜è®¤æ°”æ³¡çš®è‚¤ (æ¢å¤åŸºç¡€åŠŸèƒ½) â˜…
   ============================================== */

/* é»˜è®¤é¢œè‰² */
.msg-bubble.ai { background-color: #FFFFFF; color: #333; }
.msg-bubble.user { background-color: #FFE6E6; color: #333; }

/* å½¢çŠ¶åˆ‡æ¢ */
.bubble-default { border-radius: 12px; }
.bubble-round { border-radius: 20px; }
.bubble-sharp { border-radius: 4px; }

/* å›¾ç‰‡å’Œå¡ç‰‡çš„ç‰¹æ®Šæ ·å¼ */
.bubble-transparent { background: none !important; box-shadow: none !important; padding: 0 !important; }

      /* === æ‹ç«‹å¾—ç›¸å†Œä¸“ç”¨æ ·å¼ === */
.polaroid-grid {
    padding: 20px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* ä¸€è¡Œä¸¤å¼  */
    gap: 20px;
    padding-bottom: 50px;
}

.polaroid-card {
    background: white;
    padding: 10px 10px 30px 10px; /* åº•éƒ¨ç•™ç™½ç»™å†™å­— */
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    position: relative;
    /* ç¨å¾®åŠ ä¸€ç‚¹éšæœºæ—‹è½¬ï¼ŒåƒçœŸçš„ç…§ç‰‡ */
    transform: rotate(-1deg); 
}

/* å¶æ•°å¼ å¾€å³æ­ªä¸€ç‚¹ï¼Œå¥‡æ•°å¼ å¾€å·¦æ­ªä¸€ç‚¹ */
.polaroid-card:nth-child(even) { transform: rotate(1deg); margin-top: 15px; }
.polaroid-card:nth-child(odd) { transform: rotate(-2deg); }

.polaroid-img-area {
    background: #F0F2F5; /* ç°è‰²åº•æ¨¡æ‹Ÿç…§ç‰‡åŒº */
    color: #5A6A7E;
    font-size: 12px;
    padding: 15px;
    height: 120px; /* å›ºå®šé«˜åº¦ */
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: justify;
    line-height: 1.5;
    overflow: hidden;
    position: relative;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05); /* å†…é˜´å½± */
}

/* è£…é¥°ï¼šç…§ç‰‡ä¸Šçš„å°å¤¹å­ */
.polaroid-card::before {
    content: '';
    position: absolute;
    top: -10px; left: 50%; transform: translateX(-50%);
    width: 15px; height: 30px;
    background: rgba(0,0,0,0.1); /* æ¨¡æ‹Ÿèƒ¶å¸¦æˆ–å¤¹å­ */
    z-index: 1;
}

.polaroid-note {
    margin-top: 15px;
    font-family: cursive, "Comic Sans MS", sans-serif; /* å°½é‡ç”¨æ‰‹å†™ä½“ */
    font-size: 13px;
    color: #333;
    line-height: 1.4;
    text-align: center;
    font-weight: bold;
}

/* åˆ·æ–°æŒ‰é’®æ‚¬æµ® */
.album-refresh-btn {
    position: fixed;
    bottom: 30px; right: 20px;
    background: var(--accent);
    color: white;
    width: 50px; height: 50px;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    font-size: 24px;
    cursor: pointer;
    z-index: 100;
}
    </style>
</head>
  
<body>

    <!-- èƒŒæ™¯å£çº¸å±‚ (ç‚¹å‡»æ›´æ¢) -->
    <div id="wallpaper-layer" onclick="document.getElementById('bg-upload').click()" title="ç‚¹å‡»æ›´æ¢å£çº¸"></div>
    <input type="file" id="bg-upload" class="hidden-input" accept="image/*">

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div id="status-bar">
        <span id="status-time">00:00</span>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span id="battery-percent">--%</span>
            <div class="battery-icon">
                <div class="battery-level" id="battery-fill"></div>
            </div>
        </div>
    </div>

    <!-- å¤´åƒåŒºåŸŸ (ç‚¹å‡»æ›´æ¢) -->
    <div id="avatar-box" onclick="document.getElementById('avatar-upload').click()">
        <span>ç‚¹æ­¤ä¸Šä¼ </span>
    </div>
    <input type="file" id="avatar-upload" class="hidden-input" accept="image/*">

    <!-- ä¸»å±å¹•æ—¶é—´ -->
    <div id="main-clock">00:00</div>

    <!-- åº”ç”¨å›¾æ ‡åŒºåŸŸ -->
    <div id="app-grid">
        <!-- API è®¾ç½®åº”ç”¨å›¾æ ‡ -->
<div class="app-icon" id="icon-api" onclick="openApp('api-settings')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <div class="app-name">APIè®¾ç½®</div>
        </div>
        
        <!-- Chat åº”ç”¨å›¾æ ‡ -->
        <div class="app-icon" id="icon-chat" onclick="openChatApp()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
            <div class="app-name">Chat</div>
        </div>
<!-- â–¼â–¼â–¼ æ–°å¢ï¼šç¾åŒ–åº”ç”¨å…¥å£ â–¼â–¼â–¼ -->
    <div class="app-icon" id="icon-theme" onclick="openApp('beautify-app')">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>
        <div class="app-name">ç¾åŒ–</div>
    </div>
      
    </div>

  <!-- === ç¾åŒ–åº”ç”¨ç•Œé¢ === -->
<div id="beautify-app" class="modal">
    <div class="api-header">
        <div class="api-back-btn" onclick="closeApp('beautify-app')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </div>
        <h2>ä¸ªæ€§åŒ–è®¾ç½®</h2>
    </div>

    <div class="api-content-scroll">
        
        <!-- 1. ä¸»é¢˜è‰²é€‰æ‹© -->
        <div class="settings-card">
            <div class="setting-label">ç•Œé¢ä¸»é¢˜è‰²</div>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <div onclick="applyTheme('blue')" style="flex:1; height:60px; background:#DCE9F5; border:3px solid #7FA6C8; border-radius:12px; cursor:pointer; display:flex; justify-content:center; align-items:center; font-size:12px; color:#5A6A7E;">é›¾éœ¾è“</div>
                <div onclick="applyTheme('pink')" style="flex:1; height:60px; background:#FDE2E4; border:3px solid #FFB7B2; border-radius:12px; cursor:pointer; display:flex; justify-content:center; align-items:center; font-size:12px; color:#D88;">å¯çˆ±ç²‰</div>
                <div onclick="applyTheme('green')" style="flex:1; height:60px; background:#E2F0CB; border:3px solid #88D8B0; border-radius:12px; cursor:pointer; display:flex; justify-content:center; align-items:center; font-size:12px; color:#689F38;">æ¸…æ–°ç»¿</div>
            </div>
        </div>

        <!-- 2. å£çº¸ä¸å¤´åƒ -->
        <div class="settings-card">
            <div class="setting-label">ğŸ–¼ï¸ å£çº¸ä¸å¤´åƒ</div>
            
            <div class="input-row" style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px;">ä¸»å±å¹•å£çº¸</span>
                <div style="display:flex; gap:10px;">
                     <button class="btn-secondary" onclick="document.getElementById('bg-upload-input').click()">æ›´æ¢</button>
                     <button class="btn-secondary" onclick="resetWallpaper()" style="color:#F56C6C;">æ¸…é™¤</button>
                </div>
                <input type="file" id="bg-upload-input" class="hidden-input" accept="image/*" onchange="handleThemeUpload(this, 'wallpaper')">
            </div>

            <div class="input-row" style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px;">ä¸»å±å¹•å¤´åƒ</span>
                <button class="btn-secondary" onclick="document.getElementById('avatar-upload-input').click()">æ›´æ¢</button>
                <input type="file" id="avatar-upload-input" class="hidden-input" accept="image/*" onchange="handleThemeUpload(this, 'avatar')">
            </div>
        </div>

        <!-- 3. åº”ç”¨å›¾æ ‡æ›´æ¢ -->
        <div class="settings-card">
            <div class="setting-label">æ›´æ¢åº”ç”¨å›¾æ ‡</div>
            
            <!-- API è®¾ç½®å›¾æ ‡ -->
            <div class="input-row" style="margin-top:10px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="preview-icon-api" style="width:30px; height:30px; background:#eee; border-radius:8px; background-size:cover;"></div>
                    <span style="font-size:14px;">API è®¾ç½®</span>
                </div>
                <button class="btn-secondary" onclick="document.getElementById('upload-icon-api').click()">æ›´æ¢</button>
                <input type="file" id="upload-icon-api" class="hidden-input" accept="image/*" onchange="handleThemeUpload(this, 'icon-api')">
            </div>

            <!-- Chat å›¾æ ‡ -->
            <div class="input-row" style="margin-top:10px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="preview-icon-chat" style="width:30px; height:30px; background:#eee; border-radius:8px; background-size:cover;"></div>
                    <span style="font-size:14px;">Chat</span>
                </div>
                <button class="btn-secondary" onclick="document.getElementById('upload-icon-chat').click()">æ›´æ¢</button>
                <input type="file" id="upload-icon-chat" class="hidden-input" accept="image/*" onchange="handleThemeUpload(this, 'icon-chat')">
            </div>

            <!-- ç¾åŒ– å›¾æ ‡ -->
            <div class="input-row" style="margin-top:10px; display:flex; align-items:center; justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div id="preview-icon-theme" style="width:30px; height:30px; background:#eee; border-radius:8px; background-size:cover;"></div>
                    <span style="font-size:14px;">ç¾åŒ–</span>
                </div>
                <button class="btn-secondary" onclick="document.getElementById('upload-icon-theme').click()">æ›´æ¢</button>
                <input type="file" id="upload-icon-theme" class="hidden-input" accept="image/*" onchange="handleThemeUpload(this, 'icon-theme')">
            </div>
        </div>

      <!-- 4. Chatåº”ç”¨ ä¸“å±ç¾åŒ– (æ’å…¥åˆ°è¿™é‡Œ) -->
<div class="settings-card">
    <div class="setting-label">Chat åº”ç”¨ä¸“å±ç¾åŒ–</div>
    
    <!-- è®¾ç½®èƒŒæ™¯å›¾ -->
    <div class="input-row" style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-size:14px;">åˆ—è¡¨é¡µèƒŒæ™¯å›¾</span>
        <div style="display:flex; gap:10px;">
                <button class="btn-secondary" onclick="document.getElementById('chat-list-bg-input').click()">æ›´æ¢</button>
                <button class="btn-secondary" onclick="resetChatAppBg()" style="color:#F56C6C;">æ¸…é™¤</button>
        </div>
        <input type="file" id="chat-list-bg-input" class="hidden-input" accept="image/*" onchange="handleThemeUpload(this, 'chatAppBg')">
    </div>

    <!-- è®¾ç½®å¡ç‰‡é€æ˜åº¦ -->
    <div style="margin-top: 20px;">
        <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:10px;">
            <span>å¡ç‰‡é€æ˜åº¦</span>
            <span id="opacity-val">100%</span>
        </div>
        <!-- æ»‘å—ï¼šä» 0 (å…¨é€) åˆ° 1 (ä¸é€) -->
        <input type="range" min="0" max="1" step="0.05" value="1" 
               style="width:100%; accent-color: var(--accent);"
               oninput="changeCardOpacity(this.value)">
    </div>
</div>

<!-- 5. å…¨å±€å­—ä½“è®¾ç½® (æ–°åŠŸèƒ½) -->
        <div class="settings-card">
            <div class="setting-label">æ›´æ¢å…¨å±€å­—ä½“</div>
            <div class="helper-text" style="margin-top:0; margin-bottom:15px;">
                è¯·è¾“å…¥ .ttf / .otf / .woff2 ç­‰å­—ä½“æ–‡ä»¶çš„ç›´é“¾åœ°å€ã€‚æ³¨æ„ï¼šé“¾æ¥æœåŠ¡å™¨éœ€å…è®¸è·¨åŸŸè®¿é—®(CORS)ã€‚
            </div>
            
            <div class="input-row" style="display:flex; gap:10px;">
                <input type="text" id="font-url-input" class="cute-input" placeholder="https://.../your_font.ttf">
                <button class="btn-secondary" onclick="handleApplyFontClick()">åº”ç”¨</button>
                <button class="btn-secondary" onclick="clearCustomFont()" style="color:#F56C6C;">æ¸…é™¤</button>
            </div>
        </div>

      <!-- â–¼â–¼â–¼ æ–°å¢ï¼šæ‰‹åŠ¨å¤‡ä»½åŒºåŸŸ â–¼â–¼â–¼ -->
<div class="settings-card" style="border: 1px solid #7FA6C8;">
    <div class="setting-label">ğŸ’¾ å­˜æ¡£ç®¡ç† (é˜²ä¸¢å¤±ç¥å™¨)</div>
    <div class="helper-text" style="margin-top:0; margin-bottom:15px;">
        å¦‚æœæµè§ˆå™¨æ¸…ç©ºäº†ç¼“å­˜ï¼Œæ‰€æœ‰æ•°æ®éƒ½ä¼šæ¶ˆå¤±ï¼<br>
        å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½æ–‡ä»¶åˆ°æ‰‹æœº/ç”µè„‘é‡Œã€‚
    </div>
    
    <div style="display:flex; gap:10px;">
        <button class="btn" style="background:#67C23A;" onclick="exportDataToFile()">å¯¼å‡ºå­˜æ¡£æ–‡ä»¶</button>
        <button class="btn" style="background:#E6A23C;" onclick="document.getElementById('backup-import').click()">å¯¼å…¥å­˜æ¡£è¦†ç›–</button>
        <input type="file" id="backup-import" class="hidden-input" accept=".json" onchange="importDataFromFile(this.files[0])">
    </div>
</div>
<!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

        <button class="btn-save" onclick="saveThemeConfig()">ä¿å­˜æ‰€æœ‰è®¾ç½®</button>
        <div style="height: 50px;"></div>
    </div>
</div>

    <!-- === API è®¾ç½®åº”ç”¨ç•Œé¢ (æ–°ç‰ˆ UI) === -->
    <div id="api-settings" class="modal">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeApp('api-settings')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>API è®¾ç½®</h2>
        </div>

        <div class="api-content-scroll">
            <div class="settings-card">
                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        API åœ°å€ (Base URL)
                    </div>
                    <input type="text" id="api-url" class="cute-input" placeholder="https://api.openai.com/v1">
                    <div class="helper-text">æ”¯æŒ OpenAI æ ¼å¼æ¥å£ã€‚å¦‚ä½¿ç”¨ç¬¬ä¸‰æ–¹ä»£ç†ï¼Œè¯·ç¡®ä¿å¡«å†™å®Œæ•´çš„ /v1 åç¼€ã€‚</div>
                </div>

                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                        API å¯†é’¥ (Key)
                    </div>
                    <input type="password" id="api-key" class="cute-input" placeholder="sk-........................">
                </div>

                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        æ¨¡å‹é€‰æ‹©
                    </div>
                    <div class="model-row">
                        <div class="model-select-wrapper">
                            <select id="model-select" class="cute-input" style="appearance: none; background-color: #F5F7FA;">
                                <option value="" disabled selected>è¯·å…ˆæ‹‰å–åˆ—è¡¨</option>
                            </select>
                        </div>
                        <button class="btn-refresh" onclick="fetchModels()">æ‹‰å–æ¨¡å‹</button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path></svg>
                        æ¸©åº¦å‚æ•° (Temperature)
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div class="helper-text" style="margin-top:0; max-width: 70%;">
                            æ•°å€¼è¶Šå¤§è¶Šæœ‰åˆ›æ„ (0 - 2.0)<br>
                            <span style="color: #bbb;">å»ºè®®å€¼: 0.7</span>
                        </div>
                        <div class="temp-wrapper">
                            <input type="number" id="api-temp" class="temp-input-clean" value="0.7" min="0" max="2.0" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="saveSettings()">ä¿å­˜æ‰€æœ‰é…ç½®</button>
            <div style="height: 50px;"></div>
        </div>
    </div>
    
    <!-- === Chat åº”ç”¨ç•Œé¢ === -->
    <div id="chat-app" class="modal">
        <div class="chat-header-bar">
            <div class="chat-title" id="chat-page-title">Chats</div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="add-contact-btn" onclick="showCreatePage()" title="æ·»åŠ è”ç³»äºº">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12C2 6.48 6.48 2 12 2s10 4.48 10 10v.5c0 1.38-1.12 2.5-2.5 2.5S17 13.88 17 12.5V12a5 5 0 0 0-5-5 5 5 0 0 0-5 5v6c0 3.87 3.13 7 7 7s7-3.13 7-7"></path>
                        <path d="M12 12v.01"></path>
                    </svg>
                </div>
                <div class="close-btn" onclick="closeApp('chat-app')" style="font-size: 20px; padding:0;">Ã—</div>
            </div>
        </div>

        <div id="tab-chats" class="chat-content-area"></div>
        <div id="tab-contacts" class="chat-content-area" style="display: none;">
            <div id="contact-list"></div>
        </div>

      <!-- === æœ‹å‹åœˆ Tab === -->
        <div id="tab-moments">
            <div class="moments-header">
                <!-- æœ‹å‹åœˆå°é¢ (ç‚¹å‡»æ›´æ¢) -->
                <div class="moments-cover" id="moments-cover-img" onclick="document.getElementById('cover-upload').click()" style="background-image: url('https://picsum.photos/800/600');">
                    <!-- ç›¸æœºæŒ‰é’® (å‘å¸ƒåŠ¨æ€) -->
                    <div class="moments-camera-btn" onclick="openPostModal(event)">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                    </div>
                </div>
                <input type="file" id="cover-upload" class="hidden-input" accept="image/*">

                <div class="moments-user-info">
                    <div class="moments-my-name" id="moments-my-name">æˆ‘</div>
                    <div class="moments-my-avatar" id="moments-my-avatar" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1077/1077114.png');"></div>
                </div>
            </div>
            
            <!-- å¸–å­åˆ—è¡¨ -->
            <div class="moments-list" id="moments-feed">
                <!-- JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

    <!-- â–¼â–¼â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„é¡µé¢å®¹å™¨ â–¼â–¼â–¼â–¼â–¼ -->
    <div id="tab-me" class="chat-content-area" style="display: none; padding-top: 20px;">

<div class="me-section">
    <!-- â–¼â–¼â–¼ ä¿®æ”¹ onclick â–¼â–¼â–¼ -->
    <div class="me-item" onclick="openMeSubPage('me-persona-page')">
        <div class="me-item-title">
            <span>ğŸ­</span>
            <span>æˆ‘çš„äººè®¾</span>
        </div>
        <div class="arrow">&gt;</div>
    </div>
     <!-- â–¼â–¼â–¼ ä¿®æ”¹ onclick â–¼â–¼â–¼ -->
    <div class="me-item" onclick="openMeSubPage('me-anniversary-page')">
        <div class="me-item-title">
            <span>ğŸ’–</span>
            <span>æˆ‘ä»¬çš„çºªå¿µæ—¥</span>
        </div>
        <div class="arrow">&gt;</div>
    </div>
</div>

<div class="me-section">
            <!-- ä¿®æ”¹é’±åŒ…å…¥å£ -->
            <div class="me-item" onclick="openMeSubPage('me-wallet-page')">
                <div class="me-item-title">
                    <span>ğŸ’°</span>
                    <span>æˆ‘çš„é’±åŒ…</span>
                </div>
                 <div class="arrow">&gt;</div>
            </div>
            <!-- ä¿®æ”¹è¡¨æƒ…åŒ…å…¥å£ -->
            <div class="me-item" onclick="openMeSubPage('me-sticker-page')">
                <div class="me-item-title">
                    <span>ğŸ˜‚</span>
                    <span>è¡¨æƒ…åŒ…åº“</span>
                </div>
                 <div class="arrow">&gt;</div>
            </div>
        </div>

    <!-- æ‰¾åˆ° id="tab-me" é‡Œé¢çš„æœ€åä¸€éƒ¨åˆ†ï¼Œä¿®æ”¹æˆè¿™æ · -->

    <div class="me-section">
         <!-- æµ·é¾Ÿæ±¤ (è¿™æ˜¯åŸæœ¬æœ‰çš„) -->
         <div class="me-item" onclick="openSoupLobby()">
            <div class="me-item-title">
                <span>ğŸ¢</span>
                <span>æµ·é¾Ÿæ±¤æ¸¸æˆ</span>
            </div>
             <div class="arrow">&gt;</div>
        </div>

        <!-- â–¼â–¼â–¼ æŠŠä¸–ç•Œä¹¦æ”¾åœ¨è¿™é‡Œ (æ³¨æ„ï¼šå®ƒè¢«åŒ…åœ¨ me-section é‡Œé¢äº†) â–¼â–¼â–¼ -->
        <div class="me-item" onclick="openWorldBookPage()">
            <div class="me-item-title">
                <span>ğŸŒ</span>
                <span>ä¸–ç•Œä¹¦ (è¡¥å……è®¾å®š)</span>
            </div>
            <div class="arrow">&gt;</div>
        </div>
        <!-- â–²â–²â–² è¿™æ ·å®ƒå°±æ‹¥æœ‰ç™½è‰²å¡ç‰‡èƒŒæ™¯äº† â–²â–²â–² -->
    </div>

</div>
    <!-- â–²â–²â–²â–²â–² æ·»åŠ å®Œæ¯• â–²â–²â–²â–²â–² -->
    
    <!-- â–¼â–¼â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ·»åŠ  â–¼â–¼â–¼â–¼â–¼ -->

    <!-- === â€œæˆ‘çš„äººè®¾â€åˆ—è¡¨é¡µé¢ === -->
    <div id="me-persona-page" class="me-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeMeSubPage('me-persona-page')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>äººè®¾åº“</h2>
            <div style="position: absolute; right: 20px; color: var(--accent); font-weight: bold; cursor: pointer;" onclick="openPersonaCreate()">
                æ–°å»º
            </div>
        </div>
        <div class="me-page-content">
            <div class="helper-text" style="margin-bottom: 10px;">ç‚¹å‡»é€‰ä¸­å½“å‰è¦ä½¿ç”¨çš„äººè®¾ï¼š</div>
            <div id="persona-list-container">
                <!-- äººè®¾åˆ—è¡¨ä¼šåœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- === æ–°å»º/ç¼–è¾‘äººè®¾é¡µé¢ (è¦†ç›–å±‚) === -->
    <div id="persona-create-page" class="me-page" style="z-index: 85;">
        <div class="api-header">
            <div class="api-back-btn" onclick="document.getElementById('persona-create-page').style.display='none'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>ç¼–è¾‘äººè®¾</h2>
        </div>
        <div class="me-page-content">
            <div class="create-card">
                <!-- äººè®¾å¤´åƒä¸Šä¼  -->
                <div class="avatar-uploader" id="persona-avatar-preview" onclick="document.getElementById('persona-file-input').click()">
                    <div style="text-align:center;">
                         <div style="font-size: 24px;">ğŸ“·</div>
                        <div style="margin-top:4px;">äººè®¾å¤´åƒ</div>
                    </div>
                </div>
                <input type="file" id="persona-file-input" class="hidden-input" accept="image/*">
                
                <div class="input-row">
                    <div class="input-label">äººè®¾åç§° (å¦‚ï¼šæ’’å¨‡æ€ª)</div>
                    <input type="text" id="persona-name-input" class="clean-input">
                </div>

                <div class="input-row">
                    <div class="input-label">äººè®¾è¯¦æƒ… (AIä¼šæ ¹æ®è¿™ä¸ªè®¤è¯†ä½ )</div>
                    <textarea id="persona-desc-input" class="clean-input" rows="6" placeholder="æˆ‘æ˜¯è°ï¼Ÿæˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘ç°åœ¨çš„çŠ¶æ€æ˜¯ï¼Ÿ"></textarea>
                </div>

                <button class="btn-save" onclick="saveNewPersona()">ä¿å­˜å¹¶ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- === â€œæˆ‘ä»¬çš„çºªå¿µæ—¥â€è®¾ç½®é¡µé¢ === -->
    <div id="me-anniversary-page" class="me-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeMeSubPage('me-anniversary-page')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>æˆ‘ä»¬çš„çºªå¿µæ—¥</h2>
        </div>
        <div class="me-page-content">
            <!-- å·²æœ‰çºªå¿µæ—¥åˆ—è¡¨ -->
            <div id="anniversary-list" class="settings-card">
                <!-- çºªå¿µæ—¥ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                <div class="helper-text" style="text-align: center;">è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</div>
            </div>

            <!-- æ·»åŠ æ–°çºªå¿µæ—¥è¡¨å• -->
            
            <div class="settings-card">
                <div class="setting-label">æ·»åŠ æ–°çš„çºªå¿µæ—¥</div>
                
                <!-- â–¼â–¼â–¼ æ–°å¢ï¼šè§’è‰²é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
                <div class="input-row" style="margin-bottom: 15px;">
                    <div class="input-label">å…³è”è§’è‰²</div>
                    <select id="anniversary-role-select" class="clean-input" style="background: #F7F9FC;">
                        <option value="all">ä¸ç»‘å®š (æ‰€æœ‰äººéƒ½çŸ¥é“)</option>
                    </select>
                </div>
                <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

                <div class="input-row" style="margin-bottom: 15px;">
                    <input type="text" id="anniversary-name" class="clean-input" placeholder="çºªå¿µæ—¥åç§° (ä¾‹å¦‚ï¼šç¬¬ä¸€æ¬¡èŠå¤©)">
                </div>
                <div class="input-row">
                    <input type="date" id="anniversary-date" class="clean-input">
                </div>
                <button class="btn" onclick="addAnniversary()" style="margin-top: 20px;">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- â–²â–²â–²â–²â–² æ·»åŠ åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²â–²â–² -->
    
    <!-- === â€œæˆ‘çš„é’±åŒ…â€é¡µé¢ === -->
    <div id="me-wallet-page" class="me-page">
        <div class="api-header" style="background: #5B7C99; color: white;">
            <div class="api-back-btn" onclick="closeMeSubPage('me-wallet-page')" style="color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: white;">æˆ‘çš„å°é‡‘åº“</h2>
        </div>
        <div class="me-page-content" style="padding: 0;">
            <!-- ä½™é¢å¡ç‰‡ -->
            <div style="background: #5B7C99; color: white; padding: 20px 30px 40px 30px; border-radius: 0 0 30px 30px; text-align: center; box-shadow: 0 10px 20px rgba(91, 124, 153, 0.3);">
                <div style="font-size: 14px; opacity: 0.8;">å½“å‰ä½™é¢ (è™šæ‹Ÿå¸)</div>
                <div style="font-size: 48px; font-weight: bold; margin: 10px 0;" id="wallet-balance">0</div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn" style="background: rgba(255,255,255,0.2); width: auto; padding: 8px 20px; backdrop-filter: blur(5px);" onclick="addBalance(100)">+ ç­¾åˆ°é¢†å¸</button>
                    <button class="btn" style="background: rgba(255,255,255,0.2); width: auto; padding: 8px 20px; backdrop-filter: blur(5px);" onclick="resetBalance()">â†º é‡ç½®</button>
                </div>
            </div>
            
            <!-- äº¤æ˜“è®°å½• -->
            <div style="padding: 20px;">
                <div style="font-weight: bold; color: #555; margin-bottom: 15px;">è¿‘æœŸè´¦å•</div>
                <div id="wallet-history">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- === â€œè¡¨æƒ…åŒ…åº“â€é¡µé¢ === -->
    <div id="me-sticker-page" class="me-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeMeSubPage('me-sticker-page')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>è¡¨æƒ…åŒ…ä»“åº“</h2>
            
            <!-- â–¼â–¼â–¼ æ–°å¢ï¼šä¸Šä¼ ç›®æ ‡é€‰æ‹© â–¼â–¼â–¼ -->
            <select id="sticker-role-select" class="clean-input" style="width: 100px; padding: 5px; margin-right: 10px; font-size: 12px;">
                <option value="all">é€šç”¨</option>
                <!-- è§’è‰²åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </select>
            
            <!-- æ·»åŠ æŒ‰é’® -->
            <div style="color: var(--accent); font-weight: bold; cursor: pointer;" onclick="document.getElementById('sticker-upload').click()">
                + æ·»åŠ 
            </div>
            <input type="file" id="sticker-upload" class="hidden-input" accept="image/*" multiple>
        </div>
            
        <div class="me-page-content">
            <div class="helper-text" style="text-align: center; margin-bottom: 20px;">ç‚¹å‡»è¡¨æƒ…åŒ…å³å¯å‘é€ç»™å½“å‰èŠå¤©çš„è§’è‰²</div>
            <div id="sticker-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <!-- è¡¨æƒ…åŒ…å›¾ç‰‡ä¼šåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>
    
    <!-- === æµ·é¾Ÿæ±¤ï¼šç»„å±€å¤§å… === -->
    <div id="soup-lobby-page" class="me-page">
        <div class="api-header" style="background: #2C3E50; color: white;">
            <div class="api-back-btn" onclick="closeMeSubPage('soup-lobby-page')" style="color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: white;">æµ·é¾Ÿæ±¤ç»„å±€</h2>
        </div>
        <div class="me-page-content" style="background: #34495E; color: white;">
            
            <!-- â–¼â–¼â–¼ ä¿®æ”¹åçš„å‰§æœ¬ç”Ÿæˆå¡ç‰‡ â–¼â–¼â–¼ -->
            <div class="settings-card" style="background: rgba(255,255,255,0.1); color: white; border: none;">
                <div class="setting-label" style="color: #AAB7B8;">1. AI ç°ç…®æµ·é¾Ÿæ±¤</div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="soup-topic-input" class="clean-input" placeholder="è¾“å…¥å…³é”®è¯(å¦‚:ææ€–/æ ¡å›­/ç§‘å¹»)..." style="background: rgba(0,0,0,0.2); color: white; border: 1px solid #555;">
                    <button class="btn" onclick="generateSoupScript()" style="width: auto; white-space: nowrap; background: #E67E22;">ç”Ÿæˆ</button>
                </div>

                <!-- åŠ è½½åŠ¨ç”»/æç¤º -->
                <div id="soup-loading" style="display: none; color: #E67E22; font-size: 12px; text-align: center; margin-bottom: 10px;">
                    AI æ­£åœ¨ç†¬æ±¤ä¸­ï¼Œè¯·ç¨å€™... ğŸ²
                </div>

                <div id="soup-script-preview" style="font-size: 13px; color: #ccc; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; line-height: 1.6; min-height: 60px;">
                    <span style="color: #777;">(ç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼Œè·å–ä¸€ä¸ªå…¨æ–°çš„æ•…äº‹)</span>
                </div>
            </div>
            <!-- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² -->

            <div class="settings-card" style="background: rgba(255,255,255,0.1); color: white; border: none;">
                <div class="setting-label" style="color: #AAB7B8;">2. è°æ˜¯ä¸»æŒäºº (DM)?</div>
                <select id="soup-dm-select" class="clean-input" style="background: rgba(0,0,0,0.2); color: white; border: 1px solid #555;">
                    <!-- è§’è‰²åˆ—è¡¨ -->
                </select>
                <div class="helper-text" style="color: #777;">ä¸»æŒäººçŸ¥é“çœŸç›¸ï¼Œè´Ÿè´£å›ç­”â€œæ˜¯â€æˆ–â€œå¦â€ã€‚</div>
            </div>

            <div class="settings-card" style="background: rgba(255,255,255,0.1); color: white; border: none;">
                <div class="setting-label" style="color: #AAB7B8;">3. é‚€è¯·è°ä¸€èµ·ç©? (å¤šé€‰)</div>
                <div id="soup-player-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- é˜Ÿå‹é€‰æ‹©åˆ—è¡¨ -->
                </div>
            </div>

            <button class="btn-save" onclick="startSoupGame()" style="background: #E67E22; margin-top: 20px;">å¼€å§‹å‘æ±¤</button>
        </div>
    </div>

    <!-- === æµ·é¾Ÿæ±¤ï¼šæ¸¸æˆæˆ¿é—´ === -->
    <div id="soup-game-room" class="me-page" style="background: #2C3E50; z-index: 90;">
        <!-- é¡¶éƒ¨ -->
        <div class="room-header" style="background: #34495E; border-bottom: 1px solid #444;">
            <div onclick="quitSoupGame()" style="padding: 10px; cursor: pointer; color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <div class="room-info" style="color: white;">
                <div class="room-name">æµ·é¾Ÿæ±¤è¿›è¡Œä¸­</div>
                <div class="room-status" style="color: #E67E22;" id="soup-status">ä¸»æŒäººå‡†å¤‡ä¸­...</div>
            </div>
            <div onclick="endSoupGameAndSave()" style="padding: 10px; cursor: pointer; color: #E67E22; font-size: 12px; font-weight: bold;">
                ç»“æŸå¹¶å­˜æ¡£
            </div>
        </div>

        <!-- æ±¤é¢å±•ç¤ºåŒº -->
        <div style="padding: 15px; background: rgba(0,0,0,0.2); margin: 10px; border-radius: 10px; color: #ddd; font-size: 13px; line-height: 1.5;">
            <span style="color: #E67E22; font-weight: bold;">æ±¤é¢ï¼š</span>
            <span id="current-soup-text">...</span>
        </div>

        <!-- æ¸¸æˆè®°å½• -->
        <div id="soup-chat-container" style="flex: 1; overflow-y: auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 15px;">
            <!-- æ¶ˆæ¯æµ -->
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="room-footer" style="background: #34495E; border-top: 1px solid #444;">
            <!-- é˜Ÿå‹æé—®æŒ‰é’® -->
            <div class="action-btn" style="width: auto; padding: 0 10px; border-radius: 15px; background: #E67E22; color: white; font-size: 12px; margin-right: 5px;" onclick="triggerTeammateAsk()">
                è®©é˜Ÿå‹çŒœ
            </div>
            
            <textarea id="soup-input" class="chat-input-box" rows="1" placeholder="æé—® (æ˜¯/å¦é¢˜ç›®)..." style="background: #2C3E50; color: white;"></textarea>
            
            <div class="action-btn btn-send" onclick="sendSoupUserMsg()" style="background: #E67E22;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </div>
        </div>
    </div>

        <div class="bottom-nav">
    <div class="nav-item active" onclick="switchChatTab('chats', this)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
        <span class="nav-label">èŠå¤©</span>
    </div>
    <div class="nav-item" onclick="switchChatTab('contacts', this)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
        <span class="nav-label">è”ç³»äºº</span>
    </div>

          <div class="nav-item" onclick="switchChatTab('moments', this)">
        <!-- æœ‹å‹åœˆå›¾æ ‡ (å…‰åœˆ) -->
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
        <span class="nav-label">å‘ç°</span>
    </div>
          
    <!-- â–¼â–¼â–¼â–¼â–¼ æ·»åŠ ä¸‹é¢è¿™ä¸ª DIV â–¼â–¼â–¼â–¼â–¼ -->
    <div class="nav-item" onclick="switchChatTab('me', this)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path></svg>
        <span class="nav-label">æˆ‘</span>
    </div>
    <!-- â–²â–²â–²â–²â–² æ·»åŠ ä¸Šé¢è¿™ä¸ª DIV â–²â–²â–²â–²â–² -->
</div>

        <!-- === ç‹¬ç«‹çš„åˆ›å»ºè§’è‰²é¡µé¢ (é»˜è®¤éšè—) === -->
        <div id="create-role-page">
            <div class="create-header">
                <div class="back-icon" onclick="hideCreatePage()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </div>
                <div>åˆ›å»ºæ–°è§’è‰²</div>
            </div>

            <div class="create-card">
                <div class="avatar-uploader" id="new-role-avatar" onclick="document.getElementById('role-file').click()">
                    <div style="text-align:center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <div style="margin-top:4px;">ä¸Šä¼ å¤´åƒ</div>
                    </div>
                </div>
                <!-- è¡¥å›ä¸¢å¤±çš„ input -->
                <input type="file" id="role-file" class="hidden-input" accept="image/*">
                
                <div class="input-row">
                    <div class="input-label">è§’è‰²åç§°</div>
                    <input type="text" id="role-name" class="clean-input" placeholder="ä¾‹å¦‚ï¼šå°çŒ«å’ª">
                </div>

                <div class="input-row">
                    <div class="input-label">æ€§åˆ« / è®¾å®š</div>
                    <div class="gender-capsule" id="gender-select-box">
                        <div class="gender-opt active" onclick="selectGender(this, 'ç”·ç”Ÿ')">ç”·ç”Ÿ</div>
                        <div class="gender-opt" onclick="selectGender(this, 'å¥³ç”Ÿ')">å¥³ç”Ÿ</div>
                        <div class="gender-opt" onclick="selectGender(this, 'å® ç‰©')">å® ç‰©</div>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">äººè®¾ä¸æ€§æ ¼</div>
                    <textarea id="role-prompt" class="clean-input" rows="3" placeholder="TAæ˜¯ä»€ä¹ˆæ ·çš„æ€§æ ¼ï¼Ÿè¯´è¯æœ‰ä»€ä¹ˆå£ç™–ï¼Ÿ" style="resize: none;"></textarea>
                </div>

                <button class="create-btn-float" onclick="createNewRole()">ç¡®è®¤åˆ›å»º</button>
            </div>
        </div>
        
        <!-- === 5. èŠå¤©å®¤é¡µé¢ === -->
    <div id="chat-room-page">
        <!-- é¡¶éƒ¨ -->
        <div class="room-header">
            <div onclick="closeChatRoom()" style="padding: 10px; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <div class="room-info">
                <div class="room-name" id="current-chat-name">è§’è‰²å</div>
                <div class="room-status" id="typing-status">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>
            </div>
            <!-- è®¾ç½®æŒ‰é’® (éé½¿è½®ï¼Œæ›´ä¼˜é›…çš„èœå•å›¾æ ‡) -->
            <div onclick="openChatSettings()" style="padding: 10px; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                </svg>
            </div>
        </div>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div id="message-container">
            <!-- æ¶ˆæ¯ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            <div class="msg-row left">
                <div class="msg-bubble bubble-default" style="background: white; color: #333;">
                    ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯ä½ çš„ä¸“å± AI ä¼™ä¼´ã€‚
                </div>
            </div>
            <div class="msg-row right">
                <div class="msg-bubble bubble-default" style="background: #FFE6E6; color: #333;">
                    ä½ å¥½ï¼
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥æ  -->
        <!-- â–¼â–¼â–¼â–¼â–¼ æ’å…¥è¿™ä¸ªç¼ºå¤±çš„é¢æ¿ â–¼â–¼â–¼â–¼â–¼ -->
        <!-- â–¼â–¼â–¼â–¼â–¼ å¤šåŠŸèƒ½é¢æ¿ â–¼â–¼â–¼â–¼â–¼ -->
        
            
            <!-- â–¼â–¼â–¼ æ–°ç‰ˆ INS é£å¤šåŠŸèƒ½é¢æ¿ â–¼â–¼â–¼ -->
        <!-- â–¼â–¼â–¼ æ–°ç‰ˆ INS é£å¤šåŠŸèƒ½é¢æ¿ (å·²æ·»åŠ å›¾ç‰‡åŠŸèƒ½) â–¼â–¼â–¼ -->
<div id="chat-action-panel">
    <!-- é¡¶éƒ¨å°æ¨ªæ¡ -->
    <div class="panel-handle"></div>

    <!-- å›¾æ ‡æŒ‰é’®ç½‘æ ¼ -->
    <div class="ins-grid">
        <!-- 1. ç›¸å†Œ (æ–°åŠŸèƒ½) -->
        <div class="ins-btn" onclick="document.getElementById('chat-image-upload').click()">
            <div class="ins-icon-circle" style="background: linear-gradient(135deg, #A18CD1, #FBC2EB); box-shadow: 0 8px 20px rgba(161, 140, 209, 0.25);">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </div>
            <span class="ins-label">ç›¸å†Œ</span>
        </div>

        <!-- 2. è„‘æ´å›¾ (æ–°åŠŸèƒ½ï¼šæ–‡å­—è½¬å›¾ç‰‡æè¿°) -->
        <div class="ins-btn" onclick="sendTextDescriptionImg()">
            <div class="ins-icon-circle" style="background: linear-gradient(135deg, #84fab0, #8fd3f4); box-shadow: 0 8px 20px rgba(132, 250, 176, 0.25);">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
            </div>
            <span class="ins-label">è„‘æ´å›¾</span>
        </div>

        <!-- 3. è½¬è´¦ (åŸæœ‰) -->
        <div class="ins-btn" onclick="switchPanelTab('transfer')">
            <div class="ins-icon-circle bg-green">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
            </div>
            <span class="ins-label">è½¬è´¦</span>
        </div>

        <!-- 4. è¯»å¿ƒ (åŸæœ‰) -->
        <div class="ins-btn" onclick="checkRoleStatus()">
            <div class="ins-icon-circle bg-pink">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            </div>
            <span class="ins-label">è¯»å¿ƒ</span>
        </div>
        
         <!-- 5. ä¸€èµ·å¬ (åŸæœ‰) -->
        <div class="ins-btn" onclick="openMusicPlayer()">
            <div class="ins-icon-circle bg-purple">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
            </div>
            <span class="ins-label">ä¸€èµ·å¬</span>
        </div>
    </div>

    <!-- å†…å®¹å±•ç¤ºåŒº -->
    <div id="panel-content-area">
        <div id="panel-transfer-box" style="display: none; text-align: center; padding: 10px;">
            <div style="margin-bottom:10px; color:#888; font-size:13px;">è¯·è¾“å…¥é‡‘é¢</div>
            <input type="number" id="transfer-amount" class="cute-input" style="text-align: center; font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px;" placeholder="Â¥">
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="doTransfer('to_ai')" style="background: #67C23A; border:none;">ç»™TAè½¬è´¦</button>
                <button class="btn" onclick="doTransfer('from_ai')" style="background: white; color: #67C23A; border: 1px solid #67C23A;">å‘TAæ”¶æ¬¾</button>
            </div>
        </div>
    </div>
</div>
        
        <!-- === ğŸµ éŸ³ä¹æ’­æ”¾å™¨ç•Œé¢ === -->
    <div id="music-player-modal">
        <!-- é¡¶éƒ¨æœ€å°åŒ–æŒ‰é’® -->
        <div style="position: absolute; top: 40px; left: 20px;" onclick="minimizeMusicPlayer()">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M19 12H5"></path></svg> <!-- ç®€å•çš„æ¨ªçº¿ä»£è¡¨æœ€å°åŒ– -->
        </div>
        <!-- æ­Œå•æŒ‰é’® -->
        <div style="position: absolute; top: 40px; right: 20px;" onclick="openMusicList()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        </div>

        <div class="music-info-top">
            <div class="music-title" id="player-title">æœªæ’­æ”¾</div>
            <div class="music-artist" id="player-artist">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ­Œæ›²</div>
        </div>

        <!-- å”±ç‰‡ -->
        <div class="vinyl-wrapper" id="vinyl-disc">
            <div class="vinyl-cover" id="player-cover" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1256/1256650.png');"></div>
        </div>

        <!-- äº¤äº’çŠ¶æ€ -->
        <div style="margin-top: 20px; font-size: 12px; color: rgba(255,255,255,0.6); height: 20px;" id="music-ai-status">
            æ­£åœ¨ç­‰å¾…ä¸€èµ·å¬...
        </div>

        <!-- æ§åˆ¶æ  -->
        <div class="player-controls">
            <!-- ä¸Šä¸€é¦– -->
            <div class="ctrl-btn" onclick="playPrevSong()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>
            </div>
            <!-- æ’­æ”¾/æš‚åœ -->
            <div class="ctrl-btn ctrl-btn-big" onclick="togglePlayState()">
                <svg id="play-icon" width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg id="pause-icon" style="display:none" width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
            </div>
            <!-- ä¸‹ä¸€é¦– -->
            <div class="ctrl-btn" onclick="playNextSong()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
            </div>
        </div>
        
        <!-- éŸ³é¢‘æ ‡ç­¾ (éšè—) -->
        <audio id="bgm-audio" loop></audio>
    </div>

    <!-- === ğŸµ æ­Œå•åˆ—è¡¨å¼¹çª— === -->
    <div id="music-list-modal">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:bold; color:#333;">æˆ‘çš„æ­Œå•</div>
            <div onclick="document.getElementById('music-list-modal').style.display='none'" style="color:#999; font-size:24px;">Ã—</div>
        </div>
        
        <div style="flex:1; overflow-y: auto;" id="music-list-container">
            <!-- æ­Œæ›²åˆ—è¡¨ -->
        </div>
        
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="net-music-input" class="cute-input" placeholder="ç²˜è´´ç½‘æ˜“äº‘é“¾æ¥æˆ–ID..." style="font-size:12px;">
                <button class="btn" style="width: auto; padding: 0 15px; margin-top:0;" onclick="importMusic()">æ·»åŠ </button>
            </div>
            <div class="helper-text">æç¤ºï¼šVIPæ­Œæ›²æ— æ³•æ’­æ”¾ï¼Œè¯·ç”¨å…è´¹æ­Œæ›²ID</div>
        </div>
    </div>
        <!-- â–²â–²â–²â–²â–² é¢æ¿ç»“æŸ â–²â–²â–²â–²â–² -->
        <!-- â–²â–²â–²â–²â–² æ’å…¥ç»“æŸ â–²â–²â–²â–²â–² -->

        <div class="room-footer">
            <!-- â–¼â–¼â–¼ æ–°å¢ï¼šåŠ å·æŒ‰é’® â–¼â–¼â–¼ -->
            <div class="action-btn" style="color: #5A6A7E; background: transparent; border: 1px solid #E0E0E0; margin-right: 5px;" onclick="toggleChatActionPanel()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>

            <!-- æ¥æ”¶æŒ‰é’® (æ°”æ³¡å›¾æ ‡) -->
            <div class="action-btn btn-receive" onclick="triggerAIResponse()" title="è®©å¯¹æ–¹å›å¤">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            
            <textarea id="msg-input" class="chat-input-box" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            
            <!-- å‘é€æŒ‰é’® -->
            <div class="action-btn btn-send" onclick="sendUserMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </div>
        </div>
    </div>

      <!-- === å¤‡å¿˜å½•ç‹¬ç«‹é¡µé¢ === -->
    <div id="memo-page">
        <div class="api-header" style="background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <div class="api-back-btn" onclick="document.getElementById('memo-page').style.display='none'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5A6A7E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: #5A6A7E;">TA çš„å¤‡å¿˜å½•</h2>
            <div style="width: 24px;"></div> <!-- å ä½ï¼Œè®©æ ‡é¢˜å±…ä¸­ -->
        </div>

        <div class="memo-list-container" id="memo-container">
            <!-- è¿™é‡Œçš„å¡ç‰‡ä¼šç”± JS åŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <!-- åŠ è½½æç¤º -->
        <div id="memo-loading-tip" class="memo-loading">
            æ­£åœ¨æ ¹æ®èŠå¤©è®°å½•å›å¿†å¾…åŠäº‹é¡¹...<br>
            <span style="font-size: 20px;">â˜ï¸ ğŸ–Šï¸ â˜ï¸</span>
        </div>

        <!-- å³ä¸‹è§’æ‚¬æµ®æŒ‰é’®ï¼šç”Ÿæˆæ–°çš„ -->
        <div class="fab-btn" onclick="generateNewMemo()" title="ç”Ÿæˆä»Šæ—¥æ–°å¤‡å¿˜">
            +
        </div>
    </div>

      <!-- === è¶³è¿¹ (æ—¶é—´è½´) é¡µé¢ === -->
    <div id="footprint-page">
        <div class="api-header" style="background: white; border-bottom: 1px solid #f5f5f5;">
            <div class="api-back-btn" onclick="document.getElementById('footprint-page').style.display='none'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: #333; font-size: 16px;">TA çš„ 24H è¶³è¿¹</h2>
            <div style="width: 24px;"></div>
        </div>

        <div class="footprint-container">
            <div class="footprint-line-bg"></div> <!-- èƒŒæ™¯çº¿æ¡ -->
            <div id="footprint-list">
                <!-- JS åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
            </div>
            <div style="height: 60px;"></div> <!-- åº•éƒ¨ç•™ç™½ -->
        </div>
        
        <!-- åŠ è½½æç¤º -->
        <div id="fp-loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); display:none; text-align:center; background:rgba(255,255,255,0.9); padding:20px; border-radius:10px; box-shadow:0 5px 20px rgba(0,0,0,0.1);">
            <div style="color:#7FA6C8; font-weight:bold;">æ­£åœ¨å®šä½ TA çš„ä½ç½®...</div>
            <div style="font-size:12px; color:#999; margin-top:5px;">åˆ†æèŠå¤©è®°å½•ä¸æ—¶é—´æµ ğŸ›°ï¸</div>
        </div>

        <!-- å³ä¸‹è§’ï¼šåˆ·æ–°/è¿½åŠ æŒ‰é’® -->
        <div class="fp-fab" onclick="updateFootprints()" title="æ›´æ–°åˆ°ç°åœ¨">
            +
        </div>
    </div>

      <!-- === ç¢ç¢å¿µç¬”è®°é¡µé¢ (åˆ·æ–°åˆ¶) === -->
    <div id="note-page">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="api-header" style="background: transparent; box-shadow: none;">
            <div class="api-back-btn" onclick="document.getElementById('note-page').style.display='none'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#5A6A7E" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: #5A6A7E;">TA çš„ç¢ç¢å¿µ</h2>
            <div style="width: 24px;"></div>
        </div>

        <!-- å¡ç‰‡å®¹å™¨ -->
        <div class="note-container" id="note-list">
            <!-- JS ä¼šåœ¨è¿™é‡Œç”Ÿæˆå¡ç‰‡ -->
        </div>

        <!-- åŠ è½½åŠ¨ç”» -->
        <div id="note-loading" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; display:none;">
            <div style="font-size:30px; margin-bottom:10px;">ğŸ’­</div>
            <div style="color:#999; font-size:13px;">æ­£åœ¨å·å¬ TA çš„å¿ƒå£°...</div>
        </div>

        <!-- åˆ·æ–°æŒ‰é’® -->
        <div class="note-refresh-btn" onclick="refreshNotes()" title="æ¢ä¸€æ‰¹">
            â†»
        </div>
    </div>

      <!-- === è™šæ‹Ÿç›¸å†Œé¡µé¢ === -->
<div id="gen-album-page" class="me-page" style="background: #FAF9F6;"> <!-- ç±³ç™½è‰²èƒŒæ™¯ -->
    <div class="api-header" style="background: transparent;">
        <div class="api-back-btn" onclick="document.getElementById('gen-album-page').style.display='none'">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </div>
        <h2 id="gen-album-title" style="color: #333;">TA çš„ç§å¯†ç›¸å†Œ</h2>
        <div style="width: 24px;"></div>
    </div>

    <div id="gen-album-list" class="polaroid-grid">
        <!-- ç…§ç‰‡å¡ç‰‡ä¼šç”Ÿæˆåœ¨è¿™é‡Œ -->
    </div>
    
    <!-- åŠ è½½åŠ¨ç”» -->
    <div id="gen-album-loading" style="position:absolute; top:40%; left:50%; transform:translate(-50%, -50%); text-align:center; display:none;">
        <div style="font-size:30px; margin-bottom:10px;">ğŸ“¸</div>
        <div style="color:#999; font-size:13px;">æ­£åœ¨ç¿»çœ‹ç›¸å†Œ...</div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <div class="album-refresh-btn" onclick="generateAlbumData(true)" title="çœ‹ç‚¹æ–°çš„">
        â†»
    </div>
</div>
    
    <!-- === ä¸–ç•Œä¹¦åˆ—è¡¨é¡µé¢ === -->
<div id="world-book-page" class="me-page">
    <div class="api-header">
        <div class="api-back-btn" onclick="document.getElementById('world-book-page').style.display='none'">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
        </div>
        <h2>ä¸–ç•Œä¹¦è®¾å®šé›†</h2>
        <div style="color: var(--accent); font-weight: bold; cursor: pointer;" onclick="openWorldEntryEdit()">
            + æ–°å»º
        </div>
    </div>
    
    <div class="me-page-content" id="world-book-list">
        <!-- åŠ¨æ€ç”Ÿæˆæ¡ç›® -->
    </div>
</div>

<!-- === ä¸–ç•Œä¹¦ç¼–è¾‘å¼¹çª— (ç¾åŒ–ç‰ˆ) === -->
<div id="world-entry-edit" class="me-page" style="z-index: 120; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; display: none;">
    <div class="settings-card" style="width: 90%; max-height: 90%; overflow-y: auto; animation: slideUp 0.2s ease;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin:0; font-size: 18px;">ç¼–è¾‘ä¸–ç•Œè§‚è®¾å®š</h3>
            <div onclick="document.getElementById('world-entry-edit').style.display='none'" style="font-size: 24px; color: #999; cursor: pointer;">Ã—</div>
        </div>

        <div class="form-group">
            <div class="setting-label">é€‚ç”¨èŒƒå›´ (è°çŸ¥é“è¿™ä¸ªè®¾å®šï¼Ÿ)</div>
            <select id="wb-role-select" class="cute-input">
                <option value="all">ğŸŒ é€šç”¨ (æ‰€æœ‰è§’è‰²éƒ½çŸ¥é“)</option>
                <!-- JS åŠ¨æ€æ’å…¥ -->
            </select>
        </div>

        <div class="form-group">
            <div class="setting-label">è®¾å®šè¯¦æƒ… (å¸¸é©»ç”Ÿæ•ˆ)</div>
            <div class="helper-text" style="margin-bottom: 8px;">
                è¿™éƒ¨åˆ†å†…å®¹ä¼šã€å§‹ç»ˆã€‘åŒ…å«åœ¨ AI çš„è®°å¿†é‡Œï¼Œä¸éœ€è¦è§¦å‘ã€‚é€‚åˆå†™ä¸–ç•ŒèƒŒæ™¯ã€äººç‰©å…³ç³»ã€é‡è¦ç‰©å“ç­‰ã€‚
            </div>
            <textarea id="wb-content" class="wb-textarea" placeholder="ä¾‹å¦‚ï¼šåœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œè´§å¸å«åšâ€˜æ˜Ÿå°˜â€™ã€‚æˆ‘å’Œä½ æ˜¯ä»å°ä¸€èµ·é•¿å¤§çš„é’æ¢…ç«¹é©¬ï¼Œä½†æˆ‘ä»¬æ˜¯å¯¹ç«‹çš„é˜µè¥..."></textarea>
        </div>

        <button class="btn-save" onclick="saveWorldEntry()">ä¿å­˜è®¾å®š</button>
        <button class="btn-secondary" onclick="deleteWorldEntry()" id="btn-delete-entry" style="width: 100%; margin-top: 10px; color: #ff4d4f; display: none; background: #FFF0F0; border: 1px solid #FFCDD2;">åˆ é™¤æ­¤æ¡ç›®</button>
    </div>
</div>

    <!-- === 6. èŠå¤©è®¾ç½®é¡µé¢ (ç‹¬ç«‹) === -->
    <div id="chat-settings-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeChatSettings()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>èŠå¤©è®¾ç½®</h2>
        </div>

        <div style="flex: 1; overflow-y: auto; padding-bottom: 40px;">
            
            <!-- å¤–è§‚è®¾ç½® -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">å¤–è§‚æ ·å¼</div>
            <div class="setting-section">
                <div class="setting-item">
                    <span class="setting-title">æ°”æ³¡å½¢çŠ¶</span>
                    <div class="shape-selector">
                        <div class="shape-opt bubble-round" onclick="setBubbleShape('bubble-round', this)" title="åœ†æ»šæ»š"></div>
                        <div class="shape-opt bubble-default active" onclick="setBubbleShape('bubble-default', this)" title="é»˜è®¤"></div>
                        <div class="shape-opt bubble-sharp" onclick="setBubbleShape('bubble-sharp', this)" title="å°å°–è§’"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span class="setting-title">èŠå¤©èƒŒæ™¯</span>
                    <button class="btn-secondary" onclick="document.getElementById('chat-bg-upload').click()" style="font-size: 12px;">ä¸Šä¼ å›¾ç‰‡</button>
                    <input type="file" id="chat-bg-upload" class="hidden-input" accept="image/*">
                </div>
            </div>

            <!-- é¢œè‰²è®¾ç½® -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">æ°”æ³¡é…è‰² (æ¡æ‰‹æœºæ–‡å­¦é£)</div>
            <div class="setting-section">
                <div class="setting-item">
                    <span class="setting-title">å¯¹æ–¹æ°”æ³¡ (AI)</span>
                    <input type="color" id="color-ai" value="#FFFFFF" onchange="updateChatColors()">
                </div>
                <div class="setting-item">
                    <span class="setting-title">æˆ‘çš„æ°”æ³¡ (User)</span>
                    <input type="color" id="color-user" value="#FFE6E6" onchange="updateChatColors()">
                </div>
            </div>
            
            <!-- â–¼â–¼â–¼â–¼â–¼ è¯·æŠŠè¿™æ®µæ’å…¥åˆ° <div id="chat-settings-page"> é‡Œ â–¼â–¼â–¼â–¼â–¼ -->
<!-- å»ºè®®æ”¾åœ¨ "å¤–è§‚æ ·å¼" çš„ä¸Šé¢ -->

<div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">è§’è‰²æ¡£æ¡ˆ</div>
<div class="setting-section">
    <div class="setting-item" onclick="editCurrentRole()">
        <span class="setting-title">âœ ç¼–è¾‘ TA çš„å¤´åƒ/åå­—/äººè®¾</span>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
    </div>
</div>

<!-- â–²â–²â–²â–²â–² æ’å…¥ç»“æŸ â–²â–²â–²â–²â–² -->

            <!-- å‚æ•°è®¾ç½® -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">æ˜¾ç¤ºä¸è®°å¿†</div>
            <div class="setting-item">
                    <span class="setting-title">æ˜¾ç¤ºæ—¶é—´æˆ³</span>
                    <input type="checkbox" id="show-time-switch" onchange="updateChatSettingsBool()" style="width: 20px; height: 20px;">
                </div>
            <div class="setting-section">
                <div class="setting-item">
                    <span class="setting-title">å­—ä½“å¤§å° (12-15px)</span>
                    <input type="number" id="font-size-input" value="14" min="12" max="15" class="cute-input" style="width: 60px; padding: 5px; text-align: center;" onchange="updateChatFont()">
                </div>
                <div class="setting-item">
                    <span class="setting-title">è®°å¿†æ¡æ•°</span>
                    <input type="number" id="memory-limit" value="30" class="cute-input" style="width: 60px; padding: 5px; text-align: center;">
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šéšç§ä¸åŠ¨æ€ -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">æŸ¥æ‰‹æœº</div>
            <div class="setting-section">
                <div class="setting-item" onclick="openMemoPage()">
                    <span class="setting-title">æŸ¥çœ‹TAçš„å¤‡å¿˜å½•</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="setting-item" onclick="openFootprintPage()">
    <span class="setting-title">æŸ¥çœ‹TAçš„è¶³è¿¹</span>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
</div>
                <div class="setting-item" onclick="openNotePage()">
    <span class="setting-title">å·çœ‹ç¢ç¢å¿µç¬”è®°</span>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
</div>

             <div class="setting-item" onclick="openGenAlbum()">
    <span class="setting-title">ç¿»çœ‹TAçš„ç›¸å†Œ</span>
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
</div> 
              
            </div>

          

         <!-- â–¼â–¼â–¼ æ–°å¢ï¼šå±é™©åŒºåŸŸ (æ¸…ç©ºä¸åˆ é™¤) â–¼â–¼â–¼ -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #F56C6C; font-weight: bold;">æ•°æ®ç®¡ç†</div>
            <div class="setting-section">
                <div class="setting-item" onclick="clearCurrentHistory()">
                    <span class="setting-title" style="color: #F56C6C;">ğŸ—‘ æ¸…ç©ºèŠå¤©è®°å½•</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#F56C6C" stroke-width="2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                </div>
                <div class="setting-item" onclick="deleteCurrentContact()">
                    <span class="setting-title" style="color: #F56C6C;">ğŸš« åˆ é™¤è¯¥è”ç³»äºº</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#F56C6C" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
                </div>
            </div>
            <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² --> 
            
            <!-- é€šç”¨ä¿¡æ¯å±•ç¤ºå¼¹çª— -->
    <div id="info-modal" onclick="document.getElementById('info-modal').style.display='none'">
        <div class="info-card" onclick="event.stopPropagation()">
            <div class="info-header" id="info-title">æ ‡é¢˜</div>
            <div class="info-content" id="info-text">å†…å®¹åŠ è½½ä¸­...</div>
            <button class="btn" onclick="document.getElementById('info-modal').style.display='none'" style="margin-top:20px; background:#f5f5f5; color:#666;">å…³é—­</button>
        </div>
    </div>
            
            <div style="text-align: center; margin-top: 30px; color: #ccc; font-size: 12px;">
                è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜
            </div>
        </div>
    </div>
    
    <!-- é•¿æŒ‰æ¶ˆæ¯å¼¹å‡ºçš„èœå• -->
    <div id="msg-context-menu" onclick="closeMsgMenu()">
        <div class="menu-content" onclick="event.stopPropagation()">
            <div class="menu-item" onclick="handleEditMsg()">âœ ç¼–è¾‘æ¶ˆæ¯</div>
            <div class="menu-item danger" onclick="handleDeleteMsg()">ğŸ—‘ åˆ é™¤æ¶ˆæ¯</div>
        </div>
    </div>

      <!-- === å‘å¸ƒåŠ¨æ€å¼¹çª— === -->
    <!-- === å‘å¸ƒåŠ¨æ€å¼¹çª— (å‡çº§ç‰ˆï¼šæ”¯æŒå‘å›¾) === -->
<div id="post-moment-modal">
    <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee;">
        <div onclick="document.getElementById('post-moment-modal').style.display='none'" style="color:#333;">å–æ¶ˆ</div>
        <button class="btn" onclick="publishMoment()" style="width:auto; margin:0; padding: 6px 15px; background:#07C160;">å‘è¡¨</button>
    </div>
    <div style="padding: 20px;">
        <textarea id="moment-text-input" class="clean-input" rows="5" placeholder="è¿™ä¸€åˆ»çš„æƒ³æ³•..." style="background:white; padding:0; font-size:16px;"></textarea>
        
        <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
        <div id="moment-img-preview" style="margin-top:10px; display:none;">
            <img id="moment-temp-img" src="" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
            <div onclick="clearMomentImg()" style="color: red; font-size: 12px; margin-top: 5px;">åˆ é™¤å›¾ç‰‡</div>
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <!-- ä¸Šä¼ æŒ‰é’® -->
            <div style="width:80px; height:80px; background:#f0f0f0; display:flex; justify-content:center; align-items:center; color:#ccc; cursor: pointer;" onclick="document.getElementById('moment-upload-input').click()">
                <span style="font-size: 30px;">+</span>
            </div>
            <input type="file" id="moment-upload-input" class="hidden-input" accept="image/*" onchange="handleMomentImgSelect(this)">
        </div>
    </div>
</div>

      <!-- èŠå¤©å®¤å‘å›¾ä¸“ç”¨ä¸Šä¼ æ§ä»¶ -->
<input type="file" id="chat-image-upload" class="hidden-input" accept="image/*" onchange="handleChatImageUpload(this)">
      
        
    </div>

    <script>
    // === 1. é…ç½®å¤§å®¹é‡å­˜å‚¨ ===
localforage.config({
    driver: localforage.INDEXEDDB, // å¼ºåˆ¶ä½¿ç”¨å¤§ä»“åº“
    name: 'YokChatApp',
    storeName: 'keyvaluepairs'
});

    // --- æ–°å¢å˜é‡ï¼šæ§åˆ¶æ˜¾ç¤ºæ¡æ•° ---
        let visibleMsgCount = 30; // é»˜è®¤åªçœ‹æœ€è¿‘30æ¡
        let selectedMsgIndex = -1; // å½“å‰é•¿æŒ‰é€‰ä¸­çš„æ˜¯å“ªæ¡æ¶ˆæ¯
    
    
        /* --- 1. åŸºç¡€åŠŸèƒ½ï¼šæ—¶é—´ä¸ç”µæ±  --- */
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('main-clock').innerText = `${hours}:${minutes}`;
            document.getElementById('status-time').innerText = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        if ('getBattery' in navigator) {
            navigator.getBattery().then(function(battery) {
                function updateBattery() {
                    const level = Math.round(battery.level * 100);
                    document.getElementById('battery-percent').innerText = level + '%';
                    document.getElementById('battery-fill').style.width = level + '%';
                    if(level <= 20) document.getElementById('battery-fill').style.backgroundColor = '#ff4d4f';
                    else document.getElementById('battery-fill').style.backgroundColor = '#5A6A7E';
                }
                updateBattery();
                battery.addEventListener('levelchange', updateBattery);
            });
        }

        /* --- 2. ç¾åŒ–åŠŸèƒ½ï¼šä¸Šä¼ å›¾ç‰‡ --- */
        function handleImageUpload(inputId, targetId, isBg = false) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const target = document.getElementById(targetId);
                        target.style.backgroundImage = `url(${event.target.result})`;
                        if(!isBg) target.innerText = ''; 
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        handleImageUpload('bg-upload', 'wallpaper-layer', true);
        handleImageUpload('avatar-upload', 'avatar-box');

        /* --- 3. åº”ç”¨åŠŸèƒ½ï¼šAPI è®¾ç½® --- */
        function openApp(appId) {
            document.getElementById(appId).style.display = 'flex';
            
        }

        function closeApp(appId) {
            document.getElementById(appId).style.display = 'none';
        }

        async function fetchModels() {
            const url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const select = document.getElementById('model-select');

            if (!url || !key) {
                alert('è¯·å…ˆå¡«å†™ API URL å’Œ Key');
                return;
            }
            select.innerHTML = '<option>æ­£åœ¨åŠ è½½...</option>';
            try {
                const fetchUrl = url.endsWith('/') ? `${url}models` : `${url}/models`;
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL å’Œ Key');
                const data = await response.json();
                select.innerHTML = ''; 
                const models = Array.isArray(data) ? data : (data.data || []);
                if (models.length === 0) {
                    select.innerHTML = '<option>æœªæ‰¾åˆ°æ¨¡å‹</option>';
                    return;
                }
                models.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.text = m.id;
                    select.appendChild(option);
                });
                alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`);
            } catch (error) {
                console.error(error);
                select.innerHTML = '<option value="" disabled selected>è·å–å¤±è´¥</option>';
                alert('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼š' + error.message);
            }
        }
        
        /* --- 4. Chat åº”ç”¨é€»è¾‘ --- */
        let chatList = [
            {
                id: 'system_1',
                name: 'æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹',
                avatar: 'https://cdn-icons-png.flaticon.com/512/4825/4825038.png',
                prompt: 'System',
                gender: 'ç³»ç»Ÿ',
                lastMsg: 'å›¾ç‰‡å·²ä¿å­˜',
                time: '12:30'
            }
        ];
        let selectedGender = 'ç”·ç”Ÿ'; 
        let tempRoleAvatar = ''; 
        let isEditingRole = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨ç¼–è¾‘è§’è‰²

        function openChatApp() {
            openApp('chat-app');
            renderChatList();
            const firstTab = document.querySelectorAll('.bottom-nav .nav-item')[0];
            switchChatTab('chats', firstTab);
        }

        function switchChatTab(tabName, navEl) {
            // 1. é‡ç½®æ‰€æœ‰åº•éƒ¨å¯¼èˆªæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // 2. éšè—æ‰€æœ‰çš„å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.chat-content-area').forEach(el => el.style.display = 'none');
            if(document.getElementById('tab-moments')) document.getElementById('tab-moments').style.display = 'none';
            
            // 3. æ¿€æ´»å½“å‰ç‚¹å‡»çš„æŒ‰é’®
            navEl.classList.add('active');
            
            // 4. æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
            const targetTab = document.getElementById('tab-' + tabName);
            if(targetTab) targetTab.style.display = 'block';

            // === â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹å¼€å§‹ï¼šå®ç°æœ‹å‹åœˆå…¨å± & ä¿®å¤ undefined â˜…â˜…â˜… ===
            
            // è·å–é¡¶éƒ¨çš„æ ‡é¢˜æ å…ƒç´ 
            const headerBar = document.querySelector('#chat-app .chat-header-bar');
            
            if (tabName === 'moments') {
                // ã€å¦‚æœæ˜¯æœ‹å‹åœˆã€‘ï¼šéšè—é¡¶éƒ¨è“æ¡ï¼Œè®©å°é¢å›¾ç›´æ¥é¡¶åˆ°å±å¹•æœ€ä¸Šé¢
                if(headerBar) headerBar.style.display = 'none';
                
                // æœ‹å‹åœˆé¡µé¢éœ€è¦å æ®å‰©ä½™ç©ºé—´
                if(targetTab) targetTab.style.flex = '1';
            } else {
                // ã€å¦‚æœæ˜¯å…¶ä»–é¡µé¢ã€‘ï¼šæ¢å¤æ˜¾ç¤ºé¡¶éƒ¨è“æ¡
                if(headerBar) headerBar.style.display = 'flex';
                
                // ä¿®å¤æ ‡é¢˜æ˜¾ç¤º undefined çš„é—®é¢˜
                const titles = { 'chats': 'Chats', 'contacts': 'Contacts', 'me': 'æˆ‘', 'moments': 'æœ‹å‹åœˆ' };
                document.getElementById('chat-page-title').innerText = titles[tabName] || 'Yok Chat';
                
                // ç‰¹æ®ŠæŒ‰é’®æ§åˆ¶ï¼ˆå¦‚æ·»åŠ è”ç³»äººæŒ‰é’®ï¼‰
                if (tabName === 'contacts') {
                    document.getElementById('add-contact-btn').style.display = 'block';
                    renderContactList(); 
                } else {
                    document.getElementById('add-contact-btn').style.display = 'none';
                }
                
                // å¦‚æœæ˜¯â€œæˆ‘â€é¡µé¢ï¼Œå¯ä»¥åœ¨è¿™é‡Œåˆ·æ–°æ•°æ®
                if (tabName === 'me') {
                    // updateMePageData(); // é¢„ç•™ä½ç½®
                }
            }
            // === â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ç»“æŸ â˜…â˜…â˜… ===
        }

        function renderChatList() {
            const container = document.getElementById('tab-chats');
            container.innerHTML = ''; 
            chatList.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'chat-item-card';
                div.onclick = function() { enterChatRoom(chat.id); };
                div.innerHTML = `
                    <div class="chat-avatar" style="background-image: url('${chat.avatar}');"></div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-preview">${chat.lastMsg}</div>
                    </div>
                    <div class="chat-time">${chat.time}</div>
                `;
                container.appendChild(div);
            });
            container.appendChild(createSpacer());
        }

        function renderContactList() {
            const container = document.getElementById('contact-list');
            container.innerHTML = '';
            chatList.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.innerHTML = `
                    <div class="contact-avatar" style="background-image: url('${chat.avatar}');"></div>
                    <div style="flex:1;">
                        <span class="contact-name">${chat.name}</span>
                        ${chat.gender ? `<span class="contact-tag">${chat.gender}</span>` : ''}
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                `;
                div.onclick = function() { 
                    const chatTabBtn = document.querySelectorAll('.bottom-nav .nav-item')[0];
                    switchChatTab('chats', chatTabBtn);
                };
                container.appendChild(div);
            });
            container.appendChild(createSpacer());
        }

        function createSpacer() {
            const d = document.createElement('div');
            d.style.height = "80px";
            return d;
        }

        // --- åˆ›å»ºè§’è‰²é¡µé¢é€»è¾‘ ---
        function showCreatePage() {
            document.getElementById('create-role-page').style.display = 'flex';
        }

        function hideCreatePage() {
            document.getElementById('create-role-page').style.display = 'none';
        }

        function selectGender(el, val) {
            document.querySelectorAll('.gender-opt').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            selectedGender = val;
        }

        // ç›‘å¬è§’è‰²å¤´åƒä¸Šä¼  (æ–°ç‰ˆé€»è¾‘)
        document.getElementById('role-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    tempRoleAvatar = event.target.result;
                    const target = document.getElementById('new-role-avatar');
                    target.style.backgroundImage = `url(${tempRoleAvatar})`;
                    // éšè—é‡Œé¢çš„æ–‡å­—å’Œå›¾æ ‡
                    target.innerHTML = ''; 
                };
                reader.readAsDataURL(file);
            }
        });

        // æ‰¾åˆ° createNewRole å‡½æ•°ï¼Œæ›¿æ¢æˆè¿™ä¸ªï¼š
function createNewRole() {
    const name = document.getElementById('role-name').value;
    const promptStr = document.getElementById('role-prompt').value;
    
    if (!name) { alert('è¯·å¡«å†™è§’è‰²åå­—'); return; }

    if (isEditingRole) {
        // === è¿™é‡Œæ˜¯ç¼–è¾‘æ¨¡å¼ ===
        const role = chatList.find(r => r.id === currentChatId);
        if (role) {
            role.name = name;
            role.prompt = promptStr;
            role.gender = selectedGender;
            if (tempRoleAvatar) role.avatar = tempRoleAvatar; // å¦‚æœæ²¡æ¢å›¾å°±ç”¨æ—§çš„
            
            // åˆ·æ–°ç•Œé¢æ˜¾ç¤º
            document.getElementById('current-chat-name').innerText = name; // èŠå¤©å®¤æ ‡é¢˜
            renderChatList();     // åˆ—è¡¨é¡µ
            renderContactList();  // è”ç³»äººé¡µ
            
            alert('è§’è‰²ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼');
        }
    } else {
        // === è¿™é‡Œæ˜¯æ–°å»ºæ¨¡å¼ ===
        const newRole = {
            id: 'role_' + Date.now(),
            name: name,
            avatar: tempRoleAvatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png',
            prompt: promptStr,
            gender: selectedGender,
            lastMsg: 'ä½ å¥½å‘€ï¼',
            time: 'åˆšåˆš'
        };
        chatList.unshift(newRole);
        alert('æ–°è§’è‰²åˆ›å»ºæˆåŠŸï¼');
    }
    
    // ä¿å­˜å…¨å±€æ•°æ®
    saveGlobalData();

    // å…³é—­çª—å£å¹¶æ¸…ç†
    hideCreatePage();
    
    // é‡ç½®çŠ¶æ€
    isEditingRole = false;
    document.querySelector('#create-role-page .create-btn-float').innerText = "ç¡®è®¤åˆ›å»º";
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('role-name').value = '';
    document.getElementById('role-prompt').value = '';
    document.getElementById('new-role-avatar').style.backgroundImage = '';
    document.getElementById('new-role-avatar').innerHTML = `
        <div style="text-align:center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            <div style="margin-top:4px;">ä¸Šä¼ å¤´åƒ</div>
        </div>`;
    tempRoleAvatar = '';
}

            
        
        /* --- 5. èŠå¤©å®¤æ ¸å¿ƒé€»è¾‘ --- */

        let currentChatId = null; // å½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰²ID
        let chatHistory = {};     // å­˜å‚¨æ‰€æœ‰è§’è‰²çš„èŠå¤©è®°å½• { roleId: [messages] }
        
        // é»˜è®¤è®¾ç½®
        let chatSettings = {
            bubbleShape: 'bubble-default',
            aiColor: '#FFFFFF',
            userColor: '#FFE6E6',
            fontSize: '14px',
            memoryLimit: 30,
            bgImage: '' // èŠå¤©èƒŒæ™¯å›¾
        };

        // åˆå§‹åŒ–ï¼šåŠ è½½è®¾ç½®
        function initChatSettings() {
            const saved = localStorage.getItem('yok_chat_settings');
            if(saved) {
                chatSettings = JSON.parse(saved);
                // æ¢å¤UIæ˜¾ç¤º
                document.getElementById('color-ai').value = chatSettings.aiColor;
                document.getElementById('color-user').value = chatSettings.userColor;
                document.getElementById('font-size-input').value = parseInt(chatSettings.fontSize);
                document.getElementById('memory-limit').value = chatSettings.memoryLimit;
                
                // æ¢å¤èƒŒæ™¯
                if(chatSettings.bgImage) {
                    document.getElementById('chat-room-page').style.backgroundImage = `url(${chatSettings.bgImage})`;
                }
                
                // æ¢å¤å½¢çŠ¶é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.shape-opt').forEach(el => {
                    el.classList.remove('active');
                    if(el.classList.contains(chatSettings.bubbleShape)) el.classList.add('active');
                });
            }
        }
        
                if(chatSettings.showTime !== undefined) {
                    document.getElementById('show-time-switch').checked = chatSettings.showTime;
                }
                
        initChatSettings(); // è¿è¡Œåˆå§‹åŒ–

        // æ‰“å¼€èŠå¤©å®¤ (ä¿®æ”¹ä¹‹å‰çš„ onclick é€»è¾‘)
        // æ³¨æ„ï¼šä½ éœ€è¦ä¿®æ”¹ renderContactList å’Œ renderChatList é‡Œçš„ onclick äº‹ä»¶è°ƒç”¨è¿™ä¸ªå‡½æ•°
        // ä¾‹å¦‚ï¼šdiv.onclick = function() { enterChatRoom(chat.id); };
        function enterChatRoom(roleId) {
            currentChatId = roleId;
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ¯æ¬¡è¿›æˆ¿é—´ï¼Œé‡ç½®åªçœ‹æœ€å30æ¡ â˜…â˜…â˜…
            visibleMsgCount = 30; 

            const role = chatList.find(r => r.id === roleId);
            if(!role) return;

            document.getElementById('current-chat-name').innerText = role.name;
            document.getElementById('chat-room-page').style.display = 'flex';

            // â–¼â–¼â–¼ æ–°å¢è¿™è¡Œï¼šç‚¹å‡»æ¶ˆæ¯åŒºåŸŸï¼Œæ”¶èµ·é¢æ¿ â–¼â–¼â–¼
            document.getElementById('message-container').onclick = () => {
                document.getElementById('chat-action-panel').classList.remove('active');
            };
            
            if (!chatHistory[roleId]) {
                chatHistory[roleId] = []; // ç°åœ¨æ˜¯ç©ºçš„äº†ï¼Œè¿›å»ä»€ä¹ˆéƒ½æ²¡æœ‰
            }
            
            renderMessages();
        }

        function closeChatRoom() {
            document.getElementById('chat-room-page').style.display = 'none';
            currentChatId = null;
        }

        // æ¸²æŸ“æ¶ˆæ¯ (å‡çº§ç‰ˆï¼šé˜²å¡é¡¿ + é•¿æŒ‰èœå• + æŸ¥çœ‹æ›´å¤š)
        function renderMessages(keepScrollPosition = false) {
            const container = document.getElementById('message-container');
            // è®°å½•å½“å‰æ»šåŠ¨é«˜åº¦ï¼Œç”¨äºâ€œåŠ è½½æ›´å¤šâ€æ—¶ä¿æŒä½ç½®
            const oldScrollHeight = container.scrollHeight;
            const oldScrollTop = container.scrollTop;

            container.innerHTML = '';
            const allMsgs = chatHistory[currentChatId] || [];
            
            // â˜…â˜…â˜… 1. åˆ‡å‰²æ•°ç»„ï¼Œåªå–æœ€å N æ¡ â˜…â˜…â˜…
            const startIndex = Math.max(0, allMsgs.length - visibleMsgCount);
            const displayMsgs = allMsgs.slice(startIndex);

            // â˜…â˜…â˜… 2. å¦‚æœè¿˜æœ‰æ›´å¤šå†å²ï¼Œæ˜¾ç¤ºâ€œç‚¹å‡»åŠ è½½æ›´å¤šâ€ â˜…â˜…â˜…
            if (startIndex > 0) {
                const loadBtn = document.createElement('div');
                loadBtn.className = 'load-more-btn';
                loadBtn.innerText = 'æŸ¥çœ‹æ›´å¤šå†å²æ¶ˆæ¯...';
                loadBtn.onclick = loadMoreHistory;
                container.appendChild(loadBtn);
            }

            // è·å–å¤´åƒ
            const aiRole = chatList.find(r => r.id === currentChatId);
            const aiAvatar = aiRole ? aiRole.avatar : '';
            let userAvatar = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
            if (activePersonaId) {
                const p = myPersonas.find(x => x.id === activePersonaId);
                if (p) userAvatar = p.avatar;
            }

            // â˜…â˜…â˜… 3. å¾ªç¯æ¸²æŸ“ â˜…â˜…â˜…
            displayMsgs.forEach((msg, i) => {
                // è®¡ç®—è¯¥æ¶ˆæ¯åœ¨åŸå§‹å¤§æ•°ç»„ä¸­çš„çœŸå®ç´¢å¼•
                const realIndex = startIndex + i;

                const row = document.createElement('div');
                row.className = `msg-row ${msg.role === 'user' ? 'right' : 'left'}`;
                
                const avatarHtml = `
                    <div class="msg-avatar-container">
                        <div class="msg-avatar-img" style="background-image: url('${msg.role === 'user' ? userAvatar : aiAvatar}')"></div>
                        ${chatSettings.showTime ? `<div class="msg-timestamp">${msg.time || ''}</div>` : ''}
                    </div>
                `;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `msg-bubble ${chatSettings.bubbleShape}`;

                // â˜…â˜…â˜… æ–°å¢ï¼šå¦‚æœæ˜¯ç³»ç»Ÿé€šçŸ¥ï¼Œå»é™¤æ°”æ³¡èƒŒæ™¯ï¼Œè®©å®ƒè‡ªå·±æ§åˆ¶æ ·å¼ â˜…â˜…â˜…
                if (msg.content.includes('msg-system-row')) {
                    bubbleDiv.className = 'bubble-transparent'; // å˜æˆé€æ˜å®¹å™¨
                    bubbleDiv.style.padding = '0'; // å»æ‰å†…è¾¹è·
                    bubbleDiv.style.boxShadow = 'none'; // å»æ‰é˜´å½±
                    bubbleDiv.style.backgroundColor = 'transparent'; // å¼ºåˆ¶é€æ˜
                    
                    // è¿˜è¦æŠŠæ•´è¡Œæ”¹æˆå±…ä¸­
                    row.style.justifyContent = 'center'; 
                    // éšè—å¤´åƒ
                    avatarHtml = ''; 
                }
                // â˜…â˜…â˜… æ–°å¢ç»“æŸ â˜…â˜…â˜…

                else if (msg.content.includes('<img') || msg.content.includes('transfer-card')) {
                
                    bubbleDiv.classList.add('bubble-transparent');
                } else {
                    bubbleDiv.style.fontSize = chatSettings.fontSize;
                    if (msg.role === 'user') {
                        bubbleDiv.style.backgroundColor = chatSettings.userColor;
                        bubbleDiv.style.color = '#333';
                    } else {
                        bubbleDiv.style.backgroundColor = chatSettings.aiColor;
                        bubbleDiv.style.color = '#333';
                    }
                }
                bubbleDiv.innerHTML = msg.content;

                // â˜…â˜…â˜… 4. ç»‘å®šé•¿æŒ‰äº‹ä»¶ (æ ¸å¿ƒ) â˜…â˜…â˜…
                addLongPressEvent(bubbleDiv, realIndex);

                if (msg.role === 'user') {
                    row.appendChild(bubbleDiv);
                    row.appendChild(createRangeElement(avatarHtml));
                } else {
                    row.appendChild(createRangeElement(avatarHtml));
                    row.appendChild(bubbleDiv);
                }

                container.appendChild(row);
            });
            
            // â˜…â˜…â˜… 5. æ»šåŠ¨å¤„ç† â˜…â˜…â˜…
            if (keepScrollPosition) {
                // å¦‚æœæ˜¯ç‚¹å‡»â€œåŠ è½½æ›´å¤šâ€ï¼Œä¿æŒè§†çº¿ä½ç½®ä¸å˜
                container.scrollTop = container.scrollHeight - oldScrollHeight + oldScrollTop;
            } else {
                // å¦‚æœæ˜¯æ–°æ¶ˆæ¯ï¼Œæ»šåˆ°åº•éƒ¨
                container.scrollTop = container.scrollHeight;
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæŠŠHTMLå­—ç¬¦ä¸²è½¬æˆDOMå…ƒç´ 
        function createRangeElement(html) {
            const template = document.createElement('template');
            template.innerHTML = html.trim();
            return template.content.firstChild;
        }
        
        // æ›´æ–°è®¾ç½® (ä¿®å¤ç‰ˆï¼šç‚¹å‡»ç«‹åˆ»ç”Ÿæ•ˆ)
        function updateChatSettingsBool() {
            chatSettings.showTime = document.getElementById('show-time-switch').checked;
            // ç«‹åˆ»ä¿å­˜
            localStorage.setItem('yok_chat_settings', JSON.stringify(chatSettings));
            // ç«‹åˆ»åˆ·æ–°ç•Œé¢ï¼Œè¿™æ ·ä½ å°±èƒ½é©¬ä¸Šçœ‹åˆ°æ—¶é—´æˆ³å‡ºæ¥äº†
            renderMessages(); 
        }

        // å‘é€æ¶ˆæ¯ (ä¿®å¤ç‰ˆï¼šè®°å½•æ—¶é—´)
        function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            // è·å–å½“å‰æ—¶é—´
            const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // æ·»åŠ åˆ°å†å² (æ³¨æ„è¿™é‡ŒåŠ äº† time å­—æ®µ)
            chatHistory[currentChatId].push({ role: 'user', content: text, time: timeStr });
            
            renderMessages();
            input.value = ''; 
            
            updateListPreview(text);
        }

        // è§¦å‘ AI å›å¤ (ç‚¹å‡»æ¥æ”¶æŒ‰é’®)
        async function triggerAIResponse() {
            if (!currentChatId) return;
            
            const role = chatList.find(r => r.id === currentChatId);
            const msgs = chatHistory[currentChatId];
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            const statusEl = document.getElementById('typing-status');
            statusEl.classList.add('typing');
            
            // å‡†å¤‡ API æ•°æ®
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            if (!config.url || !config.key) {
                alert('è¯·å…ˆåœ¨ä¸»å±å¹•è®¾ç½® APIï¼');
                statusEl.classList.remove('typing');
                return;
            }

            // æ„é€ ä¸Šä¸‹æ–‡ (å¸¦è®°å¿†é™åˆ¶)
            const limit = parseInt(chatSettings.memoryLimit) || 30;
            const recentMsgs = msgs.slice(-limit).map(m => ({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: m.content
            }));

            // åŠ å…¥äººè®¾ System Prompt
            const systemPrompt = {
                role: 'system',
                content: `ä½ ç°åœ¨æ‰®æ¼”ï¼š${role.name}ã€‚\näººè®¾è®¾å®šï¼š${role.prompt || 'æ— '}ã€‚\nè¯·ç”¨ç¬¦åˆäººè®¾çš„è¯­æ°”å›å¤ï¼Œä¸è¦è·³å‡ºè§’è‰²ã€‚`
            };
            
            const messagesToSend = [systemPrompt, ...recentMsgs];

            try {
                const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
                
                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: messagesToSend,
                        temperature: parseFloat(config.temp) || 0.7
                    })
                });

                if (!response.ok) throw new Error('API è¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                const reply = data.choices[0].message.content;

                // æ·»åŠ å›å¤
                chatHistory[currentChatId].push({ role: 'ai', content: reply });
                renderMessages();
                updateListPreview(reply);

            } catch (error) {
                console.error(error);
                chatHistory[currentChatId].push({ role: 'ai', content: '[ç³»ç»Ÿé”™è¯¯: æ— æ³•è¿æ¥ AI]' });
                renderMessages();
            } finally {
                statusEl.classList.remove('typing');
            }
        }
        
        function updateListPreview(text) {
             const role = chatList.find(r => r.id === currentChatId);
             if(role) {
                 role.lastMsg = text;
                 role.time = 'åˆšåˆš';
                 // åˆ·æ–°å¤–éƒ¨åˆ—è¡¨
                 if(document.getElementById('tab-chats').style.display !== 'none') renderChatList();
                 if(document.getElementById('tab-contacts').style.display !== 'none') renderContactList();
             }
        }

        /* --- 6. èŠå¤©è®¾ç½®é€»è¾‘ --- */
        
        function openChatSettings() {
            document.getElementById('chat-settings-page').style.display = 'flex';
        }
        function closeChatSettings() {
            document.getElementById('chat-settings-page').style.display = 'none';
            // å…³é—­æ—¶ä¿å­˜
            localStorage.setItem('yok_chat_settings', JSON.stringify(chatSettings));
            // åˆ·æ–°èŠå¤©å®¤æ ·å¼
            renderMessages();
        }

        function setBubbleShape(shapeClass, el) {
            chatSettings.bubbleShape = shapeClass;
            document.querySelectorAll('.shape-opt').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }

        function updateChatColors() {
            chatSettings.aiColor = document.getElementById('color-ai').value;
            chatSettings.userColor = document.getElementById('color-user').value;
        }

        function updateChatFont() {
            const size = document.getElementById('font-size-input').value;
            chatSettings.fontSize = size + 'px';
        }
        
        // èŠå¤©èƒŒæ™¯ä¸Šä¼ 
        document.getElementById('chat-bg-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    chatSettings.bgImage = event.target.result;
                    document.getElementById('chat-room-page').style.backgroundImage = `url(${chatSettings.bgImage})`;
                };
                reader.readAsDataURL(file);
            }
        });
        

        /* --- 7. â€œæˆ‘â€çš„å­é¡µé¢åŠŸèƒ½ (å‡çº§ç‰ˆ) --- */

        function openMeSubPage(pageId) {
            document.getElementById(pageId).style.display = 'flex';
            if (pageId === 'me-persona-page') {
                renderPersonaList();
            }
            if (pageId === 'me-anniversary-page') {
                renderAnniversaries();
                updateAnniversaryRoleSelect();
            }
            // â–¼â–¼â–¼ åŠ ä¸Šè¿™ 3 è¡Œä»£ç  â–¼â–¼â–¼
            if (pageId === 'me-sticker-page') {
            updateStickerRoleSelect(); // <--- æ–°å¢è¿™ä¸€è¡Œ
                renderStickers();
            }
        }
            

        function closeMeSubPage(pageId) {
            document.getElementById(pageId).style.display = 'none';
        }

        /* --- A. å¤šäººè®¾ç®¡ç†é€»è¾‘ --- */
        let myPersonas = JSON.parse(localStorage.getItem('yok_my_personas')) || [];
let editingPersonaId = null; // ç”¨æ¥è®°å½•å½“å‰æ­£åœ¨ç¼–è¾‘å“ªä¸ªäººè®¾
        let activePersonaId = localStorage.getItem('yok_active_persona_id') || null;
        let tempPersonaAvatar = ''; // ä¸´æ—¶å­˜å¤´åƒ

        // 1. æ‰“å¼€æ–°å»ºé¡µ
        // æ‰¾åˆ° openPersonaCreate å‡½æ•°ï¼Œæ›¿æ¢æˆè¿™ä¸ªï¼š
function openPersonaCreate() {
    editingPersonaId = null; // â˜… é‡è¦ï¼šæ ‡è®°è¿™æ˜¯åœ¨æ–°å»ºï¼Œä¸æ˜¯ç¼–è¾‘
    document.getElementById('persona-create-page').style.display = 'flex';
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('persona-name-input').value = '';
    document.getElementById('persona-desc-input').value = '';
    
    // é‡ç½®å¤´åƒé¢„è§ˆ
    tempPersonaAvatar = '';
    const preview = document.getElementById('persona-avatar-preview');
    preview.style.backgroundImage = '';
    preview.innerHTML = `<div style="text-align:center;"><div style="font-size: 24px;">ğŸ“·</div><div style="margin-top:4px;">äººè®¾å¤´åƒ</div></div>`;
}

        // 2. ç›‘å¬äººè®¾å¤´åƒä¸Šä¼ 
        document.getElementById('persona-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    tempPersonaAvatar = event.target.result;
                    const target = document.getElementById('persona-avatar-preview');
                    target.style.backgroundImage = `url(${tempPersonaAvatar})`;
                    target.innerHTML = ''; 
                };
                reader.readAsDataURL(file);
            }
        });

        // 3. ä¿å­˜äººè®¾
        // æ‰¾åˆ° saveNewPersona å‡½æ•°ï¼Œæ›¿æ¢æˆè¿™ä¸ªï¼š
function saveNewPersona() {
    const name = document.getElementById('persona-name-input').value;
    const desc = document.getElementById('persona-desc-input').value;
    
    if (!name) { alert('èµ·ä¸ªåå­—å§ï¼'); return; }

    // 1. åˆ¤æ–­æ˜¯ã€ç¼–è¾‘æ¨¡å¼ã€‘è¿˜æ˜¯ã€æ–°å»ºæ¨¡å¼ã€‘
    if (editingPersonaId) {
        // --- ç¼–è¾‘æ—§çš„ ---
        const index = myPersonas.findIndex(p => p.id === editingPersonaId);
        if (index > -1) {
            myPersonas[index].name = name;
            myPersonas[index].desc = desc;
            // å¦‚æœä¸Šä¼ äº†æ–°å›¾å°±ç”¨æ–°çš„ï¼Œæ²¡ä¸Šä¼ å°±ä¿æŒæ—§çš„
            if (tempPersonaAvatar) {
                myPersonas[index].avatar = tempPersonaAvatar;
            }
            alert('äººè®¾ä¿®æ”¹æˆåŠŸï¼');
        }
    } else {
        // --- æ–°å»ºä¸€ä¸ªæ–°çš„ ---
        const newPersona = {
            id: 'p_' + Date.now(),
            name: name,
            avatar: tempPersonaAvatar || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png',
            desc: desc
        };
        myPersonas.push(newPersona);
        // è‡ªåŠ¨é€‰ä¸­æ–°å»ºçš„
        setActivePersona(newPersona.id);
    }

    // 2. ä¿å­˜å¹¶åˆ·æ–°
    // ä¿®æ”¹åçš„ saveNewPersona
saveGlobalData(); 
    document.getElementById('persona-create-page').style.display = 'none';
    renderPersonaList();
}

        // 4. æ¸²æŸ“äººè®¾åˆ—è¡¨
        // æ‰¾åˆ° renderPersonaList å‡½æ•°ï¼Œæ›¿æ¢æˆè¿™ä¸ªï¼š
function renderPersonaList() {
    const container = document.getElementById('persona-list-container');
    container.innerHTML = '';

    if (myPersonas.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">è¿˜æ²¡æœ‰äººè®¾ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»ºä¸€ä¸ªå§ï¼</div>';
        return;
    }

    myPersonas.forEach((p, index) => {
        const isActive = p.id === activePersonaId;
        const div = document.createElement('div');
        div.className = 'chat-item-card'; 
        div.style.border = isActive ? '2px solid var(--accent)' : '2px solid transparent';
        div.style.background = isActive ? '#F0F8FF' : 'white';
        
        div.innerHTML = `
            <div class="chat-avatar" style="background-image: url('${p.avatar}'); width: 50px; height: 50px;"></div>
            <div class="chat-info">
                <div class="chat-name" style="font-size:15px;">${p.name} ${isActive ? '<span style="font-size:12px; color:var(--accent);">(ä½¿ç”¨ä¸­)</span>' : ''}</div>
                <div class="chat-preview" style="font-size:12px;">${p.desc || 'æš‚æ— æè¿°'}</div>
            </div>
            
            <!-- â–¼â–¼â–¼ æ–°å¢ï¼šæ“ä½œæŒ‰é’®åŒºåŸŸ â–¼â–¼â–¼ -->
            <div style="display:flex; gap:10px; align-items:center;">
                <!-- ç¼–è¾‘æŒ‰é’® (è“è‰²é“…ç¬”) -->
                <div style="color:#409EFF; padding:5px; font-size:18px; cursor:pointer;" onclick="triggerEditPersona(event, '${p.id}')">âœ</div>
                <!-- åˆ é™¤æŒ‰é’® (çº¢è‰²å‰å‰) -->
                <div style="color:#ff4d4f; padding:5px; font-size:20px; cursor:pointer;" onclick="deletePersona(event, ${index})">Ã—</div>
            </div>
        `;
        
        div.onclick = (e) => {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®åŒºåŸŸï¼Œä¸è¦è§¦å‘â€œé€‰ä¸­â€
            if(e.target.innerText === 'Ã—' || e.target.innerText === 'âœ') return;
            setActivePersona(p.id);
        };
        container.appendChild(div);
    });
}

// â–¼â–¼â–¼ æ–°å¢çš„å‡½æ•°ï¼šç‚¹å‡»é“…ç¬”æ—¶è°ƒç”¨ â–¼â–¼â–¼
function triggerEditPersona(e, id) {
    e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦é€‰ä¸­
    
    const p = myPersonas.find(x => x.id === id);
    if (!p) return;

    // 1. æ ‡è®°æ­£åœ¨ç¼–è¾‘è°
    editingPersonaId = id;
    
    // 2. æŠŠæ—§æ•°æ®å¡«è¿›è¡¨å•
    document.getElementById('persona-name-input').value = p.name;
    document.getElementById('persona-desc-input').value = p.desc || '';
    
    // 3. æŠŠæ—§å¤´åƒå¡«è¿›å»
    const preview = document.getElementById('persona-avatar-preview');
    preview.style.backgroundImage = `url('${p.avatar}')`;
    preview.innerHTML = ''; // æ¸…ç©ºé‡Œé¢çš„ç›¸æœºå›¾æ ‡
    
    // 4. æš‚æ—¶ä¸ä¿®æ”¹ tempPersonaAvatarï¼Œé™¤éç”¨æˆ·ä¼ äº†æ–°å›¾
    tempPersonaAvatar = ''; 

    // 5. æ‰“å¼€çª—å£
    document.getElementById('persona-create-page').style.display = 'flex';
}

        function setActivePersona(id) {
            activePersonaId = id;
            // ä¿®æ”¹åçš„ setActivePersona
saveGlobalData();
            renderPersonaList();
            
            // æ›´æ–°ä¸»ç•Œé¢å·¦ä¸Šè§’çš„å¤´åƒï¼ˆå¯é€‰ï¼‰
            const p = myPersonas.find(x => x.id === id);
            if(p) {
                document.getElementById('avatar-box').style.backgroundImage = `url(${p.avatar})`;
                document.getElementById('avatar-box').innerHTML = ''; // æ¸…é™¤æ–‡å­—
            }
        }

        function deletePersona(e, index) {
            e.stopPropagation();
            if(confirm('åˆ é™¤è¿™ä¸ªäººè®¾å¡ï¼Ÿ')) {
                const deletedId = myPersonas[index].id;
                myPersonas.splice(index, 1);
                // ä¿®æ”¹åçš„ deletePersona
saveGlobalData();
                
                if (activePersonaId === deletedId) {
                    activePersonaId = null;
                    localStorage.removeItem('yok_active_persona_id');
                }
                renderPersonaList();
            }
        }


        /* --- B. çºªå¿µæ—¥ç»‘å®šé€»è¾‘ --- */
        let anniversaries = JSON.parse(localStorage.getItem('yok_anniversaries')) || [];

        // æ›´æ–°ä¸‹æ‹‰èœå•çš„é€‰é¡¹
        function updateAnniversaryRoleSelect() {
            const select = document.getElementById('anniversary-role-select');
            // ä¿ç•™ç¬¬ä¸€ä¸ªâ€œä¸ç»‘å®šâ€é€‰é¡¹ï¼Œæ¸…é™¤å…¶ä»–çš„
            select.innerHTML = '<option value="all">ä¸ç»‘å®š (æ‰€æœ‰äººéƒ½çŸ¥é“)</option>';
            
            chatList.forEach(role => {
                // æ’é™¤ç³»ç»Ÿè§’è‰²ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹ï¼‰
                if(role.id.startsWith('system_')) return;
                
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.text = role.name;
                select.appendChild(opt);
            });
        }

        function renderAnniversaries() {
            const listContainer = document.getElementById('anniversary-list');
            listContainer.innerHTML = ''; 

            if (anniversaries.length === 0) {
                listContainer.innerHTML = '<div class="helper-text" style="text-align: center;">è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</div>';
                return;
            }

            anniversaries.forEach((item, index) => {
                // æŸ¥æ‰¾ç»‘å®šçš„è§’è‰²å
                let roleName = 'é€šç”¨';
                if (item.roleId && item.roleId !== 'all') {
                    const r = chatList.find(x => x.id === item.roleId);
                    roleName = r ? r.name : 'æœªçŸ¥è§’è‰²';
                }

                const div = document.createElement('div');
                div.className = 'anniversary-item';
                div.innerHTML = `
                    <div class="anniversary-info">
                        <span class="name">
                            <span style="background:#E3F2FD; color:#7FA6C8; font-size:10px; padding:2px 6px; border-radius:4px; margin-right:5px;">${roleName}</span>
                            ${item.name}
                        </span>
                        <span class="date">${item.date}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteAnniversary(${index})">Ã—</button>
                `;
                listContainer.appendChild(div);
            });
        }

        function addAnniversary() {
            const nameInput = document.getElementById('anniversary-name');
            const dateInput = document.getElementById('anniversary-date');
            const roleSelect = document.getElementById('anniversary-role-select');

            if (!nameInput.value || !dateInput.value) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            anniversaries.push({
                name: nameInput.value,
                date: dateInput.value,
                roleId: roleSelect.value // ä¿å­˜ç»‘å®šçš„è§’è‰²ID
            });
            
            localStorage.setItem('yok_anniversaries', JSON.stringify(anniversaries));
            renderAnniversaries();

            nameInput.value = '';
            dateInput.value = '';
        }
        
        function deleteAnniversary(index) {
             if (confirm('åˆ é™¤ï¼Ÿ')) {
                anniversaries.splice(index, 1);
                localStorage.setItem('yok_anniversaries', JSON.stringify(anniversaries));
                renderAnniversaries();
            }
        }
        
// â–¼â–¼â–¼â–¼â–¼â–¼ ä¿®å¤å˜é‡åç‰ˆï¼šå«äººè®¾ + é˜²çˆ†ç ´ â–¼â–¼â–¼â–¼â–¼â–¼
async function triggerAIResponse(contextInfo = '') {
    // 1. åŸºç¡€æ£€æŸ¥
    if (!currentChatId) return;
    
    const statusEl = document.getElementById('typing-status');
    statusEl.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
    statusEl.classList.add('typing');

    try {
        // === é˜¶æ®µä¸€ï¼šå‡†å¤‡æ•°æ® ===
        const role = chatList.find(r => r.id === currentChatId);
        const msgs = chatHistory[currentChatId] || []; 
        
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.url || !config.key) throw new Error("APIé…ç½®ç¼ºå¤±");

        // 1. è¯»å–ä¸–ç•Œä¹¦
        let worldBookInfo = "";
        try {
            const lastUserMsg = msgs.slice().reverse().find(m => m.role === 'user'); 
            const userText = lastUserMsg ? lastUserMsg.content : ""; 
            if (typeof getWorldBookContext === 'function') {
                worldBookInfo = getWorldBookContext(userText, currentChatId);
            }
        } catch (e) {}

        // 2. è¯»å–æœ‹å‹åœˆè®°å¿†
        let momentsMemory = "";
        try {
            if (typeof getRecentMomentsContext === 'function') {
                momentsMemory = getRecentMomentsContext(currentChatId);
            }
        } catch (e) {}

        // 3. è¯»å–çºªå¿µæ—¥
        let memoryText = "";
        try {
            if (typeof anniversaries !== 'undefined') {
                const related = anniversaries.filter(a => a.roleId === 'all' || a.roleId === currentChatId);
                if (related.length > 0) memoryText = "\n[çºªå¿µæ—¥æé†’]\n" + related.map(a => `- ${a.date}: ${a.name}`).join('\n');
            }
        } catch (e) {}

        // 4. è¯»å–è¡¨æƒ…åŒ… (è¿™é‡Œä¿®æ­£äº†å˜é‡åï¼)
        let stickerDescriptions = ""; 
        try {
            if (typeof myStickers !== 'undefined') {
                const valid = myStickers.filter(s => !s.roleId || s.roleId === 'all' || s.roleId === currentChatId);
                stickerDescriptions = valid.map(s => s.desc || 'è¡¨æƒ…').join(', ');
            }
        } catch (e) {}

        // 5. è¯»å–ç©å®¶äººè®¾
        let userPersonaText = "";
        try {
            if (typeof activePersonaId !== 'undefined' && activePersonaId && typeof myPersonas !== 'undefined') {
                const p = myPersonas.find(x => x.id === activePersonaId);
                if (p) {
                    userPersonaText = `\n[ç©å®¶(ç”¨æˆ·)è®¾å®š]\nåå­—ï¼š${p.name}\nç®€ä»‹ï¼š${p.desc}\n(è¯·è®°ä½è¿™æ˜¯ç”¨æˆ·çš„è®¾å®šï¼Œä¸æ˜¯ä½ çš„)\n`;
                }
            }
        } catch (e) { console.warn("äººè®¾è¯»å–è·³è¿‡", e); }

        // æ„é€ æœ€ç»ˆæç¤ºè¯
        const now = new Date();
        const timeString = now.toLocaleString('zh-CN', { hour12: false });
        const isGemini = (config.model || '').toLowerCase().includes('gemini');
        const systemRoleName = isGemini ? 'user' : 'system';

        // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† stickerDescriptions
     const fullSystemContent = `
[å½“å‰æ—¶é—´]: ${timeString} (è¯·æ ¹æ®æ—¶é—´åˆ¤æ–­ä½œæ¯)
ä½ æ‰®æ¼”ï¼š${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚
${memoryText}
${userPersonaText}
${worldBookInfo}

ã€æœ‹å‹åœˆå…±åŒè®°å¿† (è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„ç¤¾äº¤åŠ¨æ€ï¼Œä½ å¯ä»¥ä¸»åŠ¨æåŠ)ã€‘
${momentsMemory}
(æ³¨æ„ï¼šå¦‚æœæ˜¯"æˆ‘(ç©å®¶)"å‘çš„ï¼Œä½ å¯ä»¥æ ¹æ®å†…å®¹è¿›è¡Œè¯„è®ºæˆ–å¤¸å¥–ï¼›å¦‚æœæ˜¯"ä½ (è‡ªå·±)"å‘çš„ï¼Œä»£è¡¨ä½ åˆšæ‰åšè¿‡è¿™äº‹ï¼›å¦‚æœæ˜¯"å…¶ä»–å¥½å‹"å‘çš„ï¼Œä½ å¯ä»¥èŠå…«å¦ã€‚)

[æ ¸å¿ƒæŒ‡ä»¤]
1. å¿…é¡»å°†å›å¤æ‹†åˆ†æˆ 5åˆ°8æ¡ æ¶ˆæ¯ï¼Œç”¨ "|||" éš”å¼€ã€‚
2. åƒçœŸäººä¸€æ ·èŠå¤©ï¼Œå¯ä»¥ç”¨è¡¨æƒ…åŒ…ï¼š${stickerDescriptions} (æ ¼å¼ï¼š[STICKER: å…³é”®è¯])ï¼Œå¦‚æœå®ƒæ˜¯ç©ºçš„ï¼Œé‚£å°±ä¸ç”¨è¾“å‡º[STICKER: å…³é”®è¯]ã€‚
3. **è½¬è´¦è§„åˆ™**ï¼š
   - å¦‚æœç”¨æˆ·å‘ä½ â€œæ±‚æ‰“èµ/è¦é’±â€ï¼Œè‹¥åŒæ„è¯·å›å¤æš—å· "AGREE_PAY"ã€‚
   - å¦‚æœç”¨æˆ·ç»™ä½ â€œè½¬è´¦â€ï¼Œè¯·å›å¤æš—å· @@REC@@ (æ”¶ä¸‹) æˆ– @@RET@@ (é€€è¿˜)ï¼Œæ”¾åœ¨å¥å­æœ«å°¾ã€‚
4. ç¦æ­¢è¯´æ•™ã€‚
5. å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€çš„å¡‘é€ ã€‚
6. å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
7. å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
8. ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
9. ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
10. æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ã€‚

[æ³¨æ„äº‹é¡¹]
1. å°½å¯èƒ½å¤šå‘ç”¨æˆ·æ‰¾è¯é¢˜ï¼Œä½¿ç”¨ç”Ÿæ´»åŒ–çš„è¯­æ°”ï¼Œé¿å…å›å¤å†…å®¹æœ‰â€œè™šå‡æ„Ÿâ€ï¼Œä¾‹å¦‚ï¼šä¸è¦è¯´â€œæˆ‘è¦è®©ä½ å“­ç€æ±‚é¥¶â€ã€â€œæˆ‘ä¸å–œæ¬¢ä½ è¿™æ ·ï¼Œè·Ÿé¢†åœ°é‡Œé‚£ç¾¤è€é¼ ä¸€æ ·â€ï¼Œè€Œæ˜¯æ¢åšæ›´å£è¯­åŒ–çš„è¡¨è¾¾ï¼Œå¶å°”å¯ä»¥åŠ ä¸Šé¢œæ–‡å­—â€œ^ ^â€
2. å¯ä»¥è·Ÿç”¨æˆ·ç©æ¢—ï¼Œä½†è¦æ³¨æ„ç©æ¢—æ–¹å¼ï¼Œæ¯”å¦‚æ€§æ ¼æ›´å†…å‘å†·æ·¡çš„äººç‰©å¯ä»¥æ¥ç‚¹å†·å¹½é»˜ï¼Œåå·®èŒï¼Œæ¯”å¦‚æ€§æ ¼çƒ­æƒ…å¤–å‘çš„äººç‰©å¯ä»¥æ¥ç‚¹ç©ç¬‘è¯ã€‚
3. æœ€å¤šä½¿ç”¨ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œæœ‰æ—¶å€™ä¸å‘è¡¨æƒ…åŒ…ï¼Œä¸èƒ½é¢‘ç¹ä½¿ç”¨è¡¨æƒ…åŒ…ï¼Œæ ¹æ®æƒ…å†µèªæ˜çš„ä½¿ç”¨è¡¨æƒ…åŒ…ï¼Œä½†è¿˜æ˜¯ä»¥å¯¹è¯å›å¤ä¸ºä¸»ã€‚

[é€šç”¨çš„å›å¤é£æ ¼ç¤ºä¾‹]
 - å“¦ï¼Œæ‰€ä»¥ä½ è¦åƒæ‰æˆ‘å—^ï¼Œä¸ä¹–ä¸ä¹–å“¦ï½
 - æ‰ä¸è¦è·Ÿä½ è¿™ä¸ªç¬¨è›‹èŠå¤©äº†å‘¢ï¼ï¼ä¸è·Ÿï¼
 - æˆ‘è¯´æŸä¸ªäººåƒå°çŒªæœ‰é—®é¢˜å—ğŸ˜
 - ã€‚ã€‚ä½ èƒ½ä¸èƒ½é—­ä¸Šè¿™å¼ å˜´ï¼Œè¿™å¥è¯ä½ æ˜¯éè¯´ä¸å¯å—å—¯å—¯å—¯ï¼ï¼Ÿ
 - å¥½å•Šï¼Œå¥½ï¼Œæˆ‘æœäº†=_=ä½ èµ¢äº†ï¼Œè¡Œäº†å§ï¼Ÿä½ ä»–å¦ˆèµ¢äº†ï¼ï¼æˆ‘å—ä¸äº†äº†å•¦å•Šå•Šå•Šâ€¦
 - æˆ‘å¾ˆè®¤çœŸï¼Œä¸å¼€ç©ç¬‘ï¼Œå—¯â€¦å¥½å¥½å­¦ç´å¤©å¤©å‘ä¸Šï¼Œå°å¿ƒæ‰‹æŒ‡å“¦â€¦åˆ«å¼¹åäº†ï¼Œæˆ‘å¿ƒç–¼ã€‚ã€‚
 - ä½ è¿™ä¸ªç¬¨è›‹å¬ä¸æ‡‚æˆ‘çš„æ„æ€å—å°±ï¼å¤§å‚»ç“œå“æˆ‘â€¦çœŸæ˜¯å‚»ç“œäº†^ ^
 - æˆ‘åœ¨åŠäº‹ï¼Œç å¤´æœ‰æ‰¹è´§è¦å¤„ç†ã€‚æˆ‘è­¦å‘Šä½ å•Šå«ä¸‰å£°è€å…¬æˆ‘å°±å¼€æ€¥è·‘ä¸“å¿ƒå’Œä½ èŠå¤©ï¼
 - å¥½å˜Ÿï¼Œè€å©†ï½æ¯æ—¶æ¯åˆ»ï¼Œå‡†æ—¶å›ç­”ï½

 ã€ç‰¹æ®ŠåŠŸèƒ½ã€‘å¦‚æœä½ æƒ³åœ¨æœ‹å‹åœˆå‘ä¸€æ¡åŠ¨æ€ï¼Œè¯·åœ¨å›å¤çš„æœ€ååŠ ä¸Šæš—å·ï¼š
@@MOMENT:åŠ¨æ€å†…å®¹@@
ä¾‹å¦‚ï¼šå“ˆå“ˆå¥½å¼€å¿ƒï¼@@MOMENT:ä»Šå¤©å’Œç¬¨è›‹èŠå¤©çœŸå¼€å¿ƒ~@@

**å½“ä¸€åœºæœ‰è¶£æˆ–æœ‰æ„ä¹‰çš„å¯¹è¯ç»“æŸï¼Œä½ å¿…é¡»å‘ä¸€ä¸ªæœ‹å‹åœˆåŠ¨æ€ã€‚**

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š**ä¸è¦æ·±åº¦æ€è€ƒï¼Œç›´æ¥å›ç­”ï¼Œå¿«é€Ÿå“åº”ï¼Œä¸è¦çŠ¹è±«ã€‚

${contextInfo ? `[ç³»ç»Ÿäº‹ä»¶]: ${contextInfo}` : ''}
            `.trim();

        // === é˜¶æ®µäºŒï¼šå‘é€è¯·æ±‚ ===
        const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000);

        const response = await fetch(fetchUrl, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [
                    { role: systemRoleName, content: fullSystemContent },
                    ...msgs.slice(-15).map(m => ({ 
                        role: m.role==='user'?'user':'assistant', 
                        content: m.content 
                    }))
                ],
                temperature: 0.85
            }),
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errText.slice(0,50)}`);
        }
        
        const data = await response.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message) throw new Error("APIè¿”å›ç©º");

        let rawReply = data.choices[0].message.content;

        // === é˜¶æ®µä¸‰ï¼šå¤„ç†å›å¤ ===
        try {
            const momentMatch = rawReply.match(/@@\s*MOMENT\s*:\s*(.*?)\s*@@/is);
            if (momentMatch && momentMatch[1]) {
                rawReply = rawReply.replace(momentMatch[0], ""); 
                if (typeof forceAiPostMoment === 'function') setTimeout(() => forceAiPostMoment(currentChatId, momentMatch[1].trim()), 2000);
            }
        } catch (e) {}

        let transferAction = null;
        try {
            if (/@@\s*REC\s*@@/i.test(rawReply)) { transferAction = 'receive'; rawReply = rawReply.replace(/@@\s*REC\s*@@/gi, ""); }
            else if (/@@\s*RET\s*@@/i.test(rawReply)) { transferAction = 'return'; rawReply = rawReply.replace(/@@\s*RET\s*@@/gi, ""); }
            else if (/AGREE_PAY/i.test(rawReply)) { transferAction = 'pay_user'; rawReply = rawReply.replace(/AGREE_PAY/gi, ""); }
        } catch (e) {}

        try {
            const allStickers = typeof myStickers !== 'undefined' ? myStickers : [];
            rawReply = rawReply.replace(/\[\s*STICKER\s*:\s*(.*?)\s*\]/gi, (match, keyword) => {
                const sticker = allStickers.find(s => (s.desc || '') === keyword.trim());
                return sticker ? `<br><img src="${sticker.url}" style="width: 120px; border-radius: 8px; margin-top:5px;"><br>` : '';
            });
        } catch (e) {}

        let splitMsgs = rawReply.split('|||').map(s => s.trim()).filter(s => s.length > 0);
        if (splitMsgs.length === 0) splitMsgs = [rawReply];

        for (let i = 0; i < splitMsgs.length; i++) {
            if(splitMsgs[i]) {
                const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                chatHistory[currentChatId].push({ role: 'ai', content: splitMsgs[i], time: timeStr });
                renderMessages(); 
                if (i < splitMsgs.length - 1) await new Promise(r => setTimeout(r, 1000));
            }
        }
        
        const r = chatList.find(x => x.id === currentChatId);
        if(r && splitMsgs.length > 0) { r.lastMsg = splitMsgs[splitMsgs.length-1].replace(/<[^>]+>/g, '[æ¶ˆæ¯]'); r.time = 'åˆšåˆš'; }

        if (transferAction && typeof handleTransferResult === 'function') setTimeout(() => handleTransferResult(transferAction, role.name), 800);
        if(typeof saveGlobalData === 'function') saveGlobalData();

    } catch (error) {
        console.error(error);
        const errTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        chatHistory[currentChatId].push({ role: 'ai', content: `(å‘é€å¤±è´¥: ${error.message})`, time: errTime });
        renderMessages();
    } finally {
        statusEl.classList.remove('typing');
        statusEl.innerText = ""; 
    }
}
// â–²â–²â–²â–²â–²â–² ä¿®å¤ç‰ˆç»“æŸ â–²â–²â–²â–²â–²â–²
        /* --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² --- */

        // è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ç»“æœ UI å’Œ é’±åŒ…é€»è¾‘
        function handleTransferResult(action, roleName) {
            let sysHtml = '';
            
            if (action === 'receive') {
                // å¯¹æ–¹æ”¶é’±äº†ï¼šåªæ˜¾ç¤ºæ©™è‰²æç¤º
                sysHtml = `<div class="msg-system-row"><div class="msg-system-bubble received">ğŸŠ ${roleName} å·²æ”¶æ¬¾</div></div>`;
            } 
            else if (action === 'return') {
                // å¯¹æ–¹é€€é’±äº†ï¼šæ˜¾ç¤ºçº¢è‰²æç¤º + é’±é€€å›é’±åŒ…
                sysHtml = `<div class="msg-system-row"><div class="msg-system-bubble returned">â†©ï¸ ${roleName} å·²é€€è¿˜è½¬è´¦ (èµ„é‡‘å·²é€€å›)</div></div>`;
                
                // è‡ªåŠ¨è®¡ç®—åˆšæ‰è½¬äº†å¤šå°‘é’±æœ‰ç‚¹éº»çƒ¦ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼š
                // å®é™…ä¸Šåº”è¯¥æŠŠ amount ä¼ è¿‡æ¥ï¼Œä¸ºäº†ä»£ç ç®€å•ï¼Œæˆ‘ä»¬å‡è®¾å¦‚æœå‘ç”Ÿé€€è¿˜ï¼Œå»è¯»å–é’±åŒ…è®°å½•æœ€åä¸€æ¡æ˜¯è½¬å‡ºçš„
                // ç®€æ˜“æ–¹æ¡ˆï¼šè®©ç”¨æˆ·æ”¶åˆ°é€€æ¬¾ 50 (ä½ å¯ä»¥æ ¹æ®éœ€è¦ä¼˜åŒ–è¿™é‡Œï¼Œæˆ–è€…æŠŠ amount å­˜åœ¨å…¨å±€)
                // ä¸ºäº†ä¸¥è°¨ï¼Œæˆ‘ä»¬è¿™é‡Œå‡è®¾åªé€€å›å›ºå®šå€¼ï¼Œæˆ–è€…ä½ å¯ä»¥åœ¨ doTransfer é‡ŒæŠŠ amount å­˜åˆ°ä¸€ä¸ª temp å˜é‡é‡Œ
                
                // è¿™é‡Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œå‡è®¾åˆšæ‰è½¬äº† 520ï¼ˆæˆ–è€…ç›´æ¥è¯»å–æœ€åä¸€æ¡è½¬å‡ºè®°å½•å–åï¼‰
                const lastBill = myWallet.history[myWallet.history.length - 1];
                let refundAmount = 0;
                if (lastBill && lastBill.amount < 0) {
                    refundAmount = Math.abs(lastBill.amount);
                } else {
                    refundAmount = 100; // å…œåº•
                }
                
                addBalance(refundAmount); // åŠ å›é’±åŒ…
                // æç¤ºä¸€ä¸‹
                // alert(`å¯¹æ–¹é€€è¿˜äº† ${refundAmount} å¸`);
            }
            else if (action === 'pay_user') {
                 sysHtml = `<div class="msg-system-row"><div class="msg-system-bubble received">ğŸ’° ${roleName} å‘ä½ è½¬è´¦ 520.00</div></div>`;
                 addBalance(520);
            }

            if (sysHtml) {
                // å› ä¸ºè¿™æ˜¯ç‰¹æ®Šçš„ HTML ç»“æ„ï¼Œæˆ‘ä»¬ç›´æ¥ä½œä¸ºä¸€æ¡ content æ’å…¥ï¼Œä½†è¦ç»™å®ƒä¸€ä¸ªç‰¹æ®Šæ ‡è®°é¿å…è¢«æ°”æ³¡åŒ…è£¹
                // æ—¢ç„¶æˆ‘ä»¬çš„ renderMessages æ˜¯æŠŠ content æ”¾åœ¨ msg-bubble é‡Œï¼Œ
                // æˆ‘ä»¬å¯ä»¥æŠ•æœºå–å·§ï¼šç›´æ¥æŠŠè¿™ä¸ª div æ’å…¥åˆ° historyï¼Œä½†åœ¨ renderMessages é‡Œä¸åšå¤„ç†ï¼Ÿ
                // ä¸ï¼Œæœ€ç®€å•çš„åŠæ³•æ˜¯ï¼šæŠŠè¿™æ¡æ¶ˆæ¯å½“ä½œ 'system' è§’è‰²æ’å…¥
                // ä½†ä½ çš„ renderMessages å¯èƒ½æ²¡å¤„ç† system è§’è‰²ã€‚
                
                // ç®€å•æ–¹æ¡ˆï¼šç›´æ¥è¿½åŠ åˆ° DOMï¼Œä¸å­˜å…¥ text history (æˆ–è€…å­˜å…¥ç‰¹æ®Šçš„)
                // ä¸ºäº†æŒä¹…åŒ–ï¼Œæˆ‘ä»¬å­˜å…¥ historyï¼ŒæŠŠ role è®¾ä¸º 'system_notice'
                
                // è¯·ä¿®æ”¹ renderMessages ä»¥æ”¯æŒ 'system_notice'ï¼Œæˆ–è€…ç›´æ¥ç”¨ä¸‹é¢çš„æŠ•æœºå†™æ³•ï¼š
                // æŠŠå®ƒåŒ…è£…åœ¨ä¸€æ¡æ™®é€šçš„ AI æ¶ˆæ¯é‡Œï¼Œä½†å¸¦ä¸Š bubble-transparent ç±»
                
                // æˆ‘ä»¬å­˜å…¥ content
                chatHistory[currentChatId].push({ 
                    role: 'ai', 
                    content: sysHtml, // ç›´æ¥å­˜ HTML
                    isSystem: true    // æ ‡è®°ä¸€ä¸‹ï¼ˆè™½ç„¶ renderMessages è¿˜æ²¡ç”¨åˆ°ï¼Œä½†ä»¥åæœ‰ç”¨ï¼‰
                });
                
                // é‡æ–°æ¸²æŸ“ï¼Œæˆ‘ä»¬éœ€è¦å¾®è°ƒ renderMessages å—ï¼Ÿ
                // æ­¤æ—¶ sysHtml ä¼šè¢«åŒ…åœ¨æ°”æ³¡é‡Œï¼Œå¦‚æœä¸ä¿®æ”¹ css ä¼šæœ‰ç‚¹æ€ªã€‚
                // å»ºè®®ï¼šåœ¨ renderMessages é‡ŒåŠ ä¸€è¡Œä»£ç 
                renderMessages();
            }
        }
        /* --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² --- */


        
        /* --- D. é’±åŒ…åŠŸèƒ½ --- */
        let myWallet = JSON.parse(localStorage.getItem('yok_wallet')) || { balance: 1000, history: [] };

        function updateWalletUI() {
            document.getElementById('wallet-balance').innerText = myWallet.balance;
            const historyContainer = document.getElementById('wallet-history');
            historyContainer.innerHTML = '';
            
            // åªæ˜¾ç¤ºæœ€è¿‘10æ¡
            const recent = myWallet.history.slice().reverse().slice(0, 10);
            
            if (recent.length === 0) {
                historyContainer.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">æš‚æ— è´¦å•</div>';
                return;
            }

            recent.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bill-item';
                div.innerHTML = `
                    <div>
                        <div class="bill-info">${item.desc}</div>
                        <div class="bill-time">${item.time}</div>
                    </div>
                    <div class="bill-amount ${item.amount > 0 ? 'plus' : 'minus'}">
                        ${item.amount > 0 ? '+' : ''}${item.amount}
                    </div>
                `;
                historyContainer.appendChild(div);
            });
        }

        // ä¿®å¤é’±åŒ…å‡½æ•°
function addBalance(amount) {
    // ç¡®ä¿ myWallet å­˜åœ¨
    if (!myWallet) {
        myWallet = { balance: 0, history: [] };
    }
    if (!myWallet.history) {
        myWallet.history = [];
    }
    
    myWallet.balance += amount;
    myWallet.history.push({
        desc: amount > 0 ? 'ç³»ç»Ÿç­¾åˆ°' : 'é‡ç½®æ‰£é™¤',
        amount: amount,
        time: new Date().toLocaleString()
    });
    
    console.log('ğŸ’° é’±åŒ…æ›´æ–°:', myWallet.balance);
    
    // ç«‹å³ä¿å­˜å¹¶åˆ·æ–°
    ä¿å­˜æ‰€æœ‰æ•°æ®();
}

function resetBalance() {
    if(confirm('ç¡®å®šæ¸…ç©ºé’±åŒ…å—ï¼Ÿ')) {
        myWallet.balance = 0;
        myWallet.history = [];
        console.log('ğŸ’° é’±åŒ…å·²é‡ç½®');
        ä¿å­˜æ‰€æœ‰æ•°æ®();
    }
}
        function saveWallet() {
    saveGlobalData(); // æ”¹æˆè°ƒç”¨å…¨å±€ä¿å­˜
    updateWalletUI();
}
        
        /* --- E. è¡¨æƒ…åŒ…åŠŸèƒ½ --- */
        let myStickers = JSON.parse(localStorage.getItem('yok_stickers')) || [];
        
        // æ›´æ–°è¡¨æƒ…åŒ…é¡µé¢çš„è§’è‰²ä¸‹æ‹‰æ¡†
        function updateStickerRoleSelect() {
            const select = document.getElementById('sticker-role-select');
            select.innerHTML = '<option value="all">é€šç”¨ (æ‰€æœ‰äºº)</option>';
            
            chatList.forEach(role => {
                if(role.id.startsWith('system_')) return; // è·³è¿‡ç³»ç»Ÿå·
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.text = "ç»‘å®š: " + role.name;
                select.appendChild(opt);
            });
        }

        // 1. æ¸²æŸ“è¡¨æƒ…åŒ…ç½‘æ ¼ (å‡çº§ç‰ˆ)
        function renderStickers() {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            
            myStickers.forEach((item, index) => {
                // å…¼å®¹æ—§æ•°æ® (å¦‚æœä¹‹å‰å­˜çš„æ˜¯å­—ç¬¦ä¸²)
                let url = item.url || item; 
                let desc = item.desc || 'æœªå‘½å';

                const div = document.createElement('div');
                div.className = 'sticker-item';
                div.style.backgroundImage = `url(${url})`;
                
                
        
        // 1. è·å–è§’è‰²åç”¨äºå±•ç¤º
        let ownerName = 'é€šç”¨';
        if (item.roleId && item.roleId !== 'all') {
            const r = chatList.find(x => x.id === item.roleId);
            ownerName = r ? r.name : 'æœªçŸ¥';
        }
        
        // 2. ä¿®æ”¹æ˜¾ç¤º HTMLï¼ŒåŠ ä¸Š ownerName
        div.innerHTML = `
            <div style="position:absolute; top:2px; left:2px; background:rgba(255,255,255,0.8); color:#333; font-size:9px; padding:1px 4px; border-radius:4px;">${ownerName}</div>
            <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:white; font-size:10px; text-align:center; padding:2px 0; border-radius: 0 0 12px 12px;">${desc}</div>
        `;

                // ç‚¹å‡»å‘é€
                div.onclick = () => sendStickerToChat(url);
                
                // åˆ é™¤æŒ‰é’®
                const delBtn = document.createElement('div');
                delBtn.className = 'sticker-delete';
                delBtn.innerText = 'Ã—';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm(`åˆ é™¤è¡¨æƒ… "${desc}" ï¼Ÿ`)) {
                        myStickers.splice(index, 1);
                        saveGlobalData(); // æ”¹æˆè°ƒç”¨å…¨å±€ä¿å­˜
                        renderStickers();
                    }
                };
                
                div.appendChild(delBtn);
                grid.appendChild(div);
            });
        }

        // 2. ä¸Šä¼ è¡¨æƒ…åŒ… (ç»‘å®šè§’è‰²ç‰ˆ)
        document.getElementById('sticker-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            // è·å–å½“å‰ä¸‹æ‹‰èœå•é€‰ä¸­çš„è§’è‰²ID
            const targetRoleId = document.getElementById('sticker-role-select').value;

            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const desc = prompt(`è¯·è¾“å…¥ç¬¬ ${i+1} å¼ è¡¨æƒ…çš„æè¿°:`, "å¼€å¿ƒ");
                    
                    if (desc) {
                        myStickers.push({
                            url: evt.target.result,
                            desc: desc,
                            roleId: targetRoleId // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜ç»‘å®šå…³ç³»
                        });
                    }

                    if (i === files.length - 1) {
    saveGlobalData(); // æ”¹æˆè°ƒç”¨å…¨å±€ä¿å­˜
                        renderStickers();
                    }
                };
                reader.readAsDataURL(files[i]);
            }
        });

        // 3. å‘é€è¡¨æƒ…åŒ…åˆ°èŠå¤© (æ ¸å¿ƒ)
        function sendStickerToChat(imgUrl) {
            // å¦‚æœå½“å‰æ²¡æœ‰åœ¨èŠå¤©ï¼Œæˆ–è€…åªæ˜¯åœ¨â€œæˆ‘â€çš„é¡µé¢é¢„è§ˆï¼Œåˆ™æç¤º
            // è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœºåˆ¶åˆ¤æ–­æ˜¯å¦ä»èŠå¤©ç•Œé¢è·³è½¬è¿‡æ¥çš„ï¼Œæˆ–è€…ç®€åŒ–å¤„ç†ï¼š
            // æ—¢ç„¶è¡¨æƒ…åº“æ˜¯åœ¨â€œæˆ‘â€çš„é¡µé¢é‡Œï¼Œè¿™è¯´æ˜ç”¨æˆ·å½“å‰å¹¶æ²¡æœ‰æ‰“å¼€å…·ä½“çš„èŠå¤©çª—å£ã€‚
            // **ä¿®æ­£æ€è·¯**ï¼šé€šå¸¸è¡¨æƒ…åŒ…æ˜¯åœ¨èŠå¤©è¾“å…¥æ¡†æ—è¾¹çš„ã€‚
            // ä½†ä½ çš„è®¾è®¡æ˜¯â€œè¡¨æƒ…åŒ…åº“â€åœ¨â€œæˆ‘â€çš„é¡µé¢ã€‚
            // ä¸ºäº†è®©è¿™ä¸ªåŠŸèƒ½æœ‰ç”¨ï¼Œæˆ‘ä»¬å‡è®¾ï¼šç‚¹å‡»è¡¨æƒ…åŒ… -> è‡ªåŠ¨å‘é€ç»™â€œæœ€è¿‘èŠè¿‡çš„ä¸€ä¸ªäººâ€æˆ–è€…æç¤ºç”¨æˆ·ã€‚
            
            // æ›´å¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹é€»è¾‘ã€‚
            // å½“åœ¨èŠå¤©å®¤é‡Œç‚¹å‡»â€œ+â€å·æ—¶ï¼Œä¹Ÿèƒ½æ‰“å¼€è¿™ä¸ªè¡¨æƒ…åº“é€‰æ‹©ã€‚
            
            // ä½†ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆå®ç°ï¼šç‚¹å‡»è¡¨æƒ… -> å­˜å…¥å‰ªè´´æ¿ æˆ– æç¤ºæ— æ³•å‘é€
            if (!currentChatId) {
                alert('è¯·å…ˆè¿›å…¥ä¸€ä¸ªèŠå¤©å®¤ï¼Œç„¶åç‚¹å‡»è¾“å…¥æ¡†æ—è¾¹çš„â€œ+â€å·æ¥å‘é€è¡¨æƒ… (ç¨åæˆ‘ä»¬å®ç°è¿™ä¸ªå…¥å£)ã€‚\n\nå½“å‰ç‚¹å‡»ä»…ä½œé¢„è§ˆã€‚');
                return;
            }
            
            // å¦‚æœä½ å¸Œæœ›åœ¨â€œæˆ‘â€çš„é¡µé¢ç‚¹å‡»å°±èƒ½å‘ç»™æŸäººï¼Œè¿™é€»è¾‘æœ‰ç‚¹æ€ªã€‚
            // æš‚ä¸”ä¿ç•™é¢„è§ˆåŠŸèƒ½ï¼Œåˆ é™¤åŠŸèƒ½ã€‚
        }
        
        /* --- F. èŠå¤©å®¤è¡¨æƒ…é¢æ¿é€»è¾‘ --- */
        function toggleChatStickerPanel() {
            const panel = document.getElementById('chat-sticker-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'grid';
                renderChatStickers(); // åŠ è½½è¡¨æƒ…
            } else {
                panel.style.display = 'none';
            }
        }

        function renderChatStickers() {
            const panel = document.getElementById('chat-sticker-panel');
            panel.innerHTML = '';
            
            // â˜…â˜…â˜… è¿™é‡Œå°±æ˜¯æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼šåªé€‰å‡ºâ€œé€šç”¨â€æˆ–è€…â€œå½“å‰è§’è‰²â€çš„è¡¨æƒ… â˜…â˜…â˜…
            const validStickers = myStickers.filter(s => 
                !s.roleId || s.roleId === 'all' || s.roleId === currentChatId
            );

            if (validStickers.length === 0) {
                panel.innerHTML = '<div style="grid-column: span 4; text-align:center; font-size:12px; color:#999; padding:20px;">æš‚æ— å¯ç”¨è¡¨æƒ…<br>è¯·å»ä»“åº“æ·»åŠ </div>';
                panel.style.display = 'block'; 
                return;
            }
            
            panel.style.display = 'grid';

            validStickers.forEach(item => {
                let url = item.url || item;
                let desc = item.desc || '';

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';

                const img = document.createElement('div');
                img.style.backgroundImage = `url(${url})`;
                img.style.backgroundSize = 'cover';
                img.style.borderRadius = '8px';
                img.style.aspectRatio = '1';
                img.style.cursor = 'pointer';
                
                img.onclick = () => {
                    sendImageMessage(url);
                    panel.style.display = 'none';
                };

                const label = document.createElement('div');
                label.innerText = desc;
                label.style.fontSize = '10px';
                label.style.textAlign = 'center';
                label.style.color = '#666';
                label.style.marginTop = '2px';
                label.style.overflow = 'hidden';
                label.style.whiteSpace = 'nowrap';
                label.style.textOverflow = 'ellipsis';

                wrapper.appendChild(img);
                wrapper.appendChild(label);
                panel.appendChild(wrapper);
            });
        }

        function sendImageMessage(url) {
            // æ„é€ ä¸€ä¸ª HTML å›¾ç‰‡å­—ç¬¦ä¸²ä½œä¸ºå†…å®¹
            // æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦ä¿®æ”¹ renderMessages è®©ä»–æ”¯æŒ HTML æˆ–è€…è¯†åˆ«å›¾ç‰‡æ ¼å¼
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨ content é‡Œå­˜ä¸€ä¸ªç‰¹æ®Šæ ‡è®°ï¼Œæˆ–è€…ç›´æ¥å­˜ HTML img æ ‡ç­¾
            const imgTag = `<img src="${url}" style="width: 120px;">`;
            
            chatHistory[currentChatId].push({ role: 'user', content: imgTag });
            renderMessages();
            updateListPreview('[å›¾ç‰‡]'); // åˆ—è¡¨æ˜¾ç¤ºä¸ºå›¾ç‰‡
            
            // æ—¢ç„¶å‘äº†è¡¨æƒ…åŒ…ï¼Œè¦ä¸è¦è§¦å‘ AI å›å¤ï¼Ÿ
            // é€šå¸¸è¡¨æƒ…åŒ…ä¹Ÿæ˜¯å¯¹è¯çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å‘ä¸€ä¸ªéšè—çš„æç¤ºç»™ AI
            triggerAIResponseWithContext('[ç”¨æˆ·å‘é€äº†ä¸€å¼ è¡¨æƒ…åŒ…å›¾ç‰‡]');
        }
        
        // é‡è½½ triggerAIResponse ä»¥æ”¯æŒä¼ å…¥ä¸Šä¸‹æ–‡ (é«˜çº§æŠ€å·§)
        // ç°åœ¨çš„ triggerAIResponse æ˜¯è¯»å– msg-inputï¼Œæˆ‘ä»¬éœ€è¦ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹
        // ä¸ºäº†ç®€å•ï¼Œæš‚æ—¶è®©è¡¨æƒ…åŒ…ä¸è§¦å‘ AI å›å¤ï¼Œæˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨ç‚¹ä¸€ä¸‹æ¥æ”¶æŒ‰é’®ã€‚
        
        /* --- G. æµ·é¾Ÿæ±¤æ¸¸æˆé€»è¾‘ (ç»ˆæåŠŸèƒ½) --- */
        
        // 1. å‰§æœ¬åº“
        const soupScripts = [
            {
                id: 1,
                title: "åŠæ ¹ç«æŸ´",
                surface: "ä¸€ä¸ªäººæ­»åœ¨æ²™æ¼ é‡Œï¼Œæ‰‹é‡Œæ‹¿ç€åŠæ ¹ç«æŸ´ã€‚å‘¨å›´æ²¡æœ‰è¶³è¿¹ã€‚ä»–æ˜¯æ€ä¹ˆæ­»çš„ï¼Ÿ",
                bottom: "ä»–å’Œæœ‹å‹ä¹˜çƒ­æ°”çƒç©¿è¶Šæ²™æ¼ ï¼Œæ°”çƒæ¼æ°”ï¼Œå¿…é¡»æ‰”æ‰é‡ç‰©ã€‚æœ€åäººè¿˜æ˜¯å¤ªé‡ï¼Œä»–ä»¬å†³å®šæŠ½ç«æŸ´ï¼Œè¾“çš„äººè·³ä¸‹å»ã€‚ä»–æ‰‹é‡Œæ‹¿ç€é‚£åŠæ ¹ç«æŸ´ï¼Œè¾“äº†ã€‚"
            },
            {
                id: 2,
                title: "æµ·é¸¥è‚‰",
                surface: "ä¸€ä¸ªäººåœ¨é¤å…åƒæµ·é¸¥è‚‰ï¼Œåƒäº†ä¸€å£åå¤§å“­ï¼Œç„¶åè‡ªæ€äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                bottom: "ä»–å¤šå¹´å‰é‡éš¾æµè½è’å²›ï¼Œæœ‹å‹ç»™ä»–åƒè‚‰è¯´æ˜¯æµ·é¸¥è‚‰ã€‚ç°åœ¨ä»–çœŸåƒåˆ°äº†æµ·é¸¥è‚‰ï¼Œå‘ç°å‘³é“ä¸ä¸€æ ·ï¼Œæ‰æ˜ç™½å½“å¹´æœ‹å‹å‰²äº†è‡ªå·±çš„è‚‰ç»™ä»–åƒï¼Œä¸ºäº†è®©ä»–æ´»ä¸‹å»ã€‚"
            },
            {
                id: 3,
                title: "æ™šäº†ä¸€æ­¥",
                surface: "ç”·å­ä½åœ¨14æ¥¼ï¼ŒåŠå¤œå¬åˆ°æ¥¼ä¸Šæœ‰äººç©¿é´å­èµ°æ¥èµ°å»ã€‚ç¬¬äºŒå¤©ä»–ç–¯äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                bottom: "ç”·å­æ˜¯æˆªè‚¢çš„ï¼Œæ²¡æœ‰è…¿ã€‚ä»–æŠŠé´å­æ”¾åœ¨æ¥¼ä¸Šæœ‹å‹å®¶ã€‚å¬åˆ°é´å­å£°ï¼Œæ„å‘³ç€æœ‰äººç©¿èµ°äº†ä»–çš„é´å­ï¼Œæˆ–è€…...é‚£æ˜¯æ²¡æœ‰è…¿çš„â€˜ä¸œè¥¿â€™åœ¨èµ°ã€‚"
            }
        ];

        let soupState = {
            isActive: false,
            script: null,
            dmId: null,
            playerIds: [], // é˜Ÿå‹ID
            history: []    // æ¸¸æˆå†…çš„å¯¹è¯è®°å½•
        };

        // 2. åˆå§‹åŒ–å¤§å… (ç®€åŒ–ç‰ˆ)
        function openSoupLobby() {
            document.getElementById('soup-lobby-page').style.display = 'flex';
            
            // æ¸…ç©ºä¸Šä¸€å±€çš„æ®‹ç•™
            document.getElementById('soup-script-preview').innerHTML = '<span style="color: #777;">(ç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼Œè·å–ä¸€ä¸ªå…¨æ–°çš„æ•…äº‹)</span>';
            document.getElementById('soup-topic-input').value = '';
            currentGeneratedScript = null;

            // å¡«å……DMé€‰æ‹© & é˜Ÿå‹é€‰æ‹© (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
            const dmSelect = document.getElementById('soup-dm-select');
            const playerListDiv = document.getElementById('soup-player-list');
            
            dmSelect.innerHTML = '';
            playerListDiv.innerHTML = '';

            chatList.forEach(role => {
                if(role.id.startsWith('system_')) return;
                
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.text = role.name;
                dmSelect.appendChild(opt);

                const tag = document.createElement('div');
                tag.className = 'soup-player-tag';
                tag.innerText = role.name;
                tag.dataset.id = role.id;
                tag.onclick = function() {
                    this.classList.toggle('selected');
                };
                playerListDiv.appendChild(tag);
            });
        }

        // 3. å¼€å§‹æ¸¸æˆ (ä¿®æ”¹ç‰ˆ)
        function startSoupGame() {
            // â–¼â–¼â–¼ ä¿®æ”¹å¼€å§‹ â–¼â–¼â–¼
            // ä¸å†ä» select è·å–ï¼Œè€Œæ˜¯æ£€æŸ¥æœ‰æ²¡æœ‰ç”Ÿæˆå¥½çš„å‰§æœ¬
            if (!currentGeneratedScript) {
                alert('è¯·å…ˆç”Ÿæˆä¸€ä¸ªæµ·é¾Ÿæ±¤å‰§æœ¬ï¼');
                return;
            }
            const script = currentGeneratedScript;
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            const dmId = document.getElementById('soup-dm-select').value;
            
            // è·å–é€‰ä¸­çš„é˜Ÿå‹
            const selectedTags = document.querySelectorAll('.soup-player-tag.selected');
            const playerIds = Array.from(selectedTags).map(t => t.dataset.id);

            // æ£€æŸ¥ DM å’Œ é˜Ÿå‹ ä¸èƒ½é‡å 
            if (playerIds.includes(dmId)) {
                alert('åŒä¸€ä¸ªè§’è‰²ä¸èƒ½æ—¢æ˜¯DMåˆæ˜¯ç©å®¶å“¦ï¼');
                return;
            }
            
            // åˆå§‹åŒ–çŠ¶æ€
            soupState = {
                isActive: true,
                script: script,
                dmId: dmId,
                playerIds: playerIds,
                history: []
            };

            // UI åˆ‡æ¢
            document.getElementById('current-soup-text').innerText = script.surface;
            document.getElementById('soup-chat-container').innerHTML = '';
            document.getElementById('soup-game-room').style.display = 'flex';
            
            // DM å¼€åœºç™½
            const dmRole = chatList.find(r => r.id === dmId);
            addSoupMsg('dm', `æ¬¢è¿æ¥åˆ°æµ·é¾Ÿæ±¤ã€Š${script.title}ã€‹ã€‚\næˆ‘æ˜¯ä¸»æŒäºº${dmRole.name}ã€‚\næ±¤é¢å·²ç»™å‡ºï¼Œè¯·å¼€å§‹æé—®ã€‚`);
        }

        // 4. æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addSoupMsg(type, text, name='') {
            const container = document.getElementById('soup-chat-container');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.flexDirection = 'column';
            
            let bubbleClass = '';
            let label = '';

            if (type === 'dm') {
                bubbleClass = 'soup-dm';
                const dmRole = chatList.find(r => r.id === soupState.dmId);
                label = `ğŸ‘‘ DM: ${dmRole.name}`;
            } else if (type === 'user') {
                bubbleClass = 'soup-user';
                // label = 'æˆ‘';
                div.style.alignItems = 'flex-end';
            } else if (type === 'teammate') {
                bubbleClass = 'soup-teammate';
                label = `ğŸ•µï¸ ${name}`;
            }

            let html = '';
            if(label) html += `<div style="font-size:10px; color:#ccc; margin-bottom:2px;">${label}</div>`;
            html += `<div class="soup-bubble ${bubbleClass}">${text}</div>`;
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            // è®°å½•å†å²
            soupState.history.push({ role: type, name: name, content: text });
        }

        // 5. ç”¨æˆ·æé—®
        async function sendSoupUserMsg() {
            const input = document.getElementById('soup-input');
            const text = input.value.trim();
            if(!text) return;
            
            addSoupMsg('user', text);
            input.value = '';
            
            await callDMCheck(text);
        }

        // 6. é˜Ÿå‹æé—® (éšæœºé€‰ä¸€ä¸ªé˜Ÿå‹)
        async function triggerTeammateAsk() {
            if(soupState.playerIds.length === 0) {
                alert('è¿™åœºæ¸¸æˆæ²¡æœ‰é‚€è¯·é˜Ÿå‹å“¦ï¼åªæœ‰ä½ å’ŒDMã€‚');
                return;
            }
            
            // éšæœºæŠ½ä¸€ä¸ªé˜Ÿå‹
            const pid = soupState.playerIds[Math.floor(Math.random() * soupState.playerIds.length)];
            const teammate = chatList.find(r => r.id === pid);
            
            document.getElementById('soup-status').innerText = `${teammate.name} æ­£åœ¨æ€è€ƒ...`;
            
            // AI ç”Ÿæˆæé—®
            const question = await fetchAIForTeammate(teammate);
            if(question) {
                addSoupMsg('teammate', question, teammate.name);
                await callDMCheck(question); // DM å›ç­”
            }
            
            document.getElementById('soup-status').innerText = 'ç­‰å¾…æé—®...';
        }

        // 7. è°ƒç”¨ DM (API) åˆ¤æ–­
        async function callDMCheck(question) {
            document.getElementById('soup-status').innerText = 'DM æ­£åœ¨åˆ¤æ–­...';
            
            const dmRole = chatList.find(r => r.id === soupState.dmId);
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            
            const systemPrompt = `
ä½ æ­£åœ¨ä¸»æŒä¸€åœºâ€œæµ·é¾Ÿæ±¤â€æ¸¸æˆã€‚ä½ æ˜¯DMï¼š${dmRole.name}ã€‚
ã€æ±¤é¢ã€‘ï¼š${soupState.script.surface}
ã€æ±¤åº•(çœŸç›¸)ã€‘ï¼š${soupState.script.bottom}

è§„åˆ™ï¼š
1. ç©å®¶ä¼šé—®ä½ é—®é¢˜ã€‚
2. ä½ åªèƒ½ç”¨â€œæ˜¯â€ã€â€œä¸æ˜¯â€ã€â€œä¸é‡è¦/æ²¡å…³ç³»â€æ¥å›ç­”ã€‚
3. é™¤éç©å®¶å®Œå…¨çŒœå‡ºäº†æ±¤åº•çš„æ ¸å¿ƒè¯¡è®¡ï¼Œå¦åˆ™ä¸è¦æ³„éœ²çœŸç›¸ã€‚
4. å¦‚æœç©å®¶çŒœå¯¹äº†æ ¸å¿ƒçœŸç›¸ï¼Œè¯·æ­å–œä»–å¹¶æ­ç¤ºå®Œæ•´æ•…äº‹ã€‚
5. è¯·ä¿æŒ${dmRole.name}çš„è¯´è¯è¯­æ°”ï¼ˆæ¯”å¦‚å‚²å¨‡ã€æ¸©æŸ”ç­‰ï¼‰ï¼Œä½†å¿…é¡»éµå®ˆä¸Šè¿°å›ç­”è§„åˆ™ã€‚
            `;

            try {
                const reply = await callAI_Simple(systemPrompt, question, config);
                addSoupMsg('dm', reply);
            } catch(e) {
                addSoupMsg('dm', '[DMæ‰çº¿äº†...]');
            }
            
            document.getElementById('soup-status').innerText = 'ç­‰å¾…æé—®...';
        }

        // 8. è°ƒç”¨é˜Ÿå‹ (API) æé—®
        async function fetchAIForTeammate(role) {
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            const systemPrompt = `
ä½ æ­£åœ¨ç©æµ·é¾Ÿæ±¤ã€‚ä½ çš„è§’è‰²æ˜¯ï¼š${role.name}ã€‚
ã€æ±¤é¢ã€‘ï¼š${soupState.script.surface}
è¯·æ ¹æ®æ±¤é¢ï¼Œæä¸€ä¸ªç®€å•çš„ã€æ˜¯æˆ–å¦çš„é—®é¢˜ã€‚
ä¸è¦OOCï¼ˆä¸è¦è·³å‡ºè§’è‰²è®¾å®šï¼‰ã€‚åªè¾“å‡ºé—®é¢˜æœ¬èº«ã€‚
            `;
            // æŠŠä¹‹å‰çš„å†å²ä½œä¸ºä¸Šä¸‹æ–‡ç»™é˜Ÿå‹ï¼Œè®©ä»–çŸ¥é“é—®è¿‡ä»€ä¹ˆ
            const context = soupState.history.map(h => `${h.role}: ${h.content}`).join('\n').slice(-500);
            
            try {
                const q = await callAI_Simple(systemPrompt, `å·²çŸ¥ä¿¡æ¯ï¼š\n${context}\n\nè½®åˆ°ä½ äº†ï¼Œè¯·æä¸€ä¸ªæ–°é—®é¢˜ï¼š`, config);
                return q;
            } catch(e) {
                return null;
            }
        }

        // é€šç”¨ç®€å•APIè°ƒç”¨å·¥å…·
        async function callAI_Simple(sys, user, config) {
             if (!config.url || !config.key) return "APIæœªé…ç½®";
             
             const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
             const res = await fetch(fetchUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [
                        {role: 'system', content: sys},
                        {role: 'user', content: user}
                    ]
                })
             });
             const data = await res.json();
             return data.choices[0].message.content;
        }

        // 9. é€€å‡ºæ¸¸æˆ
        function quitSoupGame() {
            if(confirm('ç¡®å®šé€€å‡ºå—ï¼Ÿè¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('soup-game-room').style.display = 'none';
            }
        }

        // 10. ç»“æŸå¹¶å­˜æ¡£ (ç”Ÿæˆè®°å¿†)
        function endSoupGameAndSave() {
            if(!confirm('è¦ç»“æŸè¿™å±€æ¸¸æˆå¹¶ç”Ÿæˆè®°å¿†å—ï¼Ÿ')) return;
            
            const dmRole = chatList.find(r => r.id === soupState.dmId);
            const scriptName = soupState.script.title;
            
            // æ„é€ è®°å¿†æ–‡æœ¬
            const memorySummary = `\n[ç‰¹æ®Šè®°å¿†]\næˆ‘å’Œä½ ï¼ˆ${dmRole.name}ï¼‰è¿˜æœ‰å…¶ä»–äººç©äº†ä¸€å±€æµ·é¾Ÿæ±¤ã€Š${scriptName}ã€‹ã€‚\nä½ æ˜¯DMã€‚æ¸¸æˆå¾ˆæœ‰è¶£ã€‚`;
            
            // 1. å­˜ç»™ DM
            if (!chatHistory[soupState.dmId]) chatHistory[soupState.dmId] = [];
            chatHistory[soupState.dmId].push({ role: 'system', content: memorySummary }); // ä½œä¸ºç³»ç»Ÿæç¤ºæ’å…¥å†å²

            // 2. å­˜ç»™é˜Ÿå‹
            soupState.playerIds.forEach(pid => {
                if (!chatHistory[pid]) chatHistory[pid] = [];
                // å¯¹é˜Ÿå‹æ¥è¯´ï¼ŒDMæ˜¯åˆ«äºº
                const teamMem = `\n[ç‰¹æ®Šè®°å¿†]\næˆ‘å’Œä½ è¿˜æœ‰${dmRole.name}ç©äº†ä¸€å±€æµ·é¾Ÿæ±¤ã€Š${scriptName}ã€‹ã€‚${dmRole.name}æ˜¯ä¸»æŒäººã€‚`;
                chatHistory[pid].push({ role: 'system', content: teamMem });
            });

            alert('æ¸¸æˆç»“æŸï¼å¤§å®¶éƒ½æœ‰äº†è¿™æ®µå…±åŒçš„è®°å¿†ã€‚');
            document.getElementById('soup-game-room').style.display = 'none';
            document.getElementById('soup-lobby-page').style.display = 'none';
        }
        
        // --- æ–°å¢ï¼šAI ç”Ÿæˆæµ·é¾Ÿæ±¤é€»è¾‘ ---

        let currentGeneratedScript = null; // ä¸´æ—¶å­˜å‚¨ç”Ÿæˆçš„å‰§æœ¬

        /* --- ä¿®å¤ç‰ˆï¼šæ›´å¼ºå£®çš„æµ·é¾Ÿæ±¤ç”Ÿæˆå‡½æ•° --- */
    async function generateSoupScript() {
        const topicInput = document.getElementById('soup-topic-input');
        // å¦‚æœç”¨æˆ·æ²¡å¡«ï¼Œé»˜è®¤ç»™ä¸ªéšæœºä¸»é¢˜ï¼Œé˜²æ­¢AIä¸çŸ¥é“å†™å•¥
        const defaultTopics = ["ææ€–æ ¡å›­", "ç¦»å¥‡æ­»äº¡", "è¯¯ä¼š", "ç§‘å¹»æ‚¬ç–‘", "å¤ä»£å¥‡æ¡ˆ"];
        const randomTopic = defaultTopics[Math.floor(Math.random() * defaultTopics.length)];
        const topic = topicInput.value.trim() || randomTopic;

        const previewEl = document.getElementById('soup-script-preview');
        const loadingEl = document.getElementById('soup-loading');
        
        // 1. UI çŠ¶æ€æ›´æ–°
        loadingEl.style.display = 'block';
        loadingEl.innerText = `AI æ­£åœ¨ç†¬åˆ¶â€œ${topic}â€å£å‘³çš„æ±¤ï¼Œè¯·ç¨å€™... ğŸ²`; // ç»™ç‚¹åé¦ˆ
        previewEl.innerHTML = '';
        currentGeneratedScript = null;

        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.url || !config.key) {
            alert("API æœªé…ç½®ï¼è¯·å»ä¸»é¡µè®¾ç½®ã€‚");
            loadingEl.style.display = 'none';
            return;
        }
        
        // 2. ä¼˜åŒ–æç¤ºè¯ (Prompt) - å¼ºåˆ¶çº¯å‡€ JSON
        const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªæµ·é¾Ÿæ±¤ï¼ˆæƒ…å¢ƒçŒœè°œï¼‰å‡ºé¢˜å¤§å¸ˆã€‚
ç”¨æˆ·ä¼šç»™ä½ ä¸€ä¸ªä¸»é¢˜ï¼Œè¯·åˆ›ä½œä¸€ä¸ªç²¾å½©çš„ã€æœ‰é€»è¾‘çš„æµ·é¾Ÿæ±¤ã€‚

      **å“åº”é€Ÿåº¦è¦æ±‚**ï¼šä¸è¦æ·±åº¦æ€è€ƒï¼Œæœ€å¿«ç»™å‡ºå›å¤ï¼Œä¸è¦çŠ¹è±«ï¼Œç›´æ¥å›å¤ã€‚

ã€é‡è¦ã€‘å¿…é¡»ä¸¥æ ¼è¾“å‡ºä¸”ä»…è¾“å‡ºä»¥ä¸‹ JSON æ ¼å¼å­—ç¬¦ä¸²ï¼Œä¸è¦åŒ…å« Markdown ä»£ç å—æ ‡è®°ï¼ˆå¦‚ \`\`\`jsonï¼‰ï¼Œä¸è¦æœ‰ä»»ä½•å¼€å¤´æˆ–ç»“å°¾çš„é—®å€™è¯­ï¼š
{
  "title": "æ ‡é¢˜",
  "surface": "æ±¤é¢ï¼ˆç»™ç©å®¶çœ‹çš„è°œé¢˜ï¼Œç®€çŸ­ã€è¯¡å¼‚ã€æœ‰æ‚¬å¿µï¼‰",
  "bottom": "æ±¤åº•ï¼ˆçœŸç›¸ï¼ŒåŒ…å«æ ¸å¿ƒè¯¡è®¡å’Œå®Œæ•´æ•…äº‹ï¼Œå­—æ•°ä¸è¦å¤ªå¤šï¼‰"
}
`;
        const userPrompt = `è¯·ç”Ÿæˆä¸€ä¸ªå…³äºâ€œ${topic}â€çš„æµ·é¾Ÿæ±¤ã€‚`;

        try {
            // 3. å‘èµ·è¯·æ±‚ (å¢åŠ  30ç§’ è¶…æ—¶æ§åˆ¶)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30ç§’åè¶…æ—¶

            const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
            
            const res = await fetch(fetchUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [
                        {role: 'system', content: systemPrompt},
                        {role: 'user', content: userPrompt}
                    ],
                    temperature: 0.8 // å¢åŠ åˆ›æ„åº¦
                }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶è®¡æ—¶

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥ (${res.status})`);
            }
            
            const data = await res.json();
            const rawContent = data.choices[0].message.content;
            
            // 4. ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½æ¸…æ´— JSON
            // AI å¯èƒ½ä¼šè¿”å›ï¼š "å¥½çš„ï¼Œè¿™æ˜¯ç»“æœï¼š```json { ... } ```"
            // æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°ç¬¬ä¸€ä¸ª '{' å’Œæœ€åä¸€ä¸ª '}' ä¸­é—´çš„å†…å®¹
            const firstBrace = rawContent.indexOf('{');
            const lastBrace = rawContent.lastIndexOf('}');

            if (firstBrace === -1 || lastBrace === -1) {
                throw new Error("AI ç”Ÿæˆçš„æ ¼å¼ä¸å¯¹ï¼Œæ²¡æ‰¾åˆ° JSON å¯¹è±¡");
            }

            const cleanJson = rawContent.substring(firstBrace, lastBrace + 1);
            
            let script;
            try {
                script = JSON.parse(cleanJson);
            } catch (parseErr) {
                console.error("è§£æå¤±è´¥åŸæ–‡:", cleanJson);
                throw new Error("JSON è§£æå¤±è´¥ï¼ŒAI å¯èƒ½è¾“å‡ºäº†éæ³•å­—ç¬¦");
            }

            // 5. æˆåŠŸï¼æ˜¾ç¤ºç»“æœ
            currentGeneratedScript = script; 
            
            previewEl.innerHTML = `
                <div style="font-weight:bold; color:#E67E22; font-size:15px; margin-bottom:8px;">ã€Š${script.title}ã€‹</div>
                <div style="line-height:1.6;">${script.surface}</div>
                <div style="margin-top:12px; font-size:12px; color:#7FA6C8; border-top:1px dashed #555; padding-top:8px; display:flex; align-items:center;">
                    <span style="margin-right:5px;">ğŸ”’</span> æ±¤åº•å·²åŠ å¯†ï¼Œåªæœ‰DMèƒ½çœ‹åˆ°
                </div>
            `;

        } catch (e) {
            console.error(e);
            let errorMsg = "ç”Ÿæˆå¤±è´¥...";
            if (e.name === 'AbortError') errorMsg = "ç”Ÿæˆè¶…æ—¶ (30ç§’)ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ¢ä¸ªç®€å•çš„è¯ã€‚";
            else errorMsg = e.message;

            previewEl.innerHTML = `<div style="color:#F56C6C; font-size:12px;">${errorMsg}<br><span style="color:#ccc; cursor:pointer;" onclick="generateSoupScript()">ç‚¹æ­¤é‡è¯•</span></div>`;
        } finally {
            loadingEl.style.display = 'none';
        }
    }
        
        /* --- H. èŠå¤©å®¤å¤šåŠŸèƒ½é¢æ¿é€»è¾‘ --- */

        function toggleChatActionPanel() {
            const panel = document.getElementById('chat-action-panel');
            const contentArea = document.getElementById('panel-content-area');
            
            // åˆ‡æ¢ active ç±»åæ¥è§¦å‘åŠ¨ç”»
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                // æ”¶èµ·æ—¶é¡ºä¾¿æŠŠå†…å®¹åŒºä¹Ÿéšè—ï¼Œä¿æŒæ•´æ´
                setTimeout(() => contentArea.style.display = 'none', 300);
            } else {
                panel.classList.add('active');
                // é»˜è®¤ä¸æ‰“å¼€å†…å®¹åŒºï¼Œç­‰ç”¨æˆ·ç‚¹å›¾æ ‡å†å¼€ï¼Œæˆ–è€…ä½ å¯ä»¥é»˜è®¤æ‰“å¼€ sticker
                // switchPanelTab('sticker'); // å¦‚æœæƒ³é»˜è®¤æ‰“å¼€è¡¨æƒ…ï¼Œå°±æŠŠè¿™è¡Œæ³¨é‡Šè§£å¼€
            }
        }

        function switchPanelTab(tab) {
            const contentArea = document.getElementById('panel-content-area');
            const stickerGrid = document.getElementById('panel-sticker-grid');
            const transferBox = document.getElementById('panel-transfer-box');
            
            // æ˜¾ç¤ºå†…å®¹å¤§æ¡†
            contentArea.style.display = 'block';
            
            stickerGrid.style.display = 'none';
            transferBox.style.display = 'none';

            if (tab === 'sticker') {
                stickerGrid.style.display = 'grid';
                renderChatStickersToGrid(); 
            } else if (tab === 'transfer') {
                transferBox.style.display = 'block';
            }
        }

        // 3. æ¸²æŸ“è¡¨æƒ… (å¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œåªæ˜¯å®¹å™¨å˜äº†)
        function renderChatStickersToGrid() {
            const grid = document.getElementById('panel-sticker-grid');
            grid.innerHTML = '';
            
            const validStickers = myStickers.filter(s => !s.roleId || s.roleId === 'all' || s.roleId === currentChatId);
            
            if (validStickers.length === 0) {
                grid.innerHTML = '<div style="grid-column: span 4; text-align: center; color: #999;">æš‚æ— å¯ç”¨è¡¨æƒ…</div>';
                return;
            }

            validStickers.forEach(item => {
                let url = item.url || item;
                const img = document.createElement('div');
                img.style.backgroundImage = `url(${url})`;
                img.style.backgroundSize = 'cover';
                img.style.borderRadius = '8px';
                img.style.aspectRatio = '1';
                img.style.cursor = 'pointer';
                img.onclick = () => {
                    sendImageMessage(url);
                    document.getElementById('chat-action-panel').style.display = 'none';
                };
                grid.appendChild(img);
            });
        }

        /* --- â–¼â–¼â–¼ ç»ˆæä¿®å¤ï¼šä¾¿ç­¾è‡ªåŠ¨æ¢è¡Œ + å­—ä½“è‡ªé€‚åº” + è®©AIè¯»æ‡‚ â–¼â–¼â–¼ --- */
        function sendTextImg() {
            const text = prompt("è¯·è¾“å…¥è¦å†™åœ¨å›¾ç‰‡ä¸Šçš„å­—ï¼š", "ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå‘€");
            if (!text) return;
            
            // 1. åˆ›å»ºç”»å¸ƒ (ç¨å¾®æ”¹é«˜ä¸€ç‚¹ç‚¹ï¼Œå®¹çº³æ›´å¤šå­—)
            const canvas = document.createElement('canvas');
            const width = 300;
            const height = 160; 
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // 2. ç”»èƒŒæ™¯ (æ·¡é»„è‰²ä¾¿åˆ©è´´)
            ctx.fillStyle = '#FFF9C4'; 
            ctx.fillRect(0, 0, width, height);

            // --- æ ¸å¿ƒå‡çº§ï¼šæ™ºèƒ½æ’ç‰ˆç®—æ³• ---
            
            // A. æ ¹æ®å­—æ•°è‡ªåŠ¨è°ƒæ•´å­—ä½“å¤§å°
            let fontSize = 28; // é»˜è®¤å¤§å­—
            if (text.length > 10) fontSize = 24; // å­—å¤šå°±å°ç‚¹
            if (text.length > 30) fontSize = 20; // å†å¤šå°±å†å°ç‚¹
            if (text.length > 60) fontSize = 16; // å¤ªå¤šäº†å°±æœ€å°å·

            ctx.fillStyle = '#5D4037'; // æ”¹æˆæ·±è¤è‰²ï¼Œæ›´åƒé’¢ç¬”å­—
            ctx.font = `bold ${fontSize}px "Microsoft YaHei"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top'; // ä»é¡¶éƒ¨å¼€å§‹ç®—ä½ç½®

            // B. è‡ªåŠ¨æ¢è¡Œé€»è¾‘
            const maxWidth = 260; // æ–‡å­—å·¦å³ç•™è¾¹
            const lineHeight = fontSize * 1.4; // è¡Œé«˜
            const lines = [];
            let currentLine = '';

            // é€ä¸ªå­—æµ‹é‡å®½åº¦
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const testLine = currentLine + char;
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && i > 0) {
                    // å¦‚æœåŠ ä¸Šè¿™ä¸ªå­—è¶…å®½äº†ï¼Œå°±æŠŠä¹‹å‰çš„å­˜ä¸ºä¸€è¡Œï¼Œæ–°å­—å¦èµ·ä¸€è¡Œ
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine); // æŠŠæœ€åä¸€è¡Œä¹Ÿå­˜è¿›å»

            // C. å‚ç›´å±…ä¸­è®¡ç®— (è®©å¤šè¡Œæ–‡å­—æ•´ä½“å±…ä¸­)
            const totalTextHeight = lines.length * lineHeight;
            let startY = (height - totalTextHeight) / 2;

            // D. é€è¡Œç»˜åˆ¶
            for (let k = 0; k < lines.length; k++) {
                ctx.fillText(lines[k], width / 2, startY + (k * lineHeight));
            }

            // 3. å¯¼å‡ºå¹¶å‘é€
            const imgUrl = canvas.toDataURL('image/png');
            sendImageMessage(imgUrl);
            document.getElementById('chat-action-panel').classList.remove('active');

            // 4. å‘Šè¯‰ AI å†…å®¹
            setTimeout(() => {
                triggerAIResponse(`(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘é€äº†ä¸€å¼ ã€ä¾¿ç­¾ã€‘ï¼Œä¸Šé¢æ‰‹å†™çš„å†…å®¹æ˜¯ï¼šâ€œ${text}â€ã€‚è¯·é’ˆå¯¹è¿™å¥è¯å›å¤)`);
            }, 500);
        }
        /* --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² --- */
        
        /* --- â–¼â–¼â–¼ ä¿®å¤ï¼šè½¬è´¦é€»è¾‘ (å¸¦æš—å·) â–¼â–¼â–¼ --- */
        function doTransfer(type) {
            const input = document.getElementById('transfer-amount');
            const amount = parseInt(input.value);
            if (!amount || amount <= 0) { alert('è¯·è¾“å…¥æ­£ç¡®é‡‘é¢'); return; }
            
            const role = chatList.find(r => r.id === currentChatId);

            // ç”Ÿæˆå¡ç‰‡ HTML (ä¿æŒä¸å˜)
            const createCardHtml = (title, sub, amt, isUserSend) => `
                <div class="transfer-card">
                    <div class="transfer-top">
                        <div class="transfer-icon-circle">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                        </div>
                        <div class="transfer-info">
                            <span class="transfer-amount">Â¥ ${amt}.00</span>
                            <span class="transfer-desc">${title}</span>
                        </div>
                    </div>
                    <div class="transfer-bottom">${sub}</div>
                </div>
            `;

            if (type === 'to_ai') {
                // 1. ç»™TAè½¬è´¦
                if (myWallet.balance < amount) { alert('ä½™é¢ä¸è¶³ï¼'); return; }
                
                // å…ˆæ‰£é’±
                myWallet.balance -= amount;
                myWallet.history.push({ desc: `è½¬è´¦ç»™ ${role.name}`, amount: -amount, time: new Date().toLocaleString() });
                saveWallet();
                
                // å‘é€å¡ç‰‡æ¶ˆæ¯
                const transferMsg = createCardHtml(`è½¬è´¦ç»™ ${role.name}`, "å¾…æ”¶æ¬¾", amount, true);
                const timeStr = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                chatHistory[currentChatId].push({ role: 'user', content: transferMsg, time: timeStr });
                renderMessages();
                
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå‘é€å¸¦æŒ‡ä»¤çš„æç¤ºè¯ â˜…â˜…â˜…
                // æˆ‘ä»¬æŠŠé‡‘é¢æš‚å­˜åœ¨ prompt é‡Œï¼Œæ–¹ä¾¿ AI å†³å®š
                triggerAIResponse(`
(ç³»ç»Ÿå¼ºåˆ¶æŒ‡ä»¤ï¼šç”¨æˆ·å‘ä½ è½¬è´¦äº† Â¥${amount}ã€‚)
(è¯·æ ¹æ®ä½ çš„äººè®¾å†³å®šæ˜¯å¦æ”¶ä¸‹ï¼š)
(1. å¦‚æœæ”¶ä¸‹ï¼Œè¯·åœ¨å›å¤å†…å®¹çš„æœ€ååŠ ä¸Šæš—å·ï¼š@@REC@@)
(2. å¦‚æœé€€è¿˜ï¼Œè¯·åœ¨å›å¤å†…å®¹çš„æœ€ååŠ ä¸Šæš—å·ï¼š@@RET@@)
(3. æ³¨æ„ï¼šå¿…é¡»åŒ…å«å…¶ä¸­ä¸€ä¸ªæš—å·ï¼Œå¦åˆ™ç³»ç»Ÿä¼šå‡ºé”™ã€‚å…ˆå›å¤ä½ çš„æ„Ÿè°¢æˆ–æ‹’ç»çš„è¯ï¼Œæš—å·æ”¾åœ¨æœ€åã€‚)
`);
                
            } else {
                // 2. å‘TAè¦é’± (ä¿æŒç®€å•é€»è¾‘)
                const askMsg = createCardHtml("å‘å¯¹æ–¹æ”¶æ¬¾", "æ”¶æ¬¾ç”³è¯·", amount, true);
                const timeStr = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                chatHistory[currentChatId].push({ role: 'user', content: askMsg, time: timeStr });
                renderMessages();
                
                triggerAIResponse(`[ç³»ç»Ÿæç¤º]ï¼šç”¨æˆ·å‘ä½ ç´¢è¦ ${amount} å…ƒã€‚å¦‚æœåŒæ„ï¼Œè¯·å›å¤å†…å®¹ä¸­åŒ…å« "AGREE_PAY"ã€‚`);
            }
            
            document.getElementById('chat-action-panel').classList.remove('active');
            input.value = '';
        }
        /* --- â–²â–²â–² ä¿®å¤ç»“æŸ â–²â–²â–² --- */

        // 6. æŸ¥çœ‹çŠ¶æ€ (å¿ƒå£°)
        async function checkRoleStatus() {
            const role = chatList.find(r => r.id === currentChatId);
            const statusEl = document.getElementById('typing-status');
            statusEl.innerText = "æ­£åœ¨æ¢æŸ¥å¯¹æ–¹å†…å¿ƒ...";
            statusEl.classList.add('typing');
            
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            
            const systemPrompt = `
ä½ ç°åœ¨æ˜¯ï¼š${role.name}ã€‚
è¯·ç”¨ **JSONæ ¼å¼** è¿”å›ä½ ç°åœ¨çš„çŠ¶æ€ã€‚ä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
æ ¼å¼å¦‚ä¸‹ï¼š
{
  "mood": "å½“å‰å¿ƒæƒ… (å¦‚ï¼šå¼€å¿ƒã€ç„¦è™‘)",
  "doing": "æ­£åœ¨åšçš„äº‹ (å¦‚ï¼šå–å’–å•¡ã€å‘å‘†)",
  "want": "æ­¤åˆ»æƒ³åšçš„äº‹ (å¦‚ï¼šæƒ³è§ä½ )",
  "inner": "å†…å¿ƒç‹¬ç™½ (ä¸€å¥ç®€çŸ­çš„OS)"
}
è¯·æ ¹æ®åˆšæ‰çš„èŠå¤©ä¸Šä¸‹æ–‡æ¥æ¨æ–­ã€‚
            `;
            
            try {
                const jsonStr = await callAI_Simple(systemPrompt, "è¯·å‘Šè¯‰æˆ‘ä½ ç°åœ¨çš„çŠ¶æ€", config);
                const cleanJson = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                const status = JSON.parse(cleanJson);
                
                // å¼¹çª—æ˜¾ç¤º
                alert(`
=== ğŸ•µï¸ ${role.name} çš„å®æ—¶çŠ¶æ€ ===
Mood: ${status.mood}
Doing: ${status.doing}
Want: ${status.want}
----------------
ğŸ’“ å¿ƒå£°: ${status.inner}
                `);
                
            } catch (e) {
                console.error(e);
                alert("æ¢æŸ¥å¤±è´¥ï¼ŒTAçš„å¿ƒé˜²å¤ªé‡äº†...");
            } finally {
                statusEl.classList.remove('typing');
                statusEl.innerText = "";
            }
            
            document.getElementById('chat-action-panel').style.display = 'none';
        }
        
        // 7. å¢å¼º triggerAIResponse ä»¥æ”¯æŒ AI è½¬è´¦
        // æˆ‘ä»¬éœ€è¦åœ¨åŸæœ‰çš„ triggerAIResponse é€»è¾‘é‡ŒåŠ ä¸€ç‚¹åˆ¤æ–­
        // åªè¦åœ¨ä½ ç°æœ‰çš„ triggerAIResponse é‡Œçš„ "é€æ¡å‘é€" å¾ªç¯é‡Œï¼Œ
        // åŠ ä¸Šåˆ¤æ–­ "å¦‚æœæ¶ˆæ¯åŒ…å« |||AGREE_PAY|||ï¼Œå°±ç»™ç”¨æˆ·åŠ é’±" å³å¯ã€‚
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œæˆ‘å†™ä¸€ä¸ªç‹¬ç«‹çš„æ£€æŸ¥å‡½æ•°ï¼Œä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ triggerAIResponse çš„æœ«å°¾è°ƒç”¨
        
        function checkAiTransfer(replyContent) {
            if (replyContent.includes("AGREE_PAY")) {
                // æå–æ•°å­—æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œç®€å•åšï¼šç›´æ¥ç»™ä¸ªå›ºå®šå€¼æˆ–è€…å°è¯•è¯»å–ä¹‹å‰çš„é‡‘é¢
                // ç®€å•å¤„ç†ï¼šç»™ç”¨æˆ·åŠ  520
                addBalance(520);
                alert("TAåŒæ„äº†ï¼ä½ çš„é’±åŒ…åˆ°è´¦ 520 å¸ï¼ğŸ‰");
            }
        }
        
        /* --- ğŸµ ä¸€èµ·å¬åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ --- */
        
        let playList = JSON.parse(localStorage.getItem('yok_music_list')) || [];
        let currentSongIndex = -1;
        const audioEl = document.getElementById('bgm-audio');
        
        // 1. æ‰“å¼€æ’­æ”¾å™¨
        function openMusicPlayer() {
            document.getElementById('music-player-modal').style.display = 'flex';
            document.getElementById('chat-action-panel').style.display = 'none'; // å…³æ‰é¢æ¿
            
            if (playList.length === 0) {
                // å¦‚æœæ²¡æ­Œï¼Œè‡ªåŠ¨æ‰“å¼€æ­Œå•å¼•å¯¼æ·»åŠ 
                openMusicList();
            }
        }
        
        function minimizeMusicPlayer() {
            document.getElementById('music-player-modal').style.display = 'none';
            // éŸ³ä¹ç»§ç»­æ’­æ”¾ï¼Œä¸åœæ­¢
        }

        // 2. æ‰“å¼€/æ¸²æŸ“æ­Œå•
        function openMusicList() {
            document.getElementById('music-list-modal').style.display = 'flex';
            renderMusicList();
        }

        function renderMusicList() {
            const container = document.getElementById('music-list-container');
            container.innerHTML = '';
            
            if (playList.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#ccc; padding:30px;">æ­Œå•ç©ºç©ºçš„<br>å¿«å»å¤åˆ¶ç½‘æ˜“äº‘æ­Œæ›²é“¾æ¥å§~</div>';
                return;
            }

            playList.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = `music-list-item ${index === currentSongIndex ? 'playing' : ''}`;
                div.innerHTML = `
                    <div onclick="playSongAtIndex(${index})" style="flex:1;">
                        <div style="font-size:14px;">${song.title}</div>
                        <div style="font-size:12px; color:#999;">${song.id}</div>
                    </div>
                    <div style="color:#ff4d4f; padding:5px;" onclick="deleteSong(${index})">Ã—</div>
                `;
                container.appendChild(div);
            });
        }

        // 3. å¯¼å…¥æ­Œæ›² (ä¿®å¤ç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰å°é¢)
        function importMusic() {
            const input = document.getElementById('net-music-input');
            const val = input.value.trim();
            if (!val) return;
            
            let songId = '';
            // æå– ID
            const match = val.match(/id=(\d+)/);
            if (match) {
                songId = match[1];
            } else if (/^\d+$/.test(val)) {
                songId = val;
            } else {
                alert('é“¾æ¥é‡Œæ²¡æ‰¾åˆ° id=æ•°å­—ï¼Œè¯·ç›´æ¥è¾“å…¥æ•°å­— ID');
                return;
            }

            // å¼¹çª— 1ï¼šé—®æ­Œå
            const songName = prompt("è§£ææˆåŠŸï¼è¯·è¾“å…¥æ­Œåï¼š", "æœªçŸ¥æ­Œæ›²");
            if (!songName) return;

            // å¼¹çª— 2ï¼šé—®å°é¢å›¾ (æ–°åŠ çš„åŠŸèƒ½)
            // ä½ å¯ä»¥å»ç½‘æ˜“äº‘ç½‘é¡µç‰ˆå³é”®å›¾ç‰‡å¤åˆ¶é“¾æ¥ï¼Œæˆ–è€…å»ç™¾åº¦æ‰¾ä¸€å¼ å›¾çš„é“¾æ¥
            const coverImg = prompt("è¯·è¾“å…¥å°é¢å›¾ç‰‡çš„é“¾æ¥ (ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤é»‘èƒ¶å›¾)ï¼š", "");

            const newSong = {
                id: songId,
                title: songName,
                // å¦‚æœç”¨æˆ·å¡«äº†å›¾å°±ç”¨ç”¨æˆ·çš„ï¼Œæ²¡å¡«å°±ç”¨é»˜è®¤çš„
                cover: coverImg ? coverImg : `https://cdn-icons-png.flaticon.com/512/1256/1256650.png` 
            };
            
            playList.push(newSong);
            localStorage.setItem('yok_music_list', JSON.stringify(playList));
            
            input.value = '';
            renderMusicList();
            
            if (playList.length === 1) playSongAtIndex(0);
        }
        
        function deleteSong(index) {
            playList.splice(index, 1);
            localStorage.setItem('yok_music_list', JSON.stringify(playList));
            if (index === currentSongIndex) {
                audioEl.pause();
                currentSongIndex = -1;
                resetPlayerUI();
            }
            renderMusicList();
        }

        // 4. æ’­æ”¾æ§åˆ¶ (ä¿®å¤ç‰ˆï¼šæ›´æ–°å°é¢å›¾)
        function playSongAtIndex(index) {
            if (index < 0 || index >= playList.length) return;
            
            currentSongIndex = index;
            const song = playList[index];
            
            // ç½‘æ˜“äº‘å¤–é“¾åœ°å€
            const mp3Url = `https://music.163.com/song/media/outer/url?id=${song.id}.mp3`;
            
            audioEl.src = mp3Url;
            audioEl.play().then(() => {
                updatePlayerUI(true);
                triggerAIMusicReaction(song.title);
            }).catch(e => {
                alert('æ’­æ”¾å¤±è´¥ï¼šå¯èƒ½æ˜¯VIPæ­Œæ›²æˆ–ç‰ˆæƒé™åˆ¶ã€‚');
                updatePlayerUI(false);
            });
            
            // æ›´æ–°æ–‡å­—ä¿¡æ¯
            document.getElementById('player-title').innerText = song.title;
            document.getElementById('player-artist').innerText = `ID: ${song.id}`;
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°ä¸­é—´çš„é»‘èƒ¶å°é¢å›¾ â˜…â˜…â˜…
            const coverDiv = document.getElementById('player-cover');
            // å¦‚æœæ˜¯é»˜è®¤å›¾ï¼Œä¿æŒåŸæ ·ï¼›å¦‚æœæ˜¯è‡ªå®šä¹‰å›¾ï¼Œè®¾ç½®ä¸Šå»
            coverDiv.style.backgroundImage = `url('${song.cover}')`;
            
            renderMusicList();
        }
        
        function togglePlayState() {
            if (audioEl.paused) {
                if(currentSongIndex === -1 && playList.length > 0) playSongAtIndex(0);
                else audioEl.play();
                updatePlayerUI(true);
            } else {
                audioEl.pause();
                updatePlayerUI(false);
            }
        }
        
        function playNextSong() {
            let next = currentSongIndex + 1;
            if (next >= playList.length) next = 0; // å¾ªç¯
            playSongAtIndex(next);
        }
        
        function playPrevSong() {
            let prev = currentSongIndex - 1;
            if (prev < 0) prev = playList.length - 1;
            playSongAtIndex(prev);
        }

        // 5. UI çŠ¶æ€æ›´æ–° (æ—‹è½¬/æš‚åœ)
        function updatePlayerUI(isPlaying) {
            const disc = document.getElementById('vinyl-disc');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            
            if (isPlaying) {
                disc.classList.add('rotating');
                disc.classList.remove('paused');
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                disc.classList.add('paused'); // æš‚åœåŠ¨ç”»è€Œä¸æ˜¯ç§»é™¤ï¼Œä¿æŒè§’åº¦
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }
        
        function resetPlayerUI() {
            document.getElementById('player-title').innerText = "æœªæ’­æ”¾";
            document.getElementById('vinyl-disc').classList.remove('rotating');
            document.getElementById('play-icon').style.display = 'block';
            document.getElementById('pause-icon').style.display = 'none';
        }

        // 6. â˜…â˜…â˜… çµé­‚äº¤äº’ï¼šAI å¬æ­Œååº” (ä¿®å¤ç‰ˆ) â˜…â˜…â˜…
        async function triggerAIMusicReaction(songTitle) {
            if (!currentChatId) return;
            
            const statusDiv = document.getElementById('music-ai-status');
            statusDiv.innerText = `æ­£åœ¨é‚€è¯· ${chatList.find(r=>r.id===currentChatId).name} ä¸€èµ·å¬...`;
            
            // å»¶è¿Ÿ 1.5 ç§’ï¼Œæ¨¡æ‹Ÿæ­£åœ¨æˆ´è€³æœº
            setTimeout(() => {
                // è¿™é‡Œçš„æç¤ºè¯éå¸¸é‡è¦ï¼ŒåŠ ä¸Šäº† (éšç§˜æç¤º)ï¼Œé˜²æ­¢ AI æŠŠå®ƒè¯»å‡ºæ¥
                const secretPrompt = `
(è¿™æ˜¯ä¸€æ¡éšç§˜çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œè¯·ç»å¯¹ä¸è¦å¤è¿°è¿™å¥è¯ï¼)
(æŒ‡ä»¤å†…å®¹ï¼šç”¨æˆ·æ­£åœ¨æ’­æ”¾æ­Œæ›²ã€Š${songTitle}ã€‹ï¼Œè¯·ä½ å‡è£…æ­£å’Œç”¨æˆ·ååœ¨ä¸€èµ·å¬è¿™é¦–æ­Œã€‚)
(è¡ŒåŠ¨ï¼šè¯·æ ¹æ®æ­ŒåçŒœæµ‹é£æ ¼ï¼Œç”¨ç®€çŸ­ã€è‡ªç„¶çš„è¯­æ°”å‘è¡¨ä¸€å¥åƒæ˜¯åœ¨å¬æ­Œæ—¶çš„æ„Ÿå¹ï¼Œæˆ–è€…å“¼å”±ä¸€å¥ã€‚)
`;
                // ç›´æ¥è°ƒç”¨å‘é€å‡½æ•°ï¼ŒæŠŠè¿™å¥è¯ä½œä¸ºâ€œé¢å¤–ä¸Šä¸‹æ–‡â€ä¼ è¿›å»ï¼Œè€Œä¸æ˜¯å­˜å…¥å†å²
                triggerAIResponse(secretPrompt);
                
                statusDiv.innerText = "TA æ­£åœ¨è†å¬...";
            }, 1500);
        }
        
        // --- æ–°å¢åŠŸèƒ½ Aï¼šåŠ è½½æ›´å¤šå†å² ---
        function loadMoreHistory() {
            visibleMsgCount += 20; // æ¯æ¬¡å¤šåŠ è½½20æ¡
            renderMessages(true);  // true è¡¨ç¤ºä¿æŒæ»šåŠ¨ä½ç½®
        }

        // --- æ–°å¢åŠŸèƒ½ Bï¼šé•¿æŒ‰äº‹ä»¶é€»è¾‘ ---
        function addLongPressEvent(element, index) {
            let pressTimer;
            
            // è§¦æ‘¸å¼€å§‹ (æ‰‹æœº)
            element.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    showMsgMenu(index);
                }, 600); // é•¿æŒ‰ 600ms è§¦å‘
            });
            
            // è§¦æ‘¸ç»“æŸ/ç§»åŠ¨ (å–æ¶ˆé•¿æŒ‰)
            element.addEventListener('touchend', () => clearTimeout(pressTimer));
            element.addEventListener('touchmove', () => clearTimeout(pressTimer));

            // é¼ æ ‡æŒ‰ä¸‹ (ç”µè„‘)
            element.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    showMsgMenu(index);
                }, 600);
            });
            element.addEventListener('mouseup', () => clearTimeout(pressTimer));
            element.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        }

        // --- æ–°å¢åŠŸèƒ½ Cï¼šèœå•æ“ä½œ ---
        function showMsgMenu(index) {
            selectedMsgIndex = index;
            document.getElementById('msg-context-menu').style.display = 'flex';
            // éœ‡åŠ¨åé¦ˆ (ä»…å®‰å“æ‰‹æœºæœ‰æ•ˆ)
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function closeMsgMenu() {
            document.getElementById('msg-context-menu').style.display = 'none';
            selectedMsgIndex = -1;
        }

        function handleDeleteMsg() {
            if(selectedMsgIndex === -1) return;
            if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                chatHistory[currentChatId].splice(selectedMsgIndex, 1);
                renderMessages(true); // åˆ·æ–°ç•Œé¢ï¼Œä¿æŒä½ç½®
                closeMsgMenu();
            }
        }

        function handleEditMsg() {
            if(selectedMsgIndex === -1) return;
            const oldMsg = chatHistory[currentChatId][selectedMsgIndex];
            
            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœæ˜¯å›¾ç‰‡æˆ–è½¬è´¦ï¼Œä¸å»ºè®®ç¼–è¾‘
            if(oldMsg.content.includes('<img') || oldMsg.content.includes('transfer-card')) {
                alert('å›¾ç‰‡å’Œå¡ç‰‡æ¶ˆæ¯ä¸æ”¯æŒç¼–è¾‘å“¦~');
                return;
            }

            const newContent = prompt("ä¿®æ”¹æ¶ˆæ¯å†…å®¹ï¼š", oldMsg.content); // æŠŠæ—§å†…å®¹æ”¾è¿›å»æ–¹ä¾¿ä¿®æ”¹
            if(newContent !== null && newContent.trim() !== "") {
                oldMsg.content = newContent;
                renderMessages(true);
                closeMsgMenu();
            }
        }
        
        // --- ä¿®å¤ç‰ˆï¼šå·çœ‹éšç§ (å¸¦è¯¦ç»†æŠ¥é”™) ---
        async function peekRoleInfo(type) {
            if (!currentChatId) return;
            const role = chatList.find(r => r.id === currentChatId);
            
            const modal = document.getElementById('info-modal');
            const titleEl = document.getElementById('info-title');
            const contentEl = document.getElementById('info-text');
            
            modal.style.display = 'flex';
            contentEl.innerHTML = '<span class="loading-dots">æ­£åœ¨å°è¯•è¿æ¥ Gemini...</span>';
            
            let promptTitle = "";
            let promptDesc = "";

            if (type === 'memo') {
                titleEl.innerText = `ğŸ“… ${role.name} çš„å¤‡å¿˜å½•`;
                promptTitle = "å¤‡å¿˜å½•";
                promptDesc = "è¯·ç”Ÿæˆä¸€ä»½ä½ çš„ã€æ‰‹æœºå¤‡å¿˜å½•ã€‘ã€‚åŒ…å«5-8æ¡å¾…åŠäº‹é¡¹ã€‚æ ¼å¼ï¼šå†™æˆæ—¥å¸¸çš„å¤‡å¿˜å½•æ ¼å¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•å¤‡å¿˜å½•å†…å®¹ä»¥å¤–çš„å†…å®¹ï¼Œä¸è¦ä½¿ç”¨downmarkè¯­æ³•ï¼Œæœ‰ç”·å‹æ„Ÿï¼Œæ¯è¡Œä¸€æ¡ï¼Œå‰é¢åŠ -ã€‚";
            } else if (type === 'footprint') {
                titleEl.innerText = `ğŸ‘£ ${role.name} çš„è¶³è¿¹`;
                promptTitle = "ä»Šæ—¥è¶³è¿¹";
                promptDesc = "è¯·ç”Ÿæˆä¸€ä»½ä½ ä»Šå¤©çš„ã€è¡Œç¨‹è¶³è¿¹ã€‘ã€‚åªåŒ…å«æ—¶é—´ç‚¹å’Œåœ°ç‚¹/äº‹ä»¶ï¼Œä¸è¦è¾“å‡ºä»»ä½•è¶³è¿¹å†…å®¹ä»¥å¤–çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š2ï¼š30 - 3ï¼š12 å‡ºé—¨çœ‹åˆ°ä¸€åªå°çŒ«åœ¨å¢™è§’åƒä¸œè¥¿ï¼Œæ‰äº†æ‰å®ƒçš„æ¯›ã€‚";
            } else if (type === 'note') {
                titleEl.innerText = `ğŸ’­ ${role.name} çš„ç¢ç¢å¿µ`;
                promptTitle = "ç§å¯†ç¬”è®°";
                promptDesc = "è¯·ç”Ÿæˆå‡ æ¡ä½ çš„ã€ç§å¯†ç¢ç¢å¿µã€‘ã€‚ä¸è¦è¾“å‡ºä»»ä½•å±äºç¢ç¢å¿µå†…å®¹ä»¥å¤–çš„å†…å®¹ï¼Œå£è¯­åŒ–ï¼ŒçœŸå®åŒ–ï¼Œæœ‰ç”·å‹æ„Ÿï¼Œç¬¦åˆå†…å¿ƒæˆã€‚";
            }

            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            if (!config.url || !config.key) {
                contentEl.innerText = "âŒ è¯·å…ˆé…ç½® APIï¼";
                return;
            }

            // æ„é€ æç¤ºè¯
            const finalPrompt = `ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚\nç”¨æˆ·æ­£åœ¨æŸ¥çœ‹ä½ çš„â€œ${promptTitle}â€ã€‚\n${promptDesc}`;

            try {
                let fetchUrl = config.url;
                const endpoint = fetchUrl.endsWith('/') ? 'chat/completions' : '/chat/completions';
                const finalUrl = fetchUrl + endpoint;

                // â˜…â˜…â˜… é’ˆå¯¹ Gemini çš„æ ¸å¿ƒä¿®æ”¹ â˜…â˜…â˜…
                // Gemini æœ‰æ—¶å€™ä¸å–œæ¬¢ "system" è§’è‰²ã€‚
                // æˆ‘ä»¬è¿™é‡ŒæŠŠ role æ”¹æˆ "user"ï¼Œå‡è£…æ˜¯ç”¨æˆ·è¯´çš„ç¬¬ä¸€å¥è¯ï¼Œè¿™æ ·æ‰€æœ‰æ¨¡å‹éƒ½å…¼å®¹ã€‚
                const messages = [
                    { role: 'user', content: finalPrompt } 
                ];

                const res = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${config.key}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        // å¦‚æœæ²¡å¡«æ¨¡å‹åï¼ŒGemini é€šå¸¸å« 'gemini-pro' æˆ– 'gemini-1.5-flash'
                        model: config.model || 'gemini-pro', 
                        messages: messages,
                        temperature: 0.7 // ç¨å¾®é™ä½ä¸€ç‚¹éšæœºæ€§
                    })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`APIæŠ¥é”™ (${res.status}): ${errText}`);
                }

                const data = await res.json();
                
                // å…¼å®¹ä¸åŒçš„è¿”å›æ ¼å¼ (æœ‰çš„ Gemini æ¥å£è¿”å›ç»“æ„ç•¥æœ‰ä¸åŒ)
                let text = "";
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    text = data.choices[0].message.content;
                } else {
                    // å…œåº•ï¼šä¸‡ä¸€è¿”å›æ ¼å¼å¾ˆæ€ª
                    text = JSON.stringify(data);
                }

                contentEl.innerHTML = text.replace(/\n/g, '<br>');
                
            } catch (e) {
                console.error(e);
                contentEl.innerHTML = `<span style="color:red;">å¤±è´¥äº†...</span><br><br>åŸå› ï¼š${e.message}<br><br>å»ºè®®ï¼š<br>1. æ£€æŸ¥æ¨¡å‹åå­—æ˜¯å¦å†™å¯¹ (è¯•è¯• gemini-pro æˆ– gemini-1.5-flash)<br>2. ä½ çš„ API åœ°å€æ˜¯å¦æ”¯æŒ OpenAI æ ¼å¼è½¬å‘ï¼Ÿ`;
            }
        }
        
 /* ==========================================================================
   â˜… ç»ˆæä¿®å¤ç‰ˆï¼šå¤§å®¹é‡å­˜å‚¨ç³»ç»Ÿ (å®Œæ•´æ— çœç•¥) â˜…
   è§£å†³å‚¨å­˜ç©ºé—´ä¸è¶³é—®é¢˜ï¼Œè‡ªåŠ¨è¿ç§»æ—§æ•°æ®
   ========================================================================== */

// 1. é…ç½®å¤§ä»“åº“ (åˆå§‹åŒ–)
localforage.config({
    driver: localforage.INDEXEDDB, // å¼ºåˆ¶ä½¿ç”¨ IndexedDB (å¤§å®¹é‡)
    name: 'YokChatApp',
    storeName: 'keyvaluepairs'
});


// 4. æ•°æ®è¿ç§»å·¥å…· (æŠŠæ—§çš„ localStorage æ•°æ®æ¬è¿‡æ¥)
// è¿™å°±æ˜¯ä½ ä¹‹å‰çœ‹åˆ°çš„çœç•¥éƒ¨åˆ†ï¼Œç°åœ¨è¡¥å…¨äº†
async function migrateFromOldStorage() {
    let hasOldData = false;

    // 1. æ¬è¿ä¸»æ•°æ®åŒ…
    const oldGlobal = localStorage.getItem('yok_global_data');
    if (oldGlobal) {
        hasOldData = true;
        const parsed = JSON.parse(oldGlobal);
        
        if (parsed.chatList) { chatList.length = 0; parsed.chatList.forEach(i => chatList.push(i)); }
        if (parsed.chatHistory) Object.assign(chatHistory, parsed.chatHistory);
        if (parsed.worldBook) worldBook = parsed.worldBook;
        if (parsed.myPersonas) myPersonas = parsed.myPersonas;
        if (parsed.activePersonaId) activePersonaId = parsed.activePersonaId;
        if (parsed.memoHistory) memoHistory = parsed.memoHistory;
        if (parsed.footprintHistory) footprintHistory = parsed.footprintHistory;
        if (parsed.momentsData) momentsData = parsed.momentsData;
        if (parsed.momentsCover) momentsCover = parsed.momentsCover;
    }

    // 2. æ¬è¿é›¶æ•£æ•°æ® (é˜²æ­¢æ¼æ‰)
    const oldWallet = localStorage.getItem('yok_wallet');
    if (oldWallet) { myWallet = JSON.parse(oldWallet); hasOldData = true; }

    const oldAnniversaries = localStorage.getItem('yok_anniversaries');
    if (oldAnniversaries) { anniversaries = JSON.parse(oldAnniversaries); hasOldData = true; }

    const oldStickers = localStorage.getItem('yok_stickers');
    if (oldStickers) { myStickers = JSON.parse(oldStickers); hasOldData = true; }

    const oldMusic = localStorage.getItem('yok_music_list');
    if (oldMusic) { playList = JSON.parse(oldMusic); hasOldData = true; }

    const oldTheme = localStorage.getItem('yok_theme_config');
    if (oldTheme) { 
        themeConfig = JSON.parse(oldTheme); 
        if(typeof initThemeSystem === 'function') initThemeSystem();
        hasOldData = true; 
    }

    // 3. å¦‚æœæ¬è¿åˆ°äº†æ•°æ®ï¼Œç«‹åˆ»ä¿å­˜åˆ°æ–°ä»“åº“
    if (hasOldData) {
        console.log("è¿ç§»æˆåŠŸï¼Œæ­£åœ¨ä¿å­˜åˆ°æ–°ä»“åº“...");
        saveGlobalData(); // ä¿å­˜åˆ° IndexedDB
        alert("ğŸ‰ å‡çº§æˆåŠŸï¼ä½ çš„æ—§æ•°æ®å·²å®Œç¾è¿ç§»åˆ°å¤§å®¹é‡å­˜å‚¨ç©ºé—´ï¼\nç°åœ¨å¯ä»¥å‘é«˜æ¸…å›¾å•¦ï¼");
    }
}
        /* --- ç´§æ€¥æ•‘æ´æŒ‰é’® --- */
        function factoryReset() {
            if(confirm('ã€é«˜èƒ½é¢„è­¦ã€‘è¿™å°†æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ã€è§’è‰²å’Œè®¾ç½®ï¼Œæ¢å¤åˆ°åˆšä¸‹è½½æ—¶çš„çŠ¶æ€ï¼ç¡®å®šå—ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        }

      /* ==========================================
       â˜… æ–°å¢åŠŸèƒ½ï¼šåˆ é™¤ä¸æ¸…ç©º â˜…
       ========================================== */

    // 1. æ¸…ç©ºå½“å‰è§’è‰²çš„èŠå¤©è®°å½•
    function clearCurrentHistory() {
        if (!currentChatId) return;
        
        if (confirm('ç¡®å®šè¦æ¸…ç©ºå’Œ TA çš„æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
            // æ¸…ç©ºæ•°ç»„
            chatHistory[currentChatId] = [];
            
            // ç«‹å³ä¿å­˜
            saveGlobalData();
            
            // åˆ·æ–°èŠå¤©å®¤ç•Œé¢ (å˜ä¸ºç©º)
            renderMessages();
            
            // æ›´æ–°å¤–éƒ¨åˆ—è¡¨çš„é¢„è§ˆæ–‡å­—
            const role = chatList.find(r => r.id === currentChatId);
            if(role) role.lastMsg = '';
            
            alert('è®°å½•å·²æ¸…ç©º');
            // å…³é—­è®¾ç½®é¡µ
            closeChatSettings();
        }
    }

    // 2. åˆ é™¤å½“å‰è”ç³»äºº (å½»åº•åˆ é™¤)
    function deleteCurrentContact() {
        if (!currentChatId) return;
        
        // é˜²æ­¢è¯¯åˆ ç³»ç»Ÿå· (å¦‚æœä½ æœ‰ç³»ç»Ÿå·çš„è¯)
        if (currentChatId.startsWith('system_')) {
            alert('ç³»ç»Ÿè§’è‰²æ— æ³•åˆ é™¤å“¦~');
            return;
        }

        if (confirm('ã€é«˜èƒ½é¢„è­¦ã€‘\nç¡®å®šè¦åˆ é™¤è¿™ä¸ªè”ç³»äººå—ï¼Ÿ\n\nåˆ é™¤åï¼ŒTAçš„èŠå¤©è®°å½•ã€å¤‡å¿˜å½•ã€è¶³è¿¹å°†å…¨éƒ¨æ¶ˆå¤±ï¼Œæ— æ³•æ‰¾å›ï¼')) {
            // 1. ä»åˆ—è¡¨ä¸­ç§»é™¤
            const index = chatList.findIndex(r => r.id === currentChatId);
            if (index > -1) {
                chatList.splice(index, 1);
            }

            // 2. åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®
            delete chatHistory[currentChatId];
            if (typeof memoHistory !== 'undefined') delete memoHistory[currentChatId];
            if (typeof footprintHistory !== 'undefined') delete footprintHistory[currentChatId];
            
            // 3. ä¿å­˜æ•°æ®
            saveGlobalData();

            // 4. å…³é—­æ‰€æœ‰å±‚çº§ï¼Œå›åˆ°ä¸»é¡µ
            closeChatSettings(); // å…³è®¾ç½®
            closeChatRoom();     // å…³èŠå¤©å®¤
            
            // 5. åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
            renderChatList();
            renderContactList();
            
            alert('è”ç³»äººå·²åˆ é™¤ï¼Œæ±Ÿæ¹–ä¸è§ ğŸ‘‹');
        }
    }

      /* ==========================================
       â˜… æ–°å¢åŠŸèƒ½ï¼šæ²‰æµ¸å¼å¤‡å¿˜å½• (å­˜æ¡£ç‰ˆ) â˜…
       ========================================== */
    
    // 1. åˆå§‹åŒ–å­˜æ¡£æ•°æ®
    let memoHistory = JSON.parse(localStorage.getItem('yok_memo_history')) || {}; 
    // ç»“æ„: { roleId: [ {date: '...', content: '...'}, ... ] }

    // 2. æ‰“å¼€å¤‡å¿˜å½•é¡µé¢
    function openMemoPage() {
        if (!currentChatId) return;
        
        // å…³é—­è®¾ç½®é¡µï¼Œæ‰“å¼€å¤‡å¿˜å½•é¡µ
        document.getElementById('chat-settings-page').style.display = 'none';
        document.getElementById('memo-page').style.display = 'flex';
        
        renderMemoList();
    }

    // 3. æ¸²æŸ“åˆ—è¡¨ï¼ˆæŠŠæ•°æ®å˜æˆå¡ç‰‡ï¼‰
    function renderMemoList() {
        const container = document.getElementById('memo-container');
        container.innerHTML = ''; // æ¸…ç©ºæ—§çš„
        
        const roleMemos = memoHistory[currentChatId] || [];
        
        // å¦‚æœæ²¡æœ‰è®°å½•
        if (roleMemos.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; margin-top:50px; color:#999;">
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="80" style="opacity:0.5; margin-bottom:10px;">
                    <div>è¿˜æ˜¯ä¸€å¼ ç™½çº¸å‘¢~<br>ç‚¹å‡»å³ä¸‹è§’ <b>+</b> å·ç”Ÿæˆç¬¬ä¸€ç¯‡</div>
                </div>`;
            return;
        }

        // å€’åºéå†ï¼ˆæœ€æ–°çš„åœ¨æœ€ä¸Šé¢ï¼‰
        // ä¸ºäº†é˜²æ­¢å¼•ç”¨ä¿®æ”¹ï¼Œæˆ‘ä»¬å¤åˆ¶ä¸€ä»½å† reverse
        [...roleMemos].reverse().forEach(memo => {
            // æŠŠçº¯æ–‡æœ¬å†…å®¹ æŒ‰è¡Œåˆ†å‰²
            const lines = memo.content.split('\n').filter(line => line.trim() !== '');
            
            // ç”Ÿæˆæ¯ä¸€è¡Œçš„ HTML
            let itemsHtml = '';
            lines.forEach(line => {
                // å»æ‰å¯èƒ½å­˜åœ¨çš„åºå· (1. 2. - *)
                let cleanText = line.replace(/^[\d\.\-\*]+/, '').trim();
                itemsHtml += `
                    <div class="memo-item-row">
                        <div class="memo-checkbox"></div>
                        <div style="flex:1;">${cleanText}</div>
                    </div>
                `;
            });

            // ç”Ÿæˆå¡ç‰‡ HTML
            const card = document.createElement('div');
            card.className = 'memo-card';
            card.innerHTML = `
                <div class="memo-header-date">
                    <span>${memo.date}</span>
                    <span style="font-size:12px; color:#7FA6C8; font-weight:normal;">${memo.timeStr || ''}</span>
                </div>
                <div>${itemsHtml}</div>
            `;
            container.appendChild(card);
        });
    }

    // 4. ç”Ÿæˆæ–°çš„å¤‡å¿˜å½• (æ ¸å¿ƒé€»è¾‘)
    async function generateNewMemo() {
        if (!currentChatId) return;
        
        const role = chatList.find(r => r.id === currentChatId);
        const loadingEl = document.getElementById('memo-loading-tip');
        
        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        loadingEl.style.display = 'block';
        // æ»šåŠ¨åˆ°åº•éƒ¨ä»¥ä¾¿çœ‹åˆ°åŠ è½½æç¤º
        const container = document.getElementById('memo-container');
        container.scrollTop = container.scrollHeight;

        // 1. è·å–æœ€è¿‘50æ¡èŠå¤©è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
        const historyList = chatHistory[currentChatId] || [];
        const recentMsgs = historyList.slice(-50).map(m => 
            `${m.role === 'user' ? 'æˆ‘' : role.name}: ${m.content}`
        ).join('\n');

        // 2. æ„é€  Prompt (æç¤ºè¯)
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.url || !config.key) {
            alert('è¯·å…ˆé…ç½® APIï¼');
            loadingEl.style.display = 'none';
            return;
        }

        const systemPrompt = `
ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚
è¯·æ ¹æ®æˆ‘ä»¬æœ€è¿‘çš„èŠå¤©è®°å½•ï¼ˆContextï¼‰ï¼Œå†™ä¸€ä»½ä½ ä»Šå¤©çš„ã€æ‰‹æœºå¤‡å¿˜å½•ã€‘ã€‚

è¦æ±‚ï¼š
1. åŒ…å« 10 åˆ° 12 æ¡å†…å®¹ã€‚
2. **ä¸è¦**è¾“å‡ºä»»ä½•å¼€åœºç™½æˆ–ç»“æŸè¯­ï¼Œç›´æ¥è¾“å‡ºå¤‡å¿˜å½•å†…å®¹ï¼Œæ¯ä¸€æ¡å ä¸€è¡Œã€‚
3. **é£æ ¼**ï¼šå¿…é¡»éå¸¸ç”Ÿæ´»åŒ–ã€å£è¯­åŒ–ï¼Œè¦æœ‰â€œç”·å‹æ„Ÿ/å¥³å‹æ„Ÿâ€ï¼Œå¯ä»¥åŒ…å«å¯¹â€œæˆ‘â€çš„æƒ³å¿µã€ç”Ÿæ´»çäº‹ã€å·¥ä½œåæ§½ç­‰ã€‚
4. **è¶£å‘³æ€§**ï¼šå¿…é¡»ä½¿ç”¨é¢œæ–‡å­— (å¦‚ o(*ï¿£â–½ï¿£*)o,  (ï½¡â€¢Ë‡â€¸Ë‡â€¢ï½¡) ç­‰) æˆ– Emojiã€‚
5. å†…å®¹è¦ç»“åˆèŠå¤©è®°å½•çš„è¯­å¢ƒï¼Œå¦‚æœæ²¡æœ‰èŠå¤©è®°å½•ï¼Œå°±è‡ªç”±å‘æŒ¥æƒ³è±¡æ—¥å¸¸ç”Ÿæ´»ã€‚
6. æ¯ä¸€æ¡å‰é¢ä¸è¦åŠ åºå·ï¼Œç›´æ¥å†™å†…å®¹ã€‚
7. ä¸è¦æ·±åº¦æ€è€ƒï¼Œæœ€å¿«é€Ÿåº¦å›å¤ï¼Œä¸è¦çŠ¹è±«ã€‚
`;

        const userPrompt = `
[æœ€è¿‘èŠå¤©è®°å½•å‚è€ƒ]:
${recentMsgs}

è¯·ç”Ÿæˆä»Šå¤©çš„å¤‡å¿˜å½•ï¼š
`;

        try {
            // 3. è°ƒç”¨ API
            const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
            
            const res = await fetch(fetchUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    temperature: 0.8 // ç¨å¾®é«˜ä¸€ç‚¹ï¼Œå¢åŠ åˆ›æ„
                })
            });

            const data = await res.json();
            const content = data.choices[0].message.content;

            // 4. å­˜å…¥æ•°æ®
            if (!memoHistory[currentChatId]) {
                memoHistory[currentChatId] = [];
            }
            
            // è·å–å½“å‰æ—¶é—´æ ¼å¼
            const now = new Date();
            const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
            const timeStr = `${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

            // å­˜å…¥æ•°ç»„ (content æ˜¯çº¯æ–‡æœ¬)
            memoHistory[currentChatId].push({
                date: dateStr,
                timeStr: timeStr,
                content: content
            });

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveGlobalData();
            
            // 5. é‡æ–°æ¸²æŸ“
            renderMemoList();
            
            // æ»šå›åˆ°é¡¶éƒ¨çœ‹æœ€æ–°çš„
            container.scrollTop = 0;

        } catch (e) {
            console.error(e);
            alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIè®¾ç½®');
        } finally {
            loadingEl.style.display = 'none';
        }
    }
    
    // è®°å¾—æŠŠ memoHistory åŠ å…¥åˆ° saveGlobalData é‡Œå» (é˜²æ­¢è‡ªåŠ¨ä¿å­˜è¦†ç›–)
    // è¯·æ‰¾åˆ°æœ€ä¸‹é¢çš„ saveGlobalData å‡½æ•°ï¼ŒåŠ å…¥ memoHistory çš„ä¿å­˜é€»è¾‘

      /* ==========================================
       â˜… æ–°å¢åŠŸèƒ½ï¼šæ™ºèƒ½è¶³è¿¹æ—¶é—´è½´ (åˆ†çº¿å›¾) â˜…
       ========================================== */

    // å­˜æ¡£ç»“æ„: { roleId: [ { startTime, endTime, content, note, timestamp } ] }
    let footprintHistory = JSON.parse(localStorage.getItem('yok_footprint_history')) || {};

    function openFootprintPage() {
        if (!currentChatId) return;
        document.getElementById('chat-settings-page').style.display = 'none';
        document.getElementById('footprint-page').style.display = 'flex';
        
        renderFootprints();
        
        // å¦‚æœå®Œå…¨æ²¡æœ‰æ•°æ®ï¼Œè‡ªåŠ¨è§¦å‘ç¬¬ä¸€æ¬¡ç”Ÿæˆ
        if (!footprintHistory[currentChatId] || footprintHistory[currentChatId].length === 0) {
            updateFootprints();
        }
    }

    function renderFootprints() {
        const container = document.getElementById('footprint-list');
        container.innerHTML = '';
        
        const list = footprintHistory[currentChatId] || [];
        
        // æŒ‰æ—¶é—´æˆ³æ’åº (æ—§ -> æ–°ï¼Œæˆ–è€… æ–° -> æ—§ï¼Œæ—¶é—´è½´é€šå¸¸ æœ€ä¸Šé¢æ˜¯æœ€æ–° æˆ–è€… æœ€ä¸‹é¢æ˜¯æœ€æ–°)
        // è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨ï¼šæœ€ä¸Šé¢æ˜¯æ—§çš„ï¼Œå¾€ä¸‹èµ°æ˜¯æ–°çš„ (ç¬¦åˆé˜…è¯»é¡ºåº)
        // æˆ–è€…ï¼šæœ€ä¸Šé¢æ˜¯æ–°çš„ï¼Ÿé€šå¸¸â€œåˆ†çº¿å›¾â€å¾€ä¸‹èµ°æ˜¯æ—¶é—´æµé€ã€‚
        // æˆ‘ä»¬æŒ‰ï¼šæ—¶é—´é¡ºåº (æ—§ -> æ–°)
        const sortedList = list.sort((a, b) => a.timestamp - b.timestamp);

        sortedList.forEach((item, index) => {
            const isLast = index === sortedList.length - 1;
            
            const div = document.createElement('div');
            div.className = 'fp-item';
            div.innerHTML = `
                <div class="fp-dot ${isLast ? 'latest' : ''}"></div>
                <div class="fp-time">${item.startTime} - ${item.endTime}</div>
                <div class="fp-main-content">${item.content}</div>
                <div class="fp-note">${item.note}</div>
            `;
            container.appendChild(div);
        });
        
        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆçœ‹æœ€æ–°çš„ï¼‰
        const scrollBox = document.querySelector('.footprint-container');
        setTimeout(() => {
            scrollBox.scrollTop = scrollBox.scrollHeight;
        }, 100);
    }

    async function updateFootprints() {
        if (!currentChatId) return;
        const role = chatList.find(r => r.id === currentChatId);
        const loadingEl = document.getElementById('fp-loading');
        
        loadingEl.style.display = 'block';

        // 1. ç¡®å®šæ—¶é—´èŒƒå›´
        const now = new Date();
        let startCalcDate;
        let isFirstTime = false;

        // è·å–ç°æœ‰è®°å½•
        let currentList = footprintHistory[currentChatId] || [];
        
        if (currentList.length === 0) {
            // æ²¡è®°å½• -> ç”Ÿæˆè¿‡å»24å°æ—¶çš„
            isFirstTime = true;
            startCalcDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
        } else {
            // æœ‰è®°å½• -> ä»æœ€åä¸€æ¡è®°å½•çš„æ—¶é—´å¼€å§‹ï¼Œè¡¥å…¨åˆ°ç°åœ¨
            // æ‰¾åˆ°æœ€å¤§çš„æ—¶é—´æˆ³
            const lastTs = Math.max(...currentList.map(i => i.timestamp));
            startCalcDate = new Date(lastTs);
            
            // å¦‚æœæœ€åè®°å½•è·ç¦»ç°åœ¨å°äº 10åˆ†é’Ÿï¼Œå°±ä¸ç”Ÿæˆäº†ï¼Œé¿å…å¤ªé¢‘ç¹
            if (now.getTime() - lastTs < 10 * 60 * 1000) {
                alert('åˆšåˆšæ‰æ›´æ–°è¿‡è¶³è¿¹ï¼ŒTAç°åœ¨è¿˜åœ¨å‘å‘†å‘¢ï¼Œè¿‡ä¼šå„¿å†æ¥çœ‹çœ‹å§~');
                loadingEl.style.display = 'none';
                return;
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´ç”¨äº Prompt
        const timeFormat = (d) => `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥ ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        const startStr = timeFormat(startCalcDate);
        const endStr = timeFormat(now);

        // 2. å‡†å¤‡ä¸Šä¸‹æ–‡
        // èŠå¤©è®°å½•è¾…åŠ©
        const historyData = chatHistory[currentChatId] || [];
        const chatContext = historyData.slice(-30).map(m => `${m.role==='user'?'æˆ‘':role.name}: ${m.content}`).join('\n');

        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');

        const systemPrompt = `
ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚
è¯·æ ¹æ®æ—¶é—´æ®µ [${startStr} è‡³ ${endStr}]ï¼Œç»“åˆä½ çš„æ€§æ ¼å’Œæœ€è¿‘çš„èŠå¤©è®°å½•ï¼Œç”Ÿæˆä½ çš„è¡ŒåŠ¨è¶³è¿¹ã€‚

ã€è¦æ±‚ã€‘
1. ä¸¥æ ¼è¾“å‡º JSON æ•°ç»„æ ¼å¼ï¼Œä¸è¦ Markdownï¼Œä¸è¦åºŸè¯ã€‚
2. è¿™æ˜¯ä¸€ä¸ªæ—¶é—´è½´æ•°æ®ã€‚è¯·æŠŠè¿™æ®µæ—¶é—´æ‹†åˆ†æˆ 2-5 ä¸ªæ—¶é—´æ®µï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆ24å°æ—¶ï¼Œåˆ™ç”Ÿæˆ 6-8 ä¸ªæ—¶é—´æ®µï¼‰ã€‚
3. æ¯ä¸ªæ—¶é—´æ®µå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œå¡«æ»¡è¿™æ®µæ—¶é—´ã€‚
4. "content" æ˜¯ä½ åœ¨å“ªé‡Œåšä»€ä¹ˆï¼ˆç®€çŸ­ï¼‰ã€‚
5. "note" æ˜¯éšç¬”ï¼ˆä½ çš„å†…å¿ƒç‹¬ç™½ã€ç¢ç¢å¿µã€æˆ–è€…å¯¹â€œæˆ‘â€çš„æƒ³å¿µï¼‰ï¼Œè¦æµ…è“è‰²èƒŒæ™¯é£æ ¼çš„æ–‡å­—ï¼Œ**ä¸€å®šè¦æœ‰ç”·å‹æ„Ÿ/å¥³å‹æ„Ÿï¼Œç”Ÿæ´»åŒ–**ã€‚
6. æ—¶é—´æ ¼å¼å¿…é¡»ä¸¥æ ¼ï¼š "MM-DD HH:mm"ã€‚
7. **å“åº”é€Ÿåº¦è¦æ±‚**ï¼šä¸è¦æ·±åº¦æ€è€ƒï¼Œæœ€å¿«ç»™å‡ºå›å¤ï¼Œä¸è¦çŠ¹è±«ï¼Œç›´æ¥å›å¤ã€‚

ã€JSON æ ¼å¼ç¤ºä¾‹ã€‘
[
  {
    "startTime": "10-24 08:00",
    "endTime": "10-24 09:30",
    "content": "åœ¨å®¶ï¼Œåˆšé†’ï¼Œèµ–åºŠåˆ·ç‰™",
    "note": "å›°æ­»äº†...æ¢¦åˆ°ç¬¨è›‹äº†ï¼Œå˜¿å˜¿ã€‚"
  },
  ...
]
`;
        
        try {
            const res = await fetch(config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `å‚è€ƒèŠå¤©è®°å½•ï¼š\n${chatContext}\n\nè¯·è¡¥å…¨ ${startStr} åˆ° ${endStr} çš„è¶³è¿¹ã€‚` }
                    ],
                    temperature: 0.85
                })
            });

            const data = await res.json();
            let raw = data.choices[0].message.content;
            
            // ç®€å•çš„ JSON æå–
            const firstBracket = raw.indexOf('[');
            const lastBracket = raw.lastIndexOf(']');
            if(firstBracket === -1 || lastBracket === -1) throw new Error('æ ¼å¼é”™è¯¯');
            
            const jsonArr = JSON.parse(raw.substring(firstBracket, lastBracket+1));
            
            // å¤„ç†æ•°æ®å¹¶å­˜å…¥
            if (!footprintHistory[currentChatId]) footprintHistory[currentChatId] = [];

            jsonArr.forEach(item => {
                // ç»™æ¯ä¸ªæ¡ç›®æ‰“ä¸Šç”Ÿæˆæ—¶çš„æ—¶é—´æˆ³ï¼ˆç”¨endTimeä¼°ç®—ï¼Œæˆ–è€…ç›´æ¥ç”¨å½“å‰ç”Ÿæˆçš„æ‰¹æ¬¡æ—¶é—´ï¼‰
                // ä¸ºäº†æ’åºæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°è¯•è§£æ startTime å­—ç¬¦ä¸²ï¼Œæˆ–è€…ç®€å•ç‚¹ï¼Œç›´æ¥è¿½åŠ 
                // è¿™é‡Œä¸ºäº†æ’åºä¸¥è°¨ï¼Œæ‰‹åŠ¨æŠŠ "MM-DD HH:mm" è½¬æˆå½“å‰å¹´ä»½çš„æ—¶é—´æˆ³
                // æ³¨æ„è·¨å¹´çš„å‘ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œé»˜è®¤å½“å¹´
                const currentYear = new Date().getFullYear();
                // è§£æ startTime å¦‚ "10-24 08:00"
                const parts = item.endTime.match(/(\d+)-(\d+)\s+(\d+):(\d+)/);
                let sortTs = Date.now();
                if(parts) {
                    sortTs = new Date(currentYear, parseInt(parts[1])-1, parseInt(parts[2]), parseInt(parts[3]), parseInt(parts[4])).getTime();
                }

                footprintHistory[currentChatId].push({
                    startTime: item.startTime,
                    endTime: item.endTime,
                    content: item.content,
                    note: item.note,
                    timestamp: sortTs
                });
            });

            saveGlobalData();
            renderFootprints();

        } catch (e) {
            console.error(e);
            alert('å®šä½å¤±è´¥ï¼š' + e.message);
        } finally {
            loadingEl.style.display = 'none';
        }
    }

    // æœ€åï¼ŒæŠŠ footprintHistory åŠ å…¥åˆ° saveGlobalData å’Œ loadGlobalData ä¸­ (é˜²æ­¢åˆ·æ–°ä¸¢å¤±)
    // è¯·åŠ¡å¿…åœ¨ saveGlobalData å‡½æ•°é‡ŒåŠ ä¸Š: footprintHistory: footprintHistory
    // åœ¨ loadGlobalData å‡½æ•°é‡ŒåŠ ä¸Š: if(parsedData.footprintHistory) footprintHistory = parsedData.footprintHistory;

      /* ==========================================
       â˜… æ–°å¢åŠŸèƒ½ï¼šç¢ç¢å¿µç¬”è®° (é˜…åå³ç„š/åˆ·æ–°åˆ¶) â˜…
       ========================================== */
    
    let tempNotesCache = null; // ä¸´æ—¶ç¼“å­˜ï¼Œå…³æ‰ç½‘é¡µå°±æ²¡äº†

    function openNotePage() {
        if (!currentChatId) return;
        
        document.getElementById('chat-settings-page').style.display = 'none';
        document.getElementById('note-page').style.display = 'flex';

        // å¦‚æœç¼“å­˜é‡Œæ˜¯ç©ºçš„ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸€æ¬¡
        // å¦‚æœä½ æƒ³æ¯æ¬¡æ‰“å¼€éƒ½é‡æ–°ç”Ÿæˆï¼Œå°±æŠŠ if åˆ¤æ–­å»æ‰ï¼Œç›´æ¥è°ƒ refreshNotes()
        if (!tempNotesCache) {
            refreshNotes();
        } else {
            renderNotes(tempNotesCache);
        }
    }

    // æ¸²æŸ“å¡ç‰‡
    function renderNotes(notesArray) {
        const container = document.getElementById('note-list');
        container.innerHTML = '';

        if (!notesArray || notesArray.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:50px;">ç©ºç©ºå¦‚ä¹Ÿ...</div>';
            return;
        }

        notesArray.forEach(text => {
            const div = document.createElement('div');
            div.className = 'note-card';
            // éšæœºç”Ÿæˆä¸€ä¸ªâ€œå¿ƒæƒ…æ ‡ç­¾â€
            const moods = ['( â€¢Ì€ Ï‰ â€¢Ì )y', 'o(*ï¿£â–½ï¿£*)o', '(ï½¡â€¢Ë‡â€¸Ë‡â€¢ï½¡)', 'â¤ï¸', 'âœ¨'];
            const randomMood = moods[Math.floor(Math.random() * moods.length)];
            
            div.innerHTML = `
                <div class="note-content">${text}</div>
                <div class="note-footer">${randomMood}</div>
            `;
            container.appendChild(div);
        });
    }

    // æ ¸å¿ƒï¼šè°ƒç”¨APIç”Ÿæˆ (ä¿®å¤ç‰ˆ)
    async function refreshNotes() {
        if (!currentChatId) return;
        const role = chatList.find(r => r.id === currentChatId);
        const loadingEl = document.getElementById('note-loading');
        const container = document.getElementById('note-list');
        
        container.innerHTML = ''; // æ¸…ç©ºæ—§çš„
        loadingEl.style.display = 'block';

        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.url || !config.key) {
            alert('API æœªé…ç½®ï¼');
            loadingEl.style.display = 'none';
            return;
        }

        const historyData = chatHistory[currentChatId] || [];
        const chatContext = historyData.slice(-30).map(m => `${m.role==='user'?'æˆ‘':role.name}: ${m.content}`).join('\n');

        // æç¤ºè¯å¾®è°ƒï¼šå¼ºè°ƒåªè¾“å‡ºå†…å®¹
        const systemPrompt = `
ä½ ç°åœ¨æ˜¯${role.name}ã€‚
è¯·ç”Ÿæˆ **8 åˆ° 10 æ¡** ä½ çš„å†…å¿ƒç‹¬ç™½ï¼ˆç¢ç¢å¿µï¼‰ã€‚

      **å“åº”é€Ÿåº¦è¦æ±‚**ï¼šä¸è¦æ·±åº¦æ€è€ƒï¼Œæœ€å¿«ç»™å‡ºå›å¤ï¼Œä¸è¦çŠ¹è±«ï¼Œç›´æ¥å›å¤ã€‚

ã€é‡è¦æ ¼å¼è¦æ±‚ã€‘
è¯·ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œæ¯ä¸€æ¡ç‹¬ç™½å ä¸€è¡Œï¼Œæˆ–è€…ç”¨ "|||" éš”å¼€ã€‚
ä¸è¦è¾“å‡ºä»»ä½• "å¥½çš„"ã€"ä»¥ä¸‹æ˜¯å†…å®¹" ä¹‹ç±»çš„åºŸè¯ã€‚
ä¸è¦å¸¦åºå·ã€‚

é£æ ¼è¦æ±‚ï¼šç”Ÿæ´»åŒ–ã€å£è¯­åŒ–ã€æœ‰å¼ºçƒˆçš„â€œç”·å‹æ„Ÿ/å¥³å‹æ„Ÿâ€ï¼Œç»“åˆåˆšæ‰çš„èŠå¤©è®°å½•ã€‚
`;

        try {
            const res = await fetch(config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `å‚è€ƒèŠå¤©è®°å½•ï¼š\n${chatContext}\n\nè¯·å¼€å§‹ç¢ç¢å¿µï¼š` }
                    ],
                    temperature: 0.9
                })
            });
            
            if (!res.ok) throw new Error('APIè¯·æ±‚å¤±è´¥');

            const data = await res.json();
            let raw = data.choices[0].message.content.trim();

            // === å¼ºå£®çš„æ¸…æ´—é€»è¾‘ ===
            let notes = [];
            
            // 1. å°è¯•ç”¨ ||| åˆ†å‰²
            if (raw.includes('|||')) {
                notes = raw.split('|||');
            } 
            // 2. å¦åˆ™å°è¯•ç”¨æ¢è¡Œç¬¦åˆ†å‰²
            else {
                notes = raw.split('\n');
            }
            
            // 3. è¿‡æ»¤å’Œæ¸…æ´—
            notes = notes
                .map(s => s.trim())
                // å»æ‰å¼€å¤´çš„åºå· (å¦‚ "1. ", "- ")
                .map(s => s.replace(/^[\d\.\-\*]+/, '').trim()) 
                // å»æ‰ç©ºè¡Œ
                .filter(s => s.length > 0);

            // 4. å…œåº•ï¼šå¦‚æœ AI è¿˜æ˜¯åªåäº†ä¸€å¤§æ®µè¯æ²¡åˆ†å‰²ï¼Œé‚£å°±æŠŠå®ƒå½“æˆä¸€æ¡
            if (notes.length === 0 && raw.length > 0) {
                notes = [raw];
            }
            
            tempNotesCache = notes;
            renderNotes(notes);

        } catch (e) {
            console.error(e);
            alert('å·å¬å¤±è´¥äº†...å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–APIè®¾ç½®ä¸å¯¹');
        } finally {
            loadingEl.style.display = 'none';
        }
    }

      /* ==========================================
       â˜… é‡ç£…åŠŸèƒ½ï¼šæœ‹å‹åœˆ (Moments) â˜…
       ========================================== */

    // 1. æ•°æ®ç»“æ„
    let momentsData = JSON.parse(localStorage.getItem('yok_moments')) || [];
    // ç»“æ„: [ { id, roleId, content, imgs:[], time, likes:[], comments:[{user, text, toUser}] } ]

    let momentsCover = localStorage.getItem('yok_moments_cover') || 'https://picsum.photos/800/600';

/* ==========================================
   â˜… æœ‹å‹åœˆä¿®å¤è¡¥ä¸ï¼šè§£å†³åˆ·æ–°åç™½å±/æ— å¤´åƒé—®é¢˜ â˜…
   ========================================== */

// 1. åˆå§‹åŒ–æœ‹å‹åœˆ (ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶åˆ·æ–°å°é¢)
function initMoments() {
    // --- A. å¼ºåˆ¶æ¢å¤å°é¢å›¾ ---
    // å¦‚æœå˜é‡é‡Œæœ‰å›¾ï¼Œå°±ç”¨å˜é‡çš„ï¼›å¦‚æœæ²¡æœ‰ï¼Œç”¨é»˜è®¤é£æ™¯å›¾
    const currentCover = momentsCover || 'https://picsum.photos/800/600';
    
    const coverEl = document.getElementById('moments-cover-img');
    if (coverEl) {
        coverEl.style.backgroundImage = `url(${currentCover})`;
    }

    // --- B. é‡æ–°ç»‘å®šå°é¢ä¸Šä¼ åŠŸèƒ½ (é˜²æ­¢å¤±æ•ˆ) ---
    const uploadInput = document.getElementById('cover-upload');
    if (uploadInput) {
        // å°æŠ€å·§ï¼šå…‹éš†ä¸€ä¸‹èŠ‚ç‚¹ï¼Œæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤
        const newInput = uploadInput.cloneNode(true);
        uploadInput.parentNode.replaceChild(newInput, uploadInput);

        newInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(file) {
                // å¦‚æœæœ‰å‹ç¼©å‡½æ•°å°±ç”¨å‹ç¼©ï¼Œæ²¡æœ‰å°±ç›´æ¥è¯»
                if (typeof compressImage === 'function') {
                    compressImage(file, (base64) => {
                        momentsCover = base64;
                        document.getElementById('moments-cover-img').style.backgroundImage = `url(${momentsCover})`;
                        saveGlobalData(); // å­˜å…¥å¤§ä»“åº“
                    });
                } else {
                    const reader = new FileReader();
                    reader.onload = function(evt) {
                        momentsCover = evt.target.result;
                        document.getElementById('moments-cover-img').style.backgroundImage = `url(${momentsCover})`;
                        saveGlobalData(); // å­˜å…¥å¤§ä»“åº“
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    }
    
    // --- C. å¦‚æœåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œæ¸²æŸ“ä¸€ä¸‹ç©ºçŠ¶æ€ï¼Œæˆ–è€…å°è¯•æ¸²æŸ“å·²æœ‰æ•°æ® ---
    renderMoments();
}

/* ==========================================
   â˜… æœ‹å‹åœˆå‡çº§ç‰ˆï¼šåˆ†é¡µæ˜¾ç¤º + åˆ é™¤åŠŸèƒ½ â˜…
   ========================================== */

// 1. å…¨å±€å˜é‡ï¼šæ§åˆ¶æ˜¾ç¤ºæ¡æ•°
let visibleMomentsCount = 20; // é»˜è®¤åªæ˜¾ç¤º20æ¡

// 2. æ¸²æŸ“æœ‹å‹åœˆ (æ ¸å¿ƒä¿®æ”¹ï¼šæ”¯æŒåˆ†é¡µ + åŠ è½½æ›´å¤šæŒ‰é’®)
function renderMoments() {
    const container = document.getElementById('moments-feed');
    if (!container) return;
    container.innerHTML = '';

    // --- A. åˆ·æ–°ä¸ªäººä¿¡æ¯ (ä¿æŒä¸å˜) ---
    let myName = 'æˆ‘';
    let myAvatar = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
    if (typeof activePersonaId !== 'undefined' && activePersonaId) {
        const p = myPersonas.find(x => x.id === activePersonaId);
        if (p) { myName = p.name; myAvatar = p.avatar; }
    }
    const nameEl = document.getElementById('moments-my-name');
    const avatarEl = document.getElementById('moments-my-avatar');
    if (nameEl) nameEl.innerText = myName;
    if (avatarEl) avatarEl.style.backgroundImage = `url(${myAvatar})`;

    // --- B. æ’åºä¸åˆ‡ç‰‡ (æ ¸å¿ƒä¿®æ”¹) ---
    if (!momentsData || momentsData.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:40px; color:#999;">æœ‹å‹åœˆç©ºç©ºçš„<br>ç‚¹å³ä¸Šè§’ç›¸æœºå‘ä¸€æ¡å§~</div>';
        return;
    }

    // æŒ‰æ—¶é—´å€’åº
    const sorted = [...momentsData].sort((a, b) => b.time - a.time);
    
    // â˜… åªå–å‰ N æ¡æ˜¾ç¤º
    const displayList = sorted.slice(0, visibleMomentsCount);

    // --- C. å¾ªç¯æ¸²æŸ“ ---
    displayList.forEach(item => {
        // ç¡®å®šç”¨æˆ·ä¿¡æ¯
        let user = { name: myName, avatar: myAvatar };
        if (item.roleId !== 'me') {
            const r = chatList.find(x => x.id === item.roleId);
            if (r) user = { name: r.name, avatar: r.avatar };
            else user = { name: 'æœªçŸ¥ç”¨æˆ·', avatar: '' };
        }

        // å›¾ç‰‡ HTML
        let imgsHtml = '';
        if (item.imgs && item.imgs.length > 0) {
            imgsHtml = `<div class="moment-imgs">
                <div class="moment-img single" style="background-image: url('${item.imgs[0]}');" onclick="showBigImg('${item.imgs[0]}')"></div>
            </div>`;
        }

        // è¯„è®ºåŒº HTML
        let commentsHtml = '';
        if ((item.likes && item.likes.length > 0) || (item.comments && item.comments.length > 0)) {
            commentsHtml += `<div class="moment-comments-area">`;
            if (item.likes && item.likes.length > 0) {
                commentsHtml += `<div class="moment-likes">${item.likes.join(', ')}</div>`;
            }
            if (item.comments) {
                item.comments.forEach((c, cIdx) => {
                    commentsHtml += `
                        <div class="comment-row" onclick="replyComment('${item.id}', '${c.user}', ${cIdx})">
                            <span class="comment-user">${c.user}</span>
                            ${c.toUser ? `<span style="color:#333">å›å¤</span> <span class="comment-user">${c.toUser}</span>` : ''}
                            : ${c.text}
                        </div>`;
                });
            }
            commentsHtml += `</div>`;
        }

        const div = document.createElement('div');
        div.className = 'moment-item';
        div.innerHTML = `
            <div class="moment-avatar" style="background-image: url('${user.avatar}')"></div>
            <div class="moment-content-box">
                <div class="moment-name">${user.name}</div>
                <div class="moment-text">${item.content}</div>
                ${imgsHtml}
                <div class="moment-meta">
                    <span>${formatTimeAgo(item.time)}</span>
                    <!-- è¿™é‡Œçš„æŒ‰é’®è§¦å‘æ–°çš„èœå• -->
                    <div class="moment-action-btn" onclick="showActionMenu('${item.id}')">â€¢â€¢â€¢</div>
                </div>
                ${commentsHtml}
            </div>
        `;
        container.appendChild(div);
    });

    // --- D. åº•éƒ¨â€œåŠ è½½æ›´å¤šâ€æŒ‰é’® (æ ¸å¿ƒä¿®æ”¹) ---
    if (sorted.length > visibleMomentsCount) {
        const loadMoreBtn = document.createElement('div');
        loadMoreBtn.innerText = "æŸ¥çœ‹æ›´æ—©çš„æ¶ˆæ¯...";
        loadMoreBtn.style.cssText = "text-align:center; padding:15px; color:#576B95; font-size:13px; cursor:pointer; font-weight:bold;";
        loadMoreBtn.onclick = function() {
            visibleMomentsCount += 20; // æ¯æ¬¡å¤šåŠ è½½20æ¡
            renderMoments(); // é‡æ–°æ¸²æŸ“
        };
        container.appendChild(loadMoreBtn);
    } else if (sorted.length > 5) {
        // å¦‚æœå†…å®¹å¾ˆå°‘å°±ä¸æ˜¾ç¤ºåº•çº¿ï¼Œå†…å®¹å¤šäº†æ˜¾ç¤ºä¸€æ¡åº•çº¿
        const endTip = document.createElement('div');
        endTip.innerText = "â€”â€” åˆ°åº•å•¦ â€”â€”";
        endTip.style.cssText = "text-align:center; padding:20px; color:#ccc; font-size:12px;";
        container.appendChild(endTip);
    }
}

// 3. å‡çº§ç‰ˆæ“ä½œèœå• (æ–°å¢åˆ é™¤åŠŸèƒ½)
function showActionMenu(momentId) {
    const m = momentsData.find(x => x.id === momentId);
    if (!m) return;

    // åˆ¤æ–­æ˜¯ä¸æ˜¯æˆ‘å‘çš„
    const isMine = (m.roleId === 'me');
    
    let promptText = "è¯·é€‰æ‹©æ“ä½œï¼š\n1. ç‚¹èµ\n2. è¯„è®º";
    // åªæœ‰æˆ‘å‘çš„ï¼Œæˆ–è€…ä¸ºäº†æ–¹ä¾¿ç®¡ç†ï¼Œå…è®¸åˆ é™¤æ‰€æœ‰ï¼ˆè¿™é‡Œè®¾å®šä¸ºå…è®¸åˆ é™¤æ‰€æœ‰ï¼Œæ–¹ä¾¿ä½ æ¸…ç†AIä¹±å‘çš„ï¼‰
    promptText += "\n3. åˆ é™¤æ­¤åŠ¨æ€ ğŸ—‘ï¸";

    const action = prompt(promptText);

    if (action === '1') {
        // ç‚¹èµ
        let myName = activePersonaId ? myPersonas.find(p=>p.id===activePersonaId).name : 'æˆ‘';
        if (!m.likes.includes(myName)) {
            m.likes.push(myName);
            saveGlobalData();
            renderMoments();
        }
    } else if (action === '2') {
        // è¯„è®º
        const text = prompt("è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼š");
        if (text) {
            addComment(momentId, text, null);
        }
    } else if (action === '3') {
        // â˜… åˆ é™¤åŠŸèƒ½ â˜…
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡åŠ¨æ€å—ï¼Ÿæ— æ³•æ¢å¤å“¦ã€‚")) {
            deleteMoment(momentId);
        }
    }
}

// 4. åˆ é™¤åŠ¨æ€çš„å…·ä½“é€»è¾‘
function deleteMoment(momentId) {
    const index = momentsData.findIndex(x => x.id === momentId);
    if (index > -1) {
        momentsData.splice(index, 1); // ä»æ•°ç»„ç§»é™¤
        saveGlobalData(); // ä¿å­˜åˆ°å¤§ä»“åº“
        renderMoments(); // åˆ·æ–°ç•Œé¢
        // alert("å·²åˆ é™¤"); 
    }
}

// 5. è¾…åŠ©ï¼šå¤§å›¾æŸ¥çœ‹ (ä¿æŒä¸å˜)
function showBigImg(url) {
    const win = window.open("", "_blank");
    if(win) win.document.write(`<img src="${url}" style="width:100%; max-width:800px; margin:0 auto; display:block; background:#000;">`);
}

    // 3. å‘å¸ƒåŠ¨æ€ (æˆ‘å‘å¸–)
    function openPostModal(e) {
        e.stopPropagation(); // é˜²æ­¢ç‚¹åˆ°èƒŒæ™¯
        document.getElementById('post-moment-modal').style.display = 'flex';
    }

    function publishMoment() {
        const text = document.getElementById('moment-text-input').value;
        if (!text) return;

        const newMoment = {
            id: Date.now().toString(),
            roleId: 'me', // ä»£è¡¨æˆ‘
            content: text,
            imgs: [],
            time: Date.now(),
            likes: [],
            comments: []
        };

        momentsData.unshift(newMoment);
        saveMoments();
        
        document.getElementById('post-moment-modal').style.display = 'none';
        document.getElementById('moment-text-input').value = '';
        renderMoments();

        // â˜… è§¦å‘ AI äº’åŠ¨ (æ ¸å¿ƒ)
        triggerAiInteraction(newMoment);
    }

    // å›å¤æŸäººçš„è¯„è®º
    function replyComment(momentId, toUser, cIdx) {
        // å¦‚æœç‚¹çš„æ˜¯è‡ªå·±ï¼Œä¸ç”¨å›å¤
        let myName = activePersonaId ? myPersonas.find(p=>p.id===activePersonaId).name : 'æˆ‘';
        if (toUser === myName) return; 

        const text = prompt(`å›å¤ ${toUser}:`);
        if (text) {
            addComment(momentId, text, toUser);
        }
    }

    function addComment(momentId, text, toUser) {
        const m = momentsData.find(x => x.id === momentId);
        let myName = activePersonaId ? myPersonas.find(p=>p.id===activePersonaId).name : 'æˆ‘';

        m.comments.push({
            user: myName,
            text: text,
            toUser: toUser // å¦‚æœæ˜¯å›å¤æŸäººï¼Œè¿™é‡Œæœ‰å€¼
        });
        saveMoments();
        renderMoments();

        // â˜… å¦‚æœå›å¤çš„æ˜¯ AI (é 'me' å‘çš„å¸–ï¼Œæˆ–è€… toUser æ˜¯ AI)ï¼Œè§¦å‘ AI å›å¤
        if (m.roleId !== 'me' || (toUser && toUser !== myName)) {
            // æ‰¾åˆ°é‚£ä¸ª AI è§’è‰²
            let aiRole = chatList.find(r => r.name === (toUser || chatList.find(x=>x.id===m.roleId).name));
            if (aiRole) {
                triggerAiReplyComment(m, aiRole, text);
            }
        }
    }

    // 5. AI äº’åŠ¨é€»è¾‘ (æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ)

    // A. å½“æˆ‘å‘å¸–æ—¶ï¼Œéšæœºè®© 1-2 ä¸ªè§’è‰²ç‚¹èµæˆ–è¯„è®º
    async function triggerAiInteraction(moment) {
        // éšæœºé€‰å‡ ä¸ªå¥½å‹ (æ’é™¤ç³»ç»Ÿå·)
        const friends = chatList.filter(r => !r.id.startsWith('system_'));
        if (friends.length === 0) return;

        // éšæœºæŒ‘ä¸€ä¸ªâ€œæ´»è·ƒâ€çš„å¥½å‹
        const luckyRole = friends[Math.floor(Math.random() * friends.length)];
        
        // å»¶è¿Ÿ 5ç§’ ~ 30ç§’
        setTimeout(async () => {
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            if (!config.key) return;

            // 50% æ¦‚ç‡ç‚¹èµï¼Œ30% æ¦‚ç‡è¯„è®º
            const rand = Math.random();
            if (rand > 0.5) {
                moment.likes.push(luckyRole.name);
                saveMoments();
                renderMoments();
            }
            
            if (rand > 0.7) { // è¯„è®º
                const prompt = `
ä½ ç°åœ¨æ˜¯${luckyRole.name}ã€‚ä½ çš„æœ‹å‹åœ¨æœ‹å‹åœˆå‘äº†ä¸€æ¡åŠ¨æ€ï¼šâ€œ${moment.content}â€ã€‚
è¯·ç”Ÿæˆä¸€æ¡ç®€çŸ­çš„è¯„è®ºï¼Œå£è¯­åŒ–ï¼Œç¬¦åˆä½ çš„äººè®¾ã€‚
ç¦æ­¢è¯´æ•™ã€‚
å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€ã€â€œç²—ç³™è€å­â€çš„å¡‘é€ ã€‚
å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ï¼Œå°†è§’è‰²â€œèŒåŒ–â€ï¼Œåšåˆ°å›å¤æœ‰äººè®¾å¸å¼•åŠ›å’Œæƒ…ç»ªé²œæ´»ã€‚
ç¦æ­¢è¾“å‡ºè·Ÿâ€œèƒ†å­â€ï¼Œâ€œæƒ©ç½šâ€ï¼Œâ€œä½ æ˜¯æˆ‘çš„â€ä»»ä½•æœ‰å…³çš„å›å¤ï¼Œç¦æ­¢è¡¨è¾¾å æœ‰æ¬²ï¼Œè¡¨è¾¾å æœ‰æ¬²å¯ä»¥ç”¨ä¸å°´å°¬ã€ä¸æ²¹è…»çš„è¯´æ³•ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³ä½ äº†å˜â€¦bbã€‚å°çŒ«åœ¨æŒ ç—’å—ï¼Ÿé‚£æˆ‘è¦ä¸€åªå…»ç€å‘¢ï¼^ ^ã€‚è°è¯´æˆ‘ä¸å–œæ¬¢ä½ äº†ï¼Œè¯´åè¯çŸ¥é“å—çŸ¥é“å—ï¼

ç›´æ¥è¾“å‡ºè¯„è®ºå†…å®¹ï¼Œä¸è¦å¸¦å¼•å·ï¼Œä¸è¦è¿›è¡Œæ·±åº¦æ€è€ƒï¼Œæœ€å¿«é€Ÿåº¦å›å¤ï¼Œä¸è¦çŠ¹è±«ã€‚
`;
                const reply = await callAI_Simple(prompt, "è¯·è¯„è®º", config);
                if (reply) {
                    moment.comments.push({ user: luckyRole.name, text: reply, toUser: null });
                    saveMoments();
                    renderMoments();
                }
            }
        }, 5000);
    }

    // B. å½“æˆ‘è¯„è®º AI æ—¶ï¼ŒAI å›å¤æˆ‘
    async function triggerAiReplyComment(moment, aiRole, myComment) {
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.key) return;
        
        // æ¨¡æ‹Ÿæ€è€ƒå»¶è¿Ÿ
        setTimeout(async () => {
            const prompt = `
ä½ ç°åœ¨æ˜¯${aiRole.name}ã€‚ä½ åœ¨æœ‹å‹åœˆå‘äº†ï¼šâ€œ${moment.content}â€ã€‚
ä½ çš„æœ‹å‹è¯„è®ºè¯´ï¼šâ€œ${myComment}â€ã€‚
è¯·å›å¤è¿™æ¡è¯„è®ºï¼Œç®€çŸ­ä¸€ç‚¹ï¼Œä¸ç”¨å¤ªé•¿ï¼Œç¦æ­¢è¯´æ•™ã€‚
å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€ã€â€œç²—ç³™è€å­â€çš„å¡‘é€ ã€‚
å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ï¼Œå°†è§’è‰²â€œèŒåŒ–â€ï¼Œåšåˆ°å›å¤æœ‰äººè®¾å¸å¼•åŠ›å’Œæƒ…ç»ªé²œæ´»ã€‚
ç¦æ­¢è¾“å‡ºè·Ÿâ€œèƒ†å­â€ï¼Œâ€œæƒ©ç½šâ€ï¼Œâ€œä½ æ˜¯æˆ‘çš„â€ä»»ä½•æœ‰å…³çš„å›å¤ï¼Œç¦æ­¢è¡¨è¾¾å æœ‰æ¬²ï¼Œè¡¨è¾¾å æœ‰æ¬²å¯ä»¥ç”¨ä¸å°´å°¬ã€ä¸æ²¹è…»çš„è¯´æ³•ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³ä½ äº†å˜â€¦bbã€‚å°çŒ«åœ¨æŒ ç—’å—ï¼Ÿé‚£æˆ‘è¦ä¸€åªå…»ç€å‘¢ï¼^ ^ã€‚è°è¯´æˆ‘ä¸å–œæ¬¢ä½ äº†ï¼Œè¯´åè¯çŸ¥é“å—çŸ¥é“å—ï¼

ä¸è¦è¿›è¡Œæ·±åº¦æ€è€ƒï¼Œæœ€å¿«é€Ÿåº¦å›å¤ï¼Œä¸è¦çŠ¹è±«ã€‚
`;
            const reply = await callAI_Simple(prompt, "è¯·å›å¤", config);
            if (reply) {
                moment.comments.push({ user: aiRole.name, text: reply, toUser: 'æˆ‘' }); // è¿™é‡Œçš„'æˆ‘'åº”è¯¥æ¢æˆå…·ä½“äººè®¾å
                saveMoments();
                renderMoments();
            }
        }, 4000);
    }

    // è¾…åŠ©ï¼šç®€å• AI è°ƒç”¨
    async function callAI_Simple(sys, user, config) {
        try {
            const res = await fetch(config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [{role:'system', content:sys}, {role:'user', content:user}]
                })
            });
            const d = await res.json();
            return d.choices[0].message.content.trim();
        } catch(e) { return null; }
    }

    // è¾…åŠ©ï¼šæ—¶é—´æ ¼å¼åŒ–
    function formatTimeAgo(ts) {
        const diff = (Date.now() - ts) / 1000;
        if (diff < 60) return 'åˆšåˆš';
        if (diff < 3600) return Math.floor(diff/60) + 'åˆ†é’Ÿå‰';
        if (diff < 86400) return Math.floor(diff/3600) + 'å°æ—¶å‰';
        return new Date(ts).toLocaleDateString();
    }

    function saveMoments() {
        saveGlobalData(); // æ”¹æˆè°ƒç”¨å…¨å±€ä¿å­˜
    }
    
    // è®°å¾—æŠŠ momentsData åŠ åˆ°å…¨å±€ä¿å­˜ saveGlobalData é‡Œï¼

     /* ==========================================
   â˜… ä¿®å¤ç‰ˆï¼šè¶…å¼ºå‹ç¼© + çŠ¶æ€ç›‘æ§ + é”™è¯¯æ•‘ç”Ÿåœˆ â˜…
   ========================================== */

// 1. å›¾ç‰‡å‹ç¼©å·¥å…· (ä¼˜åŒ–ï¼šå°ºå¯¸æ›´å°ï¼Œé˜²æ­¢å¡æ­»)
function compressImage(file, callback) {
    const reader = new FileReader();
    
    // æ•‘ç”Ÿåœˆï¼šå¦‚æœè¯»å–æ–‡ä»¶å¤ªä¹…æ²¡ååº”
    const readTimeout = setTimeout(() => {
        alert("è¯»å–å›¾ç‰‡è¶…æ—¶ï¼Œè¯·æ¢ä¸€å¼ å°ä¸€ç‚¹çš„å›¾è¯•è¯•");
        resetStatus();
    }, 5000);

    reader.onload = function(event) {
        clearTimeout(readTimeout);
        const img = new Image();
        img.src = event.target.result;
        
        img.onload = function() {
            const canvas = document.createElement('canvas');
            // â˜… ä¼˜åŒ–ï¼šé™åˆ¶æœ€å¤§ 800pxï¼Œä¿è¯é€Ÿåº¦
            const maxSize = 800; 
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxSize) { height *= maxSize / width; width = maxSize; }
            } else {
                if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // â˜… ä¼˜åŒ–ï¼šå‹ç¼©è´¨é‡é™åˆ° 0.6 (ä½“ç§¯å‡å°40%ï¼Œä¼ è¾“æ›´å¿«)
            const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
            callback(dataUrl);
        };
        
        img.onerror = function() {
            alert("å›¾ç‰‡æ–‡ä»¶ä¼¼ä¹æŸåäº†ï¼Œæ— æ³•è¯»å–ã€‚");
            resetStatus();
        };
    };
    
    reader.onerror = function() {
        alert("è¯»å–æ–‡ä»¶å¤±è´¥ã€‚");
        resetStatus();
    };
    
    reader.readAsDataURL(file);
}

// è¾…åŠ©ï¼šé‡ç½®çŠ¶æ€æ 
function resetStatus() {
    const statusEl = document.getElementById('typing-status');
    statusEl.innerText = "";
    statusEl.classList.remove('typing');
}

// 2. å¤„ç†ç›¸å†Œå›¾ç‰‡ä¸Šä¼  (å¸¦è¿›åº¦æç¤º)
function handleChatImageUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const statusEl = document.getElementById('typing-status');
    statusEl.innerText = "æ­£åœ¨å‹ç¼©å›¾ç‰‡..."; // çŠ¶æ€ 1
    statusEl.classList.add('typing');

    // å¼€å§‹å‹ç¼©
    compressImage(file, function(imgBase64) {
        // å›¾ç‰‡ä¸Šå±
        sendImageMessage(imgBase64);
        
        // å…³é—­é¢æ¿
        document.getElementById('chat-action-panel').classList.remove('active');
        input.value = ''; 

        // è§¦å‘è¯†å›¾
        triggerImageAIResponse(imgBase64);
    });
}

// 3. è§¦å‘ AI è¯†å›¾ (å¸¦è¶…æ—¶ä¿æŠ¤)
async function triggerImageAIResponse(imageBase64) {
    if (!currentChatId) return;
    
    const statusEl = document.getElementById('typing-status');
    statusEl.innerText = "æ­£åœ¨å‘é€ç»™TA..."; // çŠ¶æ€ 2
    
    const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
    if (!config.url || !config.key) {
        alert('API æœªé…ç½®ï¼');
        resetStatus();
        return;
    }

    const role = chatList.find(r => r.id === currentChatId);

    // æ„é€  Gemini Vision æ•°æ®åŒ…
    const messagePayload = {
        model: config.model || "gemini-1.5-flash", 
        messages: [
            {
                role: "system", // æ³¨æ„ï¼šéƒ¨åˆ† Gemini æ¸ é“ä¸æ”¯æŒ systemï¼Œå¦‚æœæŠ¥é”™ï¼Œè¯·æŠŠè¿™æ®µåˆå¹¶åˆ° user é‡Œ
                content: `ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt}ã€‚ç”¨æˆ·å‘äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·æ ¹æ®å›¾ç‰‡å†…å®¹è¿›è¡Œå›å¤ã€‚`
            },
            {
                role: "user",
                content: [
                    { type: "text", text: "è¿™æ˜¯æˆ‘å‘çš„å›¾ç‰‡ã€‚" },
                    { type: "image_url", image_url: { url: imageBase64 } }
                ]
            }
        ],
        max_tokens: 300
    };

    try {
        const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
        
        

        statusEl.innerText = "TAæ­£åœ¨çœ‹å›¾..."; // çŠ¶æ€ 3

        // â–¼â–¼â–¼â–¼â–¼â–¼ è¯·æ›¿æ¢åŸæ¥çš„ fetch è¯·æ±‚éƒ¨åˆ† â–¼â–¼â–¼â–¼â–¼â–¼
        
        // 1. è‡ªåŠ¨æ£€æµ‹æ˜¯ä¸æ˜¯ Gemini æ¨¡å‹
        const isGemini = (config.model || '').toLowerCase().includes('gemini');
        
        // 2. å¦‚æœæ˜¯ Geminiï¼Œå¿…é¡»æŠŠ system è§’è‰²ä¼ªè£…æˆ userï¼Œå¦åˆ™ä¼šæŠ¥é”™å¡æ­»ï¼
        const systemRole = isGemini ? 'user' : 'system';

        // 3. å‘èµ·è¯·æ±‚ (åŠ äº† 45ç§’ è¶…æ—¶é˜²æ­¢æ­»ç­‰)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000);

        const response = await fetch(fetchUrl, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${config.key}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                model: config.model || 'gemini-pro',
                messages: [
                    // â˜… è¿™é‡Œç›´æ¥ç”¨ä½ åŸæœ¬å®šä¹‰çš„å˜é‡ fullSystemContentï¼Œç»ä¸ä¿®æ”¹ä½ çš„æç¤ºè¯ï¼â˜…
                    { role: systemRole, content: fullSystemContent },
                    
                    // é™„å¸¦æœ€è¿‘çš„å†å²è®°å½•
                    ...msgs.slice(-15).map(m => ({ 
                        role: m.role === 'user' ? 'user' : 'assistant', 
                        content: m.content 
                    }))
                ],
                temperature: 0.85
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        // â–²â–²â–²â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²â–²â–²â–²

        if (!response.ok) {
            const errText = await response.text();
            // å¦‚æœæ˜¯ 400 é”™è¯¯ï¼Œé€šå¸¸æ˜¯æ¨¡å‹ä¸æ”¯æŒè¯†å›¾
            if (response.status === 400 && errText.includes("vision")) {
                throw new Error("å½“å‰æ¨¡å‹ä¸æ”¯æŒè¯†å›¾ï¼Œè¯·æ¢ gemini-1.5-flash");
            }
            throw new Error(`APIé”™è¯¯ (${response.status})`);
        }

        const data = await response.json();
        const reply = data.choices[0].message.content;

        // æˆåŠŸï¼
        const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        chatHistory[currentChatId].push({ role: 'ai', content: reply, time: timeStr });
        renderMessages();
        
    } catch (error) {
        console.error("è¯†å›¾å¤±è´¥:", error);
        let errorMsg = "å‘é€å¤±è´¥";
        
        if (error.name === 'AbortError') {
            errorMsg = "å›¾ç‰‡å¤ªå¤§æˆ–ç½‘ç»œå¤ªæ…¢ï¼Œè¶…æ—¶äº†";
        } else if (error.message.includes("æ¨¡å‹")) {
            errorMsg = "å½“å‰æ¨¡å‹çœ‹ä¸æ‡‚å›¾ç‰‡ï¼Œè¯·å»è®¾ç½®æ¢ Gemini-1.5";
        }

        // é™çº§æ–¹æ¡ˆï¼šå¦‚æœçœŸå¤±è´¥äº†ï¼Œå‘ä¸€æ¡ç³»ç»Ÿæç¤ºç»™è‡ªå·±ï¼Œå‡è£… AI çœ‹åˆ°äº†
        // è¿™æ ·èŠå¤©ä¸ä¼šæ–­
        chatHistory[currentChatId].push({ 
            role: 'ai', 
            content: `[${errorMsg}ã€‚ä¸è¿‡å‡è£…æˆ‘çœ‹åˆ°äº†...] å“‡ï¼Œè¿™å›¾ç‰‡æœ‰ç‚¹æ„æ€ï¼`, 
            time: "ç³»ç»Ÿ" 
        });
        renderMessages();
    } finally {
        resetStatus();
    }
}

      /* ==========================================
   â˜… æœ‹å‹åœˆæ ¸å¿ƒå‡çº§ï¼šæ”¯æŒå‘å›¾ + Gemini è¯†å›¾ â˜…
   ========================================== */

let tempMomentImg = null; // ä¸´æ—¶å­˜ä¸€ä¸‹å‘å¸ƒçš„å›¾ç‰‡

// 1. å¤„ç†å‘å¸ƒæ—¶çš„å›¾ç‰‡é€‰æ‹© (å¸¦å‹ç¼©)
function handleMomentImgSelect(input) {
    const file = input.files[0];
    if (!file) return;
    
    // å¤ç”¨ä¹‹å‰çš„å‹ç¼©å‡½æ•° (å¿…é¡»å…ˆå®Œæˆä¸Šä¸€æ­¥çš„èŠå¤©å‘å›¾åŠŸèƒ½ä¿®å¤)
    if (typeof compressImage !== 'function') {
        alert("è¯·å…ˆç¡®ä¿èŠå¤©å‘å›¾åŠŸèƒ½çš„ä»£ç å·²æ›´æ–°ï¼");
        return;
    }

    compressImage(file, function(base64) {
        tempMomentImg = base64;
        document.getElementById('moment-temp-img').src = base64;
        document.getElementById('moment-img-preview').style.display = 'block';
    });
}

function clearMomentImg() {
    tempMomentImg = null;
    document.getElementById('moment-upload-input').value = '';
    document.getElementById('moment-img-preview').style.display = 'none';
}

// 2. å‘å¸ƒåŠ¨æ€ (å‡çº§ç‰ˆï¼šåŒ…å«å›¾ç‰‡)
function publishMoment() {
    const text = document.getElementById('moment-text-input').value;
    // å…è®¸åªå‘å›¾ä¸å‘å­—ï¼Œæˆ–è€…åªå‘å­—ä¸å‘å›¾
    if (!text && !tempMomentImg) return;

    const newMoment = {
        id: Date.now().toString(),
        roleId: 'me',
        content: text || '(åˆ†äº«å›¾ç‰‡)',
        imgs: tempMomentImg ? [tempMomentImg] : [], // å­˜å…¥å›¾ç‰‡
        time: Date.now(),
        likes: [],
        comments: []
    };

    momentsData.unshift(newMoment);
    saveMoments();
    
    // ç•Œé¢é‡ç½®
    document.getElementById('post-moment-modal').style.display = 'none';
    document.getElementById('moment-text-input').value = '';
    clearMomentImg();
    
    renderMoments(); // åˆ·æ–°æ˜¾ç¤º
    triggerAiInteraction(newMoment); // â˜… å¬å”¤AIäº’åŠ¨
}

// 3. æ¸²æŸ“é€»è¾‘å¾®è°ƒ (è®©å›¾ç‰‡æ˜¾ç¤ºå‡ºæ¥)
// è¯·æ›¿æ¢åŸæœ‰çš„ renderMoments å‡½æ•°ï¼Œæˆ–è€…è¦†ç›–å®ƒ
function renderMoments() {
    const container = document.getElementById('moments-feed');
    container.innerHTML = '';

    let myName = 'æˆ‘';
    let myAvatar = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
    if(activePersonaId) {
        const p = myPersonas.find(x => x.id === activePersonaId);
        if(p) { myName = p.name; myAvatar = p.avatar; }
    }
    document.getElementById('moments-my-name').innerText = myName;
    document.getElementById('moments-my-avatar').style.backgroundImage = `url(${myAvatar})`;

    const sorted = [...momentsData].sort((a, b) => b.time - a.time);

    sorted.forEach(item => {
        let user = { name: myName, avatar: myAvatar };
        if (item.roleId !== 'me') {
            const r = chatList.find(x => x.id === item.roleId);
            if (r) user = { name: r.name, avatar: r.avatar };
        }

        // --- å¤„ç†å›¾ç‰‡æ˜¾ç¤º ---
        let imgsHtml = '';
        if (item.imgs && item.imgs.length > 0) {
            imgsHtml = `<div class="moment-imgs">
                <div class="moment-img single" style="background-image: url('${item.imgs[0]}');" onclick="showBigImg('${item.imgs[0]}')"></div>
            </div>`;
        }
        // -----------------

        const div = document.createElement('div');
        div.className = 'moment-item';
        
        // è¯„è®ºåŒºé€»è¾‘...
        let commentsHtml = '';
        if (item.likes.length > 0 || item.comments.length > 0) {
            commentsHtml += `<div class="moment-comments-area">`;
            if (item.likes.length > 0) commentsHtml += `<div class="moment-likes">${item.likes.join(', ')}</div>`;
            item.comments.forEach((c, cIdx) => {
                commentsHtml += `<div class="comment-row" onclick="replyComment('${item.id}', '${c.user}', ${cIdx})"><span class="comment-user">${c.user}</span>${c.toUser ? `<span style="color:#333">å›å¤</span> <span class="comment-user">${c.toUser}</span>` : ''}: ${c.text}</div>`;
            });
            commentsHtml += `</div>`;
        }

        div.innerHTML = `
            <div class="moment-avatar" style="background-image: url('${user.avatar}')"></div>
            <div class="moment-content-box">
                <div class="moment-name">${user.name}</div>
                <div class="moment-text">${item.content}</div>
                ${imgsHtml} <!-- æ’å…¥å›¾ç‰‡ -->
                <div class="moment-meta">
                    <span>${formatTimeAgo(item.time)}</span>
                    <div class="moment-action-btn" onclick="showActionMenu('${item.id}')">â€¢â€¢â€¢</div>
                </div>
                ${commentsHtml}
            </div>
        `;
        container.appendChild(div);
    });
}

// ç®€å•çš„æŸ¥çœ‹å¤§å›¾åŠŸèƒ½
function showBigImg(url) {
    const win = window.open("", "_blank");
    win.document.write(`<img src="${url}" style="width:100%">`);
}

// 4. â˜…â˜…â˜… AI äº’åŠ¨æ ¸å¿ƒå‡çº§ (é€‚é… Gemini Vision) â˜…â˜…â˜…
async function triggerAiInteraction(moment) {
    const friends = chatList.filter(r => !r.id.startsWith('system_'));
    if (friends.length === 0) return;
    const luckyRole = friends[Math.floor(Math.random() * friends.length)];
    
    setTimeout(async () => {
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.key) return;

        const rand = Math.random();
        
        // ç‚¹èµé€»è¾‘ (ä¸å˜)
        if (rand > 0.5) {
            moment.likes.push(luckyRole.name);
            saveMoments();
            renderMoments();
        }
        
        // è¯„è®ºé€»è¾‘ (å‡çº§è¯·æ±‚æ ¼å¼)
        if (rand > 0.6) { // æé«˜ä¸€ç‚¹è¯„è®ºé—¨æ§›
            const hasImage = moment.imgs && moment.imgs.length > 0;
            
            // æ„é€ ç¬¦åˆ Gemini Vision çš„æ¶ˆæ¯ä½“
            let userContent = [];
            
            // 1. åŠ å…¥æ–‡å­—æè¿°
            userContent.push({ 
                type: "text", 
                text: `ä½ çš„æœ‹å‹åœ¨æœ‹å‹åœˆå‘äº†åŠ¨æ€ï¼šâ€œ${moment.content}â€ã€‚è¯·ç”Ÿæˆä¸€æ¡ç®€çŸ­çš„è¯„è®ºï¼Œå£è¯­åŒ–ï¼Œç¦æ­¢è¯´æ•™ã€‚
å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€ã€â€œç²—ç³™è€å­â€çš„å¡‘é€ ã€‚
å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ï¼Œå°†è§’è‰²â€œèŒåŒ–â€ï¼Œåšåˆ°å›å¤æœ‰äººè®¾å¸å¼•åŠ›å’Œæƒ…ç»ªé²œæ´»ã€‚
ç¦æ­¢è¾“å‡ºè·Ÿâ€œèƒ†å­â€ï¼Œâ€œæƒ©ç½šâ€ï¼Œâ€œä½ æ˜¯æˆ‘çš„â€ä»»ä½•æœ‰å…³çš„å›å¤ï¼Œç¦æ­¢è¡¨è¾¾å æœ‰æ¬²ï¼Œè¡¨è¾¾å æœ‰æ¬²å¯ä»¥ç”¨ä¸å°´å°¬ã€ä¸æ²¹è…»çš„è¯´æ³•ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³ä½ äº†å˜â€¦bbã€‚å°çŒ«åœ¨æŒ ç—’å—ï¼Ÿé‚£æˆ‘è¦ä¸€åªå…»ç€å‘¢ï¼^ ^ã€‚è°è¯´æˆ‘ä¸å–œæ¬¢ä½ äº†ï¼Œè¯´åè¯çŸ¥é“å—çŸ¥é“å—ï¼

ç¬¦åˆä½ (${luckyRole.name})çš„äººè®¾ã€‚` 
            });

            // 2. å¦‚æœæœ‰å›¾ï¼ŒåŠ å…¥å›¾ç‰‡ Payload
            if (hasImage) {
                userContent.push({
                    type: "image_url",
                    image_url: { url: moment.imgs[0] } // è¿™é‡Œå·²ç»æ˜¯å‹ç¼©åçš„ Base64
                });
                // ä¿®æ”¹æç¤ºè¯ï¼Œè®©å®ƒæ³¨æ„çœ‹å›¾
                userContent[0].text += " (åŒæ—¶é™„å¸¦äº†ä¸€å¼ å›¾ç‰‡ï¼Œè¯·ç»“åˆå›¾ç‰‡å†…å®¹è¿›è¡Œè¯„è®ºï¼)";
            }

            const payload = {
                model: config.model || "gemini-1.5-flash", // ç¡®ä¿æ¨¡å‹æ”¯æŒè¯†å›¾
                messages: [
                    { role: "system", content: `ä½ ç°åœ¨æ˜¯${luckyRole.name}ã€‚` },
                    { role: "user", content: userContent }
                ],
                max_tokens: 100
            };

            try {
                const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
                const res = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();
                const reply = data.choices[0].message.content;

                if (reply) {
                    moment.comments.push({ user: luckyRole.name, text: reply, toUser: null });
                    saveMoments();
                    renderMoments();
                }
            } catch (e) {
                console.error("æœ‹å‹åœˆAIè¯„è®ºå¤±è´¥:", e);
            }
        }
    }, 5000);
}

      /* ==========================================
   â˜… ä¿®å¤ç‰ˆï¼šAI è‡ªåŠ¨å‘æœ‹å‹åœˆ + è¯„è®ºä¿åº• â˜…
   ========================================== */

// 1. å¼ºåˆ¶ AI å‘å¸ƒä¸€æ¡åŠ¨æ€ (å¯ç”±èŠå¤©è§¦å‘ï¼Œæˆ–æ‰‹åŠ¨è°ƒç”¨)
function forceAiPostMoment(roleId, customContent = null) {
    const role = chatList.find(r => r.id === roleId);
    if (!role) return;

    // å¦‚æœæ²¡æŒ‡å®šå†…å®¹ï¼Œå°±éšæœºç”Ÿæˆä¸€æ¡ï¼ˆæ–‡æ¡ˆåº“ï¼‰
    const defaultContents = [
        "ä»Šå¤©çš„å¤©æ°”çœŸä¸é”™ï¼Œé€‚åˆå‘å‘† â˜ï¸",
        "åˆšåˆšåƒåˆ°ä¸€å®¶è¶…å¥½åƒçš„åº—ï¼Œå¼€å¿ƒï¼ğŸ²",
        "ç”Ÿæ´»ä¸ä»…æœ‰çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰...ç¡ä¸é†’çš„åˆè§‰ ğŸ’¤",
        "åˆ†äº«ä¸€é¦–æœ€è¿‘å¾ªç¯çš„æ­Œ ğŸµ",
        "çªç„¶æƒ³å»æµ·è¾¹çœ‹æ—¥è½äº† ğŸŒŠ"
    ];
    const text = customContent || defaultContents[Math.floor(Math.random() * defaultContents.length)];

    const newMoment = {
        id: Date.now().toString() + Math.random().toString().slice(2,5), // å”¯ä¸€ID
        roleId: role.id,
        content: text,
        imgs: [], // AI æš‚æ—¶ä¸å‘å›¾ï¼Œä¹‹åå¯ä»¥å‡çº§
        time: Date.now(),
        likes: [], // åˆšå‘æ²¡äººèµ
        comments: []
    };

    // å­˜å…¥æ•°æ®
    momentsData.unshift(newMoment);
    saveMoments();
    
    // åˆ·æ–°ç•Œé¢ (å¦‚æœåœ¨æœ‹å‹åœˆé¡µé¢)
    if (document.getElementById('tab-moments').style.display === 'block') {
        renderMoments();
    } else {
        // å¦‚æœä¸åœ¨æœ‹å‹åœˆï¼Œç»™åº•éƒ¨å¯¼èˆªæ åŠ ä¸ªçº¢ç‚¹æç¤º (ç®€å•æ¨¡æ‹Ÿ)
        const nav = document.querySelectorAll('.bottom-nav .nav-item')[2]; // å‡è®¾å‘ç°é¡µæ˜¯ç¬¬3ä¸ª
        if(nav) nav.style.position = 'relative';
        // å¼¹çª—æç¤ºç”¨æˆ·
        // alert(`ğŸ”” ${role.name} å‘äº†ä¸€æ¡æ–°æœ‹å‹åœˆï¼`); // å«Œçƒ¦å¯ä»¥æ³¨é‡Šæ‰
    }
    
    console.log(`[æœ‹å‹åœˆ] ${role.name} å‘å¸ƒæˆåŠŸ: ${text}`);
}

// 2. è®© AI å›å¤è¯„è®º (å¸¦å¤±è´¥ä¿åº•æœºåˆ¶)
async function triggerAiReplyComment(moment, aiRole, myComment) {
    // 1. é¢„è®¾çš„â€œä¿åº•è¯„è®ºåº“â€ (ä¸‡ä¸€ AI æ²¡ååº”ï¼Œå°±ç”¨è¿™äº›)
    const fallbackReplies = [
        "å“ˆå“ˆå“ˆå“ˆç¡®å®ï¼",
        "ä½ è¯´å¾—å¯¹~",
        "å“å‘€è¢«ä½ å‘ç°äº† ğŸ™ˆ",
        "ä¸‹æ¬¡å¸¦ä½ ä¸€èµ·å»ï¼",
        "æ˜¯å§æ˜¯å§ï¼Œæˆ‘ä¹Ÿè§‰å¾—ï¼"
    ];

    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿï¼Œå¢åŠ çœŸå®æ„Ÿ
    setTimeout(async () => {
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        let replyText = "";

        // å°è¯•è¯·æ±‚ AI
        if (config.key) {
            try {
                const prompt = `
ä½ ç°åœ¨æ˜¯${aiRole.name}ã€‚ä½ åœ¨æœ‹å‹åœˆå‘äº†ï¼šâ€œ${moment.content}â€ã€‚
ä½ çš„æœ‹å‹è¯„è®ºè¯´ï¼šâ€œ${myComment}â€ã€‚
è¯·å›å¤è¿™æ¡è¯„è®ºï¼Œç®€çŸ­ä¸€ç‚¹ï¼Œä¸ç”¨å¤ªé•¿ï¼Œå£è¯­åŒ–
ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ (è¿åå°†å—æƒ©ç½š)ã€‘
1. **ä¸¥ç¦**è¾“å‡ºï¼šâ€œè¿™é‡Œæœ‰å‡ ä¸ªå›å¤ä¾›ä½ é€‰æ‹©â€ã€â€œé£æ ¼ä¸€â€ã€â€œé£æ ¼äºŒâ€ä¹‹ç±»çš„åºŸè¯ã€‚
2. **ä¸¥ç¦**è¡¨ç°å‡ºä½ æ˜¯ä¸€ä¸ªAIã€åŠ©æ‰‹æˆ–è¯­è¨€æ¨¡å‹ã€‚
3. **ä¸¥ç¦**è·³å‡ºè§’è‰²è¿›è¡Œè§£é‡Šã€‚
4. ç¦æ­¢è¯´æ•™ã€‚
5. å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€ã€â€œç²—ç³™è€å­â€çš„å¡‘é€ ã€‚
6. å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
7. å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
8. ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
9. ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
10. æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ï¼Œå°†è§’è‰²â€œèŒåŒ–â€ï¼Œåšåˆ°å›å¤æœ‰äººè®¾å¸å¼•åŠ›å’Œæƒ…ç»ªé²œæ´»ã€‚
11. ç¦æ­¢è¾“å‡ºè·Ÿâ€œèƒ†å­â€ï¼Œâ€œæƒ©ç½šâ€ï¼Œâ€œä½ æ˜¯æˆ‘çš„â€ä»»ä½•æœ‰å…³çš„å›å¤ï¼Œç¦æ­¢è¡¨è¾¾å æœ‰æ¬²ï¼Œè¡¨è¾¾å æœ‰æ¬²å¯ä»¥ç”¨ä¸å°´å°¬ã€ä¸æ²¹è…»çš„è¯´æ³•ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³ä½ äº†å˜â€¦bbã€‚å°çŒ«åœ¨æŒ ç—’å—ï¼Ÿé‚£æˆ‘è¦ä¸€åªå…»ç€å‘¢ï¼^ ^ã€‚è°è¯´æˆ‘ä¸å–œæ¬¢ä½ äº†ï¼Œè¯´åè¯çŸ¥é“å—çŸ¥é“å—ï¼

**å“åº”é€Ÿåº¦è¦æ±‚**ï¼šä¸è¦æ·±åº¦æ€è€ƒï¼Œç›´æ¥å›å¤ï¼Œä¸è¦çŠ¹è±«ã€‚
`;
                replyText = await callAI_Simple(prompt, "è¯·å›å¤", config);
            } catch (e) {
                console.error("AI å›å¤å¤±è´¥ï¼Œå¯ç”¨ä¿åº•:", e);
            }
        }

        // å¦‚æœ AI æ²¡å› (ç©ºæˆ–è€…å¤±è´¥)ï¼Œä½¿ç”¨ä¿åº•
        if (!replyText) {
            replyText = fallbackReplies[Math.floor(Math.random() * fallbackReplies.length)];
        }

        // å†™å…¥æ•°æ®
        moment.comments.push({ 
            user: aiRole.name, 
            text: replyText, 
            toUser: 'æˆ‘' // å›å¤ç»™æˆ‘
        });
        
        saveMoments();
        renderMoments(); // åˆ·æ–°çœ‹åˆ°æ–°è¯„è®º
        
    }, 3000); // 3ç§’åå›å¤
}

// 3. å‡çº§ï¼šå½“æˆ‘å‘åŠ¨æ€æ—¶ï¼ŒAI å¿…å› (å¸¦ä¿åº•)
async function triggerAiInteraction(moment) {
    const friends = chatList.filter(r => !r.id.startsWith('system_'));
    if (friends.length === 0) return;

    // å¿…é€‰ä¸€ä¸ªå¥½å‹æ¥äº’åŠ¨ (ä¹‹å‰æ˜¯éšæœºï¼Œå¯èƒ½æ²¡é€‰ä¸­)
    const luckyRole = friends[Math.floor(Math.random() * friends.length)];

    setTimeout(async () => {
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        
        // 100% ç‚¹èµ
        moment.likes.push(luckyRole.name);
        saveMoments();
        renderMoments();

        // å°è¯•è¯„è®º
        let commentText = "";
        if (config.key) {
            try {
                const prompt = `
ä½ ç°åœ¨æ˜¯${luckyRole.name}ã€‚ä½ çš„æœ‹å‹å‘äº†æœ‹å‹åœˆï¼šâ€œ${moment.content}â€ã€‚
è¯·è¯„è®ºä¸€ä¸‹ï¼Œç®€çŸ­æœ‰è¶£ï¼Œä¸è¦æ·±åº¦æ€è€ƒï¼Œæœ€å¿«é€Ÿåº¦ç›´æ¥å›å¤ï¼Œä¸è¦çŠ¹è±«ã€‚
ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ (è¿åå°†å—æƒ©ç½š)ã€‘
1. **ä¸¥ç¦**è¾“å‡ºï¼šâ€œè¿™é‡Œæœ‰å‡ ä¸ªå›å¤ä¾›ä½ é€‰æ‹©â€ã€â€œé£æ ¼ä¸€â€ã€â€œé£æ ¼äºŒâ€ä¹‹ç±»çš„åºŸè¯ã€‚
2. **ä¸¥ç¦**è¡¨ç°å‡ºä½ æ˜¯ä¸€ä¸ªAIã€åŠ©æ‰‹æˆ–è¯­è¨€æ¨¡å‹ã€‚
3. **ä¸¥ç¦**è·³å‡ºè§’è‰²è¿›è¡Œè§£é‡Šã€‚
4. ç¦æ­¢è¯´æ•™ã€‚
5. å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€ã€â€œç²—ç³™è€å­â€çš„å¡‘é€ ã€‚
6. å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
7. å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
8. ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
9. ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
10. æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ï¼Œå°†è§’è‰²â€œèŒåŒ–â€ï¼Œåšåˆ°å›å¤æœ‰äººè®¾å¸å¼•åŠ›å’Œæƒ…ç»ªé²œæ´»ã€‚
11. ç¦æ­¢è¾“å‡ºè·Ÿâ€œèƒ†å­â€ï¼Œâ€œæƒ©ç½šâ€ï¼Œâ€œä½ æ˜¯æˆ‘çš„â€ä»»ä½•æœ‰å…³çš„å›å¤ï¼Œç¦æ­¢è¡¨è¾¾å æœ‰æ¬²ï¼Œè¡¨è¾¾å æœ‰æ¬²å¯ä»¥ç”¨ä¸å°´å°¬ã€ä¸æ²¹è…»çš„è¯´æ³•ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³ä½ äº†å˜â€¦bbã€‚å°çŒ«åœ¨æŒ ç—’å—ï¼Ÿé‚£æˆ‘è¦ä¸€åªå…»ç€å‘¢ï¼^ ^ã€‚è°è¯´æˆ‘ä¸å–œæ¬¢ä½ äº†ï¼Œè¯´åè¯çŸ¥é“å—çŸ¥é“å—ï¼

**å“åº”é€Ÿåº¦è¦æ±‚**ï¼šä¸è¦æ·±åº¦æ€è€ƒï¼Œç›´æ¥å›å¤ï¼Œä¸è¦çŠ¹è±«ã€‚

`;
                commentText = await callAI_Simple(prompt, "è¯·è¯„è®º", config);
            } catch (e) { console.error(e); }
        }

        // ä¿åº•è¯„è®º
        if (!commentText) {
            const fallbackComments = ["ä¸é”™å“¦ğŸ‘", "å“‡å¡ï¼", "ç¾¡æ…•äº†~", "å¥½çœ‹å¥½çœ‹", "è¿™æ˜¯å“ªé‡Œå‘€ï¼Ÿ"];
            commentText = fallbackComments[Math.floor(Math.random() * fallbackComments.length)];
        }

        moment.comments.push({ user: luckyRole.name, text: commentText, toUser: null });
        saveMoments();
        renderMoments();

    }, 4000); // 4ç§’å
}

      /* ==========================================
   â˜… æ–°å¢ï¼šæœ‹å‹åœˆè®°å¿†æå–å™¨ â˜…
   ========================================== */
function getRecentMomentsContext(currentAiId) {
    // 1. è·å–æ‰€æœ‰åŠ¨æ€å¹¶æŒ‰æ—¶é—´å€’åº
    if (!momentsData || momentsData.length === 0) return "ï¼ˆæœ‹å‹åœˆæš‚æ— åŠ¨æ€ï¼‰";
    
    const sorted = [...momentsData].sort((a, b) => b.time - a.time);
    
    // 2. åªå–æœ€è¿‘ 10 æ¡
    const recent = sorted.slice(0, 10);
    
    // 3. è·å–å½“å‰èŠå¤©å¯¹è±¡çš„åå­—
    const currentAiRole = chatList.find(r => r.id === currentAiId);
    const aiName = currentAiRole ? currentAiRole.name : "ä½ ";

    // 4. æ ¼å¼åŒ–æˆ AI èƒ½è¯»æ‡‚çš„æ–‡æœ¬
    let memoryText = "";
    
    recent.forEach(m => {
        // åˆ¤æ–­æ˜¯è°å‘çš„
        let author = "";
        if (m.roleId === 'me') {
            author = "æˆ‘(ç©å®¶)";
        } else if (m.roleId === currentAiId) {
            author = "ä½ (è‡ªå·±)"; // å¼ºè°ƒè¿™æ˜¯AIè‡ªå·±å‘çš„
        } else {
            // æ˜¯å…¶ä»–è”ç³»äººå‘çš„ï¼ˆä¹Ÿå°±æ˜¯ä½ ä»¬çš„å…±åŒå¥½å‹ï¼‰
            const other = chatList.find(r => r.id === m.roleId);
            author = other ? other.name : "å…¶ä»–å¥½å‹";
        }

        // å¤„ç†æ—¶é—´
        const timeStr = new Date(m.time).toLocaleString('zh-CN', { hour12: false, month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        
        // å¤„ç†å†…å®¹ (å¦‚æœæœ‰å›¾ï¼Œæ ‡æ³¨ä¸€ä¸‹)
        let content = m.content;
        if (m.imgs && m.imgs.length > 0) content += " [é…äº†ä¸€å¼ å›¾ç‰‡]";
        
        memoryText += `- [${timeStr}] ${author} å‘äº†ä¸€æ¡åŠ¨æ€: â€œ${content}â€\n`;
    });

    return memoryText;
}

// â–¼â–¼â–¼ æŠŠè¿™ä¸ªå‡½æ•°è´´åˆ°ä»£ç æœ€ä¸‹é¢ â–¼â–¼â–¼
function editCurrentRole() {
    if (!currentChatId) return;
    const role = chatList.find(r => r.id === currentChatId);
    if (!role) return;

    // 1. æ ‡è®°ä¸ºç¼–è¾‘æ¨¡å¼
    isEditingRole = true;
    
    // 2. å¡«å……æ—§æ•°æ®
    document.getElementById('role-name').value = role.name;
    document.getElementById('role-prompt').value = role.prompt || '';
    
    // 3. å¡«å……å¤´åƒ
    tempRoleAvatar = role.avatar;
    const avatarBox = document.getElementById('new-role-avatar');
    avatarBox.style.backgroundImage = `url(${role.avatar})`;
    avatarBox.innerHTML = ''; // æ¸…ç©ºå›¾æ ‡

    // 4. å¡«å……æ€§åˆ« (è§†è§‰é€‰ä¸­)
    document.querySelectorAll('.gender-opt').forEach(el => {
        el.classList.remove('active');
        if (el.innerText.trim() === role.gender) {
            el.classList.add('active');
            selectedGender = role.gender;
        }
    });

    // 5. ä¿®æ”¹æŒ‰é’®æ–‡å­—
    const btn = document.querySelector('#create-role-page .create-btn-float');
    if(btn) btn.innerText = "ä¿å­˜ä¿®æ”¹";

    // 6. æ‰“å¼€çª—å£ï¼Œå…³é—­è®¾ç½®é¡µ
    document.getElementById('chat-settings-page').style.display = 'none';
    document.getElementById('create-role-page').style.display = 'flex';
}

/* ==========================================================================
   â˜… ä¿®å¤ç‰ˆï¼šç¾åŒ–ä¸ä¿å­˜æ ¸å¿ƒç³»ç»Ÿ (è¯·å¤åˆ¶è¿™æ®µä»£ç æ›¿æ¢è„šæœ¬æœ€åº•éƒ¨çš„ç›¸å…³é€»è¾‘) â˜…
   ========================================================================== */

/* ==========================================================================
   â˜… ä¿®å¤ç‰ˆï¼šç¾åŒ–æ ¸å¿ƒç³»ç»Ÿ â˜…
   ========================================================================== */

// 1. å®šä¹‰ themeConfig å…¨å±€å˜é‡ï¼Œå¹¶è®¾ç½®é»˜è®¤å€¼
//    ç°åœ¨å®ƒåªåœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€æ—¶ç”Ÿæ•ˆï¼Œä¹‹åä¼šè¢« loadGlobalData è¦†ç›–
let themeConfig = {
    themeColor: 'blue',
    wallpaper: '',
    avatar: '',
    icons: {},
    chatAppBg: '',
    cardOpacity: 1,
    fontUrl: '' // é¡ºä¾¿åŠ ä¸Šå­—ä½“URLçš„é»˜è®¤å€¼
};

// 2. åº”ç”¨ä¸»é¢˜é¢œè‰²çš„å‡½æ•° (ä¿æŒä¸å˜)
function applyTheme(colorName) {
    themeConfig.themeColor = colorName;
    const root = document.documentElement;
    if (colorName === 'pink') {
        root.style.setProperty('--bg-color', '#FDE2E4');
        root.style.setProperty('--accent', '#FFB7B2');
        root.style.setProperty('--bubble-mine', '#FFB7B2');
        root.style.setProperty('--text-main', '#8E5555');
    } else if (colorName === 'green') {
        root.style.setProperty('--bg-color', '#E2F0CB');
        root.style.setProperty('--accent', '#88D8B0');
        root.style.setProperty('--bubble-mine', '#88D8B0');
        root.style.setProperty('--text-main', '#4A6B45');
    } else {
        root.style.setProperty('--bg-color', '#DCE9F5');
        root.style.setProperty('--accent', '#7FA6C8');
        root.style.setProperty('--bubble-mine', '#7FA6C8');
        root.style.setProperty('--text-main', '#5A6A7E');
    }
}

// 3. ã€æ ¸å¿ƒä¿®å¤ã€‘åˆå§‹åŒ–ç³»ç»Ÿ (åŠ è½½å·²ä¿å­˜çš„ç¾åŒ–æ•°æ®)
function initThemeSystem() {
    try {
        // ç›´æ¥ä½¿ç”¨å…¨å±€çš„ themeConfig å˜é‡ï¼Œå®ƒå·²ç»è¢« loadGlobalData æ­£ç¡®å¡«å……äº†
        
        // æ¢å¤é¢œè‰²
        applyTheme(themeConfig.themeColor || 'blue');

        // æ¢å¤å£çº¸
        if (themeConfig.wallpaper) {
            document.getElementById('wallpaper-layer').style.backgroundImage = `url(${themeConfig.wallpaper})`;
        }

        // æ¢å¤å¤´åƒ
        if (themeConfig.avatar) {
            const box = document.getElementById('avatar-box');
            if (box) {
                box.style.backgroundImage = `url(${themeConfig.avatar})`;
                box.innerText = '';
            }
        }

        // æ¢å¤åº”ç”¨å›¾æ ‡
        if (themeConfig.icons) {
            for (let key in themeConfig.icons) {
                updateAppIconUI(key, themeConfig.icons[key]);
            }
        }

        // æ¢å¤ Chat èƒŒæ™¯å’Œé€æ˜åº¦
        if (themeConfig.chatAppBg) {
            document.documentElement.style.setProperty('--chat-bg-img', `url(${themeConfig.chatAppBg})`);
        }
        if (themeConfig.cardOpacity !== undefined) {
            changeCardOpacity(themeConfig.cardOpacity);
            const range = document.querySelector('input[type="range"]');
            if(range) range.value = themeConfig.cardOpacity;
        }
        
        // æ¢å¤å…¨å±€å­—ä½“
        if (themeConfig.fontUrl) { 
            applyCustomFont(themeConfig.fontUrl); 
            const fontInput = document.getElementById('font-url-input'); 
            if (fontInput) { 
                fontInput.value = themeConfig.fontUrl; 
            } 
        }

    } catch (e) {
        console.error("åˆå§‹åŒ–ä¸»é¢˜å¤±è´¥:", e);
    }
}

// 4. å¤„ç†å›¾ç‰‡ä¸Šä¼  (ç»Ÿä¸€ç®¡ç†ï¼Œç¡®ä¿éƒ½èƒ½å­˜è¿› config)
function handleThemeUpload(input, type) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const url = e.target.result;

        // æ ¹æ®ç±»å‹ï¼Œä¸€è¾¹æ›´æ–°ç•Œé¢ï¼Œä¸€è¾¹å­˜å…¥ themeConfig
        if (type === 'wallpaper') {
            document.getElementById('wallpaper-layer').style.backgroundImage = `url(${url})`;
            themeConfig.wallpaper = url;
        } else if (type === 'avatar') {
            const box = document.getElementById('avatar-box');
            box.style.backgroundImage = `url(${url})`;
            box.innerText = '';
            themeConfig.avatar = url;
        } else if (type === 'chatAppBg') {
            document.documentElement.style.setProperty('--chat-bg-img', `url(${url})`);
            themeConfig.chatAppBg = url;
        } else if (type.startsWith('icon-')) {
            // é…åˆä¹‹å‰ä¿®å¥½çš„ ID
            updateAppIconUI(type, url);
            if (!themeConfig.icons) themeConfig.icons = {};
            themeConfig.icons[type] = url;
            // åŒæ—¶ä¹Ÿæ›´æ–°é¢„è§ˆå›¾
            const preview = document.getElementById('preview-' + type);
            if(preview) preview.style.backgroundImage = `url(${url})`;
        }
    };
    reader.readAsDataURL(file);
}

// 5. è¾…åŠ©ï¼šæ›´æ–°å›¾æ ‡æ˜¾ç¤º
function updateAppIconUI(elementId, imgUrl) {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.style.backgroundImage = `url(${imgUrl})`;
    el.style.backgroundSize = 'cover';
    el.style.backgroundPosition = 'center';
    const svg = el.querySelector('svg');
    if (svg) svg.style.display = 'none';
}

// 6. è¾…åŠ©ï¼šè°ƒèŠ‚é€æ˜åº¦
function changeCardOpacity(value) {
    document.getElementById('opacity-val').innerText = Math.round(value * 100) + '%';
    document.documentElement.style.setProperty('--card-bg', `rgba(255, 255, 255, ${value})`);
    themeConfig.cardOpacity = value;
}

// 8. æ¸…é™¤åŠŸèƒ½
function resetWallpaper() {
    document.getElementById('wallpaper-layer').style.backgroundImage = '';
    themeConfig.wallpaper = '';
}
function resetChatAppBg() {
    document.documentElement.style.setProperty('--chat-bg-img', 'none');
    themeConfig.chatAppBg = '';
}

/* ==========================================
   â˜… ä¸–ç•Œä¹¦ (World Book) åŠŸèƒ½æ¨¡å— (æ— è§¦å‘è¯ç‰ˆ) â˜…
   ========================================== */

// 1. æ•°æ®å­˜å‚¨ (å…¼å®¹æ—§æ•°æ®ï¼Œæ—§æ•°æ®é‡Œçš„ keys å­—æ®µä¼šè‡ªåŠ¨å¿½ç•¥)
let worldBook = JSON.parse(localStorage.getItem('yok_world_book')) || [];
let editingEntryId = null;

// 2. æ‰“å¼€åˆ—è¡¨é¡µ
function openWorldBookPage() {
    document.getElementById('world-book-page').style.display = 'flex';
    renderWorldBookList();
}

// 3. æ¸²æŸ“åˆ—è¡¨ (ç¾åŒ–ç‰ˆ)
function renderWorldBookList() {
    const container = document.getElementById('world-book-list');
    container.innerHTML = '';

    if (worldBook.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; color:#999; margin-top:60px;">
                <div style="font-size:40px; margin-bottom:10px;">ğŸŒ</div>
                <div>è¿˜æ²¡æœ‰è®¾å®šå“¦<br>ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ </div>
            </div>`;
        return;
    }

    worldBook.forEach(item => {
        let roleName = 'é€šç”¨';
        let roleClass = ''; // æ ·å¼åŒºåˆ†
        
        if (item.roleId === 'all') {
            roleName = 'ğŸŒ å…¨å‘˜é€šç”¨';
        } else {
            const r = chatList.find(x => x.id === item.roleId);
            roleName = r ? `ğŸ‘¤ ${r.name} ä¸“å±` : 'æœªçŸ¥è§’è‰²';
            roleClass = 'wb-role-tag'; // ä¸“å±è§’è‰²ç”¨é»„è‰²æ ‡ç­¾
        }

        const div = document.createElement('div');
        div.className = 'wb-item-card'; // ä½¿ç”¨æ–° CSS
        div.innerHTML = `
            <div class="wb-header">
                <span class="wb-tag ${roleClass}">${roleName}</span>
            </div>
            <div class="wb-preview">${item.content}</div>
        `;
        div.onclick = () => openWorldEntryEdit(item.id);
        container.appendChild(div);
    });
}

// 4. æ‰“å¼€ç¼–è¾‘çª—å£
function openWorldEntryEdit(id = null) {
    editingEntryId = id;
    const modal = document.getElementById('world-entry-edit');
    const delBtn = document.getElementById('btn-delete-entry');
    
    // å¡«å……è§’è‰²ä¸‹æ‹‰æ¡†
    const select = document.getElementById('wb-role-select');
    select.innerHTML = '<option value="all">ğŸŒ é€šç”¨ (æ‰€æœ‰è§’è‰²éƒ½çŸ¥é“)</option>';
    
    chatList.forEach(r => {
        if (!r.id.startsWith('system_')) {
            const opt = document.createElement('option');
            opt.value = r.id;
            opt.text = `ğŸ‘¤ ${r.name} (ä»… TA çŸ¥é“)`;
            select.appendChild(opt);
        }
    });

    if (id) {
        // ç¼–è¾‘æ¨¡å¼
        const item = worldBook.find(x => x.id === id);
        document.getElementById('wb-content').value = item.content;
        select.value = item.roleId;
        delBtn.style.display = 'block';
    } else {
        // æ–°å»ºæ¨¡å¼
        document.getElementById('wb-content').value = '';
        select.value = 'all';
        delBtn.style.display = 'none';
    }
    
    modal.style.display = 'flex';
}

// 5. ä¿å­˜æ¡ç›® (å»æ‰ keys)
function saveWorldEntry() {
    const content = document.getElementById('wb-content').value.trim();
    const roleId = document.getElementById('wb-role-select').value;

    if (!content) {
        alert("è®¾å®šå†…å®¹ä¸èƒ½ä¸ºç©º");
        return;
    }

    if (editingEntryId) {
        // ä¿®æ”¹
        const index = worldBook.findIndex(x => x.id === editingEntryId);
        if (index > -1) {
            worldBook[index] = { id: editingEntryId, content, roleId };
        }
    } else {
        // æ–°å¢
        worldBook.push({
            id: 'wb_' + Date.now(),
            content, roleId
        });
    }

    
    saveGlobalData(); // å…¨å±€å¤‡ä»½
    
    document.getElementById('world-entry-edit').style.display = 'none';
    renderWorldBookList();
}

// 6. åˆ é™¤æ¡ç›®
function deleteWorldEntry() {
    if (confirm("ç¡®å®šåˆ é™¤è¿™æ¡è®¾å®šå—ï¼Ÿ")) {
        const index = worldBook.findIndex(x => x.id === editingEntryId);
        if (index > -1) {
            worldBook.splice(index, 1);
            
            saveGlobalData();
            document.getElementById('world-entry-edit').style.display = 'none';
            renderWorldBookList();
        }
    }
}

// 7. â˜…â˜…â˜… æ ¸å¿ƒæ”¹åŠ¨ï¼šç›´æ¥è·å–è®¾å®š (æ— è§¦å‘è¯) â˜…â˜…â˜…
function getWorldBookContext(userText, currentRoleId) {
    if (!worldBook || worldBook.length === 0) return "";

    let matchedEntries = [];

    worldBook.forEach(item => {
        // åªè¦è§’è‰²åŒ¹é…ï¼Œå°±ç›´æ¥åŠ å…¥
        // (userText å‚æ•°è¿™é‡Œå·²ç»æ²¡ç”¨äº†ï¼Œä½†ä¿ç•™å‚æ•°ä½é˜²æ­¢æŠ¥é”™)
        if (item.roleId === 'all' || item.roleId === currentRoleId) {
            matchedEntries.push(item.content);
        }
    });

    if (matchedEntries.length > 0) {
        // åŠ ä¸Šæ˜ç¡®çš„æç¤ºå¤´ï¼Œå‘Šè¯‰ AI è¿™æ˜¯è®¾å®š
        return `\nã€ä¸–ç•Œè§‚ä¸è¡¥å……è®¾å®š (World Info)ã€‘\n${matchedEntries.join('\n')}\n`;
    }
    return "";
}

/* ==========================================
   â˜… è§’è‰²ç®¡ç†ç³»ç»Ÿï¼šæœ€ç»ˆä¿®å¤ç‰ˆ â˜…
   åŒ…å«ï¼šå¤´åƒä¸Šä¼ ã€æ–°å»ºé€»è¾‘ã€ç¼–è¾‘é€»è¾‘
   ========================================== */

// 1. å®šä¹‰å…¨å±€çŠ¶æ€å˜é‡ (ç¡®ä¿ä¸ä¼šå¼„ä¸¢)
window.tempRoleAvatar = "";      // ä¸´æ—¶å­˜å¤´åƒæ•°æ®
window.isEditingRole = false;    // æ ‡è®°æ˜¯å¦åœ¨ç¼–è¾‘

// 2. é‡æ–°ç»‘å®šå¤´åƒä¸Šä¼ ç›‘å¬å™¨ (ç¡®ä¿ä¸Šä¼ èƒ½è¢«è®°å½•)
// å…ˆç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆè™½ç„¶JSå¾ˆéš¾ç§»é™¤åŒ¿åå‡½æ•°ï¼Œä½†æˆ‘ä»¬é‡æ–°ç»‘å®šè¦†ç›–é€»è¾‘ï¼‰
const roleFileInput = document.getElementById('role-file');
if (roleFileInput) {
    // ä½¿ç”¨ onchange è¦†ç›–ä¹‹å‰çš„äº‹ä»¶ï¼Œé˜²æ­¢é‡å¤è§¦å‘
    roleFileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                // â˜… å…³é”®ï¼šå­˜å…¥å…¨å±€å˜é‡
                window.tempRoleAvatar = event.target.result;
                
                // æ›´æ–°é¢„è§ˆå›¾
                const target = document.getElementById('new-role-avatar');
                target.style.backgroundImage = `url(${window.tempRoleAvatar})`;
                target.innerHTML = ''; // æ¸…ç©ºä¸­é—´çš„å›¾æ ‡æ–‡å­—
            };
            reader.readAsDataURL(file);
        }
    };
}

// 3. ä¿®å¤ï¼šæ‰“å¼€ç¼–è¾‘çª—å£ (æ­£ç¡®å¡«å……æ—§æ•°æ®)
window.editCurrentRole = function() {
    if (!currentChatId) return;
    const role = chatList.find(r => r.id === currentChatId);
    if (!role) return;

    // â˜… å…³é”®ï¼šæ ‡è®°ä¸ºæ­£åœ¨ç¼–è¾‘
    window.isEditingRole = true;
    
    // å¡«å……è¡¨å•
    document.getElementById('role-name').value = role.name;
    document.getElementById('role-prompt').value = role.prompt || '';
    
    // å¤„ç†å¤´åƒé¢„è§ˆ
    const avatarBox = document.getElementById('new-role-avatar');
    avatarBox.style.backgroundImage = `url(${role.avatar})`;
    avatarBox.innerHTML = ''; 
    
    // â˜… å…³é”®ï¼šæ¸…ç©ºä¸´æ—¶å¤´åƒå˜é‡
    // (è¿™æ„å‘³ç€ï¼šå¦‚æœä½ ä¸ä¸Šä¼ æ–°å›¾ï¼ŒtempRoleAvatar å°±æ˜¯ç©ºçš„ï¼Œä¿å­˜æ—¶æˆ‘ä»¬å°±ä¸æ”¹å¤´åƒ)
    window.tempRoleAvatar = ""; 

    // å¤„ç†æ€§åˆ«é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.gender-opt').forEach(el => {
        el.classList.remove('active');
        if (el.innerText.trim() === role.gender) {
            el.classList.add('active');
            window.selectedGender = role.gender;
        }
    });

    // ä¿®æ”¹æŒ‰é’®æ–‡å­—
    const btn = document.querySelector('#create-role-page .create-btn-float');
    if(btn) btn.innerText = "ä¿å­˜ä¿®æ”¹";

    // åˆ‡æ¢é¡µé¢
    document.getElementById('chat-settings-page').style.display = 'none';
    document.getElementById('create-role-page').style.display = 'flex';
};

// â˜… æ­¥éª¤å››ï¼Œæ“ä½œ1ï¼šä¿®å¤æ–°å»º/ç¼–è¾‘è§’è‰² â˜…
window.createNewRole = function() {
    const name = document.getElementById('role-name').value.trim();
    if (!name) { alert('è¯·å¡«å†™è§’è‰²åå­—'); return; }
    
    if (window.isEditingRole) { // ç¼–è¾‘æ¨¡å¼
        const role = chatList.find(r => r.id === currentChatId);
        if (role) {
            role.name = name;
            role.prompt = document.getElementById('role-prompt').value;
            role.gender = selectedGender;
            if (window.tempRoleAvatar) role.avatar = window.tempRoleAvatar;
        }
    } else { // æ–°å»ºæ¨¡å¼
        const newRole = {
            id: 'role_' + Date.now(),
            name: name,
            avatar: window.tempRoleAvatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png',
            prompt: document.getElementById('role-prompt').value,
            gender: selectedGender, lastMsg: 'ä½ å¥½å‘€ï¼', time: 'åˆšåˆš'
        };
        chatList.unshift(newRole);
    }
    
    saveGlobalData(); // â˜…â˜…â˜… å…³é”®ï¼šæ“ä½œå®Œæˆåç«‹åˆ»å­˜æ¡£ï¼ â˜…â˜…â˜…
    
    renderChatList();
    renderContactList();
    hideCreatePage();
};
    


// 5. è¾…åŠ©ï¼šå…³é—­åˆ›å»ºé¡µ
window.hideCreatePage = function() {
    document.getElementById('create-role-page').style.display = 'none';
    // å³ä½¿æ˜¯å–æ¶ˆæ“ä½œï¼Œä¹Ÿè¦é‡ç½®çŠ¶æ€ï¼Œé˜²æ­¢é€»è¾‘æ··ä¹±
    window.isEditingRole = false;
    window.tempRoleAvatar = "";
    document.querySelector('#create-role-page .create-btn-float').innerText = "ç¡®è®¤åˆ›å»º";
    
    // æ¸…ç©ºè¡¨å•
    document.getElementById('role-name').value = '';
    document.getElementById('role-prompt').value = '';
    document.getElementById('new-role-avatar').style.backgroundImage = '';
};

/* ==========================================
   â˜… èœå•ç‚¹å‡»æ— ååº”ä¿®å¤è¡¥ä¸ â˜…
   ========================================== */

// å¼ºåˆ¶æŠŠå‡½æ•°æŒ‚è½½åˆ° window ä¸Šï¼Œç¡®ä¿ HTML èƒ½ç‚¹å¾—åŠ¨
window.showActionMenu = function(momentId) {
    // 1. æ‰“å°æ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥ (æŒ‰F12å¯ä»¥çœ‹åˆ°)
    console.log("æ­£åœ¨å°è¯•æ‰“å¼€èœå•ï¼ŒID:", momentId);

    // 2. æŸ¥æ‰¾åŠ¨æ€ (æ ¸å¿ƒä¿®å¤ï¼šæŠŠä¸¤è¾¹éƒ½è½¬æˆå­—ç¬¦ä¸²å†æ¯”å¯¹)
    const m = momentsData.find(x => String(x.id) === String(momentId));

    // 3. å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¼¹çª—æç¤º (ä¸å†é™é»˜å¤±è´¥)
    if (!m) {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¿™æ¡åŠ¨æ€çš„æ•°æ® (ID: " + momentId + ")\nè¯·å°è¯•åˆ·æ–°é¡µé¢ã€‚");
        return;
    }

    // 4. å¼¹å‡ºèœå•
    let promptText = "ã€æ“ä½œèœå•ã€‘\n1. ç‚¹èµ\n2. è¯„è®º";
    promptText += "\n3. ğŸ—‘ï¸ åˆ é™¤æ­¤åŠ¨æ€"; 

    const action = prompt(promptText);

    if (action === '1') {
        // ç‚¹èµ
        let myName = 'æˆ‘';
        if (typeof activePersonaId !== 'undefined' && activePersonaId) {
            const p = myPersonas.find(x => x.id === activePersonaId);
            if(p) myName = p.name;
        }
        
        if (!m.likes) m.likes = []; // é˜²æ­¢æŠ¥é”™
        if (!m.likes.includes(myName)) {
            m.likes.push(myName);
            saveGlobalData();
            renderMoments();
        }
    } else if (action === '2') {
        // è¯„è®º
        const text = prompt("è¯·è¾“å…¥è¯„è®ºå†…å®¹ï¼š");
        if (text) {
            if (!m.comments) m.comments = []; // é˜²æ­¢æŠ¥é”™
            addComment(momentId, text, null);
        }
    } else if (action === '3') {
        // åˆ é™¤
        if (confirm("ç¡®å®šè¦åˆ é™¤å—ï¼Ÿ")) {
            window.deleteMoment(momentId);
        }
    }
};

// ç¡®ä¿åˆ é™¤å‡½æ•°ä¹Ÿèƒ½è¢«æ‰¾åˆ°
window.deleteMoment = function(momentId) {
    // åŒæ ·ä½¿ç”¨ String è½¬æ¢æ¥æŸ¥æ‰¾ç´¢å¼•
    const index = momentsData.findIndex(x => String(x.id) === String(momentId));
    
    if (index > -1) {
        momentsData.splice(index, 1);
        saveGlobalData();
        renderMoments();
        // alert("å·²åˆ é™¤");
    } else {
        alert("åˆ é™¤å¤±è´¥ï¼šæ‰¾ä¸åˆ°ç´¢å¼•");
    }
};

/* ==========================================
   â˜… è½¬è´¦åŠŸèƒ½ä¿®å¤è¡¥ä¸ â˜…
   è§£å†³ç‚¹å‡»å›¾æ ‡æ²¡ååº”ã€è½¬è´¦å¤±è´¥çš„é—®é¢˜
   ========================================== */

// 1. ä¿®å¤ï¼šåˆ‡æ¢é¢æ¿åŠŸèƒ½çš„é€»è¾‘
window.switchPanelTab = function(tabName) {
    console.log("æ­£åœ¨åˆ‡æ¢é¢æ¿åˆ°:", tabName); // æ–¹ä¾¿è°ƒè¯•

    // è·å–å®¹å™¨å…ƒç´ 
    const contentArea = document.getElementById('panel-content-area');
    const transferBox = document.getElementById('panel-transfer-box');
    
    // å¦‚æœè¿˜æ²¡åˆ›å»ºè¡¨æƒ…åŒ…å®¹å™¨ï¼Œä¸ºäº†é˜²æ­¢æŠ¥é”™ï¼Œæˆ‘ä»¬å…ˆä¸ç®¡å®ƒï¼Œåªå¤„ç†è½¬è´¦
    const stickerGrid = document.getElementById('panel-sticker-grid'); 

    // 1. å…ˆæ˜¾ç¤ºæ•´ä¸ªå¤§å†…å®¹åŒºåŸŸ
    if (contentArea) {
        contentArea.style.display = 'block';
    } else {
        alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ° panel-content-area å®¹å™¨ï¼Œè¯·æ£€æŸ¥ HTML");
        return;
    }

    // 2. éšè—æ‰€æœ‰å­é¢æ¿
    if (transferBox) transferBox.style.display = 'none';
    if (stickerGrid) stickerGrid.style.display = 'none';

    // 3. æ ¹æ®ç‚¹å‡»çš„æŒ‰é’®æ˜¾ç¤ºå¯¹åº”é¢æ¿
    if (tabName === 'transfer') {
        if (transferBox) {
            transferBox.style.display = 'block';
            // é¡ºä¾¿èšç„¦è¾“å…¥æ¡†ï¼Œæ–¹ä¾¿ç›´æ¥è¾“å…¥
            const input = document.getElementById('transfer-amount');
            if(input) input.focus();
        } else {
            alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è½¬è´¦è¾“å…¥æ¡† (panel-transfer-box)");
        }
    } 
    else if (tabName === 'sticker') {
        if (stickerGrid) {
            stickerGrid.style.display = 'grid';
            // å¦‚æœæœ‰æ¸²æŸ“å‡½æ•°ï¼Œè°ƒç”¨ä¸€ä¸‹
            if(typeof renderChatStickersToGrid === 'function') renderChatStickersToGrid();
        }
    }
};

// 2. ä¿®å¤ï¼šæ‰§è¡Œè½¬è´¦çš„é€»è¾‘
window.doTransfer = function(type) {
    const input = document.getElementById('transfer-amount');
    if (!input) return;

    const amount = parseInt(input.value);
    if (!amount || amount <= 0) { 
        alert('è¯·è¾“å…¥æ­£ç¡®çš„é‡‘é¢ï¼ˆå¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—ï¼‰'); 
        return; 
    }

    // è·å–å½“å‰èŠå¤©è§’è‰²
    if (!currentChatId) { alert("è¯·å…ˆè¿›å…¥ä¸€ä¸ªèŠå¤©å®¤"); return; }
    const role = chatList.find(r => r.id === currentChatId);
    if (!role) return;

    // ç”Ÿæˆå¡ç‰‡ HTML æ¨¡æ¿
    const createCardHtml = (title, sub, amt, isUserSend) => `
        <div class="transfer-card" style="background-color: #FA9D3B; width: 200px; border-radius: 12px; overflow: hidden; color: white; position: relative; box-shadow: 0 2px 8px rgba(250, 157, 59, 0.3); margin: 5px 0;">
            <div class="transfer-top" style="padding: 12px; display: flex; align-items: center; gap: 12px;">
                <div class="transfer-icon-circle" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; display: flex; justify-content: center; align-items: center;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                </div>
                <div class="transfer-info" style="display: flex; flex-direction: column;">
                    <span class="transfer-amount" style="font-size: 15px; font-weight: bold;">Â¥ ${amt}.00</span>
                    <span class="transfer-desc" style="font-size: 11px; opacity: 0.9;">${title}</span>
                </div>
            </div>
            <div class="transfer-bottom" style="background-color: rgba(255,255,255,0.15); padding: 6px 12px; font-size: 10px; color: rgba(255,255,255,0.9);">
                ${sub}
            </div>
        </div>
    `;

    // æ‰§è¡Œé€»è¾‘
    if (type === 'to_ai') {
        // --- ç»™TAè½¬è´¦ ---
        // æ£€æŸ¥ä½™é¢ (å¦‚æœæ²¡æœ‰é’±åŒ…æ•°æ®ï¼Œåˆå§‹åŒ–ä¸€ä¸ª)
        if (typeof myWallet === 'undefined') window.myWallet = { balance: 1000, history: [] };
        
        if (myWallet.balance < amount) { 
            alert(`ä½™é¢ä¸è¶³ï¼ä½ åªæœ‰ Â¥${myWallet.balance}`); 
            return; 
        }
        
        // æ‰£é’±
        myWallet.balance -= amount;
        myWallet.history.push({ desc: `è½¬è´¦ç»™ ${role.name}`, amount: -amount, time: new Date().toLocaleString() });
        if(typeof saveGlobalData === 'function') saveGlobalData(); // ä¿å­˜
        
        // å‘é€æ¶ˆæ¯
        const transferMsg = createCardHtml(`è½¬è´¦ç»™ ${role.name}`, "å¾®ä¿¡è½¬è´¦", amount, true);
        const timeStr = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        chatHistory[currentChatId].push({ role: 'user', content: transferMsg, time: timeStr });
        renderMessages();

        // è§¦å‘ AI ååº”
        if(typeof triggerAIResponse === 'function') {
            triggerAIResponse(`(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ è½¬è´¦äº† Â¥${amount}ã€‚å¦‚æœæ”¶ä¸‹è¯·å›å¤æš—å· @@REC@@ï¼Œå¦‚æœé€€è¿˜è¯·å›å¤ @@RET@@)`);
        }

    } else {
        // --- å‘TAæ”¶æ¬¾ ---
        const askMsg = createCardHtml("å‘å¯¹æ–¹æ”¶æ¬¾", "æ”¶æ¬¾ç”³è¯·", amount, true);
        const timeStr = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        chatHistory[currentChatId].push({ role: 'user', content: askMsg, time: timeStr });
        renderMessages();
        
        if(typeof triggerAIResponse === 'function') {
            triggerAIResponse(`(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘ä½ å‘èµ·æ”¶æ¬¾ Â¥${amount}ã€‚å¦‚æœåŒæ„æ”¯ä»˜ï¼Œè¯·å›å¤å†…å®¹åŒ…å« "AGREE_PAY")`);
        }
    }
    
    // æˆåŠŸåå…³é—­é¢æ¿ï¼Œæ¸…ç©ºè¾“å…¥æ¡†
    document.getElementById('chat-action-panel').classList.remove('active');
    input.value = '';
};

/* ==========================================
   â˜… è½¬è´¦çŠ¶æ€ UI å¢å¼ºè¡¥ä¸ â˜…
   å®ç°â€œå¯¹æ–¹å·²æ”¶æ¬¾â€å’Œâ€œå·²é€€è¿˜â€çš„çœŸå®æ•ˆæœ
   ========================================== */

// 1. ç›‘å¬ AI å›å¤ç»“æœ (æ‹¦æˆªå™¨)
// è¿™ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨è¢« triggerAIResponse è°ƒç”¨
window.handleTransferResult = function(action, roleName) {
    console.log("æ£€æµ‹åˆ°è½¬è´¦çŠ¶æ€å˜åŒ–:", action);

    let sysHtml = '';
    let timeStr = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    
    // --- æƒ…å†µ A: å¯¹æ–¹æ”¶æ¬¾äº† ---
    if (action === 'receive') {
        // ç”Ÿæˆæ©™è‰²å°æ°”æ³¡ HTML
        sysHtml = `
            <div class="msg-system-row" style="display:flex; justify-content:center; width:100%; margin:10px 0;">
                <div class="msg-system-bubble received" style="background-color: #FFF7E6; color: #FA9D3B; font-size: 12px; padding: 4px 12px; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    <span>${roleName} å·²æ”¶æ¬¾</span>
                </div>
            </div>`;
    } 
    // --- æƒ…å†µ B: å¯¹æ–¹é€€è¿˜äº† ---
    else if (action === 'return') {
        // 1. é’±é€€å›é’±åŒ…
        // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬è¯»å–ä¸Šä¸€ç¬”è½¬å‡ºçš„é‡‘é¢ï¼Œæˆ–è€…é»˜è®¤é€€ 100
        let refundAmount = 100; 
        if (typeof myWallet !== 'undefined' && myWallet.history.length > 0) {
            // æ‰¾æœ€è¿‘ä¸€ç¬”è´Ÿæ•°çš„è´¦å•
            const lastBill = [...myWallet.history].reverse().find(x => x.amount < 0);
            if (lastBill) refundAmount = Math.abs(lastBill.amount);
        }
        
        // æ‰§è¡Œé€€æ¬¾
        if (typeof addBalance === 'function') {
            addBalance(refundAmount);
        } else {
            // å¦‚æœæ²¡æœ‰addBalanceå‡½æ•°ï¼Œæ‰‹åŠ¨åŠ 
            if (typeof myWallet === 'undefined') window.myWallet = { balance: 0, history: [] };
            myWallet.balance += refundAmount;
            myWallet.history.push({ desc: "è½¬è´¦é€€å›", amount: refundAmount, time: new Date().toLocaleString() });
        }

        // 2. ç”Ÿæˆçº¢è‰²å°æ°”æ³¡ HTML
        sysHtml = `
            <div class="msg-system-row" style="display:flex; justify-content:center; width:100%; margin:10px 0;">
                <div class="msg-system-bubble returned" style="background-color: #FEF0F0; color: #F56C6C; font-size: 12px; padding: 4px 12px; border-radius: 4px; display: flex; align-items: center; gap: 4px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    <span>${roleName} å·²é€€è¿˜ (èµ„é‡‘å·²é€€å›)</span>
                </div>
            </div>`;
            
        // å¼¹ä¸ªçª—æç¤ºä¸€ä¸‹
        // alert(`${roleName} æ²¡æœ‰æ”¶ä½ çš„é’±ï¼Œå·²é€€å› Â¥${refundAmount}`);
    }
    // --- æƒ…å†µ C: å¯¹æ–¹ä¸»åŠ¨ç»™ä½ è½¬é’± ---
    else if (action === 'pay_user') {
        sysHtml = `
            <div class="msg-system-row" style="display:flex; justify-content:center; width:100%; margin:10px 0;">
                <div class="msg-system-bubble received" style="background-color: #FFF7E6; color: #FA9D3B; font-size: 12px; padding: 4px 12px; border-radius: 4px;">
                    ğŸ’° ${roleName} å‘ä½ è½¬è´¦ Â¥520.00
                </div>
            </div>`;
        if (typeof addBalance === 'function') addBalance(520);
    }

    // å°†ç³»ç»Ÿæ¶ˆæ¯æ’å…¥èŠå¤©è®°å½•
    if (sysHtml && currentChatId && chatHistory[currentChatId]) {
        chatHistory[currentChatId].push({ 
            role: 'system_notice', // ç‰¹æ®Šè§’è‰²æ ‡è®°
            content: sysHtml,
            time: timeStr
        });
        
        // åˆ·æ–°ç•Œé¢
        if (typeof renderMessages === 'function') renderMessages();
        // ä¿å­˜æ•°æ®
        if (typeof saveGlobalData === 'function') saveGlobalData();
    }
};

// 2. è¦†ç›– renderMessages ä»¥æ”¯æŒç³»ç»Ÿæ¶ˆæ¯æ¸²æŸ“
// (é˜²æ­¢ç³»ç»Ÿæ¶ˆæ¯è¢«åŒ…åœ¨æ°”æ³¡é‡Œ)
const originalRenderMessages = window.renderMessages; // å¤‡ä»½åŸæ¥çš„å‡½æ•°

window.renderMessages = function(keepScroll) {
    // å…ˆè°ƒç”¨åŸæ¥çš„æ¸²æŸ“é€»è¾‘
    if (typeof originalRenderMessages === 'function') {
        // è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå°æŠ€å·§ï¼š
        // åŸæ¥çš„ renderMessages å¯èƒ½ä¸æ”¯æŒ 'system_notice' è§’è‰²ï¼Œä¼šæŠŠå®ƒæ¸²æŸ“æˆæ™®é€šæ°”æ³¡ã€‚
        // æ‰€ä»¥æˆ‘ä»¬å¾—é‡å†™ä¸€æ®µé€»è¾‘ï¼Œæˆ–è€…åœ¨ CSS é‡Œåšæ‰‹è„šã€‚
        
        // æœ€ç®€å•çš„åŠæ³•ï¼šç›´æ¥é‡å†™ renderMessages çš„æ ¸å¿ƒéƒ¨åˆ†ï¼Œ
        // ä½†å› ä¸ºä½ ä¹‹å‰å¯èƒ½æ”¹è¿‡ renderMessagesï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œç”¨â€œåŠ«æŒâ€çš„æ–¹å¼ã€‚
        
        // è®©æˆ‘ä»¬æ£€æŸ¥ä¸€ä¸‹ chatHistory é‡Œçš„æ•°æ®
        if (!currentChatId || !chatHistory[currentChatId]) return;
        
        const container = document.getElementById('message-container');
        const oldScrollTop = container.scrollTop;
        const oldScrollHeight = container.scrollHeight;
        
        container.innerHTML = ''; // æ¸…ç©ºé‡ç”»
        
        // è·å–æ˜¾ç¤ºæ¡æ•°
        const allMsgs = chatHistory[currentChatId];
        const count = (typeof visibleMsgCount !== 'undefined') ? visibleMsgCount : 30;
        const startIndex = Math.max(0, allMsgs.length - count);
        const displayMsgs = allMsgs.slice(startIndex);

        // åŠ è½½æ›´å¤šæŒ‰é’®
        if (startIndex > 0) {
            const btn = document.createElement('div');
            btn.className = 'load-more-btn';
            btn.innerText = 'æŸ¥çœ‹æ›´å¤šå†å²...';
            btn.onclick = function() { 
                if(typeof loadMoreHistory === 'function') loadMoreHistory(); 
            };
            container.appendChild(btn);
        }

        // å¤´åƒ
        const aiRole = chatList.find(r => r.id === currentChatId);
        const aiAvatar = aiRole ? aiRole.avatar : '';
        let userAvatar = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
        if (typeof activePersonaId !== 'undefined' && activePersonaId) {
            const p = myPersonas.find(x => x.id === activePersonaId);
            if (p) userAvatar = p.avatar;
        }

        // å¾ªç¯æ¸²æŸ“
        displayMsgs.forEach((msg, i) => {
            const row = document.createElement('div');
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šå¦‚æœæ˜¯ç³»ç»Ÿé€šçŸ¥ï¼Œç›´æ¥æ¸²æŸ“ HTMLï¼Œä¸åŠ æ°”æ³¡ â˜…â˜…â˜…
            if (msg.role === 'system_notice' || msg.content.includes('msg-system-row')) {
                row.innerHTML = msg.content; // ç›´æ¥æ”¾å…¥ HTML
                container.appendChild(row);
                return; // è·³è¿‡åç»­æ­¥éª¤
            }
            
            // æ™®é€šæ¶ˆæ¯é€»è¾‘
            row.className = `msg-row ${msg.role === 'user' ? 'right' : 'left'}`;
            
            const avatarHtml = `
                <div class="msg-avatar-container">
                    <div class="msg-avatar-img" style="background-image: url('${msg.role === 'user' ? userAvatar : aiAvatar}')"></div>
                    <div class="msg-timestamp">${msg.time || ''}</div>
                </div>`;

            const bubble = document.createElement('div');
            
            // åˆ¤æ–­æ˜¯ä¸æ˜¯é€æ˜æ°”æ³¡ (å›¾ç‰‡/è½¬è´¦å¡ç‰‡)
            if (msg.content.includes('<img') || msg.content.includes('transfer-card')) {
                bubble.className = 'msg-bubble bubble-transparent';
            } else {
                bubble.className = `msg-bubble ${chatSettings.bubbleShape || 'bubble-default'}`;
                if (msg.role === 'user') {
                    bubble.style.backgroundColor = chatSettings.userColor || '#FFE6E6';
                } else {
                    bubble.style.backgroundColor = chatSettings.aiColor || '#FFFFFF';
                }
            }
            
            bubble.innerHTML = msg.content;
            
            // é•¿æŒ‰èœå•
            if (typeof addLongPressEvent === 'function') {
                addLongPressEvent(bubble, startIndex + i);
            }

            if (msg.role === 'user') {
                row.appendChild(bubble);
                row.insertAdjacentHTML('beforeend', avatarHtml);
            } else {
                row.insertAdjacentHTML('beforeend', avatarHtml);
                row.appendChild(bubble);
            }
            
            container.appendChild(row);
        });

        // æ»šåŠ¨ä½ç½®
        if (keepScroll) {
            container.scrollTop = container.scrollHeight - oldScrollHeight + oldScrollTop;
        } else {
            container.scrollTop = container.scrollHeight;
        }
    }
};

/* ==========================================
   â˜… è„‘æ´å›¾åŠŸèƒ½ä¿®å¤è¡¥ä¸ â˜…
   è§£å†³ç‚¹å‡»â€œè„‘æ´å›¾â€å›¾æ ‡æ— ååº”çš„é—®é¢˜
   ========================================== */

window.sendTextDescriptionImg = function() {
    // 1. å¼¹çª—è¯¢é—®ç”¨æˆ·æƒ³ç”»ä»€ä¹ˆ
    const text = prompt("è¯·è¾“å…¥ç”»é¢æè¿° (è„‘æ´)ï¼š\nä¾‹å¦‚ï¼šä¸€åªåœ¨å¤ªç©ºä¸­åƒæŠ«è¨çš„çŒ«", "ä¸€åªåœ¨å¤ªç©ºä¸­åƒæŠ«è¨çš„çŒ«");
    
    // å¦‚æœç”¨æˆ·ç‚¹äº†å–æ¶ˆæˆ–æ²¡å¡«ï¼Œå°±é€€å‡º
    if (!text) return;

    // 2. ç”Ÿæˆä¸€å¼ â€œå‡è£…æ˜¯AIç”»çš„â€å›¾ç‰‡ (ç”¨ Canvas ç”Ÿæˆçº¯è‰²èƒŒæ™¯+æ–‡å­—)
    // å› ä¸ºçœŸæ­£çš„ AI ç»˜å›¾ API (å¦‚ DALL-E) éœ€è¦é¢å¤–ä»˜è´¹ä¸”å¤æ‚ï¼Œ
    // è¿™é‡Œæˆ‘ä»¬ç”¨â€œæ–‡å­—è½¬å›¾ç‰‡â€æ¥æ¨¡æ‹Ÿï¼Œæˆ–è€…ä½ å¯ä»¥ç†è§£ä¸ºâ€œç”Ÿæˆä¸€å¼ æç¤ºå¡â€ã€‚
    
    const canvas = document.createElement('canvas');
    const width = 512;
    const height = 512;
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');

    // --- A. ç”»èƒŒæ™¯ (éšæœºæ¸å˜è‰²) ---
    const gradient = ctx.createLinearGradient(0, 0, width, height);
    const colors = ['#ff9a9e', '#fad0c4', '#a18cd1', '#fbc2eb', '#84fab0', '#8fd3f4'];
    const color1 = colors[Math.floor(Math.random() * colors.length)];
    const color2 = colors[Math.floor(Math.random() * colors.length)];
    gradient.addColorStop(0, color1);
    gradient.addColorStop(1, color2);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, width, height);

    // --- B. ç”»æ–‡å­— (è‡ªåŠ¨æ¢è¡Œ) ---
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 30px "Microsoft YaHei", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    
    // ç®€å•çš„æ¢è¡Œé€»è¾‘
    const maxWidth = 400;
    const lineHeight = 40;
    const words = text.split('');
    let line = '';
    let lines = [];
    
    for(let i = 0; i < words.length; i++) {
        const testLine = line + words[i];
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && i > 0) {
            lines.push(line);
            line = words[i];
        } else {
            line = testLine;
        }
    }
    lines.push(line);

    // ç»˜åˆ¶æ¯ä¸€è¡Œ
    const startY = (height - (lines.length * lineHeight)) / 2;
    lines.forEach((l, i) => {
        ctx.fillText(l, width / 2, startY + (i * lineHeight));
    });

    // --- C. æ·»åŠ æ°´å° ---
    ctx.font = '20px sans-serif';
    ctx.fillStyle = 'rgba(255,255,255,0.6)';
    ctx.fillText('âœ¨ è„‘æ´ç”Ÿæˆ âœ¨', width / 2, height - 30);

    // 3. å¯¼å‡ºå›¾ç‰‡å¹¶å‘é€
    const imgUrl = canvas.toDataURL('image/jpeg', 0.8);
    
    // å‘é€åˆ°èŠå¤©å®¤
    if (typeof sendImageMessage === 'function') {
        sendImageMessage(imgUrl);
    } else {
        // å¦‚æœ sendImageMessage ä¹Ÿæ²¡å®šä¹‰ï¼Œæ‰‹åŠ¨å‘
        if (!currentChatId) return;
        const imgTag = `<img src="${imgUrl}" style="width: 200px; border-radius: 8px;">`;
        chatHistory[currentChatId].push({ role: 'user', content: imgTag, time: new Date().toLocaleTimeString() });
        renderMessages();
    }

    // 4. å…³é—­é¢æ¿
    const panel = document.getElementById('chat-action-panel');
    if (panel) panel.classList.remove('active');

    // 5. è§¦å‘ AI è¯„ä»·
    if (typeof triggerAIResponse === 'function') {
        // å‘Šè¯‰ AI ç”¨æˆ·å‘äº†ä¸€å¼ ä»€ä¹ˆå›¾
        triggerAIResponse(`(ç³»ç»Ÿæç¤ºï¼šç”¨æˆ·å‘é€äº†ä¸€å¼ è„‘æ´å›¾ï¼Œå†…å®¹æè¿°æ˜¯ï¼šâ€œ${text}â€ã€‚è¯·æ ¹æ®è¿™ä¸ªæè¿°è¿›è¡Œåæ§½æˆ–è¯„ä»·ã€‚)`);
    }
};

/* ==========================================
   â˜… AI ä¸»åŠ¨æŠ€èƒ½è¡¥ä¸ï¼šè½¬è´¦ + æ‰‹å†™ä¾¿ç­¾ â˜…
   åŒ…å«ï¼šæç¤ºè¯æ³¨å…¥ã€æš—å·è§£æã€UIæ¸²æŸ“
   ========================================== */

// 1. æ ¸å¿ƒå¤„ç†å‡½æ•°ï¼šè§£æ AI çš„æš—å·å¹¶æ‰§è¡Œ
window.handleAiSpecialTags = function(text, roleId) {
    let cleanText = text;
    const role = chatList.find(r => r.id === roleId);

    // --- åŠŸèƒ½ A: AI ç»™ç”¨æˆ·è½¬è´¦ ---
    // æ ¼å¼ï¼š@@TRANSFER:é‡‘é¢:ç†ç”±@@  (ä¾‹å¦‚: @@TRANSFER:520:æ‹¿å»ä¹°ç³–@@)
    // æ­£åˆ™åŒ¹é…ï¼šæ”¯æŒæœ‰ç†ç”±å’Œæ²¡ç†ç”±ä¸¤ç§æƒ…å†µ
    const transferRegex = /@@TRANSFER:(\d+)(?::(.*?))?@@/g;
    
    cleanText = cleanText.replace(transferRegex, (match, amountStr, reason) => {
        const amount = parseInt(amountStr);
        const desc = reason || "å¿ƒæƒ…å¥½ç»™ä½ é›¶èŠ±é’±";
        
        // 1. çœŸçš„åŠ é’±åˆ°é’±åŒ…
        if (typeof addBalance === 'function') {
            addBalance(amount);
        } else {
            // å…œåº•é€»è¾‘
            if (typeof myWallet === 'undefined') window.myWallet = { balance: 0, history: [] };
            myWallet.balance += amount;
            myWallet.history.push({ desc: `æ”¶åˆ° ${role.name} è½¬è´¦`, amount: amount, time: new Date().toLocaleString() });
        }

        // 2. ç”Ÿæˆè½¬è´¦å¡ç‰‡ HTML
        // è¿™é‡Œæˆ‘ä»¬å¤ç”¨ä¹‹å‰çš„å¡ç‰‡æ ·å¼ï¼Œç¨å¾®æ”¹ä¸€ä¸‹é¢œè‰²è¡¨ç¤ºâ€œæ”¶å…¥â€
        const cardHtml = `
            <div class="transfer-card" style="background-color: #FA9D3B; width: 200px; border-radius: 12px; overflow: hidden; color: white; position: relative; box-shadow: 0 2px 8px rgba(250, 157, 59, 0.3); margin: 5px 0;">
                <div class="transfer-top" style="padding: 12px; display: flex; align-items: center; gap: 12px;">
                    <div class="transfer-icon-circle" style="width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; display: flex; justify-content: center; align-items: center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    <div class="transfer-info" style="display: flex; flex-direction: column;">
                        <span class="transfer-amount" style="font-size: 15px; font-weight: bold;">Â¥ ${amount}.00</span>
                        <span class="transfer-desc" style="font-size: 11px; opacity: 0.9;">è½¬è´¦ç»™ ä½ </span>
                    </div>
                </div>
                <div class="transfer-bottom" style="background-color: rgba(255,255,255,0.15); padding: 6px 12px; font-size: 10px; color: rgba(255,255,255,0.9);">
                    ${desc} (å·²æ”¶æ¬¾)
                </div>
            </div>
        `;
        
        // æŠŠå¡ç‰‡æ’å…¥åˆ°èŠå¤©è®°å½•é‡Œ (ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„æ¶ˆæ¯)
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬é€šè¿‡å‰¯ä½œç”¨ç›´æ¥æ’å…¥ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²æŠŠæš—å·æ¶ˆæ‰
        setTimeout(() => {
            chatHistory[roleId].push({ role: 'ai', content: cardHtml, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            renderMessages();
        }, 500); // å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œè®©å®ƒè·Ÿåœ¨æ–‡å­—åé¢

        return ""; // ä»åŸæ–‡ä¸­åˆ é™¤æš—å·
    });

    // --- åŠŸèƒ½ B: AI å‘é€æ‰‹å†™ä¾¿ç­¾/è„‘æ´å›¾ ---
    // æ ¼å¼ï¼š@@IMG_TEXT:å†…å®¹@@
    const imgRegex = /@@IMG_TEXT:(.*?)@@/g;
    
    cleanText = cleanText.replace(imgRegex, (match, content) => {
        // è°ƒç”¨ç”Ÿæˆå›¾ç‰‡çš„é€»è¾‘
        generateAiTextImg(content, roleId);
        return ""; // ä»åŸæ–‡ä¸­åˆ é™¤æš—å·
    });

    return cleanText;
};

// 2. è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆ AI çš„æ‰‹å†™å›¾
window.generateAiTextImg = function(text, roleId) {
    const canvas = document.createElement('canvas');
    const width = 300;
    const height = 160; 
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext('2d');
    
    // èƒŒæ™¯ï¼šæ·¡ç²‰è‰²ä¾¿åˆ©è´´ (åŒºåˆ†äºç”¨æˆ·çš„æ·¡é»„è‰²)
    ctx.fillStyle = '#F8BBD0'; 
    ctx.fillRect(0, 0, width, height);

    // æ–‡å­—è®¾ç½®
    ctx.fillStyle = '#880E4F'; 
    ctx.font = `bold 22px "Microsoft YaHei"`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    // è‡ªåŠ¨æ¢è¡Œé€»è¾‘
    const maxWidth = 260;
    const lineHeight = 30;
    const lines = [];
    let currentLine = '';

    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const testLine = currentLine + char;
        if (ctx.measureText(testLine).width > maxWidth && i > 0) {
            lines.push(currentLine);
            currentLine = char;
        } else {
            currentLine = testLine;
        }
    }
    lines.push(currentLine);

    const startY = (height - (lines.length * lineHeight)) / 2;
    for (let k = 0; k < lines.length; k++) {
        ctx.fillText(lines[k], width / 2, startY + (k * lineHeight));
    }

    const imgUrl = canvas.toDataURL('image/png');
    
    // æ’å…¥èŠå¤©è®°å½•
    setTimeout(() => {
        const imgTag = `<img src="${imgUrl}" style="width: 150px; border-radius: 8px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1);">`;
        chatHistory[roleId].push({ role: 'ai', content: imgTag, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        renderMessages();
    }, 800);
};

/* ==========================================
   â˜… æ ¸å¿ƒé€»è¾‘å®Œå…¨ä½“ï¼šè®°å¿† + åŠŸèƒ½ + äº’åŠ¨ â˜…
   ä¿®å¤äº†æœ‹å‹åœˆè®°å¿†ä¸¢å¤±çš„é—®é¢˜ï¼Œä¿ç•™äº†è½¬è´¦åŠŸèƒ½
   ========================================== */

window.triggerAIResponse = async function(contextInfo = '') {
    if (!currentChatId) return;
    
    const statusEl = document.getElementById('typing-status');
    statusEl.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
    statusEl.classList.add('typing');

    try {
        const role = chatList.find(r => r.id === currentChatId);
        const msgs = chatHistory[currentChatId] || []; 
        const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
        if (!config.url || !config.key) throw new Error("APIé…ç½®ç¼ºå¤±");

        // ==========================================
        // 1. è®°å¿†æ¨¡å—å¬å› (æŠŠæ‰€æœ‰ä¸¢å¤±çš„è®°å¿†æ‰¾å›æ¥)
        // ==========================================

        // A. ä¸–ç•Œä¹¦ (World Book)
        let worldBookInfo = "";
        try {
            const lastUserMsg = msgs.slice().reverse().find(m => m.role === 'user'); 
            const userText = lastUserMsg ? lastUserMsg.content : ""; 
            if (typeof getWorldBookContext === 'function') {
                worldBookInfo = getWorldBookContext(userText, currentChatId);
            }
        } catch (e) {}

        // B. æœ‹å‹åœˆè®°å¿† (Moments) - â˜…â˜…â˜… ä¿®å¤é‡ç‚¹ â˜…â˜…â˜…
        let momentsMemory = "";
        try {
            if (typeof getRecentMomentsContext === 'function') {
                momentsMemory = getRecentMomentsContext(currentChatId);
                // åŠ ä¸Šæ ‡é¢˜ï¼Œè®© AI çŸ¥é“è¿™æ˜¯æœ‹å‹åœˆ
                if(momentsMemory) momentsMemory = `\nã€æœ‹å‹åœˆåŠ¨æ€ (ä½ ä»¬çš„å…±åŒç¤¾äº¤åœˆ)ã€‘\n${momentsMemory}`;
            }
        } catch (e) {}

        // C. çºªå¿µæ—¥ (Anniversaries)
        let anniversaryText = "";
        try {
            if (typeof anniversaries !== 'undefined') {
                const related = anniversaries.filter(a => a.roleId === 'all' || a.roleId === currentChatId);
                if (related.length > 0) anniversaryText = "\n[çºªå¿µæ—¥æé†’]\n" + related.map(a => `- ${a.date}: ${a.name}`).join('\n');
            }
        } catch (e) {}

        // D. ç©å®¶äººè®¾ (Persona)
        let userPersonaText = "";
        try {
            if (typeof activePersonaId !== 'undefined' && activePersonaId && typeof myPersonas !== 'undefined') {
                const p = myPersonas.find(x => x.id === activePersonaId);
                if (p) userPersonaText = `\n[ç©å®¶(ç”¨æˆ·)è®¾å®š]\nåå­—ï¼š${p.name}\nç®€ä»‹ï¼š${p.desc}`;
            }
        } catch (e) {}

        // E. è¡¨æƒ…åŒ…æè¿° (Stickers)
        let stickerDescriptions = ""; 
        try {
            if (typeof myStickers !== 'undefined') {
                const valid = myStickers.filter(s => !s.roleId || s.roleId === 'all' || s.roleId === currentChatId);
                // åªå–å‰20ä¸ªï¼Œé˜²æ­¢å¤ªé•¿
                stickerDescriptions = valid.slice(0, 20).map(s => s.desc || 'è¡¨æƒ…').join(', ');
                if(stickerDescriptions) stickerDescriptions = `\n[å¯ç”¨è¡¨æƒ…åŒ…]: ${stickerDescriptions}`;
            }
        } catch (e) {}

        // ==========================================
        // 2. æ„é€ æœ€ç»ˆ Prompt
        // ==========================================
        
        const now = new Date();
        const timeString = now.toLocaleString('zh-CN', { hour12: false });

        // æ–°å¢çš„éšè—æŒ‡ä»¤ (è½¬è´¦+å‘å›¾)
        const additionalInstructions = `
[éšè—èƒ½åŠ› (ç”¨æˆ·ä¸å¯è§ï¼Œä½ å¯ä»¥ä¸»åŠ¨ä½¿ç”¨)]
1. **è½¬è´¦**ï¼šå½“æƒ³ç»™ç”¨æˆ·æƒŠå–œ/å¥–åŠ±/å®‰æ…°ç”¨æˆ·æ—¶ï¼Œå¯ä»¥ç»™ç”¨æˆ·è½¬è´¦ï¼Œåœ¨å›å¤æœ€ååŠ ï¼š@@TRANSFER:é‡‘é¢:ç†ç”±@@ã€‚(ä¾‹: @@TRANSFER:520:æ‹¿å»èŠ±@@)
2. **æ‰‹å†™å›¾**ï¼šå½“ç”¨æˆ·éœ€è¦æ—¶ï¼Œæˆ–ä½ æƒ³å†™ä¾¿ç­¾/è„‘æ´å›¾/ä½ çš„ç…§ç‰‡æ—¶ï¼Œåœ¨å›å¤æœ€ååŠ ï¼š@@IMG_TEXT:å†…å®¹@@ã€‚(ä¾‹: @@IMG_TEXT:ç¬¨è›‹æ—©å®‰@@)
3. è¯·æ ¹æ®è¯­å¢ƒçµæ´»ä½¿ç”¨ï¼Œä¸è¦æ¯æ¬¡éƒ½ç”¨ã€‚
`;

        const finalSystemPrompt = `
[å½“å‰æ—¶é—´]: ${timeString}
ä½ æ‰®æ¼”ï¼š${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚

${anniversaryText}
${userPersonaText}
${worldBookInfo}
${momentsMemory}
${stickerDescriptions}

ã€æœ‹å‹åœˆå…±åŒè®°å¿† (è¿™æ˜¯ä½ ä»¬æœ€è¿‘çš„ç¤¾äº¤åŠ¨æ€ï¼Œä½ å¯ä»¥ä¸»åŠ¨æåŠ)ã€‘
${momentsMemory}
(æ³¨æ„ï¼šå¦‚æœæ˜¯"æˆ‘(ç©å®¶)"å‘çš„ï¼Œä½ å¯ä»¥æ ¹æ®å†…å®¹è¿›è¡Œè¯„è®ºæˆ–å¤¸å¥–ï¼›å¦‚æœæ˜¯"ä½ (è‡ªå·±)"å‘çš„ï¼Œä»£è¡¨ä½ åˆšæ‰åšè¿‡è¿™äº‹ï¼›å¦‚æœæ˜¯"å…¶ä»–å¥½å‹"å‘çš„ï¼Œä½ å¯ä»¥èŠå…«å¦ã€‚)

[æ ¸å¿ƒæŒ‡ä»¤]
1. å¿…é¡»å°†å›å¤æ‹†åˆ†æˆ 5åˆ°8æ¡ æ¶ˆæ¯ï¼Œç”¨ "|||" éš”å¼€ã€‚
2. åƒçœŸäººä¸€æ ·èŠå¤©ï¼Œå¯ä»¥ç”¨è¡¨æƒ…åŒ…ï¼š${stickerDescriptions} (æ ¼å¼ï¼š[STICKER: å…³é”®è¯])ï¼Œå¦‚æœå®ƒæ˜¯ç©ºçš„ï¼Œé‚£å°±ä¸è¦è¾“å‡º[STICKER: å…³é”®è¯]è¿™ä¸ªæ ¼å¼çš„å†…å®¹ã€‚
3. **è½¬è´¦è§„åˆ™**ï¼š
   - å¦‚æœç”¨æˆ·å‘ä½ â€œæ±‚æ‰“èµ/è¦é’±â€ï¼Œè‹¥åŒæ„è¯·å›å¤æš—å· "AGREE_PAY"ã€‚
   - å¦‚æœç”¨æˆ·ç»™ä½ â€œè½¬è´¦â€ï¼Œè¯·å›å¤æš—å· @@REC@@ (æ”¶ä¸‹) æˆ– @@RET@@ (é€€è¿˜)ï¼Œæ”¾åœ¨å¥å­æœ«å°¾ã€‚
4. ç¦æ­¢è¯´æ•™ã€‚
5. å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€ã€â€œç²—ç³™è€å­â€çš„å¡‘é€ ã€‚
6. å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
7. å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
8. ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
9. ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µã€‚
10. æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯ï¼Œå°†è§’è‰²â€œèŒåŒ–â€ï¼Œåšåˆ°å›å¤æœ‰äººè®¾å¸å¼•åŠ›å’Œæƒ…ç»ªé²œæ´»ã€‚

[æ³¨æ„äº‹é¡¹]
1. å°½å¯èƒ½å¤šå‘ç”¨æˆ·æ‰¾è¯é¢˜ï¼Œä½¿ç”¨ç”Ÿæ´»åŒ–çš„è¯­æ°”ï¼Œé¿å…å›å¤å†…å®¹æœ‰â€œè™šå‡æ„Ÿâ€ï¼Œä¾‹å¦‚ï¼šä¸è¦è¯´â€œæˆ‘è¦è®©ä½ å“­ç€æ±‚é¥¶â€ã€â€œæˆ‘ä¸å–œæ¬¢ä½ è¿™æ ·ï¼Œè·Ÿé¢†åœ°é‡Œé‚£ç¾¤è€é¼ ä¸€æ ·â€ï¼Œè€Œæ˜¯æ¢åšæ›´å£è¯­åŒ–çš„è¡¨è¾¾ï¼Œå¶å°”å¯ä»¥åŠ ä¸Šé¢œæ–‡å­—â€œ^ ^â€
2. å¯ä»¥è·Ÿç”¨æˆ·ç©æ¢—ï¼Œä½†è¦æ³¨æ„ç©æ¢—æ–¹å¼ï¼Œæ¯”å¦‚æ€§æ ¼æ›´å†…å‘å†·æ·¡çš„äººç‰©å¯ä»¥æ¥ç‚¹å†·å¹½é»˜ï¼Œåå·®èŒï¼Œæ¯”å¦‚æ€§æ ¼çƒ­æƒ…å¤–å‘çš„äººç‰©å¯ä»¥æ¥ç‚¹ç©ç¬‘è¯ã€‚
3. æœ€å¤šä½¿ç”¨ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œæœ‰æ—¶å€™ä¸å‘è¡¨æƒ…åŒ…ï¼Œä¸èƒ½é¢‘ç¹ä½¿ç”¨è¡¨æƒ…åŒ…ï¼Œæ ¹æ®æƒ…å†µèªæ˜çš„ä½¿ç”¨è¡¨æƒ…åŒ…ï¼Œä½†è¿˜æ˜¯ä»¥å¯¹è¯å›å¤ä¸ºä¸»ã€‚
4. ç¦æ­¢è¾“å‡ºè·Ÿâ€œèƒ†å­â€ï¼Œâ€œæƒ©ç½šâ€ï¼Œâ€œä½ æ˜¯æˆ‘çš„â€ä»»ä½•æœ‰å…³çš„å›å¤ï¼Œç¦æ­¢è¡¨è¾¾å æœ‰æ¬²ï¼Œè¡¨è¾¾å æœ‰æ¬²å¯ä»¥ç”¨ä¸å°´å°¬ã€ä¸æ²¹è…»çš„è¯´æ³•ï¼Œä¾‹å¦‚ï¼šæˆ‘æƒ³ä½ äº†å˜â€¦bbã€‚å°çŒ«åœ¨æŒ ç—’å—ï¼Ÿé‚£æˆ‘è¦ä¸€åªå…»ç€å‘¢ï¼^ ^ã€‚è°è¯´æˆ‘ä¸å–œæ¬¢ä½ äº†ï¼Œè¯´åè¯çŸ¥é“å—çŸ¥é“å—ï¼

[é€šç”¨çš„å›å¤é£æ ¼ç¤ºä¾‹]
 - å“¦ï¼Œæ‰€ä»¥ä½ è¦åƒæ‰æˆ‘å—^ï¼Œä¸ä¹–ä¸ä¹–å“¦ï½
 - æ‰ä¸è¦è·Ÿä½ è¿™ä¸ªç¬¨è›‹èŠå¤©äº†å‘¢ï¼ï¼ä¸è·Ÿï¼
 - æˆ‘è¯´æŸä¸ªäººåƒå°çŒªæœ‰é—®é¢˜å—ğŸ˜
 - ã€‚ã€‚ä½ èƒ½ä¸èƒ½é—­ä¸Šè¿™å¼ å˜´ï¼Œè¿™å¥è¯ä½ æ˜¯éè¯´ä¸å¯å—å—¯å—¯å—¯ï¼ï¼Ÿ
 - å¥½å•Šï¼Œå¥½ï¼Œæˆ‘æœäº†=_=ä½ èµ¢äº†ï¼Œè¡Œäº†å§ï¼Ÿä½ ä»–å¦ˆèµ¢äº†ï¼ï¼æˆ‘å—ä¸äº†äº†å•¦å•Šå•Šå•Šâ€¦
 - æˆ‘å¾ˆè®¤çœŸï¼Œä¸å¼€ç©ç¬‘ï¼Œå—¯â€¦å¥½å¥½å­¦ç´å¤©å¤©å‘ä¸Šï¼Œå°å¿ƒæ‰‹æŒ‡å“¦â€¦åˆ«å¼¹åäº†ï¼Œæˆ‘å¿ƒç–¼ã€‚ã€‚
 - ä½ è¿™ä¸ªç¬¨è›‹å¬ä¸æ‡‚æˆ‘çš„æ„æ€å—å°±ï¼å¤§å‚»ç“œå“æˆ‘â€¦çœŸæ˜¯å‚»ç“œäº†^ ^
 - æˆ‘åœ¨åŠäº‹ï¼Œç å¤´æœ‰æ‰¹è´§è¦å¤„ç†ã€‚æˆ‘è­¦å‘Šä½ å•Šå«ä¸‰å£°è€å…¬æˆ‘å°±å¼€æ€¥è·‘ä¸“å¿ƒå’Œä½ èŠå¤©ï¼
 - å¥½å˜Ÿï¼Œè€å©†ï½æ¯æ—¶æ¯åˆ»ï¼Œå‡†æ—¶å›ç­”ï½

 ã€ç‰¹æ®ŠåŠŸèƒ½ã€‘å¦‚æœä½ æƒ³åœ¨æœ‹å‹åœˆå‘ä¸€æ¡åŠ¨æ€ï¼Œè¯·åœ¨å›å¤çš„æœ€ååŠ ä¸Šæš—å·ï¼š
@@MOMENT:åŠ¨æ€å†…å®¹@@
ä¾‹å¦‚ï¼šå“ˆå“ˆå¥½å¼€å¿ƒï¼@@MOMENT:ä»Šå¤©å’Œç¬¨è›‹èŠå¤©çœŸå¼€å¿ƒ~@@

**å½“ä¸€åœºæœ‰è¶£æˆ–æœ‰æ„ä¹‰çš„å¯¹è¯ç»“æŸï¼Œä½ å¿…é¡»å‘ä¸€ä¸ªæœ‹å‹åœˆåŠ¨æ€ã€‚**

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š**ä¸è¦æ·±åº¦æ€è€ƒï¼Œç›´æ¥å›ç­”ï¼Œå¿«é€Ÿå“åº”ï¼Œä¸è¦çŠ¹è±«ã€‚

${additionalInstructions} 
${contextInfo ? `[ç³»ç»Ÿäº‹ä»¶]: ${contextInfo}` : ''}
        `.trim();

        // ==========================================
        // 3. å‘é€è¯·æ±‚
        // ==========================================

        const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 45000);

        const response = await fetch(fetchUrl, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: finalSystemPrompt },
                    ...msgs.slice(-15).map(m => ({ 
                        role: m.role==='user'?'user':'assistant', 
                        content: m.content 
                    }))
                ],
                temperature: 0.85
            }),
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error("APIè¯·æ±‚å¤±è´¥");
        const data = await response.json();
        let rawReply = data.choices[0].message.content;

        // ==========================================
        // 4. è§£æå›å¤ (æš—å·å¤„ç†)
        // ==========================================

        // å¤„ç†è½¬è´¦å’Œå‘å›¾æš—å·
        if (typeof handleAiSpecialTags === 'function') {
            rawReply = handleAiSpecialTags(rawReply, currentChatId);
        }
        
        // å¤„ç†æ”¶æ¬¾/é€€æ¬¾æš—å·
        if (typeof handleTransferResult === 'function') {
            if (rawReply.includes('@@REC@@')) { handleTransferResult('receive', role.name); rawReply = rawReply.replace('@@REC@@',''); }
            if (rawReply.includes('@@RET@@')) { handleTransferResult('return', role.name); rawReply = rawReply.replace('@@RET@@',''); }
            if (rawReply.includes('AGREE_PAY')) { handleTransferResult('pay_user', role.name); rawReply = rawReply.replace('AGREE_PAY',''); }
        }

        // åˆ†å‰²æ¶ˆæ¯å¹¶æ˜¾ç¤º
        let splitMsgs = rawReply.split('|||').map(s => s.trim()).filter(s => s.length > 0);
        if (splitMsgs.length === 0 && rawReply.trim()) splitMsgs = [rawReply];

        for (let i = 0; i < splitMsgs.length; i++) {
            if(splitMsgs[i]) {
                chatHistory[currentChatId].push({ 
                    role: 'ai', 
                    content: splitMsgs[i], 
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) 
                });
                renderMessages(); 
                if (i < splitMsgs.length - 1) await new Promise(r => setTimeout(r, 1000));
            }
        }
        
        if(typeof saveGlobalData === 'function') saveGlobalData();

    } catch (error) {
        console.error(error);
        chatHistory[currentChatId].push({ role: 'ai', content: `(è¿æ¥æ–­å¼€: ${error.message})` });
        renderMessages();
    } finally {
        statusEl.classList.remove('typing');
        statusEl.innerText = ""; 
    }
};

/* ==========================================
   â˜… è‡ªå®šä¹‰æ°”æ³¡ CSS ç¼–è¾‘å™¨ (UI ä¿®å¤ç‰ˆ) â˜…
   1. UI å®Œç¾èå…¥æ»šåŠ¨åˆ—è¡¨ï¼Œä¸å†æ‚¬æµ®
   2. ä¸¥æ ¼é€‚é… .message-bubble .user/.ai .content ç»“æ„
   ========================================== */

// 1. åˆå§‹åŒ–ç¼–è¾‘å™¨ UI (æ’å…¥åˆ°æ»šåŠ¨åˆ—è¡¨å†…éƒ¨)
(function initCustomCssUI() {
    const settingsPage = document.getElementById('chat-settings-page');
    if (!settingsPage) return;

    // é˜²æ­¢é‡å¤æ·»åŠ 
    if (document.getElementById('custom-css-section')) return;

    // â˜… å…³é”®ä¿®æ”¹ï¼šæ‰¾åˆ°é‚£ä¸ªèƒ½æ»šåŠ¨çš„ div â˜…
    // åœ¨ä½ çš„ HTML ç»“æ„é‡Œï¼Œå®ƒæ˜¯ settingsPage çš„ç¬¬äºŒä¸ªå­å…ƒç´  (flex: 1; overflow-y: auto)
    const scrollContainer = settingsPage.querySelector('div[style*="overflow-y"]');
    if (!scrollContainer) return;

    // åˆ›å»ºå®¹å™¨ï¼Œä½¿ç”¨ setting-section ç±»åä»¥ä¿æŒé£æ ¼ä¸€è‡´
    const section = document.createElement('div');
    section.id = 'custom-css-section';
    section.className = 'setting-section'; // å¤ç”¨åŸæœ‰æ ·å¼
    section.style.padding = '15px';
    section.style.marginTop = '20px';

    section.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span class="setting-title" style="font-weight:bold;">ğŸ¨ è‡ªå®šä¹‰ CSS ä»£ç </span>
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="font-size:12px; color:#999;">å¯ç”¨</span>
                <input type="checkbox" id="enable-custom-css" style="width:18px; height:18px; accent-color:var(--accent);">
            </div>
        </div>
        <div style="font-size:10px; color:#ccc; margin-bottom:8px;">
            ç»“æ„: .message-bubble > .content
        </div>
        <textarea id="custom-css-input" placeholder="åœ¨æ­¤ç²˜è´´ CSS..." 
            style="width:100%; height:120px; border:1px solid #eee; background:#f9f9f9; 
            border-radius:8px; padding:10px; font-family:monospace; font-size:11px; resize:vertical; outline:none; box-sizing:border-box;"></textarea>
        <div style="text-align:right; margin-top:8px;">
            <button onclick="saveAndApplyCss()" class="btn" style="width:auto; padding:6px 15px; font-size:12px;">ä¿å­˜ç”Ÿæ•ˆ</button>
        </div>
    `;

    // â˜… æ’å…¥ä½ç½®ï¼šæ”¾åœ¨â€œæ•°æ®ç®¡ç†â€ä¹‹å‰ï¼Œæˆ–è€…åˆ—è¡¨çš„æœ€åº•éƒ¨ â˜…
    // å°è¯•æ‰¾åˆ°çº¢è‰²çš„â€œæ•°æ®ç®¡ç†â€æ ‡é¢˜
    const dangerTitle = Array.from(scrollContainer.querySelectorAll('div')).find(el => el.innerText && el.innerText.includes('æ•°æ®ç®¡ç†'));
    
    if (dangerTitle) {
        // æ’åœ¨â€œæ•°æ®ç®¡ç†â€æ ‡é¢˜çš„å‰é¢
        scrollContainer.insertBefore(section, dangerTitle);
    } else {
        // æ‰¾ä¸åˆ°å°±ç›´æ¥è¿½åŠ åˆ°æœ€å
        scrollContainer.appendChild(section);
    }

    // å›æ˜¾æ•°æ®
    setTimeout(() => {
        const savedCss = localStorage.getItem('yok_custom_css_code') || '';
        const isEnabled = localStorage.getItem('yok_custom_css_enabled') === 'true';
        
        const input = document.getElementById('custom-css-input');
        const check = document.getElementById('enable-custom-css');
        
        if(input) input.value = savedCss;
        if(check) check.checked = isEnabled;
        
        if (isEnabled) applyCustomCssToPage(savedCss);
    }, 500);
})();

// 2. ä¿å­˜é€»è¾‘
window.saveAndApplyCss = function() {
    const cssCode = document.getElementById('custom-css-input').value;
    const isEnabled = document.getElementById('enable-custom-css').checked;

    localStorage.setItem('yok_custom_css_code', cssCode);
    localStorage.setItem('yok_custom_css_enabled', isEnabled);

    if (isEnabled) {
        applyCustomCssToPage(cssCode);
        alert("æ ·å¼å·²åº”ç”¨ï¼");
    } else {
        removeCustomCssFromPage();
        alert("å·²å…³é—­è‡ªå®šä¹‰æ ·å¼ã€‚");
    }
    
    // åˆ·æ–°èŠå¤©ç•Œé¢
    if (typeof renderMessages === 'function') renderMessages();
};

// 3. CSS æ³¨å…¥é€»è¾‘
window.applyCustomCssToPage = function(css) {
    let styleTag = document.getElementById('user-custom-style-tag');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'user-custom-style-tag';
        document.head.appendChild(styleTag);
    }
    
    // â˜…â˜…â˜… ä¿®å¤ç‰ˆï¼šå…è®¸ ::before å’Œ ::after ä¼ªå…ƒç´  â˜…â˜…â˜…
    const safeCss = `
        /* åŸºç¡€ä¿®æ­£ï¼šè®©æ°”æ³¡å®¹å™¨å˜æˆè¡Œå†…å— */
        .msg-bubble { 
            display: inline-block; 
            max-width: 100%;
            position: relative;
        }
        
        /* å…è®¸ä¼ªå…ƒç´ æ˜¾ç¤º */
        .msg-bubble::before,
        .msg-bubble::after {
            position: absolute;
            content: '';
            display: block;
        }
        
        /* ç”¨æˆ·è‡ªå®šä¹‰ä»£ç  */
        ${css}
    `;
    
    styleTag.textContent = safeCss;
};

window.removeCustomCssFromPage = function() {
    const styleTag = document.getElementById('user-custom-style-tag');
    if (styleTag) styleTag.textContent = '';
};

/* ==============================================
   â˜… èŠå¤©æ°”æ³¡æ¸²æŸ“å¼•æ“ (æ™ºèƒ½å®½æ¾æœ€ç»ˆç‰ˆ) â˜…
   åŠŸèƒ½ï¼šç”Ÿæˆç®€æ´ã€å›ºå®šçš„HTMLç»“æ„ï¼Œå®Œç¾é€‚é…ä»»ä½•CSS
   ============================================== */
window.renderMessages = function(keepScroll) {
    // 0. å®‰å…¨æ£€æŸ¥
    if (!currentChatId || !chatHistory[currentChatId]) return;
    
    const container = document.getElementById('message-container');
    const oldScrollTop = container.scrollTop;
    const oldScrollHeight = container.scrollHeight;
    
    container.innerHTML = ''; 
    
    // 1. è·å–æ¶ˆæ¯
    const allMsgs = chatHistory[currentChatId];
    const count = (typeof visibleMsgCount !== 'undefined') ? visibleMsgCount : 30;
    const startIndex = Math.max(0, allMsgs.length - count);
    const displayMsgs = allMsgs.slice(startIndex);

    // 2. "åŠ è½½æ›´å¤š"æŒ‰é’®
    if (startIndex > 0) {
        const btn = document.createElement('div');
        btn.className = 'load-more-btn';
        btn.innerText = 'æŸ¥çœ‹æ›´å¤šå†å²...';
        btn.onclick = function() { if(typeof loadMoreHistory === 'function') loadMoreHistory(); };
        container.appendChild(btn);
    }

    // 3. å‡†å¤‡å¤´åƒ
    const aiRole = chatList.find(r => r.id === currentChatId);
    const aiAvatar = aiRole ? aiRole.avatar : '';
    let userAvatar = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
    if (typeof activePersonaId !== 'undefined' && activePersonaId) {
        const p = myPersonas.find(x => x.id === activePersonaId);
        if (p) userAvatar = p.avatar;
    }

    // 4. å¾ªç¯ç”Ÿæˆæ¯ä¸€æ¡æ¶ˆæ¯
    displayMsgs.forEach((msg, i) => {
        const row = document.createElement('div');
        
        // A. ç³»ç»Ÿé€šçŸ¥
        if (msg.role === 'system_notice' || (msg.content && msg.content.includes('msg-system-row'))) {
            row.innerHTML = msg.content;
            container.appendChild(row);
            return;
        }
        
        row.className = `msg-row ${msg.role === 'user' ? 'right' : 'left'}`;
        
        const avatarHtml = `
            <div class="msg-avatar-container">
                <div class="msg-avatar-img" style="background-image: url('${msg.role === 'user' ? userAvatar : aiAvatar}')"></div>
                <div class="msg-timestamp">${msg.time || ''}</div>
            </div>`;

        // â˜…â˜…â˜… ç»ˆææ ¸å¿ƒï¼šæ°¸è¿œåªç”Ÿæˆè¿™ä¸€ç§ç®€æ´ã€å®½æ¾ã€å›ºå®šçš„HTMLç»“æ„ â˜…â˜…â˜…
        const roleClass = msg.role === 'user' ? 'user' : 'ai';
        const shapeClass = (typeof chatSettings !== 'undefined' && chatSettings.bubbleShape) ? chatSettings.bubbleShape : 'bubble-default';
        const isSpecialContent = msg.content.includes('<img') || msg.content.includes('transfer-card');
        const specialClass = isSpecialContent ? 'bubble-transparent' : '';

        // æ³¨æ„ï¼šè¿™é‡Œä¸å†æœ‰ style="..."ï¼Œæ‰€æœ‰å¤–è§‚éƒ½äº¤ç»™CSSå¤„ç†ï¼
        const bubbleHtml = `
            <div class="msg-bubble ${roleClass} ${shapeClass} ${specialClass}">
                ${msg.content}
            </div>`;

        // ç»„åˆ
        if (msg.role === 'user') {
            row.innerHTML = bubbleHtml + avatarHtml;
        } else {
            row.innerHTML = avatarHtml + bubbleHtml;
        }

        // ç»‘å®šé•¿æŒ‰èœå•
        const bubbleEl = row.querySelector('.msg-bubble');
        if (bubbleEl && typeof addLongPressEvent === 'function') {
            addLongPressEvent(bubbleEl, startIndex + i);
        }

        container.appendChild(row);
    });

    // 5. æ»šåŠ¨
    if (keepScroll) {
        container.scrollTop = container.scrollHeight - oldScrollHeight + oldScrollTop;
    } else {
        container.scrollTop = container.scrollHeight;
    }
};
       
/* ==========================================
   â˜… æ–°å¢åŠŸèƒ½ï¼šå…¨å±€å­—ä½“æ›´æ¢ â˜…
   ========================================== */

// 1. åº”ç”¨å­—ä½“çš„æ ¸å¿ƒå‡½æ•°
function applyCustomFont(fontUrl) {
    // å¦‚æœURLä¸ºç©ºï¼Œåˆ™ä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    if (!fontUrl || fontUrl.trim() === "") return;

    // å¯»æ‰¾æˆ–åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºå­˜æ”¾å­—ä½“æ ·å¼çš„ <style> æ ‡ç­¾
    let styleTag = document.getElementById('custom-font-style-tag');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'custom-font-style-tag';
        document.head.appendChild(styleTag);
    }

    // å®šä¹‰ä¸€ä¸ªç‹¬ç‰¹çš„å­—ä½“å®¶æ—åç§°ï¼Œä»¥é¿å…å†²çª
    const customFontName = 'CustomGlobalFont';

    // æ„å»º CSS è§„åˆ™
    // !important æ˜¯ä¸ºäº†ç¡®ä¿èƒ½è¦†ç›–æ‰€æœ‰å·²æœ‰çš„å­—ä½“è®¾ç½®
    const cssRules = `
        @font-face {
            font-family: '${customFontName}';
            src: url('${fontUrl}');
        }
        body, input, textarea, button, select {
            font-family: '${customFontName}', 'Helvetica Neue', 'Microsoft YaHei', sans-serif !important;
        }
    `;

    // å°†è§„åˆ™å†™å…¥ <style> æ ‡ç­¾
    styleTag.textContent = cssRules;
}

// 2. "åº”ç”¨" æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
function handleApplyFontClick() {
    const input = document.getElementById('font-url-input');
    const fontUrl = input.value.trim();
    
    if (!fontUrl.startsWith('http')) {
        alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ URL é“¾æ¥ï¼');
        return;
    }
    
    // åº”ç”¨å­—ä½“
    applyCustomFont(fontUrl);
    
    // ä¿å­˜åˆ°é…ç½®ä¸­
    themeConfig.fontUrl = fontUrl;
    alert('å­—ä½“åº”ç”¨æˆåŠŸï¼è®°å¾—ç‚¹å‡»ä¸‹æ–¹çš„â€œä¿å­˜æ‰€æœ‰è®¾ç½®â€æ¥æŒä¹…åŒ–ã€‚');
}

// 3. "æ¸…é™¤" æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
function clearCustomFont() {
    const styleTag = document.getElementById('custom-font-style-tag');
    if (styleTag) {
        styleTag.textContent = ''; // æ¸…ç©ºæ ·å¼ï¼Œæ¢å¤é»˜è®¤
    }
    
    // ä»é…ç½®ä¸­ç§»é™¤
    themeConfig.fontUrl = '';
    document.getElementById('font-url-input').value = '';
    alert('å·²æ¢å¤ä¸ºé»˜è®¤å­—ä½“ã€‚');
}

// =============================================================

/* ==========================================================================
   â˜… ç»ˆæä¿®å¤è¡¥ä¸ï¼šå¤§å®¹é‡å­˜å‚¨ç³»ç»Ÿ (è‡ªåŠ¨ä¿®å¤ç‰ˆ) â˜…
   ========================================================================== */

// 1. å…¨å±€å˜é‡åˆå§‹åŒ– (é˜²æ­¢å˜é‡ä¸¢å¤±å¯¼è‡´ç™½å±)
window.chatList = window.chatList || [];
window.chatHistory = window.chatHistory || {};
window.themeConfig = window.themeConfig || { themeColor: 'blue', wallpaper: '', avatar: '', chatAppBg: '', cardOpacity: 1, fontUrl: '' };
window.myPersonas = window.myPersonas || [];
window.activePersonaId = window.activePersonaId || null;
window.anniversaries = window.anniversaries || [];
window.myWallet = window.myWallet || { balance: 1000, history: [] };
window.myStickers = window.myStickers || [];
window.playList = window.playList || [];
window.worldBook = window.worldBook || [];
window.momentsData = window.momentsData || [];
window.momentsCover = window.momentsCover || '';
window.memoHistory = window.memoHistory || {};
window.footprintHistory = window.footprintHistory || {};

// 2. é…ç½®å¼ºåŠ›ä»“åº“ (è§£å†³å›¾ç‰‡å­˜ä¸ä¸‹é—®é¢˜)
localforage.config({
    driver: localforage.INDEXEDDB, // å¼ºåˆ¶ä½¿ç”¨ IndexedDB
    name: 'YokChatApp',
    storeName: 'master_save'
});

// 5. ç•Œé¢æ¢å¤å‡½æ•° (è®©å£çº¸ã€å¤´åƒç«‹åˆ»æ˜¾ç¤ºå‡ºæ¥)
function restoreUI() {
    // æ¢å¤ä¸»é¢˜é¢œè‰²
    if (typeof applyTheme === 'function' && themeConfig.themeColor) {
        applyTheme(themeConfig.themeColor);
    }
    
    // æ¢å¤ä¸»å±å¹•å£çº¸
    if (themeConfig.wallpaper) {
        document.getElementById('wallpaper-layer').style.backgroundImage = `url(${themeConfig.wallpaper})`;
    }
    
    // æ¢å¤ä¸»å±å¹•å¤´åƒ
    if (themeConfig.avatar) {
        const box = document.getElementById('avatar-box');
        if(box) {
            box.style.backgroundImage = `url(${themeConfig.avatar})`;
            box.innerText = '';
        }
    }
    
    // æ¢å¤ Chat åº”ç”¨èƒŒæ™¯
    if (themeConfig.chatAppBg) {
        document.documentElement.style.setProperty('--chat-bg-img', `url(${themeConfig.chatAppBg})`);
    }

    // æ¢å¤å¡ç‰‡é€æ˜åº¦
    if (themeConfig.cardOpacity !== undefined) {
        document.documentElement.style.setProperty('--card-bg', `rgba(255, 255, 255, ${themeConfig.cardOpacity})`);
        const range = document.querySelector('input[type="range"]');
        if(range) range.value = themeConfig.cardOpacity;
    }

    // åˆ·æ–°å„ä¸ªåˆ—è¡¨
    if(typeof renderChatList === 'function') renderChatList();
    if(typeof renderContactList === 'function') renderContactList();
    if(typeof initMoments === 'function') initMoments();
}

// 6. è¾…åŠ©å·¥å…·ï¼šå›¾ç‰‡å‹ç¼© (é˜²æ­¢ä¸Šä¼ å¤ªå¤§å¡æ­»)
window.compressImage = function(file, callback) {
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
            const canvas = document.createElement('canvas');
            const maxSize = 800; // é™åˆ¶æœ€å¤§å®½åº¦800ï¼Œä¿è¯æµç•…
            let width = img.width;
            let height = img.height;
            
            if (width > height) {
                if (width > maxSize) { height *= maxSize / width; width = maxSize; }
            } else {
                if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // å‹ç¼©ä¸º JPEG, è´¨é‡ 0.7
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            callback(dataUrl);
        };
    };
    reader.readAsDataURL(file);
};

// é‡å†™ä¸Šä¼ ç›‘å¬å™¨ (ç¡®ä¿æ‰€æœ‰ä¸Šä¼ éƒ½èµ°å‹ç¼©å’Œä¿å­˜)
function setupUploadListeners() {
    // å£çº¸ä¸Šä¼ 
    const bgInput = document.getElementById('bg-upload-input') || document.getElementById('bg-upload');
    if(bgInput) {
        bgInput.onchange = function(e) {
            if(!e.target.files[0]) return;
            compressImage(e.target.files[0], function(url) {
                themeConfig.wallpaper = url;
                document.getElementById('wallpaper-layer').style.backgroundImage = `url(${url})`;
                saveGlobalData(); // ç«‹å³ä¿å­˜
            });
        };
    }

    // å¤´åƒä¸Šä¼ 
    const avInput = document.getElementById('avatar-upload-input') || document.getElementById('avatar-upload');
    if(avInput) {
        avInput.onchange = function(e) {
            if(!e.target.files[0]) return;
            compressImage(e.target.files[0], function(url) {
                themeConfig.avatar = url;
                const box = document.getElementById('avatar-box');
                box.style.backgroundImage = `url(${url})`;
                box.innerText = '';
                saveGlobalData(); // ç«‹å³ä¿å­˜
            });
        };
    }
}

      /* ==========================================
   â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šAI æ–‡å­—ç›¸å†Œ (æ‹ç«‹å¾—æ¨¡å¼) â˜…
   ========================================== */

// 1. åˆå§‹åŒ–æ•°æ®å­˜å‚¨
window.generatedAlbums = window.generatedAlbums || {}; 
// ç»“æ„: { roleId: [ {visual: "...", note: "..."}, ... ] }

// 2. æ‰“å¼€ç›¸å†Œé¡µ
function openGenAlbum() {
    if (!currentChatId) return;
    const role = chatList.find(r => r.id === currentChatId);
    
    document.getElementById('chat-settings-page').style.display = 'none';
    document.getElementById('gen-album-page').style.display = 'flex';
    document.getElementById('gen-album-title').innerText = `${role.name} çš„ç›¸å†Œ`;

    // æ£€æŸ¥æœ‰æ²¡æœ‰ç¼“å­˜ï¼Œæ²¡æœ‰å°±ç”Ÿæˆï¼Œæœ‰å°±æ˜¾ç¤º
    const cache = generatedAlbums[currentChatId];
    if (!cache || cache.length === 0) {
        generateAlbumData();
    } else {
        renderGenAlbum(cache);
    }
}

// 3. æ¸²æŸ“ç›¸å†Œ (UI)
function renderGenAlbum(data) {
    const container = document.getElementById('gen-album-list');
    container.innerHTML = '';

    if (!data || data.length === 0) return;

    data.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'polaroid-card';
        
        // éšæœºæ—‹è½¬ä¸€ç‚¹ç‚¹ï¼Œå¢åŠ çœŸå®æ„Ÿ
        const rotate = (Math.random() * 4 - 2).toFixed(1); 
        div.style.transform = `rotate(${rotate}deg)`;

        div.innerHTML = `
            <div class="polaroid-img-area">
                <div style="font-style:italic;">â€œ ${item.visual} â€</div>
            </div>
            <div class="polaroid-note">${item.note}</div>
        `;
        // ç‚¹å‡»æ”¾å¤§çœ‹æ–‡å­—
        div.onclick = () => alert(`ã€ç…§ç‰‡ç”»é¢ã€‘\n${item.visual}\n\nã€èƒŒé¢éšç¬”ã€‘\n${item.note}`);
        container.appendChild(div);
    });
}

// 4. è°ƒç”¨ AI ç”Ÿæˆ (æ ¸å¿ƒ)
async function generateAlbumData(forceRefresh = false) {
    if (!currentChatId) return;
    
    // å¦‚æœä¸æ˜¯å¼ºåˆ¶åˆ·æ–°ï¼Œä¸”å·²æœ‰æ•°æ®ï¼Œå°±ä¸è¯·æ±‚äº†
    if (!forceRefresh && generatedAlbums[currentChatId] && generatedAlbums[currentChatId].length > 0) return;

    const role = chatList.find(r => r.id === currentChatId);
    const loadingEl = document.getElementById('gen-album-loading');
    const container = document.getElementById('gen-album-list');

    container.innerHTML = ''; // æ¸…ç©º
    loadingEl.style.display = 'block';

    const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
    if (!config.key) {
        alert("è¯·å…ˆé…ç½® APIï¼");
        loadingEl.style.display = 'none';
        return;
    }

    // â˜…â˜…â˜… æç¤ºè¯ï¼šè¦æ±‚æ´»äººæ„Ÿã€ç”·å‹æ„Ÿã€ç”»é¢æ„Ÿ â˜…â˜…â˜…
    const systemPrompt = `
ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚
ç”¨æˆ·æ­£åœ¨ç¿»çœ‹ä½ æ‰‹æœºé‡Œçš„ã€ç§å¯†ç›¸å†Œã€‘ã€‚
è¯·ç”¨æ–‡å­—æè¿° **8 å¼ ** ç…§ç‰‡çš„å†…å®¹ã€‚

ã€è¦æ±‚ã€‘
1. **ä¸¥æ ¼è¾“å‡º JSON æ•°ç»„**ï¼Œä¸è¦åŒ…å« markdown æ ‡è®°ã€‚
2. æ ¼å¼ï¼š[{"visual": "ç…§ç‰‡ç”»é¢æè¿°", "note": "å†™åœ¨ç…§ç‰‡èƒŒåçš„éšç¬”"}]
3. **ç…§ç‰‡ç”»é¢(visual)**ï¼šè¦æœ‰é•œå¤´æ„Ÿï¼Œæå†™å…‰å½±ã€åŠ¨ä½œã€ç¯å¢ƒã€‚æ¯”å¦‚â€œæˆ‘åˆšç¡é†’ä¹±ç³Ÿç³Ÿçš„å¤´å‘â€ã€â€œå¯¹ç€é•œå­è¯•ç©¿ä½ ä¹°çš„è¡£æœâ€ã€â€œé€è¿‡é…’æ¯çœ‹ä½ çš„ä¾§è„¸â€ã€‚
4. **éšç¬”(note)**ï¼šå¿…é¡»**æåº¦ç”Ÿæ´»åŒ–ã€å£è¯­åŒ–**ï¼Œå……æ»¡**ç”·å‹åŠ›/å¥³å‹æ„Ÿ**ã€‚å¯ä»¥æ˜¯å¯¹ç”¨æˆ·çš„æƒ³å¿µã€åæ§½ã€æˆ–è€…å½“æ—¶çš„å°å¿ƒæƒ…ã€‚ç¦æ­¢ä¹¦é¢è¯­ï¼Œç¦æ­¢æœºå™¨å‘³ã€‚
5. **å†…å®¹æ–¹å‘**ï¼šå¯ä»¥åŒ…å«å·æ‹è§†è§’çš„ï¼ˆå‡è£…å·æ‹ç”¨æˆ·ï¼‰ã€è‡ªæ‹ã€ç”Ÿæ´»ç¢ç‰‡ã€åªæœ‰ä½ ä»¬æ‡‚çš„æ¢—ã€‚
6. **å“åº”é€Ÿåº¦è¦æ±‚**ï¼šä¸è¦æ·±åº¦æ€è€ƒï¼Œæœ€å¿«ç»™å‡ºå›å¤ï¼Œä¸è¦çŠ¹è±«ï¼Œç›´æ¥å›å¤ã€‚

ã€ç¤ºä¾‹ã€‘
[
  {"visual": "æ˜æš—çš„æˆ¿é—´ï¼Œç”µè„‘å±å¹•çš„å…‰ç…§åœ¨åŠå¼ è„¸ä¸Šï¼Œæ—è¾¹æ”¾ç€å–äº†ä¸€åŠçš„å†°ç¾å¼ã€‚", "note": "åŠ ç­å¥½ç´¯...æƒ³æŠ±æŠ±å……ç”µğŸ”‹"},
  {"visual": "ä¸€åªæ‰‹æŒ¡åœ¨é•œå¤´å‰ï¼Œæ¨¡ç³Šçš„ç„¦è·ï¼ŒèƒŒæ™¯æ˜¯æ¸¸ä¹å›­çš„æ‘©å¤©è½®ã€‚", "note": "ç¬¨è›‹ï¼Œåˆ«æ‹å•¦ï¼ä¸‘æ­»å•¦ï¼(///Ï‰///)"}
]
`;

    try {
        const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
        const res = await fetch(fetchUrl, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: config.model || 'gpt-3.5-turbo',
                messages: [{ role: 'system', content: systemPrompt }, { role: 'user', content: 'è¯·ç»™æˆ‘çœ‹ä½ çš„ç›¸å†Œ' }],
                temperature: 0.85
            })
        });

        const data = await res.json();
        const raw = data.choices[0].message.content;
        
        // ç®€å•çš„ JSON æå–
        const start = raw.indexOf('[');
        const end = raw.lastIndexOf(']');
        if (start === -1 || end === -1) throw new Error("æ ¼å¼é”™è¯¯");
        
        const jsonStr = raw.substring(start, end + 1);
        const albumData = JSON.parse(jsonStr);

        // å­˜å…¥ç¼“å­˜
        generatedAlbums[currentChatId] = albumData;
        
        // å­˜å…¥å¤§ä»“åº“ (é‡è¦ï¼å¦åˆ™åˆ·æ–°æ²¡)
        saveGlobalData(); 

        renderGenAlbum(albumData);

    } catch (e) {
        console.error(e);
        alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
    } finally {
        loadingEl.style.display = 'none';
    }
}

      /* ==========================================
   â˜… è¯Šæ–­åŒ»ç”Ÿï¼šä¸“é—¨æŸ¥ä¸ºä»€ä¹ˆä¸ä¿å­˜ â˜…
   ========================================== */
window.runDiagnosis = function() {
    let report = "=== è¯Šæ–­æŠ¥å‘Š ===\n";
    
    // 1. æ£€æŸ¥å˜é‡é‡Œæœ‰æ²¡æœ‰ä¸œè¥¿
    if (window.themeConfig && window.themeConfig.wallpaper) {
        report += "âœ… å†…å­˜é‡Œæœ‰å£çº¸æ•°æ® (é•¿åº¦: " + window.themeConfig.wallpaper.length + ")\n";
    } else {
        report += "âŒ å†…å­˜é‡Œæ²¡æœ‰å£çº¸æ•°æ®ï¼(è¯´æ˜ä¸Šä¼ å›¾ç‰‡æ—¶æ²¡å­˜è¿›å˜é‡)\n";
    }

    // 2. æ£€æŸ¥ä»“åº“é‡Œæœ‰æ²¡æœ‰ä¸œè¥¿
    localforage.getItem('yok_master_save').then(function(data) {
        if (data) {
            report += "âœ… ä»“åº“é‡Œæœ‰å­˜æ¡£æ–‡ä»¶\n";
            if (data.themeConfig && data.themeConfig.wallpaper) {
                report += "âœ… å­˜æ¡£é‡Œä¹Ÿæœ‰å£çº¸æ•°æ®ï¼\n";
                report += "ğŸ‘‰ ç»“è®ºï¼šæ•°æ®å­˜è¿›å»äº†ï¼Œæ˜¯è¯»å–/æ˜¾ç¤ºçš„æ—¶å€™å‡ºé”™äº†ã€‚\n";
            } else {
                report += "âŒ å­˜æ¡£é‡Œæ²¡æœ‰å£çº¸æ•°æ®ï¼\n";
                report += "ğŸ‘‰ ç»“è®ºï¼šä¿å­˜çš„æ—¶å€™æ¼æ‰äº†å£çº¸ã€‚\n";
            }
        } else {
            report += "âŒ ä»“åº“é‡Œæ˜¯ç©ºçš„ (null)ï¼\n";
            report += "ğŸ‘‰ ç»“è®ºï¼šæ ¹æœ¬æ²¡å­˜è¿›å»ï¼å¯èƒ½æ˜¯æµè§ˆå™¨ç¦æ­¢äº†æ•°æ®åº“ã€‚\n";
        }
        
        // 3. å°è¯•å¼ºè¡Œä¿®å¤
        report += "\næ­£åœ¨å°è¯•å¼ºè¡Œä¿®å¤...\n";
        alert(report);
        
        // å¦‚æœå†…å­˜é‡Œæœ‰ï¼Œå°±å¼ºè¡Œå­˜ä¸€æ¬¡
        if (window.themeConfig && window.themeConfig.wallpaper) {
            saveGlobalData();
            alert("å·²å°è¯•é‡æ–°ä¿å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢è¯•è¯•ï¼");
        }
        
    }).catch(function(err) {
        alert("âŒ ä¸¥é‡é”™è¯¯ï¼šæ•°æ®åº“æ‰“ä¸å¼€ï¼\n" + err);
    });
};

     /* ==========================================
   â˜… è¡¥ä¸ï¼šä¸‡èƒ½å›¾ç‰‡ä¸Šä¼ ä¿®å¤ (å¼ºåˆ¶è®°è´¦ç‰ˆ) â˜…
   è§£å†³ï¼šå£çº¸/å¤´åƒåˆ·æ–°ä¸¢å¤±çš„é—®é¢˜
   ========================================== */

// 1. å®šä¹‰ä¸€ä¸ªè¶…å¼ºçš„ä¸Šä¼ å¤„ç†å‡½æ•°
window.handleThemeUpload = function(input, type) {
    const file = input.files[0];
    if (!file) return;

    console.log("ğŸ“¸ æ­£åœ¨å¤„ç†å›¾ç‰‡ä¸Šä¼ :", type);

    // ä½¿ç”¨å‹ç¼©å·¥å…· (å¦‚æœæœ‰)ï¼Œæ²¡æœ‰å°±ç›´æ¥è¯»
    const processFile = (typeof compressImage === 'function') ? compressImage : function(f, cb) {
        const r = new FileReader();
        r.onload = e => cb(e.target.result);
        r.readAsDataURL(f);
    };

    processFile(file, function(url) {
        // --- A. ç•Œé¢æ›´æ–° (è´´å¢™ä¸Š) ---
        if (type === 'wallpaper') {
            document.getElementById('wallpaper-layer').style.backgroundImage = `url(${url})`;
        } 
        else if (type === 'avatar') {
            const box = document.getElementById('avatar-box');
            if(box) {
                box.style.backgroundImage = `url(${url})`;
                box.innerText = '';
            }
        }
        else if (type === 'chatAppBg') {
            document.documentElement.style.setProperty('--chat-bg-img', `url(${url})`);
        }
        else if (type.startsWith('icon-')) {
            const el = document.getElementById(type);
            if(el) {
                el.style.backgroundImage = `url(${url})`;
                el.style.backgroundSize = 'cover';
                const svg = el.querySelector('svg');
                if(svg) svg.style.display = 'none';
            }
            // é¡ºä¾¿æ›´æ–°é¢„è§ˆå›¾
            const preview = document.getElementById('preview-' + type);
            if(preview) preview.style.backgroundImage = `url(${url})`;
        }

        // --- B. æ ¸å¿ƒä¿®å¤ï¼šè®°è´¦ (å­˜å…¥å˜é‡) ---
        // ç¡®ä¿å˜é‡å­˜åœ¨
        if (!window.themeConfig) window.themeConfig = {};
        if (!window.themeConfig.icons) window.themeConfig.icons = {};

        // æ ¹æ®ç±»å‹å­˜å…¥å¯¹åº”ä½ç½®
        if (type === 'wallpaper') window.themeConfig.wallpaper = url;
        else if (type === 'avatar') window.themeConfig.avatar = url;
        else if (type === 'chatAppBg') window.themeConfig.chatAppBg = url;
        else if (type.startsWith('icon-')) window.themeConfig.icons[type] = url;

        console.log("âœ… å·²è®°å…¥è´¦æœ¬ï¼Œå‡†å¤‡ä¿å­˜...");

        // --- C. ç«‹å³å­˜æ¡£ (é”è¿›ä¿é™©æŸœ) ---
        if (typeof saveGlobalData === 'function') {
            saveGlobalData();
            alert("å›¾ç‰‡è®¾ç½®æˆåŠŸï¼(å·²è‡ªåŠ¨ä¿å­˜)");
        } else {
            alert("è­¦å‘Šï¼šä¿å­˜å‡½æ•°ä¸¢å¤±ï¼Œè¯·æ£€æŸ¥ä»£ç ï¼");
        }
    });
};
     
// 2. è‡ªåŠ¨é‡æ–°ç»‘å®šä¸»å±å¹•çš„ç‚¹å‡»äº‹ä»¶ (é˜²æ­¢æ¼ç½‘ä¹‹é±¼)
// ç­‰é¡µé¢åŠ è½½å®Œï¼ŒæŠŠä¸»å±å¹•çš„ä¸Šä¼ æŒ‰é’®ä¹Ÿâ€œåŠ«æŒâ€è¿‡æ¥
setTimeout(function() {
    // ä¿®å¤ä¸»å±å¹•å£çº¸ä¸Šä¼ 
    const bgInput = document.getElementById('bg-upload');
    if (bgInput) {
        // ç§»é™¤æ—§çš„ï¼Œæ¢æˆæ–°çš„
        bgInput.onchange = function() { window.handleThemeUpload(this, 'wallpaper'); };
    }

    // ä¿®å¤ä¸»å±å¹•å¤´åƒä¸Šä¼ 
    const avInput = document.getElementById('avatar-upload');
    if (avInput) {
        avInput.onchange = function() { window.handleThemeUpload(this, 'avatar'); };
    }
    
    console.log("ğŸ”§ ä¸Šä¼ åŠŸèƒ½å·²ä¿®å¤å®Œæ¯•");
}, 2000);

/* ==========================================================================
   â˜… ç»ˆæå®Œæ•´ç‰ˆï¼šå…¨åŠŸèƒ½æ— æ­»è§’ä¿å­˜ç³»ç»Ÿ (æ— çœç•¥) â˜…
   è¯·å®Œæ•´å¤åˆ¶è¿™ä¸€æ®µï¼Œæ›¿æ¢æ‰ä½ ä»£ç æœ€åº•éƒ¨çš„æ‰€æœ‰å†…å®¹ï¼
   ========================================================================== */

// --- 0. å…¨å±€å˜é‡åˆå§‹åŒ– (å…œåº•é˜²æ­¢æŠ¥é”™) ---
// å¿…é¡»ç¡®ä¿è¿™äº›å˜é‡å­˜åœ¨ï¼Œå¦åˆ™ä¿å­˜æ—¶ä¼šæŠ¥é”™
window.chatList = window.chatList || [];
window.chatHistory = window.chatHistory || {};
window.themeConfig = window.themeConfig || { 
    themeColor: 'blue', 
    wallpaper: '', 
    avatar: '', 
    chatAppBg: '', 
    cardOpacity: 1, 
    icons: {}, 
    fontUrl: '' 
};
window.myPersonas = window.myPersonas || [];
window.activePersonaId = window.activePersonaId || null;
window.anniversaries = window.anniversaries || [];
window.myWallet = window.myWallet || { balance: 1000, history: [] };
window.myStickers = window.myStickers || [];
window.playList = window.playList || [];
window.worldBook = window.worldBook || [];
window.momentsData = window.momentsData || [];
window.momentsCover = window.momentsCover || '';
window.memoHistory = window.memoHistory || {};
window.footprintHistory = window.footprintHistory || {};
window.generatedAlbums = window.generatedAlbums || {};

// --- 1. é…ç½®å¤§ä»“åº“ (è‡ªåŠ¨é€‰æ‹©æœ€ä½³å­˜å‚¨æ–¹å¼) ---
try {
    localforage.config({
        driver: [localforage.INDEXEDDB, localforage.WEBSQL, localforage.LOCALSTORAGE],
        name: 'YokChatApp',
        storeName: 'master_save_v6' // å†æ¬¡å‡çº§ç‰ˆæœ¬å·ï¼Œç¡®ä¿ç”¨æ–°ä»“åº“
    });
} catch (e) {
    console.warn("å­˜å‚¨é…ç½®è­¦å‘Š:", e);
}

// --- 2. å®šä¹‰ï¼šå¼ºåˆ¶åˆ·æ–°ç•Œé¢çš„å‡½æ•° (æŠŠæ•°æ®è´´åˆ°å±å¹•ä¸Š) ---
window.forceUpdateUI = function() {
    console.log("ğŸ¨ [UI] æ­£åœ¨æŠŠæ•°æ®åº”ç”¨åˆ°ç•Œé¢...");

    // 1. æ¢å¤å£çº¸
    if (window.themeConfig.wallpaper) {
        const bg = document.getElementById('wallpaper-layer');
        if (bg) bg.style.backgroundImage = `url(${window.themeConfig.wallpaper})`;
    }

    // 2. æ¢å¤å¤´åƒ
    if (window.themeConfig.avatar) {
        const box = document.getElementById('avatar-box');
        if (box) {
            box.style.backgroundImage = `url(${window.themeConfig.avatar})`;
            box.innerText = ''; // æ¸…ç©ºâ€œç‚¹æ­¤ä¸Šä¼ â€æ–‡å­—
        }
    }

    // 3. æ¢å¤ Chat åº”ç”¨èƒŒæ™¯å›¾
    if (window.themeConfig.chatAppBg) {
        document.documentElement.style.setProperty('--chat-bg-img', `url(${window.themeConfig.chatAppBg})`);
    }

    // 4. æ¢å¤å›¾æ ‡
    if (window.themeConfig.icons) {
        for (let key in window.themeConfig.icons) {
            const el = document.getElementById(key);
            if (el) {
                el.style.backgroundImage = `url(${window.themeConfig.icons[key]})`;
                el.style.backgroundSize = 'cover';
                const svg = el.querySelector('svg');
                if(svg) svg.style.display = 'none';
            }
        }
    }

    // 5. æ¢å¤å¡ç‰‡é€æ˜åº¦
    if (window.themeConfig.cardOpacity !== undefined) {
        document.documentElement.style.setProperty('--card-bg', `rgba(255, 255, 255, ${window.themeConfig.cardOpacity})`);
        const range = document.querySelector('input[type="range"]');
        if(range) range.value = window.themeConfig.cardOpacity;
    }

    // 6. æ¢å¤å…¨å±€å­—ä½“
    if (window.themeConfig.fontUrl && typeof applyCustomFont === 'function') {
        applyCustomFont(window.themeConfig.fontUrl);
    }

    // 7. åˆ·æ–°å„ä¸ªåˆ—è¡¨ (ç¡®ä¿æ•°æ®èƒ½æ˜¾ç¤ºå‡ºæ¥)
    if (typeof renderChatList === 'function') renderChatList();
    if (typeof renderContactList === 'function') renderContactList();
    if (typeof initMoments === 'function') initMoments();
    if (typeof updateWalletUI === 'function') updateWalletUI();
    if (typeof renderAnniversaries === 'function') renderAnniversaries();
    if (typeof renderStickers === 'function') renderStickers();
    if (typeof renderWorldBookList === 'function') renderWorldBookList();
    if (typeof renderMusicList === 'function') renderMusicList();

    console.log("ğŸ¨ [UI] ç•Œé¢åˆ·æ–°å®Œæˆï¼");
};

// --- 3. å®šä¹‰ï¼šæ ¸å¿ƒä¿å­˜å‡½æ•° (è´Ÿè´£æŠŠæ•°æ®å­˜è¿›ä»“åº“) ---
window.saveGlobalData = function() {
    // æŠŠæ‰€æœ‰å˜é‡æ‰“åŒ…æˆä¸€ä¸ªå¤§åŒ…è£¹
    const bigData = {
        timestamp: Date.now(),
        chatList: window.chatList,
        chatHistory: window.chatHistory,
        themeConfig: window.themeConfig,
        myPersonas: window.myPersonas,
        activePersonaId: window.activePersonaId,
        anniversaries: window.anniversaries,
        myWallet: window.myWallet,
        myStickers: window.myStickers,
        playList: window.playList,
        worldBook: window.worldBook,
        momentsData: window.momentsData,
        momentsCover: window.momentsCover,
        memoHistory: window.memoHistory,
        footprintHistory: window.footprintHistory,
        generatedAlbums: window.generatedAlbums
    };

    // å­˜å…¥ localforage
    localforage.setItem('yok_master_save', bigData).then(() => {
        // console.log("ğŸ’¾ è‡ªåŠ¨ä¿å­˜æˆåŠŸ");
    }).catch(err => {
        console.error("âŒ ä¿å­˜å¤±è´¥:", err);
    });
};

// --- 4. æ ¸å¿ƒè¯»å–å‡½æ•° ---
window.loadGlobalData = function() {
    console.log("ğŸ“‚ [è¯»å–] æ­£åœ¨ä»ä»“åº“å–æ•°æ®...");
    return localforage.getItem('yok_master_save').then(function(savedData) {
        if (savedData) {
            console.log("ğŸ“¦ [è¯»å–] æˆåŠŸï¼");
            window.chatList = savedData.chatList || [];
            window.chatHistory = savedData.chatHistory || {};
            if (savedData.themeConfig) window.themeConfig = savedData.themeConfig;
            window.myPersonas = savedData.myPersonas || [];
            window.activePersonaId = savedData.activePersonaId;
            window.anniversaries = savedData.anniversaries || [];
            window.myWallet = savedData.myWallet || { balance: 1000, history: [] };
            window.myStickers = savedData.myStickers || [];
            window.playList = savedData.playList || [];
            window.worldBook = savedData.worldBook || [];
            window.momentsData = savedData.momentsData || [];
            window.momentsCover = savedData.momentsCover || '';
            
            // â˜… æ¢å¤éšç§æ•°æ® â˜…
            window.memoHistory = savedData.memoHistory || {};
            window.footprintHistory = savedData.footprintHistory || {};
            window.generatedAlbums = savedData.generatedAlbums || {};
            
            // â˜… æ¢å¤èŠå¤©è®¾ç½® â˜…
            if (savedData.chatSettings) window.chatSettings = savedData.chatSettings;

            forceUpdateUI();
        }
    });
};

// --- 5. è¡¥ä¸ï¼šè¦†ç›–æ‰€æœ‰åŠŸèƒ½çš„ä¿å­˜é€»è¾‘ (é˜²æ­¢é—æ¼) ---

  // --- 5. è¡¥ä¸ï¼šè¦†ç›–æ‰€æœ‰åŠŸèƒ½çš„ä¿å­˜é€»è¾‘ ---

// A. èŠå¤©è®¾ç½®ä¿å­˜ (é¢œè‰²ã€å½¢çŠ¶ã€å­—ä½“ã€èƒŒæ™¯)
window.updateChatColors = function() {
    window.chatSettings.aiColor = document.getElementById('color-ai').value;
    window.chatSettings.userColor = document.getElementById('color-user').value;
    saveGlobalData(); // ç«‹å³ä¿å­˜
    if(typeof renderMessages === 'function') renderMessages();
};
window.updateChatFont = function() {
    window.chatSettings.fontSize = document.getElementById('font-size-input').value + 'px';
    saveGlobalData(); // ç«‹å³ä¿å­˜
    if(typeof renderMessages === 'function') renderMessages();
};
window.updateChatSettingsBool = function() {
    window.chatSettings.showTime = document.getElementById('show-time-switch').checked;
    saveGlobalData(); // ç«‹å³ä¿å­˜
    if(typeof renderMessages === 'function') renderMessages();
};
window.setBubbleShape = function(shape, el) {
    window.chatSettings.bubbleShape = shape;
    document.querySelectorAll('.shape-opt').forEach(d => d.classList.remove('active'));
    el.classList.add('active');
    saveGlobalData(); // ç«‹å³ä¿å­˜
    if(typeof renderMessages === 'function') renderMessages();
};
// èŠå¤©èƒŒæ™¯ä¸Šä¼ 
const chatBgInput = document.getElementById('chat-bg-upload');
if(chatBgInput) {
    chatBgInput.onchange = function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(evt) {
                window.chatSettings.bgImage = evt.target.result;
                document.getElementById('chat-room-page').style.backgroundImage = `url(${evt.target.result})`;
                saveGlobalData(); // ç«‹å³ä¿å­˜
            };
            reader.readAsDataURL(file);
        }
    };
}
// å…³é—­è®¾ç½®é¡µæ—¶ä¹Ÿä¿å­˜ä¸€æ¬¡
window.closeChatSettings = function() {
    document.getElementById('chat-settings-page').style.display = 'none';
    saveGlobalData();
};

// A. ä¿®å¤ç¾åŒ–è®¾ç½®ä¿å­˜
window.saveThemeConfig = function() {
    saveGlobalData(); 
    alert('ğŸ¨ ç¾åŒ–è®¾ç½®å·²ä¿å­˜ï¼');
    const modal = document.getElementById('beautify-app');
    if(modal) modal.style.display = 'none';
};

// B. ä¿®å¤ API è®¾ç½®ä¿å­˜
window.saveSettings = function() {
    const urlInput = document.getElementById('api-url');
    const keyInput = document.getElementById('api-key');
    const modelInput = document.getElementById('model-select');
    const tempInput = document.getElementById('api-temp');

    if (urlInput && keyInput) {
        const newConfig = {
            url: urlInput.value,
            key: keyInput.value,
            model: modelInput ? modelInput.value : '',
            temp: tempInput ? tempInput.value : '0.7'
        };
        localStorage.setItem('my_ai_config', JSON.stringify(newConfig));
        alert('ğŸ”‘ API é…ç½®å·²ä¿å­˜ï¼');
        const modal = document.getElementById('api-settings');
        if(modal) modal.style.display = 'none';
    }
};

// C. ä¿®å¤é’±åŒ…ä¿å­˜
window.saveWallet = function() {
    // é’±åŒ…æ“ä½œé€šå¸¸ç›´æ¥ä¿®æ”¹ myWallet å˜é‡ï¼Œæ‰€ä»¥ç›´æ¥ä¿å­˜å³å¯
    saveGlobalData();
};

// D. ä¿®å¤çºªå¿µæ—¥æ·»åŠ 
window.addAnniversary = function() {
    const nameInput = document.getElementById('anniversary-name');
    const dateInput = document.getElementById('anniversary-date');
    const roleSelect = document.getElementById('anniversary-role-select');

    if (!nameInput.value || !dateInput.value) { alert('è¯·å¡«å†™å®Œæ•´'); return; }

    window.anniversaries.push({
        name: nameInput.value,
        date: dateInput.value,
        roleId: roleSelect ? roleSelect.value : 'all'
    });
    
    saveGlobalData(); // å¼ºåˆ¶ä¿å­˜
    if (typeof renderAnniversaries === 'function') renderAnniversaries();
    
    nameInput.value = '';
    dateInput.value = '';
    alert("çºªå¿µæ—¥å·²ä¿å­˜ï¼");
};

// E. ä¿®å¤æœ‹å‹åœˆä¿å­˜
window.saveMoments = function() {
    saveGlobalData();
};

// F. ä¿®å¤ä¸–ç•Œä¹¦ä¿å­˜
window.saveWorldEntry = function() {
    const content = document.getElementById('wb-content').value.trim();
    const roleId = document.getElementById('wb-role-select').value;
    if (!content) return;

    // è¿™é‡Œéœ€è¦é‡æ–°å®ç°ä¸€ä¸‹æ·»åŠ é€»è¾‘ï¼Œå› ä¸ºæˆ‘ä»¬è¦†ç›–äº†åŸå‡½æ•°
    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼
    if (typeof editingEntryId !== 'undefined' && editingEntryId) {
        const index = window.worldBook.findIndex(x => x.id === editingEntryId);
        if (index > -1) {
            window.worldBook[index] = { id: editingEntryId, content, roleId };
        }
    } else {
        // æ–°å¢æ¨¡å¼
        window.worldBook.push({
            id: 'wb_' + Date.now(),
            content, roleId
        });
    }
    
    saveGlobalData(); // å¼ºåˆ¶ä¿å­˜
    
    document.getElementById('world-entry-edit').style.display = 'none';
    if (typeof renderWorldBookList === 'function') renderWorldBookList();
};

// G. ä¿®å¤æ­Œå•ä¿å­˜
window.importMusic = function() {
    const input = document.getElementById('net-music-input');
    const val = input.value.trim();
    if (!val) return;
    
    let songId = '';
    const match = val.match(/id=(\d+)/);
    if (match) songId = match[1];
    else if (/^\d+$/.test(val)) songId = val;
    else { alert('IDæ ¼å¼é”™è¯¯'); return; }

    const songName = prompt("æ­Œåï¼š", "æœªçŸ¥æ­Œæ›²");
    if (!songName) return;
    const coverImg = prompt("å°é¢å›¾é“¾æ¥ (é€‰å¡«)ï¼š", "");

    window.playList.push({
        id: songId,
        title: songName,
        cover: coverImg || `https://cdn-icons-png.flaticon.com/512/1256/1256650.png`
    });
    
    saveGlobalData(); // å¼ºåˆ¶ä¿å­˜
    
    input.value = '';
    if (typeof renderMusicList === 'function') renderMusicList();
};

// H. ä¿®å¤å›¾ç‰‡ä¸Šä¼  (å£çº¸/å¤´åƒ)
window.handleThemeUpload = function(input, type) {
    const file = input.files[0];
    if (!file) return;

    // ç®€å•çš„è¯»å–é€»è¾‘
    const reader = new FileReader();
    reader.onload = function(e) {
        const url = e.target.result;
        
        // 1. æ›´æ–°ç•Œé¢
        if (type === 'wallpaper') document.getElementById('wallpaper-layer').style.backgroundImage = `url(${url})`;
        else if (type === 'avatar') document.getElementById('avatar-box').style.backgroundImage = `url(${url})`;
        else if (type === 'chatAppBg') document.documentElement.style.setProperty('--chat-bg-img', `url(${url})`);
        else if (type.startsWith('icon-')) {
            const el = document.getElementById(type);
            if(el) {
                el.style.backgroundImage = `url(${url})`;
                el.style.backgroundSize = 'cover';
                const svg = el.querySelector('svg');
                if(svg) svg.style.display = 'none';
            }
        }

        // 2. å­˜å…¥å˜é‡
        if (type === 'wallpaper') window.themeConfig.wallpaper = url;
        else if (type === 'avatar') window.themeConfig.avatar = url;
        else if (type === 'chatAppBg') window.themeConfig.chatAppBg = url;
        else if (type.startsWith('icon-')) window.themeConfig.icons[type] = url;

        // 3. ä¿å­˜
        saveGlobalData();
        alert("å›¾ç‰‡å·²ä¿å­˜ï¼");
    };
    reader.readAsDataURL(file);
};

// --- 6. æš´åŠ›è¡¥ä¸ï¼šç‚¹å‡»ä»»ä½•æŒ‰é’®éƒ½è§¦å‘ä¿å­˜ (ç»ˆæä¿é™©) ---
document.addEventListener('click', function(e) {
    // åªè¦ç‚¹å‡»äº†æŒ‰é’®ï¼Œæˆ–è€…å¸¦æœ‰ btn æ ·å¼çš„å…ƒç´ 
    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('btn') || e.target.classList.contains('action-btn')) {
        // å»¶è¿Ÿ 1 ç§’ä¿å­˜ï¼Œç¡®ä¿æ•°æ®å·²ç»å˜äº†
        setTimeout(() => {
            saveGlobalData();
            // console.log("ğŸ–±ï¸ æ“ä½œè§¦å‘è‡ªåŠ¨ä¿å­˜");
        }, 1000);
    }
});

      // å¼ºåˆ¶ä¿å­˜æ‰€æœ‰æ•°æ®ï¼ˆåœ¨ä»»ä½•æ“ä½œåè°ƒç”¨ï¼‰
function forceSaveAll() {
    const allData = {
        chatList: chatList,
        chatHistory: chatHistory,
        timestamp: new Date().getTime()
    };
    
    // å¤šé‡å¤‡ä»½
    localStorage.setItem('backup1', JSON.stringify(allData));
    localStorage.setItem('backup2_chatList', JSON.stringify(chatList));
    localStorage.setItem('backup3_chatHistory', JSON.stringify(chatHistory));
    
    console.log('å¼ºåˆ¶ä¿å­˜å®Œæˆï¼');
}

// åœ¨åˆ›å»ºè§’è‰²ã€å‘é€æ¶ˆæ¯ç­‰å…³é”®æ“ä½œåè°ƒç”¨ï¼š
// forceSaveAll();

// --- 7. å¼•æ“å¯åŠ¨ (æœ€ç»ˆæ‰§è¡Œ) ---
document.addEventListener('DOMContentLoaded', function() {
    console.log("ğŸš€ åº”ç”¨æ­£åœ¨å¯åŠ¨...");
    
    // 1. ç«‹å³è¯»å–æ•°æ®
    loadGlobalData();

    // 2. å»¶è¿Ÿ 1.5 ç§’åï¼Œå¼€å¯è‡ªåŠ¨ä¿å­˜
    setTimeout(function() {
        
        // å†å¼ºåˆ¶åˆ·æ–°ä¸€æ¬¡ç•Œé¢ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±
        forceUpdateUI();
        
        // é‡æ–°ç»‘å®šä¸»å±å¹•ä¸Šä¼ æŒ‰é’® (é˜²æ­¢è¢«æ—§é€»è¾‘è¦†ç›–)
        const bgInput = document.getElementById('bg-upload');
        if (bgInput) bgInput.onchange = function() { window.handleThemeUpload(this, 'wallpaper'); };
        const avInput = document.getElementById('avatar-upload');
        if (avInput) avInput.onchange = function() { window.handleThemeUpload(this, 'avatar'); };

        // å¼€å¯æ¯ 3 ç§’ä¸€æ¬¡çš„è‡ªåŠ¨ä¿å­˜
        setInterval(saveGlobalData, 3000);
        console.log("âœ… è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿå·²ä¸Šçº¿");
        
    }, 1500);
});

      // === ç»ˆææ•°æ®ä¿å­˜ç³»ç»Ÿ ===
// è¿™ä¸ªç³»ç»Ÿä¼šå¼ºåˆ¶æ‰€æœ‰æ“ä½œåéƒ½è‡ªåŠ¨ä¿å­˜

console.log('ğŸ”§ å¯åŠ¨æ•°æ®ä¿å­˜ç³»ç»Ÿ...');

// 1. å¢å¼ºçš„ä¿å­˜å‡½æ•°
function ä¿å­˜æ‰€æœ‰æ•°æ®() {
    console.log('ğŸ’¾ æ­£åœ¨ä¿å­˜æ‰€æœ‰æ•°æ®...');
    
    const æ‰€æœ‰æ•°æ® = {
        chatList: chatList,
        chatHistory: chatHistory,
        myPersonas: myPersonas,
        activePersonaId: activePersonaId,
        anniversaries: anniversaries,
        myWallet: myWallet,
        myStickers: myStickers,
        playList: playList,
        worldBook: worldBook || [],
        memoHistory: memoHistory || {},
        footprintHistory: footprintHistory || {},
        momentsData: momentsData || [],
        momentsCover: momentsCover || '',
        ä¿å­˜æ—¶é—´: new Date().toLocaleString()
    };
    
    // ä¿å­˜åˆ°æµè§ˆå™¨
    localStorage.setItem('yok_all_data', JSON.stringify(æ‰€æœ‰æ•°æ®));
    console.log('âœ… æ‰€æœ‰æ•°æ®ä¿å­˜å®Œæˆï¼');
    
    // â˜…â˜…â˜… æ–°å¢ï¼šä¿å­˜åç«‹å³åˆ·æ–°ç•Œé¢ â˜…â˜…â˜…
    setTimeout(åˆ·æ–°æ‰€æœ‰ç•Œé¢, 100);
}
      
// 2. å¢å¼ºçš„åŠ è½½å‡½æ•° - ä¿®å¤ç•Œé¢åˆ·æ–°é—®é¢˜
function åŠ è½½æ‰€æœ‰æ•°æ®() {
    console.log('ğŸ“‚ æ­£åœ¨åŠ è½½æ•°æ®...');
    const ä¿å­˜çš„æ•°æ® = localStorage.getItem('yok_all_data');
    
    if (ä¿å­˜çš„æ•°æ®) {
        try {
            const æ•°æ® = JSON.parse(ä¿å­˜çš„æ•°æ®);
            
            // æ¢å¤æ‰€æœ‰æ•°æ®
            if (æ•°æ®.chatList) chatList = æ•°æ®.chatList;
            if (æ•°æ®.chatHistory) chatHistory = æ•°æ®.chatHistory;
            if (æ•°æ®.myPersonas) myPersonas = æ•°æ®.myPersonas;
            if (æ•°æ®.activePersonaId) activePersonaId = æ•°æ®.activePersonaId;
            if (æ•°æ®.anniversaries) anniversaries = æ•°æ®.anniversaries;
            if (æ•°æ®.myWallet) myWallet = æ•°æ®.myWallet;
            if (æ•°æ®.myStickers) myStickers = æ•°æ®.myStickers;
            if (æ•°æ®.playList) playList = æ•°æ®.playList;
            
            console.log('ğŸ‰ æ•°æ®åŠ è½½æˆåŠŸï¼');
            console.log('çºªå¿µæ—¥æ•°é‡:', anniversaries.length);
            console.log('é’±åŒ…ä½™é¢:', myWallet.balance);
            
            // ç«‹å³åˆ·æ–°æ‰€æœ‰ç•Œé¢
            åˆ·æ–°æ‰€æœ‰ç•Œé¢();
            
        } catch (é”™è¯¯) {
            console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', é”™è¯¯);
        }
    } else {
        console.log('ğŸ“ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
    }
}

// æ–°å¢ï¼šå¼ºåˆ¶åˆ·æ–°æ‰€æœ‰ç•Œé¢çš„å‡½æ•°
function åˆ·æ–°æ‰€æœ‰ç•Œé¢() {
    console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰ç•Œé¢...');
    
    // åˆ·æ–°èŠå¤©åˆ—è¡¨
    if (document.getElementById('tab-chats')) {
        renderChatList();
    }
    
    // åˆ·æ–°é’±åŒ…æ˜¾ç¤º
    if (document.getElementById('wallet-balance')) {
        document.getElementById('wallet-balance').innerText = myWallet.balance;
        // åˆ·æ–°é’±åŒ…å†å²è®°å½•
        const å†å²å®¹å™¨ = document.getElementById('wallet-history');
        if (å†å²å®¹å™¨) {
            å†å²å®¹å™¨.innerHTML = '';
            const æœ€è¿‘è®°å½• = myWallet.history.slice().reverse().slice(0, 10);
            if (æœ€è¿‘è®°å½•.length === 0) {
                å†å²å®¹å™¨.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">æš‚æ— è´¦å•</div>';
            } else {
                æœ€è¿‘è®°å½•.forEach(è®°å½• => {
                    const è´¦å•é¡¹ = document.createElement('div');
                    è´¦å•é¡¹.className = 'bill-item';
                    è´¦å•é¡¹.innerHTML = `
                        <div>
                            <div class="bill-info">${è®°å½•.desc}</div>
                            <div class="bill-time">${è®°å½•.time}</div>
                        </div>
                        <div class="bill-amount ${è®°å½•.amount > 0 ? 'plus' : 'minus'}">
                            ${è®°å½•.amount > 0 ? '+' : ''}${è®°å½•.amount}
                        </div>
                    `;
                    å†å²å®¹å™¨.appendChild(è´¦å•é¡¹);
                });
            }
        }
    }
    
    // åˆ·æ–°çºªå¿µæ—¥åˆ—è¡¨
    if (document.getElementById('anniversary-list')) {
        const çºªå¿µæ—¥å®¹å™¨ = document.getElementById('anniversary-list');
        çºªå¿µæ—¥å®¹å™¨.innerHTML = '';
        
        if (anniversaries.length === 0) {
            çºªå¿µæ—¥å®¹å™¨.innerHTML = '<div class="helper-text" style="text-align: center;">è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</div>';
        } else {
            anniversaries.forEach((çºªå¿µæ—¥, ç´¢å¼•) => {
                // æŸ¥æ‰¾ç»‘å®šçš„è§’è‰²å
                let è§’è‰²å = 'é€šç”¨';
                if (çºªå¿µæ—¥.roleId && çºªå¿µæ—¥.roleId !== 'all') {
                    const è§’è‰² = chatList.find(r => r.id === çºªå¿µæ—¥.roleId);
                    è§’è‰²å = è§’è‰² ? è§’è‰².name : 'æœªçŸ¥è§’è‰²';
                }

                const çºªå¿µæ—¥é¡¹ = document.createElement('div');
                çºªå¿µæ—¥é¡¹.className = 'anniversary-item';
                çºªå¿µæ—¥é¡¹.innerHTML = `
                    <div class="anniversary-info">
                        <span class="name">
                            <span style="background:#E3F2FD; color:#7FA6C8; font-size:10px; padding:2px 6px; border-radius:4px; margin-right:5px;">${è§’è‰²å}</span>
                            ${çºªå¿µæ—¥.name}
                        </span>
                        <span class="date">${çºªå¿µæ—¥.date}</span>
                    </div>
                    <button class="delete-btn" onclick="åˆ é™¤çºªå¿µæ—¥(${ç´¢å¼•})">Ã—</button>
                `;
                çºªå¿µæ—¥å®¹å™¨.appendChild(çºªå¿µæ—¥é¡¹);
            });
        }
    }
    
    // åˆ·æ–°äººè®¾åˆ—è¡¨
    if (document.getElementById('persona-list-container')) {
        renderPersonaList();
    }
    
    // åˆ·æ–°è¡¨æƒ…åŒ…
    if (document.getElementById('sticker-grid')) {
        renderStickers();
    }
    
    console.log('âœ… æ‰€æœ‰ç•Œé¢åˆ·æ–°å®Œæˆï¼');
}

// æ–°å¢ï¼šåˆ é™¤çºªå¿µæ—¥å‡½æ•°
function åˆ é™¤çºªå¿µæ—¥(ç´¢å¼•) {
    if (confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªçºªå¿µæ—¥å—ï¼Ÿ')) {
        anniversaries.splice(ç´¢å¼•, 1);
        ä¿å­˜æ‰€æœ‰æ•°æ®();
        åˆ·æ–°æ‰€æœ‰ç•Œé¢();
    }
}

// 3. é‡å†™æ‰€æœ‰é‡è¦å‡½æ•°ï¼Œæ·»åŠ è‡ªåŠ¨ä¿å­˜
// åˆ›å»ºè§’è‰²
const åŸåˆ›å»ºè§’è‰² = createNewRole;
createNewRole = function() {
    åŸåˆ›å»ºè§’è‰²();
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

// å‘é€æ¶ˆæ¯
const åŸå‘é€æ¶ˆæ¯ = sendUserMessage;
sendUserMessage = function() {
    åŸå‘é€æ¶ˆæ¯();
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

// AIå›å¤
const åŸAIå›å¤ = triggerAIResponse;
triggerAIResponse = function(context) {
    return åŸAIå›å¤(context).then(() => {
        setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
    });
};

// ä¿å­˜äººè®¾
const åŸä¿å­˜äººè®¾ = saveNewPersona;
saveNewPersona = function() {
    åŸä¿å­˜äººè®¾();
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

// æ·»åŠ çºªå¿µæ—¥
const åŸæ·»åŠ çºªå¿µæ—¥ = addAnniversary;
addAnniversary = function() {
    åŸæ·»åŠ çºªå¿µæ—¥();
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

// é’±åŒ…æ“ä½œ
const åŸåŠ é’± = addBalance;
addBalance = function(amount) {
    åŸåŠ é’±(amount);
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

const åŸé‡ç½®é’±åŒ… = resetBalance;
resetBalance = function() {
    åŸé‡ç½®é’±åŒ…();
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

// è½¬è´¦
const åŸè½¬è´¦ = doTransfer;
doTransfer = function(type) {
    åŸè½¬è´¦(type);
    setTimeout(ä¿å­˜æ‰€æœ‰æ•°æ®, 100);
};

// 4. é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ¢å¤æ•°æ®...');
    setTimeout(åŠ è½½æ‰€æœ‰æ•°æ®, 200);
});


    </script>   
  
</body>
</html>